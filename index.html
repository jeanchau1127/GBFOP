<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gbfop</title>
    <style>
        :root {
            --bg-body: #f5f5f5;
            --bg-table: #fff;
            --bg-toolbar: #fff;
            --bg-modal: #fff;
            --bg-header: #f8f9fa;
            --border-color: #eee;
            --text-primary: #333;
            --text-secondary: #666;
            --text-coord: #ccc;
            --text-on-dark: #fff;
            --shadow: rgba(0,0,0,0.08);
            --t-text-hover: #e3f2fd;
            /* é˜¶æ®µé¢œè‰²å®šä¹‰ */
            --p-red-border: #ff6b6b;
            --p-red-bg: linear-gradient(90deg, rgba(255,107,107,0.08) 0%, transparent 100%);
            --p-red-text: #c62828;
            --p-orange-border: #ffb347;
            --p-orange-bg: linear-gradient(90deg, rgba(255,179,71,0.08) 0%, transparent 100%);
            --p-orange-text: #e65100;
            --p-yellow-border: #fdd835;
            --p-yellow-bg: linear-gradient(90deg, rgba(255,241,118,0.08) 0%, transparent 100%);
            --p-yellow-text: #f9a825;
            --p-green-border: #66bb6a;
            --p-green-bg: linear-gradient(90deg, rgba(129,199,132,0.08) 0%, transparent 100%);
            --p-green-text: #2e7d32;
            /* æŒ‰é’®æ¸å˜è‰² */
            --btn-gradient: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
            --btn-gradient-hover: linear-gradient(135deg, #386a8a 0%, #5d518a 100%);
            /* ğŸŒŒ æå…‰é«˜äº®ç³»ç»Ÿé…è‰² */
            --beam-summon-color: 0, 188, 170;  /* å¬å”¤çŸ³ï¼šæå…‰é’ç»¿ */
            --beam-skill-color: 99, 102, 241;  /* æŠ€èƒ½ï¼šç”µå…‰è“ç´« */
        }
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-table: #1e1e1e;
            --bg-toolbar: #252525;
            --bg-modal: #2a2a2a;
            --bg-header: #2a2a2a;
            --border-color: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-coord: #555;
            --text-on-dark: #e0e0e0;
            --shadow: rgba(0,0,0,0.4);
            --t-text-hover: #333;
            --p-red-text: #ff8a80;
            --p-orange-text: #ffcc80;
            --p-yellow-text: #fff59d;
            --p-green-text: #a5d6a7;
            --btn-bg: #424242;
            --btn-text: #fff;
            --btn-hover-bg: #616161;
            /* ğŸŒŒ æš—è‰²æ¨¡å¼æå…‰é«˜äº® - æ¸…é€å®çŸ³é£ */
            --beam-summon-color: 0, 210, 160;    /* è–„è·è§å…‰ (Mint Glow) */
            --beam-skill-color: 110, 140, 255;   /* æœˆå…‰è“ç´« (Periwinkle) */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: var(--bg-body); padding: 20px; user-select: none; transition: background 0.3s; }
        
        /* [ä¼˜åŒ–] è¡¨æ ¼å®¹å™¨ - å…è®¸æ¨ªå‘æ»šåŠ¨ */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin: 0 auto;
        }
        
        /* [ä¼˜åŒ–] è¡¨æ ¼å¸ƒå±€ - æ ¹æ®å†…å®¹è‡ªåŠ¨æ’‘å¼€ */
        .guide-table { 
            width: auto;
            min-width: 100%;
            margin: 0 auto; 
            border-collapse: collapse; 
            table-layout: auto;
            background: var(--bg-table); 
            box-shadow: 0 4px 16px var(--shadow); 
            border-radius: 12px; 
            overflow: hidden; 
        }
        .guide-table thead { position: static; }
        .guide-table th, .guide-table td { 
            border: 1px solid var(--border-color); 
            padding: 8px 10px; 
            text-align: center; 
            vertical-align: middle; 
            color: var(--text-primary); 
            transition: background 0.15s ease; 
            position: relative;
            white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
        }
        
        /* è¡¨æ ¼è¡Œå›ºå®šé«˜åº¦ï¼Œç¡®ä¿åŸºçº¿ä¸€è‡´ */
        .guide-table tbody tr {
            height: 50px; /* å›ºå®šè¡Œé«˜ */
        }
        
        /* ç¡®ä¿è¡¨æ ¼å•å…ƒæ ¼æ­£å¸¸æ˜¾ç¤º */
        .guide-table td {
            display: table-cell !important;
            width: auto;
            height: 50px; /* ä¸è¡¨æ ¼è¡Œé«˜åº¦ä¸€è‡´ */
            overflow: visible; /* å…è®¸å†…å®¹é€‚å½“æº¢å‡º */
        }
        
        /* [ä¼˜åŒ–] é˜¶æ®µåˆ—ï¼ˆAåˆ—ï¼‰ä¿æŠ¤æœ€å°å®½åº¦ */
        .guide-table td[rowspan] {
            min-width: 60px;
            white-space: normal; /* é˜¶æ®µåå…è®¸æ¢è¡Œ */
        }
        
        /* [ä¼˜åŒ–] å¤‡æ³¨åˆ—å…è®¸æ¢è¡Œ */
        .guide-table .note-cell {
            white-space: normal;
            min-width: 80px;
            max-width: 200px;
        }
        
        .guide-table th { background: var(--bg-header); color: var(--text-on-dark); font-weight: bold; }
        /* æ•°æ®è¡Œæ‚¬åœæ•ˆæœ */
        .guide-table tbody tr:not(.add-phase-row):hover td { background: rgba(33, 150, 243, 0.05); }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover td { background: rgba(33, 150, 243, 0.1); }
        .top-row th { background: var(--bg-top-row); }
        .source-cell { background: var(--bg-top-row); color: var(--text-on-dark); }
        .character-header { background: var(--bg-char-header) !important; position: relative; padding: 10px 4px 28px 4px !important; min-height: 180px; min-width: 110px; height: 180px; }
        .character-header img { width: auto; height: auto; max-height: 140px; max-width: 100%; display: block; margin: 5px auto 10px auto; object-fit: contain; }
        .character-header .char-name { font-size: 12px; color: var(--text-primary); position: absolute; bottom: 5px; left: 0; right: 0; text-align: center; border-bottom: none; }
        .character-header .char-name:hover,
        .character-header .char-name:focus { border-bottom: 1px dashed var(--text-coord); }
        .back-row { background: var(--bg-back-row) !important; }
        .skill-box { width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; margin: 2px; padding: 0; cursor: pointer; background: transparent; position: relative; }
        .skill-box img { width: 40px; height: 40px; object-fit: contain; }
        /* å¬å”¤çŸ³ä¸“ç”¨æ ·å¼ - å›ºå®šå®¹å™¨é«˜åº¦ + ç»å¯¹å®šä½å›¾ç‰‡ */
        .skill-box.summon-box { 
            width: 40px; 
            height: 40px; /* å›ºå®šå®¹å™¨é«˜åº¦ï¼Œä¸å½±å“è¡Œé«˜ */
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; /* ä¸ºç»å¯¹å®šä½å›¾ç‰‡æä¾›å‚è€ƒç‚¹ */
        }
        .skill-box.summon-box img { 
            position: absolute; /* ç»å¯¹å®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
            max-width: 40px; 
            max-height: 48px; /* ç•¥å¤§äºå®¹å™¨ï¼Œä½†ä¸è¶…è¿‡è¡Œé«˜ */
            width: auto; 
            height: auto; 
            object-fit: contain; 
            z-index: 5; /* ç¡®ä¿åœ¨æ­£ç¡®å±‚çº§ */
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); /* å±…ä¸­å¯¹é½ */
        }
        /* Båˆ—æ•°æ®è¡Œçš„skill-boxä½¿ç”¨blockå¸ƒå±€ï¼Œè®©å›¾ç‰‡ç‹¬å ä¸€è¡Œ */
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:first-child:not([rowspan]) .skill-box,
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:nth-child(1):not([rowspan]) .skill-box {
            display: block;
            margin: 2px auto;
        }
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:first-child:not([rowspan]) .skill-box img,
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:nth-child(1):not([rowspan]) .skill-box img {
            display: block;
            margin: 0 auto;
        }
        /* ========== ç¬¬ä¸€å±‚ï¼šå…‰æ ‡UX - æ‹–æ‹½æš—ç¤º ========== */
        .skill-source { 
            cursor: grab; /* å¼ å¼€çš„æ‰‹æŒï¼Œæš—ç¤º"å¯ä»¥æŠ“å–" */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border-radius: 4px; 
        }
        .skill-source:active { 
            cursor: grabbing; /* æŒ‰ä¸‹æ—¶æ˜¾ç¤º"æŠ“ä½çš„æ‰‹" */
            transform: scale(1.05); 
        }
        .skill-source:hover { transform: scale(1.1) translateY(-2px); box-shadow: 0 4px 12px rgba(33,150,243,0.4); }
        .skill-source.selected { outline: 3px solid #2196f3; opacity: 0.7; }
        
        /* =========================================
           ğŸŒŒ æå…‰å…‰æŸé«˜äº®ç³»ç»Ÿ (Aurora Beam System)
           ========================================= */
        
        /* 1. é€šç”¨é«˜äº®è¿‡æ¸¡ */
        .guide-table th, .guide-table td {
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 2. Dåˆ—é«˜äº® (å¬å”¤çŸ³/A-B/C/Dæº -> Dåˆ—) - æ•´åˆ—å…‰æŸ± */
        .guide-table.highlight-col-D tbody td[data-col="D"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-summon-color), 0.15) 0%, 
                rgba(var(--beam-summon-color), 0.06) 50%, 
                rgba(var(--beam-summon-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-summon-color), 0.05);
            border-left: 1px solid rgba(var(--beam-summon-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-summon-color), 0.20) !important;
        }
        
        /* 3. E-Jåˆ—é«˜äº® (æŠ€èƒ½æº -> å¯¹åº”åˆ—) - æ•´åˆ—å…‰æŸ± */
        .guide-table.highlight-col-E tbody td[data-col="E"],
        .guide-table.highlight-col-F tbody td[data-col="F"],
        .guide-table.highlight-col-G tbody td[data-col="G"],
        .guide-table.highlight-col-H tbody td[data-col="H"],
        .guide-table.highlight-col-I tbody td[data-col="I"],
        .guide-table.highlight-col-J tbody td[data-col="J"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.15) 0%, 
                rgba(var(--beam-skill-color), 0.06) 50%, 
                rgba(var(--beam-skill-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-skill-color), 0.05);
            border-left: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
        }
        
        /* 4. 9äººæ¨¡å¼é¢å¤–åˆ— K-N - æ•´åˆ—å…‰æŸ± */
        .guide-table.highlight-col-K tbody td[data-col="K"],
        .guide-table.highlight-col-L tbody td[data-col="L"],
        .guide-table.highlight-col-M tbody td[data-col="M"],
        .guide-table.highlight-col-N tbody td[data-col="N"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.15) 0%, 
                rgba(var(--beam-skill-color), 0.06) 50%, 
                rgba(var(--beam-skill-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-skill-color), 0.05);
            border-left: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
        }
        
        /* 5. è¡¨å¤´é«˜äº®æ•ˆæœ - ä½œä¸ºå…‰æº */
        .guide-table.highlight-col-D thead th[data-col="D"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-summon-color), 0.30) 0%, 
                rgba(var(--beam-summon-color), 0.15) 100%) !important;
            box-shadow: 0 3px 12px rgba(var(--beam-summon-color), 0.20);
            text-shadow: 0 0 8px rgba(var(--beam-summon-color), 0.5);
        }
        
        .guide-table.highlight-col-E thead th[data-col="E"],
        .guide-table.highlight-col-F thead th[data-col="F"],
        .guide-table.highlight-col-G thead th[data-col="G"],
        .guide-table.highlight-col-H thead th[data-col="H"],
        .guide-table.highlight-col-I thead th[data-col="I"],
        .guide-table.highlight-col-J thead th[data-col="J"],
        .guide-table.highlight-col-K thead th[data-col="K"],
        .guide-table.highlight-col-L thead th[data-col="L"],
        .guide-table.highlight-col-M thead th[data-col="M"],
        .guide-table.highlight-col-N thead th[data-col="N"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.30) 0%, 
                rgba(var(--beam-skill-color), 0.15) 100%) !important;
            box-shadow: 0 3px 12px rgba(var(--beam-skill-color), 0.20);
            text-shadow: 0 0 8px rgba(var(--beam-skill-color), 0.5);
        }
        .swap-row { background: var(--bg-header) !important; }
        .swap-row td { color: var(--text-on-dark); }
        .coord { font-size: 9px; color: var(--text-coord); display: block; }
        .coord-header { font-size: 9px; color: #ccc; }
        .note-cell { font-size: 11px; background: var(--bg-note-cell); color: var(--text-primary); }
        .note-cell-dark { font-size: 11px; background: var(--bg-back-row); color: var(--text-on-dark); }
        #floatingIcon { position: fixed; pointer-events: none; opacity: 0.7; z-index: 9999; display: none; }
        /* ========== Material Design å·¥å…·æ  ========== */
        .toolbar {
            max-width: 1800px;
            margin: 0 auto 15px;
            padding: 12px 16px;
            background: var(--bg-toolbar);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .toolbar button {
            padding: 8px 16px;
            /* ä¿®æ”¹ï¼šä½¿ç”¨æ¸å˜èƒŒæ™¯ï¼Œæ–‡å­—ç™½è‰² */
            background: var(--btn-gradient);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            display: inline-flex; /* ä¿è¯å›¾æ ‡å¯¹é½ */
            align-items: center;
            gap: 4px;
        }
        .toolbar button:hover {
            /* ä¿®æ”¹ï¼šæ‚¬åœä½¿ç”¨æ·±è‰²æ¸å˜ */
            background: var(--btn-gradient-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .toolbar button:active { transform: translateY(0); }
        .toolbar span { color: var(--text-secondary); font-size: 12px; margin-left: auto; }
        
        /* ========== åˆ›ä½œè€…å¾½ç« ç³»ç»Ÿ ========== */
        .author-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            white-space: nowrap;
            height: 36px;
            box-sizing: border-box;
        }
        .author-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(var(--beam-skill-color), 0.15);
            border-color: rgba(var(--beam-skill-color), 0.4);
            color: rgb(var(--beam-skill-color));
        }
        .author-badge .author-icon {
            font-size: 14px;
            opacity: 0.7;
        }
        [data-theme="dark"] .author-badge {
            background: rgba(40, 40, 45, 0.8);
            backdrop-filter: blur(8px);
        }
        
        /* ğŸŒŸ å‘¼å¸ç¯åŠ¨ç”» - å¼•å¯¼ç”¨æˆ·ç‚¹å‡» */
        @keyframes badge-pulse {
            0% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 0 rgba(var(--beam-skill-color), 0.4); }
            70% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 8px rgba(var(--beam-skill-color), 0); }
            100% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 0 rgba(var(--beam-skill-color), 0); }
        }
        .author-badge.pulse {
            animation: badge-pulse 2s infinite;
            border-color: rgba(var(--beam-skill-color), 0.5);
        }
        
        /* åˆ›ä½œè€…å¼¹çª—é®ç½© */
        .author-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        .author-modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        /* åˆ›ä½œè€…å¡ç‰‡ */
        .author-card {
            width: 380px;
            max-width: 90vw;
            background: var(--bg-modal);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--border-color);
            position: relative;
        }
        .author-modal-overlay.active .author-card {
            transform: scale(1);
        }
        .author-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .author-card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(90deg, rgb(var(--beam-skill-color)), rgb(var(--beam-summon-color)));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .author-card .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }
        .author-card .close-btn:hover {
            color: var(--text-primary);
        }
        
        /* åŒºå—æ ‡ç­¾ */
        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* å†å²è´¡çŒ®è€…åˆ—è¡¨ */
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
        }
        [data-theme="dark"] .history-list {
            background: rgba(255,255,255,0.03);
        }
        .history-tag {
            font-size: 12px;
            padding: 4px 10px;
            background: rgba(var(--beam-skill-color), 0.1);
            color: rgb(var(--beam-skill-color));
            border-radius: 12px;
            border: 1px solid rgba(var(--beam-skill-color), 0.2);
            transition: all 0.2s;
        }
        .history-tag:hover {
            background: rgba(var(--beam-skill-color), 0.15);
        }
        .empty-history {
            font-size: 13px;
            color: var(--text-coord);
            font-style: italic;
            padding: 8px;
        }
        
        /* å½“å‰ç¼–è¾‘è€…è¾“å…¥ */
        .current-author-section {
            margin-top: 16px;
        }
        .author-input-wrapper {
            position: relative;
            margin-bottom: 8px;
        }
        #authorInput {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-table);
            font-size: 15px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #authorInput:focus {
            border-color: rgb(var(--beam-skill-color));
            box-shadow: 0 0 0 3px rgba(var(--beam-skill-color), 0.1);
        }
        #authorInput::placeholder {
            color: var(--text-coord);
        }
        .input-hint {
            font-size: 11px;
            color: var(--text-coord);
            margin: 8px 0 0 0;
        }
        
        /* ========== Material Design å¼€å…³æ ·å¼ ========== */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .toggle-switch input {
            display: none;
        }
        .toggle-slider {
            width: 36px;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s ease;
        }
        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: #2196f3;
        }
        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(16px);
        }
        .toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ========== éšè—åæ ‡æ ·å¼ ========== */
        .hide-coords .coord,
        .hide-coords .coord-header {
            display: none !important;
        }
        .user-text { font-size: 11px; color: var(--text-primary); margin-top: 3px; display: block; word-break: break-all; cursor: text; outline: none; }
        .user-text:hover { background: var(--t-text-hover); }
        .user-text:focus { background: var(--t-text-hover); }
        
        /* ========== ç¬¬ä¸€å±‚ï¼šå…‰æ ‡UX - å¤‡æ³¨ç¼–è¾‘æš—ç¤º ========== */
        /* å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€æ—¶æ˜¾ç¤ºç¼–è¾‘å…‰æ ‡å’Œæç¤º */
        .note-cell {
            cursor: text; /* æ–‡æœ¬ç¼–è¾‘å…‰æ ‡ */
        }
        
        /* å¤‡æ³¨å•å…ƒæ ¼æ‚¬åœæ—¶çš„ç¼–è¾‘æç¤ºè¾¹æ¡† */
        .note-cell:hover {
            outline: 1px dashed var(--text-coord);
            outline-offset: -2px;
        }
        .note-cell:focus-within {
            outline: 2px solid #2196f3;
            outline-offset: -2px;
        }
        /* ========== Material Design å¼¹çª—æ ·å¼ ========== */
        .text-input-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.2), 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            color: var(--text-primary);
            animation: modalFadeIn 0.2s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .text-input-modal input {
            width: 220px;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .text-input-modal input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .text-input-modal button {
            margin-left: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .text-input-modal button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            backdrop-filter: blur(2px);
            animation: overlayFadeIn 0.2s ease-out;
        }
        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ========== é˜¶æ®µ/è¡ŒæŒ‰é’®ï¼ˆç®€æ´æ–‡å­—é£æ ¼ï¼‰ ========== */
        .phase-btn {
            padding: 0 2px;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .phase-btn:hover {
            color: #4caf50;
            transform: scale(1.3);
        }
        .phase-btn:active { transform: scale(1.1); }
        
        /* åˆ é™¤é˜¶æ®µæŒ‰é’® */
        .phase-del-btn {
            padding: 0 2px;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .phase-del-btn:hover {
            color: #f44336;
            transform: scale(1.3);
        }
        .phase-del-btn:active { transform: scale(1.1); }
        
        /* Aåˆ—æŒ‰é’®å®¹å™¨ - è®©+å’Œ-å±…ä¸­å¯¹ç§° */
        .a-cell-buttons {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .del-btn {
            padding: 0 2px;
            margin: 0;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .del-btn:hover {
            color: #f44336;
            transform: scale(1.3);
        }
        .del-btn:active { transform: scale(1.1); }
        
        /* Båˆ—å•å…ƒæ ¼å†…å®¹å®¹å™¨ - ä¼˜åŒ–ç‰ˆ */
        .b-cell-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 25px;
        }
        /* å·¦ä¾§åˆ é™¤æŒ‰é’® */
        .b-cell-content .del-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }
        /* å³ä¾§æ·»åŠ è¡ŒæŒ‰é’® */
        .b-cell-content .add-row-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            padding: 0;
            background: transparent;
            color: var(--text-primary);
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .b-cell-content .add-row-btn:hover {
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            transform: translateY(-50%) scale(1.1);
        }
        .b-cell-content .add-row-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        [data-theme="dark"] .b-cell-content .add-row-btn:hover {
            color: #81c784;
            background: rgba(129, 199, 132, 0.1);
        }
        .b-cell-content .t-text {
            display: inline-block;
        }
        
        .t-text { cursor: pointer; border-bottom: 1px dashed var(--text-coord); color: var(--text-primary); }
        .t-text:hover { background: var(--t-text-hover); }
        .t-text.phase-name { font-weight: bold; border-bottom: none; }
        .header-text { cursor: pointer; }
        .header-text:hover { opacity: 0.8; }
        /* ========== Material Design æ–°å¢é˜¶æ®µæŒ‰é’® ========== */
        .add-phase-row td { background: var(--bg-table); }
        .add-phase-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .add-phase-btn:hover {
            background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .add-phase-btn:active { transform: translateY(0); }
        /* ========== Material Design å³é”®èœå• ========== */
        .context-menu {
            position: fixed;
            background: var(--bg-modal);
            border: none;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10002;
            min-width: 180px;
            padding: 8px 0;
            animation: menuSlideIn 0.15s ease-out;
        }
        @keyframes menuSlideIn {
            from { opacity: 0; transform: translateY(-8px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: background 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .context-menu-item:hover { background: rgba(33, 150, 243, 0.1); }
        .context-menu-divider { height: 1px; background: var(--border-color); margin: 6px 0; }
        .context-menu-submenu { position: relative; }
        .context-menu-submenu::after { content: 'â–¶'; position: absolute; right: 12px; font-size: 10px; opacity: 0.6; }
        .context-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: var(--bg-modal);
            border: none;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
            min-width: 140px;
            padding: 8px 0;
            display: none;
        }
        .context-menu-submenu:hover .context-submenu { display: block; }
        
        /* ========== Material Design è§’è‰²å¿«é€Ÿæ·»åŠ å¼¹çª—æ ·å¼ ========== */
        .char-add-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.2), 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            color: var(--text-primary);
            min-width: 420px;
            max-width: 90vw;
            animation: modalFadeIn 0.2s ease-out;
        }
        .char-add-modal h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 500;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
        }
        .char-add-modal .wiki-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 16px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            transition: all 0.2s ease;
        }
        .char-add-modal .wiki-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .char-add-modal .top-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .char-add-modal .more-skills-inline-btn {
            margin-left: auto;
            height: 36px;
            padding: 0 18px;
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
        }
        .char-add-modal label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .char-add-modal input[type="text"], .char-add-modal textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg-table);
            color: var(--text-primary);
            margin-bottom: 14px;
            transition: border-color 0.2s ease;
        }
        .char-add-modal input[type="text"]:focus, .char-add-modal textarea:focus {
            outline: none;
            border-color: #2196f3;
        }
        .char-add-modal textarea { height: 80px; resize: vertical; font-family: monospace; }
        .char-add-modal .preview-area {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            align-items: center;
            flex-wrap: wrap;
            padding: 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }
        [data-theme="dark"] .char-add-modal .preview-area { background: rgba(255,255,255,0.05); }
        .char-add-modal .preview-img {
            width: 50px;
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-table);
        }
        .char-add-modal .preview-skill {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-table);
        }
        .char-add-modal .preview-summon {
            width: 40px;
            height: auto;
            max-height: 56px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            object-fit: contain;
            background: var(--bg-table);
        }
        .char-add-modal .btn-row {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .char-add-modal .btn-row button {
            padding: 10px 24px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .char-add-modal .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .char-add-modal .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .char-add-modal .btn-secondary {
            background: #616161;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .char-add-modal .btn-secondary:hover {
            background: #757575;
            transform: translateY(-1px);
        }
        .char-add-modal .hint {
            font-size: 11px;
            color: var(--text-coord);
            margin-top: -10px;
            margin-bottom: 14px;
        }
        
        /* ========== è§’è‰²/èŒä¸šç‹¬ç«‹è¾“å…¥æ¡†æ ·å¼ ========== */
        .char-input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .char-input-label {
            width: 90px;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
            padding-bottom: 8px;
        }
        .char-avatar-input {
            flex: 1;
            padding: 8px 12px !important;
            margin: 0 !important;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        .char-avatar-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .char-avatar-preview {
            width: 50px;
            height: auto;
            max-height: 80px;
            object-fit: contain;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .skill-inputs-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
        }
        .skill-input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .skill-input-label {
            width: 60px;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
            padding-bottom: 8px;
        }
        .skill-url-input-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
            display: flex;
            align-items: center;
        }
        .skill-url-input {
            flex: 1;
            padding: 0 40px 0 12px !important;
            margin: 0 !important;
            height: 40px;
            line-height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .skill-url-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        /* æ‹–æ‹½æ‚¬åœæ•ˆæœ */
        .skill-url-input.drag-over {
            border-color: #4caf50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }
        .skill-url-input.drag-over::placeholder {
            content: 'æ¾å¼€ä»¥ç²˜è´´';
        }
        
        /* å¬å”¤çŸ³è¾“å…¥æ¡†ä¸“ç”¨æ ·å¼ - å‚ç…§èŒä¸šå¤´åƒå¤„ç†æ–¹å¼ */
        .summon-url-input {
            flex: 1;
            padding: 8px 40px 8px 12px !important;
            margin: 0 !important;
            height: auto;
            min-height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .summon-url-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .summon-url-input.drag-over {
            border-color: #4caf50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }
        
        /* è¾“å…¥æ¡†å†…çš„ç²˜è´´æŒ‰é’® */
        .paste-btn-inline {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .paste-btn-inline:hover {
            background: #f57c00;
            transform: translateY(-50%) scale(1.1);
        }
        .paste-btn-inline:active {
            transform: translateY(-50%) scale(0.95);
        }
        .skill-input-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* å¬å”¤çŸ³é¢„è§ˆå›¾ - å‚ç…§èŒä¸šå¤´åƒå¤„ç†æ–¹å¼ */
        .summon-input-preview {
            width: 40px;
            height: auto;
            max-height: 80px;
            object-fit: contain;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* ========== 1. ç»Ÿä¸€çš„åœ†å½¢æŒ‰é’®åŸºç¡€æ ·å¼ (Glass Bubble) ========== */
        .mini-fab, .micro-fab {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨åŠé€æ˜èƒŒæ™¯ + é˜´å½±ï¼Œè€Œä¸æ˜¯çº¯è‰²å— */
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§åŠ¨ç”» */
            opacity: 0; /* é»˜è®¤éšè— */
            transform: scale(0.8);
        }
        
        /* æ‚¬åœæ˜¾ç¤ºé€»è¾‘ */
        .has-fab:hover .mini-fab,
        .skill-box:hover .mini-fab,
        .data-cell:hover .micro-fab {
            opacity: 1;
            transform: scale(1);
        }
        
        /* æŒ‰é’®æ‚¬åœäº¤äº’ */
        .mini-fab:hover, .micro-fab:hover {
            transform: scale(1.15) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #fff; /* æ‚¬åœæ—¶å˜çº¯ç™½ */
        }
        
        /* ========== 2. é¢œè‰²å®šä¹‰ (å›¾æ ‡ç€è‰²) ========== */
        /* ç¼–è¾‘ (è“è‰²) */
        .mini-fab.edit, .micro-fab.text { color: #2196f3; }
        /* åˆ é™¤ (çº¢è‰²) */
        .mini-fab.delete, .delete-char-btn { color: #f44336; }
        /* æ·»åŠ  (ç»¿è‰²) */
        .mini-fab.add { color: #4caf50; }
        /* åˆå¹¶ (ç»¿è‰²) */
        .micro-fab.merge { color: #4caf50; }
        /* æ‹†åˆ† (æ©™è‰²) */
        .micro-fab.split { color: #ff9800; }
        /* å®Œå…¨æ‹†åˆ† (çº¢è‰²) */
        .micro-fab.split-full { color: #f44336; }
        
        /* ========== 3. æš—è‰²æ¨¡å¼é€‚é… ========== */
        [data-theme="dark"] .mini-fab, 
        [data-theme="dark"] .micro-fab {
            background: rgba(50, 50, 50, 0.9); /* æ·±è‰²åŠé€æ˜åº• */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        
        [data-theme="dark"] .mini-fab:hover, 
        [data-theme="dark"] .micro-fab:hover {
            background: #424242;
        }
        
        [data-theme="dark"] .mini-fab.edit, 
        [data-theme="dark"] .micro-fab.text { color: #64b5f6; }
        [data-theme="dark"] .mini-fab.delete { color: #ef5350; }
        [data-theme="dark"] .mini-fab.add { color: #81c784; }
        [data-theme="dark"] .micro-fab.merge { color: #81c784; }
        [data-theme="dark"] .micro-fab.split { color: #ffb74d; }
        [data-theme="dark"] .micro-fab.split-full { color: #ef5350; }
        
        /* ========== 4. ä½ç½®å¾®è°ƒ ========== */
        /* è§’è‰²å¤´åƒåŒºåŸŸçš„ç¼–è¾‘æŒ‰é’® */
        .character-header .mini-fab { top: 6px; right: 6px; }
        /* å¬å”¤çŸ³/æŠ€èƒ½æºåŒºåŸŸçš„æŒ‰é’® */
        .source-cell .mini-fab { top: 6px; right: 6px; }
        
        /* æŠ€èƒ½å›¾æ ‡ä¸Šçš„åˆ é™¤æŒ‰é’® */
        .skill-box .mini-fab { 
            width: 18px; 
            height: 18px; 
            font-size: 12px;
            top: -6px; 
            right: -6px; 
        }
        
        /* å•å…ƒæ ¼æ“ä½œæŒ‰é’®ä½ç½® */
        .micro-fab.top-left { top: 2px; left: 2px; }
        .micro-fab.top-right { top: 2px; right: 2px; }
        
        /* æ•°æ®å•å…ƒæ ¼æ‚¬åœæ—¶æ˜¾ç¤ºå¾®å‹æŒ‰é’® */
        .data-cell { 
            position: relative !important; 
            vertical-align: middle !important;
            text-align: center !important;
            height: 50px;
            padding: 4px;
            display: table-cell !important;
            overflow: visible !important; /* ç¡®ä¿æŒ‰é’®ä¸è¢«é®æŒ¡ */
        }
        .data-cell:hover .micro-fab,
        td:hover > .micro-fab.top-left { 
            opacity: 1; 
            transform: scale(1);
            transition-delay: 0s;
        }
        .data-cell .micro-fab,
        td > .micro-fab.top-left { 
            transition-delay: 0.3s;
        }
        
        /* æ•°æ®å•å…ƒæ ¼å†…çš„æŠ€èƒ½å›¾æ ‡å®¹å™¨ */
        .data-cell .skill-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            margin-bottom: 4px;
        }
        
        /* æ•°æ®å•å…ƒæ ¼å†…çš„æŠ€èƒ½å›¾æ ‡ */
        .data-cell .skill-box {
            margin: 1px;
            display: inline-block; /* ç¡®ä¿æŠ€èƒ½å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
        }
        
        /* æ•°æ®å•å…ƒæ ¼å†…çš„æ–‡å­— */
        .data-cell .user-text-wrapper {
            margin-top: 4px;
            text-align: center;
            display: block;
        }
        
        /* Dåˆ—ï¼ˆå¬å”¤çŸ³åˆ—ï¼‰å†…çš„æ–‡å­— - ä¸data-cellä¿æŒä¸€è‡´ */
        td:not(.data-cell) .user-text-wrapper {
            margin-top: 4px;
            text-align: center;
            display: block;
        }
        
        /* å¾®å‹æŒ‰é’®å®šä½ */
        .micro-fab.top-left { top: 2px; left: 2px; }
        .micro-fab.top-right { top: 2px; right: 2px; }
        
        /* çˆ¶å…ƒç´ æ‚¬åœæ—¶æ˜¾ç¤ºæŒ‰é’® */
        .has-fab { position: relative; }
        .has-fab:hover .mini-fab { opacity: 1; }
        
        /* ========== ä¼˜åŒ–å·¦ä¸Šè§’åˆ é™¤æŒ‰é’® (ä¸å³ä¸Šè§’é£æ ¼ç»Ÿä¸€) ========== */
        .delete-char-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* å‡çº§ä¸ºæ¯›ç»ç’ƒè´¨æ„Ÿï¼Œä¸å³ä¾§æŒ‰é’®ä¸€è‡´ */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f44336; /* çº¢è‰²å›¾æ ‡ */
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            /* ç»Ÿä¸€çš„é˜´å½±è´¨æ„Ÿ */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* æ‚¬åœæ•ˆæœ */
        .delete-char-btn:hover {
            background: #fff;       /* çº¯ç™½é«˜äº® */
            color: #d32f2f;         /* å›¾æ ‡å˜æ·±çº¢ */
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2); /* çº¢è‰²ç³»çš„æ·¡é˜´å½± */
        }

        .delete-char-btn:active {
            transform: scale(1);
        }

        /* çˆ¶å…ƒç´ æ‚¬åœæ˜¾ç¤ºé€»è¾‘ä¿æŒä¸å˜ */
        .has-fab:hover .delete-char-btn {
            opacity: 1;
        }

        /* æš—è‰²æ¨¡å¼é€‚é… */
        [data-theme="dark"] .delete-char-btn {
            background: rgba(50, 50, 50, 0.9);
            color: #ef5350;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .delete-char-btn:hover {
            background: #424242;
        }
        
        /* è§’è‰²å¤´åƒåŒºåŸŸçš„ç¼–è¾‘æŒ‰é’® */
        .character-header .mini-fab { 
            top: 4px; 
            right: 4px;
        }
        .character-header:hover .mini-fab {
            opacity: 1;
        }
        
        /* å¬å”¤çŸ³/æŠ€èƒ½æºåŒºåŸŸçš„æ·»åŠ æŒ‰é’® */
        .source-cell .mini-fab { top: 2px; right: 2px; }
        
        /* BOSSå›¾åŒºåŸŸçš„ç¼–è¾‘æŒ‰é’® - ä½¿ç”¨å­é€‰æ‹©å™¨ç²¾ç¡®å®šä½ */
        .top-row > th > .mini-fab.edit { top: 5px; right: 10px; }
        
        /* è¡¨å¤´çŠ¶æ€å›¾æ ‡çš„åˆ é™¤æŒ‰é’® - ä¸å†…å®¹è¡Œä¿æŒä¸€è‡´ */
        .top-row .skill-box.skill-source {
            position: relative;
        }
        .top-row .skill-box.skill-source .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.15s ease;
        }
        .top-row .skill-box.skill-source:hover .mini-fab {
            opacity: 1;
            transform: scale(1);
        }
        
        /* æ•°æ®æ ¼å­çš„æ·»åŠ æŒ‰é’® */
        .data-cell-fab { top: 2px; right: 2px; }
        
        /* å·²æ”¾ç½®æŠ€èƒ½çš„åˆ é™¤æŒ‰é’® */
        .skill-box:not(.skill-source) { position: relative; }
        .skill-box:not(.skill-source) .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
        }
        
        /* å¬å”¤çŸ³åˆ é™¤æŒ‰é’®ç‰¹æ®Šå®šä½ - ç›¸å¯¹äºå›¾ç‰‡è€Œéå®¹å™¨ */
        .skill-box.summon-box:not(.skill-source) .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
            /* åˆ é™¤æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€è°ƒæ•´ä½ç½® */
        }
        
        .skill-box:not(.skill-source):hover .mini-fab { opacity: 1; }
        
        /* å¯¼å‡ºå›¾ç‰‡æ—¶éšè—æŒ‰é’® */
        .exporting .mini-fab { display: none !important; }
        .exporting .empty-cell-hint { display: none !important; }
        
        /* ========== ç©ºçŠ¶æ€æç¤ºåŸºç¡€æ ·å¼ ========== */
        .empty-state-hint,
        .summon-empty-state-hint,
        .boss-empty-state-hint {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
        }
        
        .empty-state-hint {
            top: 40%;
            text-align: center;
            width: 90%;
        }
        
        .summon-empty-state-hint {
            top: 50%;
            width: 90%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .boss-empty-state-hint {
            top: 50%;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
        }
        
        /* ç©ºçŠ¶æ€æ–‡å­—æ ·å¼ */
        .empty-text,
        .summon-empty-text,
        .boss-empty-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .empty-text { margin-bottom: 12px; }
        .summon-empty-text { white-space: nowrap; }
        .boss-empty-text { font-size: 14px; text-align: center; }
        
        /* ç©ºçŠ¶æ€æŒ‰é’®å®¹å™¨ */
        .empty-buttons,
        .summon-empty-buttons,
        .boss-empty-buttons {
            pointer-events: auto;
            display: flex;
            gap: 6px;
        }
        
        .empty-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .summon-empty-buttons { gap: 8px; }
        .summon-empty-buttons-vertical {
            flex-direction: column;
            gap: 5px;
        }
        
        /* å°æŒ‰é’®æ ·å¼ */
        .wiki-btn-small {
            padding: 6px 12px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .wiki-btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }
        
        .wiki-btn-small:active { transform: translateY(0); }
        
        /* å¬å”¤çŸ³æŒ‰é’®ç¼©å°å°ºå¯¸ */
        .summon-empty-buttons-vertical .wiki-btn-small {
            padding: 4px 8px;
            font-size: 10px;
            min-width: 80px;
        }
        
        /* è§’è‰²åç§°æ–‡å­—åœ¨ç©ºçŠ¶æ€æ—¶æé«˜å±‚çº§ */
        .character-header .char-name {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 2;
        }
        
        /* æ‹–æ‹½æ‚¬åœæ•ˆæœ */
        .drag-drop-zone { position: relative; }
        .drag-drop-zone.drag-over {
            outline: 3px dashed #2196f3;
            outline-offset: -3px;
            background: rgba(33, 150, 243, 0.05);
        }
        [data-theme="dark"] .drag-drop-zone.drag-over { background: rgba(33, 150, 243, 0.1); }
        
        /* ========== å¸®åŠ©æŒ‰é’®å’Œæç¤ºæ¡†æ ·å¼ ========== */
        .modal-help-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 28px;
            height: 28px;
            background: transparent;
            color: #2196f3;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-help-btn:hover {
            color: #1565c0;
            transform: scale(1.15);
        }
        .modal-help-btn:active {
            transform: scale(0.95);
        }
        
        .help-tooltip {
            position: absolute;
            top: 60px;
            right: 24px;
            width: 320px;
            background: var(--bg-modal);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            z-index: 9;
            display: none;
        }
        .help-tooltip h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #2196f3;
            font-weight: 600;
        }
        .help-tooltip ol {
            margin: 0 0 12px 0;
            padding-left: 20px;
        }
        .help-tooltip li {
            margin-bottom: 6px;
        }
        .help-tooltip .help-section {
            margin-bottom: 12px;
        }
        .help-tooltip .help-section:last-child {
            margin-bottom: 0;
        }
        
        /* ========== Material Design è¾“å…¥æ¡†æ ·å¼ ========== */
        .font-size-input {
            width: 55px;
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-table);
            color: var(--text-primary);
            font-size: 13px;
            transition: border-color 0.2s ease;
        }
        .font-size-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .toolbar-label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-right: 4px;
        }
        
        /* ========== Material Design å•é€‰æŒ‰é’®æ ·å¼ ========== */
        .material-radio {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.15s ease;
            margin-right: 8px;
        }
        .material-radio:hover { background: rgba(33, 150, 243, 0.1); }
        .material-radio input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .material-radio input[type="radio"]:checked {
            border-color: #2196f3;
        }
        .material-radio input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #2196f3;
            border-radius: 50%;
            animation: radioCheck 0.15s ease-out;
        }
        @keyframes radioCheck {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* ========== ç”¨æˆ·æ–‡å­—åˆ é™¤æŒ‰é’® ========== */
        .user-text-wrapper {
            position: relative;
            display: inline-block;
        }
        .user-text-wrapper .mini-fab {
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            font-size: 10px;
        }
        .user-text-wrapper:hover .mini-fab { opacity: 1; }
        
        /* ========== ç©ºæ ¼å­æç¤ºæ ·å¼ ========== */
        .empty-cell-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-coord);
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        td:hover .empty-cell-hint { opacity: 0.6; }
        td.has-content .empty-cell-hint { display: none; }
        
        /* ========== Ripple æ¶Ÿæ¼ªæ•ˆæœ ========== */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
        }
        .ripple:active::after {
            width: 200%;
            height: 200%;
            opacity: 0;
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        /* ========== çŠ¶æ€æ ä¼˜åŒ– ========== */
        #statusBar {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
            animation: statusSlideIn 0.2s ease-out;
        }
        @keyframes statusSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* ========== ä¸»è§’å¸¸ç”¨æŠ€èƒ½å¿«æ·æŒ‰é’® ========== */
        .quick-skills-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed var(--border-color);
        }
        .quick-skills-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .quick-skill-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .quick-skill-btn {
            padding: 4px;
            width: 36px;
            height: 36px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .quick-skill-btn:hover {
            background: #4caf50;
            color: #fff;
            transform: translateY(-1px) scale(1.05);
        }
        .quick-skill-btn.special:hover {
            background: #ff9800;
        }
        .quick-skill-btn img {
            width: 28px;
            height: 28px;
            border-radius: 4px;
        }
        
        /* ========== æŠ€èƒ½æ§½å†…è”å¢åˆ æŒ‰é’® ========== */
        .skill-inline-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .skill-inline-btn.add-skill-row {
            background: #4caf50;
        }
        .skill-inline-btn.add-skill-row:hover {
            background: #43a047;
            transform: scale(1.15);
        }
        .skill-inline-btn.remove-skill-row {
            background: #f44336;
        }
        .skill-inline-btn.remove-skill-row:hover {
            background: #e53935;
            transform: scale(1.15);
        }
        .skill-inline-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ========== ğŸ¨ ç°ä»£ UI ä¼˜åŒ–æ ·å¼ (GBF Theme) ========== */
        
        /* Google Fonts å¼•å…¥ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        /* å…¨å±€å­—ä½“ä¼˜åŒ– */
        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
        }
        
        /* æ•°å­—ä½¿ç”¨ Roboto å­—ä½“ */
        .t-text, .phase-name, .coord, .coord-header, .font-size-input {
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
        }
        
        /* 1. è¡¨æ ¼å»è¾¹æ¡†åŒ–ä¸åœ†è§’ */
        .guide-table {
            border-radius: 16px;
            border: none !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            /* [ä¿®æ”¹] æ”¹ä¸ºè‡ªåŠ¨å¸ƒå±€ï¼Œå…è®¸å†…å®¹æ’‘å¼€ */
            table-layout: auto;
            width: auto;
            min-width: 100%;
        }
        
        /* [ä¿®æ”¹] å•å…ƒæ ¼ä¸æ¢è¡Œï¼Œä½†ä¸æˆªæ–­ */
        .guide-table td, .guide-table th {
            overflow: visible;
            white-space: nowrap;
        }
        /* ä¾‹å¤–ï¼šå…è®¸æ¢è¡Œçš„å…ƒç´  */
        .guide-table .phase-name,
        .guide-table .user-text,
        .guide-table .char-name,
        .guide-table .t-text,
        .guide-table .note-cell,
        .guide-table td[rowspan] {
            white-space: normal;
        }
        
        .guide-table th, 
        .guide-table td {
            border-top: none !important;
            border-left: none !important;
            border-bottom: 1px solid rgba(0,0,0,0.06) !important;
            border-right: 1px solid rgba(0,0,0,0.04) !important; /* ææ·¡å‚ç›´çº¿ */
            padding: 12px 14px;
        }
        
        /* å»æ‰æœ€åä¸€åˆ—çš„å³è¾¹æ¡† */
        .guide-table th:last-child,
        .guide-table td:last-child {
            border-right: none !important;
        }
        
        [data-theme="dark"] .guide-table th,
        [data-theme="dark"] .guide-table td {
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            border-right: 1px solid rgba(255,255,255,0.05) !important; /* æš—è‰²æ¨¡å¼å‚ç›´çº¿ */
        }
        
        [data-theme="dark"] .guide-table th:last-child,
        [data-theme="dark"] .guide-table td:last-child {
            border-right: none !important;
        }
        
        /* å»æ‰æœ€åä¸€è¡Œçš„çº¿ */
        .guide-table tbody tr:last-child td {
            border-bottom: none !important;
        }
        
        /* æ–‘é©¬çº¹æ•ˆæœ */
        .guide-table tbody tr:nth-child(even):not(.add-phase-row) td {
            background-color: rgba(0,0,0,0.015);
        }
        [data-theme="dark"] .guide-table tbody tr:nth-child(even):not(.add-phase-row) td {
            /* ä¿®æ”¹ï¼šä½¿ç”¨æå¾®å¼±çš„é»‘è‰²å åŠ ï¼Œæ¯”ç™½è‰²å åŠ æ›´æ²‰ç¨³ */
            background-color: rgba(0,0,0,0.15);
        }
        
        /* 2. è¡¨å¤´ GBF é£æ ¼å¢å¼º */
        .guide-table thead tr.top-row th {
            background: var(--bg-header) !important; /* èƒŒæ™¯æ”¹ä¸ºä¸è¡¨æ ¼å¤´éƒ¨ä¸€è‡´çš„æµ…ç°è‰² */
            color: var(--text-primary);              /* æ–‡å­—é¢œè‰²æ”¹ä¸ºæ·±è‰² */
            border-bottom: none !important;          /* å»æ‰åŸæœ¬æ¯è¡Œéƒ½æœ‰çš„è¾¹æ¡† */
            padding-top: 15px;                       /* å¢åŠ ä¸€ç‚¹é¡¶éƒ¨ç©ºé—´ */
        }
        
        /* ä¸“é—¨ç»™ç¬¬äºŒè¡Œï¼ˆçŠ¶æ€å›¾æ ‡è¡Œï¼‰åº•éƒ¨åŠ ä¸€æ¡é‡‘çº¿ï¼Œä½œä¸ºä¸æ­£æ–‡çš„åˆ†å‰² */
        .guide-table thead tr.top-row:nth-child(2) th {
            border-bottom: 3px solid #c2a05d !important; /* GBF é‡‘è‰²å®çº¿ */
            padding-bottom: 15px;
        }
        
        [data-theme="dark"] .guide-table thead tr.top-row th {
            background: var(--bg-header) !important; /* æš—è‰²æ¨¡å¼èƒŒæ™¯ */
            border-bottom: none !important;
        }
        
        /* æš—è‰²æ¨¡å¼ä¸‹çš„é‡‘çº¿è°ƒæ•´ */
        [data-theme="dark"] .guide-table thead tr.top-row:nth-child(2) th {
            border-bottom: 3px solid #8b7355 !important;
        }
        
        /* è§’è‰²æ å¤´éƒ¨æ ·å¼ */
        .character-header {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
            border-bottom: 2px solid #e0e4e8 !important;
            transition: all 0.3s ease;
        }
        
        .character-header:hover {
            background: linear-gradient(180deg, #fff 0%, #f5f7fa 100%) !important;
        }
        
        [data-theme="dark"] .character-header {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
            border-bottom: 2px solid #3a3a3a !important;
        }
        
        [data-theme="dark"] .character-header:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%) !important;
        }
        
        /* åæ’è§’è‰²ç‰¹æ®Šæ ·å¼ (5-6å·ä½ / I-Jåˆ—) */
        .character-header.back-row {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
            opacity: 0.85;
        }
        
        [data-theme="dark"] .character-header.back-row {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* [æ–°å¢] åæ’çš„åæ’æ ·å¼ (7-9å·ä½ / K-Måˆ—) - ä¸åæ’1-2ä¿æŒä¸€è‡´ */
        .character-header.back-row-2 {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
            opacity: 0.85;
        }
        
        [data-theme="dark"] .character-header.back-row-2 {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* 3. é˜¶æ®µæ˜¾ç¤ºä¼˜åŒ– - å·¦ä¾§è‰²æ¡é£æ ¼ */
        /* 100%-80% é˜¶æ®µ - çº¢è‰² */
        tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(255,107,107,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #ff6b6b !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03); /* å³ä¾§è½»å¾®é˜´å½±å¢åŠ å±‚æ¬¡æ„Ÿ */
            position: relative;
            z-index: 5;
        }
        tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] .phase-name {
            color: #d32f2f;
            font-weight: 600;
        }
        [data-theme="dark"] tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] {
            /* é™ä½é€æ˜åº¦åˆ° 0.05ï¼Œè®©å®ƒéšçº¦å¯è§ */
            background: linear-gradient(90deg, rgba(255,107,107,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] .phase-name {
            color: #ff8a80;
        }
        
        /* 80%-60% é˜¶æ®µ - æ©™è‰² */
        .phase-80-60 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(255,179,71,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #ffb347 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-80-60 td:first-child[rowspan] .phase-name {
            color: #e65100;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-80-60 td:first-child[rowspan] {
            /* é™ä½é€æ˜åº¦åˆ° 0.05 */
            background: linear-gradient(90deg, rgba(255,179,71,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-80-60 td:first-child[rowspan] .phase-name {
            color: #ffb74d;
        }
        
        /* 60%-20% é˜¶æ®µ - é»„è‰² */
        .phase-60-20 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(253,216,53,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #fdd835 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-60-20 td:first-child[rowspan] .phase-name {
            color: #f9a825;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-60-20 td:first-child[rowspan] {
            /* é™ä½é€æ˜åº¦åˆ° 0.05 */
            background: linear-gradient(90deg, rgba(253,216,53,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-60-20 td:first-child[rowspan] .phase-name {
            color: #ffee58;
        }
        
        /* 20%-0% é˜¶æ®µ - ç»¿è‰² */
        .phase-20-0 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(102,187,106,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #66bb6a !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-20-0 td:first-child[rowspan] .phase-name {
            color: #2e7d32;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-20-0 td:first-child[rowspan] {
            /* é™ä½é€æ˜åº¦åˆ° 0.05 */
            background: linear-gradient(90deg, rgba(102,187,106,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-20-0 td:first-child[rowspan] .phase-name {
            color: #81c784;
        }
        
        /* 4. å·¥å…·æ æ¯›ç»ç’ƒæ•ˆæœ */
        .toolbar {
            position: sticky;
            top: 10px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            z-index: 1000;
            border-radius: 16px;
            padding: 14px 20px;
        }
        
        [data-theme="dark"] .toolbar {
            background: rgba(30, 30, 30, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* 5. æŒ‰é’®è´¨æ„Ÿä¼˜åŒ– */
        .toolbar button {
            font-weight: 600;
            letter-spacing: 0.3px;
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 13px;
        }
        
        .toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® GBF é£æ ¼ */
        .theme-toggle {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid #c2a05d !important;
        }
        
        .theme-toggle:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4) !important;
        }
        
        /* 6. è¾“å…¥æ¡†ä¼˜åŒ– */
        .font-size-input,
        .char-add-modal input,
        .text-input-modal input {
            border: 2px solid #e0e4e8;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.25s ease;
        }
        
        .font-size-input:focus,
        .char-add-modal input:focus,
        .text-input-modal input:focus {
            background: #fff;
            border-color: #1d4585;
            box-shadow: 0 0 0 4px rgba(29, 69, 133, 0.15);
        }
        
        [data-theme="dark"] .font-size-input,
        [data-theme="dark"] .char-add-modal input,
        [data-theme="dark"] .text-input-modal input {
            border-color: #444;
            background: #2a2a2a;
        }
        
        [data-theme="dark"] .font-size-input:focus,
        [data-theme="dark"] .char-add-modal input:focus,
        [data-theme="dark"] .text-input-modal input:focus {
            border-color: #4a7ab8;
            box-shadow: 0 0 0 4px rgba(74, 122, 184, 0.2);
        }
        
        /* 7. ç©ºçŠ¶æ€æç¤ºä¼˜åŒ– - ä¸­é—´æŒ‰é’®å¸¸é©»ä¸”ç¾åŒ– */
        .empty-state-hint {
            opacity: 1 !important; /* å¼ºåˆ¶ä¸é€æ˜ï¼Œå¸¸é©»æ˜¾ç¤º */
            pointer-events: auto;  /* ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
            transition: opacity 0.3s ease;
        }
        
        /* ç¾åŒ–ä¸­é—´çš„ "WikiæŸ¥è¯¢/ç¼–é˜ŸæŸ¥è¯¢" æŒ‰é’® */
        .wiki-btn, .wiki-btn-small {
            /* ä½¿ç”¨ä¸é¡¶éƒ¨å·¥å…·æ ä¸€è‡´çš„æ·±è“æ¸å˜ */
            background: var(--btn-gradient) !important;
            color: #fff !important;
            border: none !important;
            border-radius: 20px !important; /* åœ†è§’èƒ¶å›Šæ ·å¼ */
            box-shadow: 0 4px 10px rgba(43, 88, 118, 0.2);
            font-weight: 500;
            padding: 6px 16px; /* ç¨å¾®åŠ å¤§ç‚¹å‡»åŒºåŸŸ */
            transition: all 0.2s;
        }
        .wiki-btn:hover, .wiki-btn-small:hover {
            background: var(--btn-gradient-hover) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(43, 88, 118, 0.4);
        }
        
        .character-header:hover .empty-state-hint,
        .source-cell:hover .empty-state-hint {
            opacity: 1;
        }
        
        .empty-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* 8. æ“ä½œæŒ‰é’®éšè—ä¼˜åŒ–å·²åœ¨ä¸Šæ–¹ç»Ÿä¸€å®šä¹‰ */
        
        /* 9. æ•°æ®å•å…ƒæ ¼æ‚¬åœæ•ˆæœä¼˜åŒ– - ç°ä»£æµ®èµ·å¡ç‰‡é£æ ¼ */
        .guide-table tbody tr:not(.add-phase-row) {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .guide-table tbody tr:not(.add-phase-row):hover {
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .guide-table tbody tr:not(.add-phase-row):hover td {
            background: var(--bg-table) !important;
            border-bottom-color: transparent !important;
        }
        
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover td {
            background: #2a2a2a !important;
        }
        
        /* 10. å¼¹çª—æ ·å¼ä¼˜åŒ– */
        .text-input-modal,
        .char-add-modal {
            border: 1px solid rgba(194, 160, 93, 0.3);
            box-shadow: 0 24px 64px rgba(0,0,0,0.15), 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .char-add-modal h3 {
            color: #1d4585;
            border-bottom: 2px solid #c2a05d;
        }
        
        [data-theme="dark"] .char-add-modal h3 {
            color: #7ba3d4;
            border-bottom-color: #8b7355;
        }
        
        /* 11. æ–°å¢é˜¶æ®µæŒ‰é’® GBF é£æ ¼ */
        .add-phase-btn {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid #c2a05d;
            box-shadow: 0 4px 12px rgba(29, 69, 133, 0.3);
        }
        
        .add-phase-btn:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 6px 20px rgba(29, 69, 133, 0.4);
        }
        
        /* 12. æŠ€èƒ½å›¾æ ‡æ‚¬åœæ•ˆæœä¼˜åŒ– */
        .skill-source:hover {
            transform: scale(1.12) translateY(-3px);
            box-shadow: 0 6px 16px rgba(29, 69, 133, 0.35);
        }
        
        /* 13. æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(29, 69, 133, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(29, 69, 133, 0.5);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* 14. çŠ¶æ€æ ä¼˜åŒ– */
        #statusBar {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%);
            border: 1px solid #c2a05d;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4);
        }
        
        /* 15. å³é”®èœå•ä¼˜åŒ– */
        .context-menu {
            border: 1px solid rgba(194, 160, 93, 0.2);
            box-shadow: 0 12px 32px rgba(0,0,0,0.12);
        }
        
        .context-menu-item:hover {
            background: rgba(29, 69, 133, 0.08);
        }
        
        [data-theme="dark"] .context-menu-item:hover {
            background: rgba(74, 122, 184, 0.15);
        }
        
        /* 16. å¤‡æ³¨å•å…ƒæ ¼ä¼˜åŒ– */
        .note-cell {
            background: transparent !important; /* ä¿®å¤ï¼šæ”¹ä¸ºé€æ˜ï¼Œä¸è¡¨æ ¼èƒŒæ™¯ä¸€è‡´ï¼Œæ¶ˆé™¤è‰²å·® */
            font-size: 12px;
        }
        
        /* ç™½è‰²ä¸»é¢˜ä¸‹å¶æ•°è¡Œçš„ note-cell ä¹Ÿè¦æœ‰æ–‘é©¬çº¹æ•ˆæœ */
        .guide-table tbody tr:nth-child(even):not(.add-phase-row) .note-cell {
            background-color: rgba(0,0,0,0.015) !important;
        }
        
        /* ä¿®æ”¹ï¼šæš—è‰²æ¨¡å¼ä¸‹å¤‡æ³¨æ ä¸è®¾ç½®ç‹¬ç«‹èƒŒæ™¯ï¼Œè®©å®ƒè·Ÿéšè¡Œçš„æ–‘é©¬çº¹ */
        [data-theme="dark"] .note-cell {
            background: none !important;
            background-color: transparent !important;
            border-left: 1px solid rgba(255,255,255,0.05); /* åŠ ä¸€æ¡ææ·¡çš„åˆ†å‰²çº¿å¢åŠ ç²¾è‡´æ„Ÿ */
        }
        
        /* ç¡®ä¿æš—è‰²æ¨¡å¼ä¸‹å¶æ•°è¡Œçš„ note-cell ä¹Ÿæœ‰æ­£ç¡®çš„èƒŒæ™¯ */
        [data-theme="dark"] .guide-table tbody tr:nth-child(even):not(.add-phase-row) .note-cell {
            background-color: rgba(0,0,0,0.15) !important;
        }
        
        /* ç¡®ä¿æ‚¬åœæ—¶ note-cell ä¹Ÿèƒ½æ­£ç¡®é«˜äº® */
        .guide-table tbody tr:not(.add-phase-row):hover .note-cell {
            background: rgba(29, 69, 133, 0.04) !important;
        }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover .note-cell {
            background: rgba(74, 122, 184, 0.08) !important;
        }
        
        /* 17. è§’è‰²åç§°æ ·å¼ä¼˜åŒ– */
        .char-name {
            font-weight: 500;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        /* 18. Wiki æŒ‰é’® GBF é£æ ¼ */
        .wiki-btn,
        .wiki-btn-small {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid rgba(194, 160, 93, 0.5);
            position: relative;
        }
        
        .wiki-btn:hover,
        .wiki-btn-small:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4) !important;
        }
        
        /* Wiki æŒ‰é’®æ‚¬åœæç¤º - åªç»™å¸¦ wiki-warning ç±»çš„æŒ‰é’®æ˜¾ç¤ºè­¦å‘Š */
        .wiki-btn.wiki-warning::after,
        .wiki-btn-small.wiki-warning::after {
            content: 'âš ï¸ Wikiå›¾ç‰‡å¯èƒ½å¯¼è‡´å¯¼å‡ºç©ºç™½';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #ffcc00;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10002;
        }
        
        .wiki-btn.wiki-warning:hover::after,
        .wiki-btn-small.wiki-warning:hover::after {
            opacity: 1;
        }
        
        /* 19. ç¡®è®¤æŒ‰é’®ä¿æŒç»¿è‰² */
        .btn-primary,
        .char-add-modal .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%) !important;
        }
        
        /* 20. æºå•å…ƒæ ¼ï¼ˆå¬å”¤çŸ³/æŠ€èƒ½æºï¼‰æ ·å¼ä¼˜åŒ– - åˆ†ç»„ç€è‰² */
        /* åŸºç¡€é‡ç½®ï¼šå»é™¤æ—§çš„è“è‰²èƒŒæ™¯ */
        .source-cell {
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color) !important; /* åº•éƒ¨åŠ ç²—çº¿ï¼ŒåŒºåˆ†æ­£æ–‡ */
        }
        
        /* === Group 1: å¬å”¤çŸ³åŒºåŸŸ (A-D åˆ— / å‰3ä¸ªtdï¼Œç¬¬1ä¸ªæœ‰colspan=2) === */
        /* è·Ÿéšå·¦ä¾§åŸºç¡€è¡¨å¤´é¢œè‰² */
        .skill-source-row .source-cell:nth-child(1),
        .skill-source-row .source-cell:nth-child(2),
        .skill-source-row .source-cell:nth-child(3) {
            background: var(--bg-header) !important;
        }
        
        /* === Group 2: å‰æ’è§’è‰²æŠ€èƒ½ (E-H åˆ— / ä¸­é—´4ä¸ªtd) === */
        /* è·Ÿéšå‰æ’è§’è‰²è¡¨å¤´ (.character-header) */
        .skill-source-row .source-cell:nth-child(4),
        .skill-source-row .source-cell:nth-child(5),
        .skill-source-row .source-cell:nth-child(6),
        .skill-source-row .source-cell:nth-child(7) {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
        }
        
        /* === Group 3: åæ’è§’è‰²æŠ€èƒ½ (I-J åˆ—) === */
        /* è·Ÿéšåæ’è§’è‰²è¡¨å¤´ (.character-header.back-row) */
        .skill-source-row .source-cell:nth-child(8),
        .skill-source-row .source-cell:nth-child(9) {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
        }
        
        /* [æ–°å¢] === Group 4: åæ’çš„åæ’æŠ€èƒ½ (K-M åˆ— / 9äººæ¨¡å¼) === */
        /* ä¸ Group 3 ä¿æŒä¸€è‡´ */
        .skill-source-row .source-cell:nth-child(10),
        .skill-source-row .source-cell:nth-child(11),
        .skill-source-row .source-cell:nth-child(12) {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
        }
        
        /* ====== æš—è‰²æ¨¡å¼ (Dark Mode) é€‚é… ====== */
        [data-theme="dark"] .source-cell {
            color: var(--text-on-dark);
        }
        
        /* Dark Group 1 */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(1),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(2),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(3) {
            background: var(--bg-header) !important;
        }
        
        /* Dark Group 2 - æ·±ç°æ¸å˜ */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(4),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(5),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(6),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(7) {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
        }
        
        /* Dark Group 3 - æ›´æ·±çš„ç°æ¸å˜ */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(8),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(9) {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* [æ–°å¢] Dark Group 4 - ä¸ Dark Group 3 ä¿æŒä¸€è‡´ (9äººæ¨¡å¼) */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(10),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(11),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(12) {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* ========== [é‡æ„] æ¢äººè¡Œæ ·å¼ (ä¸é¡¶éƒ¨ä¸€è‡´) ========== */
        /* 1. æ¢äººè¡Œå¤´éƒ¨ (Header Row) */
        .swap-header-row td,
        .swap-header-row td.character-header,
        .swap-header-row td,
        .swap-header-row th {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
            border-top: 2px solid #c2a05d !important; /* é‡‘è‰²åˆ†å‰²çº¿ */
            border-bottom: 1px solid var(--border-color) !important;
            position: relative;
            padding: 8px 4px !important;
        }
        [data-theme="dark"] .swap-header-row td.character-header,
        [data-theme="dark"] .swap-header-row td,
        [data-theme="dark"] .swap-header-row th {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
            border-top-color: #8b7355 !important;
        }
        
        /* 2. æ¢äººè¡Œå·¦ä¾§æ ‡ç­¾æ ¼ (A-Dåˆ—) - ç®€çº¦é£æ ¼ */
        .swap-header-row .swap-label-cell {
            background: var(--bg-header) !important;
            color: var(--text-secondary);
            font-size: 12px;
            vertical-align: middle;
            text-align: center;
            border-right: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .swap-header-row .swap-label-cell {
            background: #252525 !important;
            color: #888;
        }
        
        /* 3. æ¢äººè¡Œåˆ é™¤æŒ‰é’® - ç®€æ´åœ†å½¢ */
        .swap-delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-top: 4px;
            background: transparent;
            color: #ff5252;
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s;
        }
        .swap-delete-btn:hover {
            background: #ff5252;
            color: white;
            transform: scale(1.1);
        }
        
        /* 4. æ¢äººè¡Œè§’è‰²æ ¼ */
        .swap-header-row .swap-char-cell {
            min-width: 110px;
            min-height: 180px;
            height: 180px;
            padding: 10px 4px 28px 4px !important;
            vertical-align: middle;
            position: relative;
        }
        .swap-header-row .swap-char-cell img {
            width: auto;
            height: auto;
            max-height: 130px;
            max-width: 100%;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }
        .swap-header-row .swap-char-cell .char-name {
            font-size: 12px;
            color: var(--text-primary);
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
        }
        
        /* 5. æ¢äººè¡ŒæŠ€èƒ½æº (Source Row) */
        .swap-source-row .source-cell {
            position: static !important;
            background-color: #fafafa !important;
            border-bottom: 2px solid var(--border-color) !important;
            box-shadow: none !important;
        }
        [data-theme="dark"] .swap-source-row .source-cell {
            background-color: #1e1e1e !important;
            border-bottom-color: #444 !important;
        }
        
        /* 6. æ‹–æ‹½é«˜äº® */
        .swap-source-row .source-cell.drag-feedback,
        .swap-header-row .swap-char-cell.drag-feedback {
            background-color: rgba(33, 150, 243, 0.15) !important;
            box-shadow: inset 0 0 0 2px #2196f3 !important;
            z-index: 10;
        }
        
        /* å¯¼å‡ºå›¾ç‰‡æ—¶éšè—æ¢äººè¡Œçš„åˆ é™¤æŒ‰é’® */
        .exporting .swap-delete-btn {
            display: none !important;
        }

        /* ========== ä¼˜åŒ–: æ‹–æ‹½åé¦ˆä¸ç©ºæ§½ä½è´¨æ„Ÿ ========== */
        /* 1. æ‹–æ‹½æ—¶çš„åŠ¨æ€é«˜äº®åé¦ˆ (Active Drop Zone) */
        .drag-feedback {
            background-color: rgba(33, 150, 243, 0.15) !important;
            box-shadow: inset 0 0 0 2px #2196f3 !important;
            transition: all 0.1s;
        }
        
        /* 2. ç©ºæ§½ä½çš„"å®¹å™¨å‡¹é™·"è´¨æ„Ÿ */
        /* [ä¿®æ”¹] å¢åŠ é€‰æ‹©å™¨æƒé‡ï¼Œç¡®ä¿ç©ºçŠ¶æ€å›¾æ ‡èƒ½æ˜¾ç¤ºåœ¨åæ’èƒŒæ™¯ä¹‹ä¸Š */
        .character-header.has-empty-state,
        .character-header.back-row.has-empty-state,
        .character-header.back-row-2.has-empty-state,
        .source-cell.has-empty-state {
            background: rgba(0, 0, 0, 0.03) !important;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.06);
            border-radius: 8px;
        }
        
        /* æš—è‰²æ¨¡å¼ä¸‹çš„å‡¹é™·è´¨æ„Ÿé€‚é… */
        [data-theme="dark"] .character-header.has-empty-state,
        [data-theme="dark"] .character-header.back-row.has-empty-state,
        [data-theme="dark"] .character-header.back-row-2.has-empty-state,
        [data-theme="dark"] .source-cell.has-empty-state {
            background: rgba(0, 0, 0, 0.25) !important;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* ========== ğŸ‘» å¹½çµå›¾æ ‡ç³»ç»Ÿï¼šIåˆ—è¡Œæ§é¢æ¿ (Ghost Icon) ========== */
        
        /* 1. é¢æ¿å®¹å™¨ï¼šå±…ä¸­å®šä½ï¼Œå§‹ç»ˆå¯è§ä½†é€æ˜åº¦æ¸å˜ */
        .note-cell { position: relative; }
        .note-cell-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 0;
            z-index: 100;
            /* ğŸ‘» å¹½çµæ¨¡å¼ï¼šé»˜è®¤ææ·¡ï¼Œå§‹ç»ˆå­˜åœ¨ */
            opacity: 0.12;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            /* èƒ¶å›ŠèƒŒæ™¯ - é»˜è®¤ä¹Ÿæ˜¯åŠé€æ˜ */
            background: rgba(255, 255, 255, 0.6);
            padding: 4px;
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.03);
            pointer-events: auto; /* å§‹ç»ˆå¯ç‚¹å‡» */
        }

        /* 2. è¡Œæ‚¬åœï¼šæ•´è¡Œæ‚¬åœæ—¶æŒ‰é’®å˜æ˜æ˜¾ */
        .guide-table tbody tr:not(.add-phase-row):not(.swap-header-row):not(.swap-data-row):hover .note-cell-controls {
            opacity: 0.55;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* 3. å•å…ƒæ ¼æ‚¬åœï¼šè¿›ä¸€æ­¥å¢å¼º */
        .note-cell:hover .note-cell-controls {
            opacity: 0.75;
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translate(-50%, -50%) scale(1.08);
        }

        /* 4. æŒ‰é’®æ ·å¼ï¼šä½¿ç”¨ SVG å›¾æ ‡ */
        .row-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: #555;
            padding: 6px;
            position: relative;
        }

        .row-action-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
            display: block;
        }

        /* 5. æŒ‰é’®æ‚¬åœï¼šå®Œå…¨é«˜äº® + å‘å…‰æ•ˆæœ */
        .row-action-btn:hover {
            background: rgba(0,0,0,0.08);
            transform: scale(1.15);
        }
        
        /* å½“æŒ‰é’®è¢«æ‚¬åœæ—¶ï¼Œå¼ºåˆ¶é¢æ¿å®Œå…¨æ˜¾ç¤º */
        .note-cell-controls:hover {
            opacity: 1 !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
            transform: translate(-50%, -50%) scale(1.1) !important;
        }

        /* é¢œè‰²åŒºåˆ† */
        .row-action-btn.merge { color: #4caf50; }
        .row-action-btn.split { color: #ff9800; }
        
        /* æŒ‰é’®æ‚¬åœæ—¶çš„å‘å…‰æ•ˆæœ */
        .row-action-btn.merge:hover { 
            color: #2e7d32;
            box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
        }
        .row-action-btn.split:hover { 
            color: #e65100;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.4);
        }

        /* æ–‡å­—æç¤º Tooltip */
        .row-action-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 8px;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* ========== æš—è‰²æ¨¡å¼é€‚é… ========== */
        [data-theme="dark"] .note-cell-controls { 
            background: rgba(50, 50, 50, 0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            opacity: 0.15; /* æš—è‰²æ¨¡å¼ç¨å¾®äº®ä¸€ç‚¹ */
        }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):not(.swap-header-row):not(.swap-data-row):hover .note-cell-controls {
            opacity: 0.6;
            background: rgba(60, 60, 60, 0.9);
        }
        [data-theme="dark"] .note-cell:hover .note-cell-controls {
            opacity: 0.8;
            background: rgba(70, 70, 70, 0.95);
        }
        [data-theme="dark"] .note-cell-controls:hover {
            opacity: 1 !important;
            background: rgba(80, 80, 80, 0.98) !important;
        }
        [data-theme="dark"] .row-action-btn { color: #aaa; }
        [data-theme="dark"] .row-action-btn:hover { background: rgba(255,255,255,0.1); }
        [data-theme="dark"] .row-action-btn.merge { color: #81c784; }
        [data-theme="dark"] .row-action-btn.split { color: #ffb74d; }
        [data-theme="dark"] .row-action-btn.merge:hover { 
            color: #a5d6a7;
            box-shadow: 0 0 12px rgba(129, 199, 132, 0.4);
        }
        [data-theme="dark"] .row-action-btn.split:hover { 
            color: #ffcc80;
            box-shadow: 0 0 12px rgba(255, 183, 77, 0.4);
        }

        /* ========== ğŸš€ æ–°ç‰ˆæ‚¬æµ®æ§åˆ¶å° (Toolbar Refactoring) ========== */
        .toolbar-console {
            position: sticky;
            top: 15px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            margin: 0 auto 25px;
            max-width: 1800px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        [data-theme="dark"] .toolbar-console {
            background: rgba(30, 32, 38, 0.85);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* å³ä¾§å·¥å…·ç»„ - è‡ªåŠ¨é å³ */
        .toolbar-group-end {
            margin-left: auto;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.1), transparent);
            margin: 0 12px;
        }
        [data-theme="dark"] .toolbar-divider {
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2), transparent);
        }

        .t-btn {
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-family: inherit;
            position: relative;
            outline: none;
        }
        .t-btn:active { transform: scale(0.96); }

        .t-btn-icon {
            width: 36px;
            height: 36px;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
        }
        .t-btn-icon:hover {
            background: rgba(0,0,0,0.05);
            color: #2196f3;
        }
        [data-theme="dark"] .t-btn-icon:hover { background: rgba(255,255,255,0.1); }

        .t-btn-ghost {
            background: transparent;
            border: 1px solid rgba(0,0,0,0.1);
            color: var(--text-secondary);
            padding: 6px 14px;
            font-size: 13px;
            gap: 6px;
        }
        .t-btn-ghost:hover {
            border-color: #2196f3;
            color: #2196f3;
            background: rgba(33, 150, 243, 0.05);
        }
        [data-theme="dark"] .t-btn-ghost { border-color: rgba(255,255,255,0.2); }
        [data-theme="dark"] .t-btn-ghost:hover { border-color: #64b5f6; color: #64b5f6; }

        .t-btn-primary {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%);
            color: white;
            padding: 8px 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(43, 88, 118, 0.3);
            gap: 8px;
        }
        .t-btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(43, 88, 118, 0.4);
        }

        .toolbar-input-group {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
            padding: 2px 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .toolbar-input-group { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .mini-label { font-size: 11px; color: var(--text-coord); margin-right: 4px; }
        .t-input {
            width: 36px;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 13px;
            padding: 4px 0;
        }
        .t-input:focus { outline: none; color: #2196f3; }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            text-align: center;
            pointer-events: none;
            animation: fadeInTooltip 0.2s;
            z-index: 1001;
        }
        @keyframes fadeInTooltip { from { opacity: 0; transform: translate(-50%, 5px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* ========== ç´ æç½‘ç«™ä¸‹æ‹‰èœå• (Resource Dropdown) ========== */
        .resource-dropdown {
            position: relative;
            display: inline-block;
        }
        .resource-dropdown .t-btn .arrow {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.6;
            transition: transform 0.2s;
        }
        .resource-dropdown.active .t-btn .arrow {
            transform: rotate(180deg);
        }
        .resource-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;
            padding: 8px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1002;
        }
        .resource-dropdown:hover .resource-dropdown-menu,
        .resource-dropdown.active .resource-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        [data-theme="dark"] .resource-dropdown-menu {
            background: rgba(30, 32, 38, 0.95);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .resource-dropdown-item {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-primary);
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .resource-dropdown-item:hover {
            background: rgba(var(--beam-skill-color), 0.08);
            border-left-color: rgb(var(--beam-skill-color));
        }
        .resource-dropdown-item .item-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .resource-dropdown-item .item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }
        .resource-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 12px;
            opacity: 0.5;
        }
        /* è­¦å‘Šé¡¹æ ·å¼ (ç°æœºWiki) */
        .resource-dropdown-item.warning-item .item-title {
            color: #ff9800;
        }
        .resource-dropdown-item.warning-item .item-desc {
            color: #ef5350;
        }
        .resource-dropdown-item.warning-item:hover {
            background: rgba(255, 152, 0, 0.08);
            border-left-color: #ff9800;
        }
        .warn-badge {
            font-size: 12px;
        }
        /* æ¨èæ ‡ç­¾ */
        .recommend-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(var(--beam-summon-color), 0.15);
            color: rgb(var(--beam-summon-color));
            border-radius: 4px;
            font-weight: 500;
        }

        /* ========== è§’è‰²å¡ç‰‡ UI å‡çº§ (Character Card Upgrade) ========== */
        /* 1. å¡ç‰‡å®¹å™¨ï¼šå¢åŠ æº¢å‡ºéšè—ï¼Œä¸ºäº†å›¾ç‰‡çš„æ”¾å¤§æ•ˆæœä¸è¶…å‡ºå» */
        .character-header {
            position: relative;
            overflow: hidden; /* å…³é”®ï¼šé™åˆ¶å†…éƒ¨å…ƒç´ æº¢å‡º */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 2. å›¾ç‰‡äº¤äº’ï¼šæ‚¬åœæ—¶è½»å¾®æ”¾å¤§ + ç¨å¾®å˜æš— (æå‡æ–‡å­—å¯è¯»æ€§) */
        .character-header img {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s;
            transform-origin: center center;
        }
        .character-header:hover img {
            transform: scale(1.08); /* æ‚¬åœæ”¾å¤§ */
            filter: brightness(0.9); /* ç¨å¾®å˜æš— */
        }

        /* 3. æ–°ç‰ˆç¼–è¾‘æŒ‰é’®ï¼šæ¯›ç»ç’ƒåœ†å½¢æŒ‰é’® */
        .btn-edit-glass {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* ç»ç’ƒè´¨æ„Ÿ */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            /* å¸ƒå±€ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1d4585; /* GBF æ·±è“ */
            cursor: pointer;
            z-index: 20;
            /* é»˜è®¤éšè—çŠ¶æ€ï¼šä¸Šç§» + é€æ˜ */
            opacity: 0;
            transform: translateY(-10px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§åŠ¨ç”» */
        }

        /* æ‚¬åœå¡ç‰‡æ—¶ï¼šæŒ‰é’®æµ®ç° */
        .character-header:hover .btn-edit-glass {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* æŒ‰é’®è‡ªèº«æ‚¬åœï¼šå˜å¤§å˜è“ */
        .btn-edit-glass:hover {
            background: #fff;
            color: #2196f3;
            transform: translateY(0) scale(1.15) !important;
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3);
        }

        /* ç‚¹å‡»åé¦ˆ */
        .btn-edit-glass:active {
            transform: translateY(0) scale(0.95) !important;
        }

        /* æš—è‰²æ¨¡å¼é€‚é… */
        [data-theme="dark"] .btn-edit-glass {
            background: rgba(40, 40, 40, 0.85);
            border-color: rgba(255,255,255,0.1);
            color: #90caf9;
        }
        [data-theme="dark"] .btn-edit-glass:hover {
            background: #333;
            color: #fff;
        }

        /* ========== BOSSé€‰æ‹©å¼¹çª—æ ·å¼ (ç°ä»£ WebApp é£æ ¼) ========== */
        .boss-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ç°ä»£æ¯›ç»ç’ƒé®ç½© */
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10000;
            /* é»˜è®¤éšè—çŠ¶æ€ */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            /* æŸ”å’Œçš„è¿‡æ¸¡æ•ˆæœ */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* æ¿€æ´»çŠ¶æ€ */
        .boss-select-modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .boss-select-content {
            background: var(--bg-modal);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            /* æ›´åŠ æŸ”å’Œæ·±é‚ƒçš„é˜´å½± */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* åˆå§‹ç¼©æ”¾çŠ¶æ€ */
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        /* å†…å®¹æ¿€æ´»çŠ¶æ€ */
        .boss-select-modal.active .boss-select-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .boss-select-title {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .boss-select-hint {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .boss-select-grid {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        .boss-option {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            border-radius: 16px;
            padding: 12px;
        }
        .boss-option:hover {
            background: rgba(33, 150, 243, 0.05);
            transform: translateY(-6px);
        }
        .boss-option:active {
            transform: scale(0.97);
        }
        .boss-img-wrapper {
            width: 240px;
            height: 150px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-table);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        /* 9äººæ¨¡å¼ (æå¦ˆ/Versusia) - çŒ©çº¢å…‰æ™• */
        .boss-option.option-9man:hover .boss-img-wrapper {
            border-color: #ff5252;
            box-shadow: 0 12px 30px rgba(255, 82, 82, 0.35);
            transform: scale(1.02);
        }
        /* 6äººæ¨¡å¼ (ææ³•/Lucilius) - æ¹›è“å…‰æ™• */
        .boss-option.option-6man:hover .boss-img-wrapper {
            border-color: #2196f3;
            box-shadow: 0 12px 30px rgba(33, 150, 243, 0.35);
            transform: scale(1.02);
        }
        .boss-img-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .boss-option-label {
            margin-top: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .boss-select-cancel {
            display: block;
            margin: 24px auto 0;
            padding: 10px 32px;
            background: #616161;
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .boss-select-cancel:hover {
            background: #757575;
            transform: translateY(-1px);
        }
        
        /* ========== åˆ†äº«ä»£ç å¼¹çª—ä¸“ç”¨æ ·å¼ ========== */
        
        /* åˆ†äº«å¼¹çª—å³ä¸Šè§’å…³é—­æŒ‰é’® - ç°ä»£ WebApp é£æ ¼ */
        .share-modal-close-x {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #999;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            padding: 0;
        }
        
        /* æ‚¬åœ/ç‚¹å‡»æ•ˆæœ - å¢å¼ºç‰ˆçŠç‘šçº¢é«˜äº® */
        .share-modal-close-x:hover {
            background-color: #ff4757; /* é²œè‰³çš„çŠç‘šçº¢ */
            color: #ffffff;            /* å›¾æ ‡å˜çº¯ç™½ï¼Œé«˜å¯¹æ¯” */
            transform: rotate(90deg);  /* ä¼˜é›…çš„æ—‹è½¬åŠ¨ç”» */
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4); /* çº¢è‰²è¾‰å…‰æŠ•å½± */
        }
        
        .share-modal-close-x:active {
            transform: rotate(90deg) scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5);
        }
        
        /* æš—è‰²æ¨¡å¼é€‚é… */
        [data-theme="dark"] .share-modal-close-x {
            color: #aaa;
        }
        
        [data-theme="dark"] .share-modal-close-x:hover {
            background-color: #ff6b81; /* æš—è‰²æ¨¡å¼ä¸‹çš„æŸ”å’Œç²‰çº¢ */
            color: #fff;
            box-shadow: 0 4px 12px rgba(255, 107, 129, 0.4); /* ç²‰çº¢è¾‰å…‰ */
        }
        
        [data-theme="dark"] .share-modal-close-x:active {
            box-shadow: 0 2px 8px rgba(255, 107, 129, 0.5);
        }
        
        .share-code-textarea {
            width: 100%;
            height: 160px;
            margin: 10px 0 20px 0;
            padding: 14px;
            background: var(--bg-table);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: all 0.2s ease;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
        }
        .share-code-textarea:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.15);
            background: var(--bg-table);
        }
        [data-theme="dark"] .share-code-textarea {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.1);
        }
        [data-theme="dark"] .share-code-textarea:focus {
            border-color: #4a7ab8;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Toast æç¤ºæ ·å¼ */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-modal);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 10003;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid #2196f3;
        }
        .toast-notification.success {
            border-left-color: #4caf50;
        }
        .toast-notification.error {
            border-left-color: #f44336;
        }
        .toast-notification.loading {
            border-left-color: #ff9800;
        }
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        .toast-notification.hiding {
            animation: toastSlideOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="statusBar">æ‹–æ‹½ä¸­...æ¾å¼€æ”¾ç½®</div>
    <div id="floatingIcon"></div>
    <div class="toolbar-console">
        <div class="toolbar-group">
            <button class="t-btn t-btn-icon" onclick="toggleTheme()" data-tooltip="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button class="t-btn t-btn-icon" id="btnCoordToggle" onclick="toggleCoords()" data-tooltip="æ˜¾ç¤º/éšè—åæ ‡">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
            </button>
            <div class="toolbar-divider"></div>
            <div class="toolbar-input-group" data-tooltip="é»˜è®¤å­—å· (px)">
                <span class="mini-label">Aa</span>
                <input type="number" id="defaultFontSize" class="t-input" value="11" min="10" max="24" onchange="saveDefaultFontSize()">
            </div>
            <div class="toolbar-input-group" data-tooltip="å›¾æ ‡ç¼©æ”¾ (10=100%)">
                <span class="mini-label">ğŸ”</span>
                <input type="number" id="iconScale" class="t-input" value="10" min="5" max="20" onchange="saveIconScale()">
            </div>
        </div>
        <div class="toolbar-group">
            <!-- BOSSæ¨¡æ¿é€‰æ‹©æŒ‰é’® -->
            <button class="t-btn t-btn-ghost" onclick="showBossSelectModal()" data-tooltip="åˆ‡æ¢å‰¯æœ¬æ¨¡å¼ (9äºº/6äºº)">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg>BOSSæ¨¡æ¿
            </button>
            <button class="t-btn t-btn-ghost" id="btnAddSwapRow" onclick="insertSwapRow()" data-tooltip="åœ¨åº•éƒ¨å¢åŠ æ¢äººè¡Œ">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>å¢åŠ æ¢äººè¡Œ
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" id="btnReset" onclick="resetData()" data-tooltip="é‡ç½®ä¸ºå½“å‰æ¨¡å¼é»˜è®¤çŠ¶æ€">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 2v6h6M21.5 22v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.3"/></svg>é‡ç½®
            </button>
            <button class="t-btn t-btn-ghost" onclick="clearAll()" data-tooltip="æ¸…ç©ºæ‰€æœ‰å·²æ”¾ç½®çš„æŠ€èƒ½å›¾æ ‡">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>æ¸…ç©ºæŠ€èƒ½
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" onclick="loadConfig()" data-tooltip="åŠ è½½ä¿å­˜å¸ƒå±€">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>åŠ è½½é…ç½®
            </button>
            <button class="t-btn t-btn-ghost" onclick="saveAsDefault()" data-tooltip="ä¿å­˜å½“å‰å¸ƒå±€">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>ä¿å­˜é…ç½®
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" onclick="exportJSON()" data-tooltip="å¯¼å‡ºé…ç½® JSON">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>å¯¼å‡º
            </button>
            <button class="t-btn t-btn-ghost" onclick="openShareModal()" data-tooltip="ç”Ÿæˆ/å¯¼å…¥åˆ†äº«ä»£ç  (Gzipå‹ç¼©)">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>åˆ†äº«ä»£ç 
            </button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
            <button class="t-btn t-btn-ghost" onclick="document.getElementById('importFile').click()" data-tooltip="å¯¼å…¥é…ç½® JSON">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>å¯¼å…¥
            </button>
        </div>
        <div class="toolbar-group toolbar-group-end">
            <!-- ç´ æç½‘ç«™ä¸‹æ‹‰èœå• -->
            <div class="resource-dropdown" id="resourceDropdown">
                <button class="t-btn t-btn-ghost" onclick="toggleResourceDropdown(event)">
                    <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><line x1="12" y1="6" x2="12" y2="10"></line><line x1="12" y1="14" x2="12.01" y2="14"></line></svg>
                    ç´ æç½‘ç«™
                    <span class="arrow">â–¼</span>
                </button>
                <div class="resource-dropdown-menu">
                    <a href="https://gbf.wiki/" target="_blank" class="resource-dropdown-item">
                        <div class="item-title">
                            GBF Wiki (English)
                            <span class="recommend-badge">æ¨è</span>
                        </div>
                        <div class="item-desc">âœ… å›¾ç‰‡å¯ç›´æ¥å¯¼å‡ºï¼Œèµ„æ–™å…¨é¢</div>
                    </a>
                    <a href="https://mizagbf.github.io/GBFAL/" target="_blank" class="resource-dropdown-item">
                        <div class="item-title">
                            GBFAL (Asset Library)
                            <span class="recommend-badge">æ¨è</span>
                        </div>
                        <div class="item-desc">âœ… çº¯å‡€ç´ æåº“ï¼Œæ”¯æŒæœç´¢ä¸‹è½½</div>
                    </a>
                    <div class="resource-dropdown-divider"></div>
                    <a href="https://gbf.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5" target="_blank" class="resource-dropdown-item warning-item">
                        <div class="item-title">
                            ç°æœº Wiki (ä¸­æ–‡)
                            <span class="warn-badge">âš ï¸</span>
                        </div>
                        <div class="item-desc">âŒ è·¨åŸŸé™åˆ¶ï¼Œå›¾ç‰‡æ— æ³•ç›´æ¥å¯¼å‡º<br>è¯·å…ˆä¿å­˜å›¾ç‰‡å†ä¸Šä¼ ä½¿ç”¨</div>
                    </a>
                </div>
            </div>
            <button class="t-btn t-btn-primary" onclick="exportAsImage()" data-tooltip="âš ï¸ Wiki/å¤–ç½‘å›¾ç‰‡å¯èƒ½å¯¼å‡ºç©ºç™½ï¼Œå»ºè®®æˆªå›¾">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                å¯¼å‡ºå›¾ç‰‡
            </button>
            <!-- åˆ›ä½œè€…å¾½ç«  -->
            <div class="author-badge" id="authorBadge" onclick="openAuthorModal()" data-tooltip="ç‚¹å‡»ç¼–è¾‘åˆ›ä½œè€…ä¿¡æ¯">
                <span class="author-icon">âœ</span>
                <span id="currentAuthorDisplay">è®¿å®¢</span>
            </div>
        </div>
    </div>
    
    <!-- åˆ›ä½œè€…å¼¹çª— -->
    <div id="authorModal" class="author-modal-overlay" onclick="closeAuthorModal(event)">
        <div class="author-card" onclick="event.stopPropagation()">
            <div class="author-card-header">
                <h3>ğŸ“ åˆ›ä½œè€…ä¿¡æ¯</h3>
                <button class="close-btn" onclick="closeAuthorModal(null)">Ã—</button>
            </div>
            <div class="author-history-section">
                <p class="section-label">å†å²è´¡çŒ®è€…</p>
                <div id="authorHistoryList" class="history-list">
                    <div class="empty-history">æš‚æ— å†å²ç¼–è¾‘è®°å½•</div>
                </div>
            </div>
            <div class="current-author-section">
                <p class="section-label">å½“å‰ç¼–è¾‘è€…</p>
                <div class="author-input-wrapper">
                    <input type="text" id="authorInput" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" maxlength="20" oninput="updateCurrentAuthor(this.value)">
                </div>
                <p class="input-hint">æ‚¨çš„ç½²åå°†åœ¨å¯¼å‡ºæ—¶è‡ªåŠ¨è®°å½•åˆ°å†å²åˆ—è¡¨ä¸­ã€‚</p>
            </div>
        </div>
    </div>
    <div class="table-wrapper">
    <table class="guide-table" id="guideTable">
    <thead>
        <tr class="top-row has-fab"><th colspan="10" style="padding:10px;position:relative;"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" style="max-width:100%;height:auto;"><button class="mini-fab edit" onclick="showQuickAddBoss(this)"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button></th></tr>
        <tr class="top-row has-fab"><th colspan="10" style="padding:8px;position:relative;min-height:50px;"><span class="skill-box skill-source"><img src="https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png" style="width:33px;height:33px;"></span><button class="mini-fab edit" onclick="showQuickAddStatus(this)"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button></th></tr>
        <tr>
            <th><span class="coord-header">(0,A)</span><br><span class="header-text t-text">é˜¶æ®µ</span></th>
            <th><span class="coord-header">(0,B)</span><br><span class="header-text t-text">å›åˆ/ç‰¹åŠ¨</span></th>
            <th><span class="coord-header">(0,C)</span><br><span class="header-text t-text">å¤‡æ³¨</span></th>
            <th><span class="coord-header">(0,D)</span><br><span class="header-text t-text">å¬å”¤çŸ³</span></th>
            <th class="character-header has-fab"><span class="coord-header">(0,E)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">ä¸»è§’</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            <th class="character-header has-fab"><span class="coord-header">(0,F)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">2å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            <th class="character-header has-fab"><span class="coord-header">(0,G)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">3å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            <th class="character-header has-fab"><span class="coord-header">(0,H)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">4å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            <th class="character-header back-row has-fab"><span class="coord-header">(0,I)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="display:none"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">åæ’1</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            <th class="character-header back-row has-fab"><span class="coord-header">(0,J)</span><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="display:none"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">åæ’2</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="ç¼–è¾‘è§’è‰²"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
        </tr>
        <tr class="skill-source-row">
            <td colspan="2" class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,A-B)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest('.source-cell'))"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button></td>
            <td class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,C)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest('.source-cell'))"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button></td>
            <td class="source-cell"><span class="coord">(1,D)</span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span></td>
            <td class="source-cell"><span class="coord">(1,E)</span></td>
            <td class="source-cell"><span class="coord">(1,F)</span></td>
            <td class="source-cell"><span class="coord">(1,G)</span></td>
            <td class="source-cell"><span class="coord">(1,H)</span></td>
            <td class="source-cell"><span class="coord">(1,I)</span></td>
            <td class="source-cell"><span class="coord">(1,J)</span></td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan="1"><span class="coord">(2,A)</span><span class="t-text phase-name" contenteditable="true" onblur="GBFGuide.Storage.save()">100%-?</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)">âˆ’</button><button class="phase-btn" onclick="insertPhaseBelow(this)">+</button></div></td>
            <td><span class="coord">(2,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">1T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
            <td class="data-cell"><span class="coord">(2,C)</span></td>
            <td><span class="coord">(2,D)</span></td>
            <td class="data-cell"><span class="coord">(2,E)</span></td>
            <td class="data-cell"><span class="coord">(2,F)</span></td>
            <td class="data-cell"><span class="coord">(2,G)</span></td>
            <td class="data-cell"><span class="coord">(2,H)</span></td>
            <td class="note-cell"><span class="coord">(2,I)</span></td>
            <td class="note-cell"><span class="coord">(2,J)</span></td>
        </tr>
    </tbody>
    </table>

    </div><!-- .table-wrapper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script>
        // ========== GBFGuide å‘½åç©ºé—´ ==========
        /**
         * GBF æ”»ç•¥æ¨¡æ¿åº”ç”¨ä¸»å‘½åç©ºé—´
         * @namespace GBFGuide
         */
        var GBFGuide = window.GBFGuide || {};
        
        // ========== é…ç½®å¸¸é‡æ¨¡å— ==========
        /**
         * å…¨å±€é…ç½®å¸¸é‡
         * @namespace GBFGuide.Config
         */
        GBFGuide.Config = {
            // ç‰ˆæœ¬å·
            DATA_VERSION: 4,
            
            // å­˜å‚¨é”®
            STORAGE_KEY: 'gbf_guide_data',
            THEME_KEY: 'gbf_guide_theme',
            AUTHOR_KEY: 'gbf_guide_author',
            
            // å°ºå¯¸å¸¸é‡
            ICON_SIZE: {
                BASE: 40,              // åŸºç¡€å›¾æ ‡å°ºå¯¸
                SKILL_BOX: 44,         // æŠ€èƒ½æ¡†å°ºå¯¸
                SUMMON_MAX_HEIGHT: 48, // å¬å”¤çŸ³æœ€å¤§é«˜åº¦
                MINI_FAB: 24,          // å°å‹æµ®åŠ¨æŒ‰é’®
                EDIT_BTN: 32           // ç¼–è¾‘æŒ‰é’®å°ºå¯¸
            },
            
            // åˆ—æ˜ å°„ï¼ˆA-M å…±13åˆ—ï¼Œæ”¯æŒ9äººæ¨¡å¼ï¼‰
            COLUMNS: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M'],
            
            // ç©ºå›¾ç‰‡å ä½ç¬¦
            EMPTY_IMAGE_SRC: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
            
            // é˜²æŠ–å’ŒèŠ‚æµå»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
            DEBOUNCE_DELAY: 500,
            THROTTLE_DELAY: 100
        };
        
        // ========== å·¥å…·å‡½æ•°æ¨¡å— ==========
        /**
         * é€šç”¨å·¥å…·å‡½æ•°
         * @namespace GBFGuide.Utils
         */
        GBFGuide.Utils = {
            /**
             * é˜²æŠ–å‡½æ•° - åœ¨æŒ‡å®šå»¶è¿Ÿå†…å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œæœ€åä¸€æ¬¡
             * @param {Function} fn - è¦é˜²æŠ–çš„å‡½æ•°
             * @param {number} delay - å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
             * @returns {Function} é˜²æŠ–åçš„å‡½æ•°
             * @example
             * var debouncedSave = GBFGuide.Utils.debounce(saveData, 500);
             * debouncedSave(); // å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œæœ€åä¸€æ¬¡
             */
            debounce: function(fn, delay) {
                var timer = null;
                return function() {
                    var context = this;
                    var args = arguments;
                    if (timer) {
                        clearTimeout(timer);
                    }
                    timer = setTimeout(function() {
                        fn.apply(context, args);
                    }, delay);
                };
            },
            
            /**
             * èŠ‚æµå‡½æ•° - åœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…æœ€å¤šæ‰§è¡Œä¸€æ¬¡
             * @param {Function} fn - è¦èŠ‚æµçš„å‡½æ•°
             * @param {number} delay - æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰
             * @returns {Function} èŠ‚æµåçš„å‡½æ•°
             * @example
             * var throttledResize = GBFGuide.Utils.throttle(handleResize, 100);
             * window.addEventListener('resize', throttledResize);
             */
            throttle: function(fn, delay) {
                var lastTime = 0;
                return function() {
                    var now = Date.now();
                    if (now - lastTime >= delay) {
                        lastTime = now;
                        fn.apply(this, arguments);
                    }
                };
            },
            
            /**
             * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å›¾ç‰‡ URL
             * @param {string} src - å›¾ç‰‡ URL
             * @returns {boolean} æ˜¯å¦ä¸ºæœ‰æ•ˆå›¾ç‰‡
             * @example
             * GBFGuide.Utils.isValidImageSrc('https://example.com/image.png'); // true
             * GBFGuide.Utils.isValidImageSrc(''); // false
             * GBFGuide.Utils.isValidImageSrc(EMPTY_IMAGE_SRC); // false
             */
            isValidImageSrc: function(src) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦
                if (!src || !src.trim()) {
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå›¾ç‰‡å ä½ç¬¦
                if (src === GBFGuide.Config.EMPTY_IMAGE_SRC) {
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ç©ºå›¾ç‰‡çš„ base64 æ ‡è¯†
                if (src.includes('data:image/gif;base64')) {
                    return false;
                }
                
                return true;
            },
            
            /**
             * å®‰å…¨è§£æ JSON å­—ç¬¦ä¸²
             * @param {string} str - JSON å­—ç¬¦ä¸²
             * @param {*} defaultValue - è§£æå¤±è´¥æ—¶çš„é»˜è®¤å€¼
             * @returns {*} è§£æç»“æœæˆ–é»˜è®¤å€¼
             * @example
             * var data = GBFGuide.Utils.safeParseJSON('{"key":"value"}', {});
             * var invalid = GBFGuide.Utils.safeParseJSON('invalid json', null); // è¿”å› null
             */
            safeParseJSON: function(str, defaultValue) {
                try {
                    return JSON.parse(str);
                } catch (e) {
                    console.warn('[GBFGuide.Utils] JSON è§£æå¤±è´¥:', e.message);
                    return defaultValue;
                }
            }
        };
        
        // ========== å­˜å‚¨ç®¡ç†æ¨¡å— ==========
        /**
         * localStorage å­˜å‚¨ç®¡ç†ï¼ˆå¸¦é˜²æŠ–ï¼‰
         * @namespace GBFGuide.Storage
         */
        GBFGuide.Storage = {
            /**
             * é˜²æŠ–è®¡æ—¶å™¨ ID
             * @private
             * @type {number|null}
             */
            _debounceTimer: null,
            
            /**
             * æ˜¯å¦æœ‰å¾…ä¿å­˜çš„æ•°æ®
             * @private
             * @type {boolean}
             */
            _pendingSave: false,
            
            /**
             * é˜²æŠ–ä¿å­˜ - åœ¨æŒ‡å®šå»¶è¿Ÿå†…å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œæœ€åä¸€æ¬¡
             * ç”¨äºé¢‘ç¹çš„ç”¨æˆ·æ“ä½œï¼ˆå¦‚æ‹–æ‹½ã€ç¼–è¾‘æ–‡æœ¬ç­‰ï¼‰
             * @example
             * GBFGuide.Storage.save(); // å¤šæ¬¡å¿«é€Ÿè°ƒç”¨åªä¼šæ‰§è¡Œä¸€æ¬¡
             */
            save: function() {
                var self = this;
                this._pendingSave = true;
                
                // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
                if (this._debounceTimer) {
                    clearTimeout(this._debounceTimer);
                }
                
                // è®¾ç½®æ–°çš„è®¡æ—¶å™¨
                this._debounceTimer = setTimeout(function() {
                    self._doSave();
                }, GBFGuide.Config.DEBOUNCE_DELAY);
            },
            
            /**
             * ç«‹å³ä¿å­˜ - å¼ºåˆ¶æ‰§è¡Œå¾…å¤„ç†çš„ä¿å­˜æ“ä½œ
             * ç”¨äºé¡µé¢å…³é—­å‰æˆ–éœ€è¦ç«‹å³ä¿å­˜çš„åœºæ™¯
             * @example
             * window.addEventListener('beforeunload', function() {
             *     GBFGuide.Storage.flush();
             * });
             */
            flush: function() {
                if (this._pendingSave) {
                    // æ¸…é™¤è®¡æ—¶å™¨
                    if (this._debounceTimer) {
                        clearTimeout(this._debounceTimer);
                        this._debounceTimer = null;
                    }
                    // ç«‹å³æ‰§è¡Œä¿å­˜
                    this._doSave();
                }
            },
            
            /**
             * æ‰§è¡Œå®é™…çš„ä¿å­˜æ“ä½œ
             * @private
             */
            _doSave: function() {
                try {
                    // è°ƒç”¨ç°æœ‰çš„ collectData å‡½æ•°æ”¶é›†æ•°æ®
                    var data = collectData();
                    
                    // ä¿å­˜åˆ° localStorage
                    localStorage.setItem(
                        GBFGuide.Config.STORAGE_KEY,
                        JSON.stringify(data)
                    );
                    
                    // é‡ç½®å¾…ä¿å­˜æ ‡è®°
                    this._pendingSave = false;
                    
                    console.log('[GBFGuide.Storage] æ•°æ®å·²ä¿å­˜');
                } catch (e) {
                    // å¤„ç†å­˜å‚¨é”™è¯¯
                    if (e.name === 'QuotaExceededError') {
                        console.error('[GBFGuide.Storage] localStorage å·²æ»¡ï¼Œæ— æ³•ä¿å­˜');
                        alert('å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·æ¸…ç†æµè§ˆå™¨æ•°æ®æˆ–å¯¼å‡ºå­˜æ¡£åæ¸…é™¤ã€‚');
                    } else {
                        console.error('[GBFGuide.Storage] ä¿å­˜å¤±è´¥:', e);
                    }
                }
            },
            
            /**
             * åŠ è½½æ•°æ® - ä» localStorage è¯»å–å¹¶è§£ææ•°æ®
             * @returns {Object|null} è§£æåçš„æ•°æ®å¯¹è±¡ï¼Œå¤±è´¥æ—¶è¿”å› null
             * @example
             * var data = GBFGuide.Storage.load();
             * if (data) {
             *     restoreData(data);
             * }
             */
            load: function() {
                try {
                    // ä» localStorage è¯»å–åŸå§‹æ•°æ®
                    var raw = localStorage.getItem(GBFGuide.Config.STORAGE_KEY);
                    
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å› null
                    if (!raw) {
                        return null;
                    }
                    
                    // è§£æ JSON
                    var data = JSON.parse(raw);
                    
                    console.log('[GBFGuide.Storage] æ•°æ®å·²åŠ è½½');
                    return data;
                    
                } catch (e) {
                    // å¤„ç†åŠ è½½é”™è¯¯
                    if (e instanceof SyntaxError) {
                        console.error('[GBFGuide.Storage] å­˜æ¡£ JSON æ ¼å¼é”™è¯¯:', e);
                        this._showLoadError('å­˜æ¡£æ•°æ®å·²æŸåï¼Œæ— æ³•åŠ è½½ã€‚\nå»ºè®®ï¼šæ¸…é™¤å­˜æ¡£æˆ–ä»å¤‡ä»½å¯¼å…¥ã€‚');
                    } else {
                        console.error('[GBFGuide.Storage] åŠ è½½å¤±è´¥:', e);
                        this._showLoadError('åŠ è½½å­˜æ¡£æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + e.message);
                    }
                    return null;
                }
            },
            
            /**
             * æ˜¾ç¤ºåŠ è½½é”™è¯¯æç¤º
             * @private
             * @param {string} message - é”™è¯¯æ¶ˆæ¯
             */
            _showLoadError: function(message) {
                alert(message);
            },
            
            /**
             * æ¸…é™¤å­˜æ¡£ - åˆ é™¤ localStorage ä¸­çš„æ•°æ®
             * @example
             * if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
             *     GBFGuide.Storage.clear();
             * }
             */
            clear: function() {
                try {
                    localStorage.removeItem(GBFGuide.Config.STORAGE_KEY);
                    console.log('[GBFGuide.Storage] å­˜æ¡£å·²æ¸…é™¤');
                } catch (e) {
                    console.error('[GBFGuide.Storage] æ¸…é™¤å­˜æ¡£å¤±è´¥:', e);
                }
            }
        };
        
        // ========== å…¼å®¹å±‚ï¼šä¿ç•™æ—§çš„å…¨å±€å˜é‡å¼•ç”¨ ==========
        var STORAGE_KEY = GBFGuide.Config.STORAGE_KEY;
        var THEME_KEY = GBFGuide.Config.THEME_KEY;
        var AUTHOR_KEY = GBFGuide.Config.AUTHOR_KEY;
        var EMPTY_IMAGE_SRC = GBFGuide.Config.EMPTY_IMAGE_SRC;
        
        // ========== å…¶ä»–å…¨å±€å˜é‡ï¼ˆå¾…åç»­è¿ç§»åˆ°å‘½åç©ºé—´ï¼‰==========
        var draggedElement=null;
        var floatingIcon=document.getElementById('floatingIcon');
        var statusBar=document.getElementById('statusBar');
        
        // ========== åˆ›ä½œè€…ç³»ç»Ÿ (Author System) ==========
        var AuthorSystem = {
            currentAuthor: 'è®¿å®¢',
            history: [] // å­˜å‚¨ä¹‹å‰çš„ä½œè€…å ["UserA", "UserB"]
        };
        
        // ========== [å…¨å±€é…ç½®] è§’è‰²å’Œå¬å”¤çŸ³é…ç½®ï¼ˆç§»è‡³å…¨å±€ä½œç”¨åŸŸï¼‰==========
        var characterConfigs = [
            { coord: '(0,E)', name: 'ä¸»è§’', skillCoord: 'E' },
            { coord: '(0,F)', name: '2å·ä½', skillCoord: 'F' },
            { coord: '(0,G)', name: '3å·ä½', skillCoord: 'G' },
            { coord: '(0,H)', name: '4å·ä½', skillCoord: 'H' },
            { coord: '(0,I)', name: 'åæ’1', skillCoord: 'I' },
            { coord: '(0,J)', name: 'åæ’2', skillCoord: 'J' },
            { coord: '(0,K)', name: 'åæ’3', skillCoord: 'K' },
            { coord: '(0,L)', name: 'åæ’4', skillCoord: 'L' },
            { coord: '(0,M)', name: 'åæ’5', skillCoord: 'M' }
        ];
        
        var summonConfigs = [
            { coord: 'A-B', fullCoord: '(1,A-B)', name: 'ä¸»å¬å”¤çŸ³', maxCount: 6, showButton: true },
            { coord: 'C', fullCoord: '(1,C)', name: 'å‰¯å¬å”¤çŸ³', maxCount: 3, showButton: false }
        ];
        
        // ========== åˆ›ä½œè€…ç³»ç»Ÿå‡½æ•° ==========
        
        // æ‰“å¼€åˆ›ä½œè€…å¼¹çª—
        function openAuthorModal() {
            var modal = document.getElementById('authorModal');
            modal.classList.add('active');
            // å¡«å……è¾“å…¥æ¡†
            document.getElementById('authorInput').value = AuthorSystem.currentAuthor === 'è®¿å®¢' ? '' : AuthorSystem.currentAuthor;
            // æ¸²æŸ“å†å²è®°å½•
            renderAuthorHistory();
        }
        
        // å…³é—­åˆ›ä½œè€…å¼¹çª—
        function closeAuthorModal(e) {
            if (!e || e.target.id === 'authorModal') {
                document.getElementById('authorModal').classList.remove('active');
            }
        }
        
        // å®æ—¶æ›´æ–°å½“å‰ä½œè€…å
        function updateCurrentAuthor(name) {
            var safeName = name.trim() || 'è®¿å®¢';
            AuthorSystem.currentAuthor = safeName;
            // æ›´æ–°å¾½ç« æ˜¾ç¤º
            document.getElementById('currentAuthorDisplay').textContent = safeName;
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem(AUTHOR_KEY, safeName);
            // æ›´æ–°å‘¼å¸ç¯çŠ¶æ€
            updateBadgePulse();
        }
        
        // æ›´æ–°å¾½ç« å‘¼å¸ç¯çŠ¶æ€
        function updateBadgePulse() {
            var badge = document.getElementById('authorBadge');
            if (!badge) return;
            if (AuthorSystem.currentAuthor === 'è®¿å®¢') {
                badge.classList.add('pulse');
            } else {
                badge.classList.remove('pulse');
            }
        }
        
        // ========== ç´ æç½‘ç«™ä¸‹æ‹‰èœå•æ§åˆ¶ ==========
        function toggleResourceDropdown(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('resourceDropdown');
            dropdown.classList.toggle('active');
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(e) {
            var dropdown = document.getElementById('resourceDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // æ¸²æŸ“å†å²è´¡çŒ®è€…åˆ—è¡¨
        function renderAuthorHistory() {
            var listEl = document.getElementById('authorHistoryList');
            listEl.innerHTML = '';
            
            if (AuthorSystem.history.length === 0) {
                listEl.innerHTML = '<div class="empty-history">æš‚æ— å†å²ç¼–è¾‘è®°å½•</div>';
                return;
            }
            
            // å»é‡å¹¶æ˜¾ç¤º
            var uniqueAuthors = [...new Set(AuthorSystem.history)];
            uniqueAuthors.forEach(function(name) {
                var tag = document.createElement('span');
                tag.className = 'history-tag';
                tag.textContent = name;
                listEl.appendChild(tag);
            });
        }
        
        // åˆå§‹åŒ–åˆ›ä½œè€…ç³»ç»Ÿï¼ˆä» localStorage æ¢å¤ï¼‰
        function initAuthorSystem() {
            var savedAuthor = localStorage.getItem(AUTHOR_KEY);
            // å…¼å®¹æ—§ç‰ˆæœ¬çš„ Guest
            if (savedAuthor && savedAuthor !== 'è®¿å®¢' && savedAuthor !== 'Guest') {
                AuthorSystem.currentAuthor = savedAuthor;
                document.getElementById('currentAuthorDisplay').textContent = savedAuthor;
            }
            // åˆå§‹åŒ–å‘¼å¸ç¯çŠ¶æ€
            updateBadgePulse();
        }
        
        // ========== é€šç”¨å·¥å…·å‡½æ•° ==========
        
        /**
         * ğŸŒŒ æ™ºèƒ½é«˜äº®ç³»ç»Ÿ - æ ¹æ®æºæŠ€èƒ½åæ ‡é«˜äº®å¯¹åº”åˆ—
         * @param {HTMLElement} element - æ‹–æ‹½çš„æºæŠ€èƒ½å…ƒç´ 
         * @param {boolean} activate - true=æ¿€æ´»é«˜äº®, false=ç§»é™¤é«˜äº®
         */
        function smartColumnHighlight(element, activate) {
            var table = document.querySelector('.guide-table');
            if (!table) return;
            
            // ç§»é™¤æ‰€æœ‰é«˜äº®ç±»
            var highlightClasses = ['highlight-col-D', 'highlight-col-E', 'highlight-col-F', 
                'highlight-col-G', 'highlight-col-H', 'highlight-col-I', 'highlight-col-J',
                'highlight-col-K', 'highlight-col-L', 'highlight-col-M', 'highlight-col-N'];
            highlightClasses.forEach(function(cls) {
                table.classList.remove(cls);
            });
            
            if (!activate) return;
            
            // è·å–æºæŠ€èƒ½æ‰€åœ¨å•å…ƒæ ¼çš„åæ ‡
            var parentCell = element.closest('td');
            if (!parentCell) return;
            
            var coordEl = parentCell.querySelector('.coord');
            if (!coordEl) return;
            
            var coordText = coordEl.textContent; // ä¾‹å¦‚ "(1,E)" æˆ– "(1,A-B)"
            var match = coordText.match(/\([\d]+,([A-Z\-]+)\)/);
            if (!match) return;
            
            var sourceCol = match[1]; // ä¾‹å¦‚ "E", "A-B", "C"
            
            // æ ¹æ®æºåˆ—ç¡®å®šç›®æ ‡é«˜äº®åˆ—
            var targetCol = '';
            if (sourceCol === 'A-B' || sourceCol === 'C' || sourceCol === 'D') {
                // å¬å”¤çŸ³åŒºåŸŸ -> é«˜äº® D åˆ—
                targetCol = 'D';
            } else if (['E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'].includes(sourceCol)) {
                // æŠ€èƒ½åŒºåŸŸ -> é«˜äº®å¯¹åº”åˆ—
                targetCol = sourceCol;
            }
            
            if (targetCol) {
                table.classList.add('highlight-col-' + targetCol);
            }
        }
        
        /**
         * ğŸ·ï¸ ä¸ºæ‰€æœ‰å•å…ƒæ ¼æ·»åŠ  data-col å±æ€§
         * ç”¨äºæ™ºèƒ½é«˜äº®ç³»ç»Ÿçš„ CSS é€‰æ‹©å™¨
         */
        function initColumnDataAttributes() {
            // å¤„ç† thead ä¸­çš„ th
            document.querySelectorAll('thead th').forEach(function(th) {
                var coordEl = th.querySelector('.coord-header');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\([\d]+,([A-Z\-]+)\)/);
                    if (match) {
                        th.setAttribute('data-col', match[1]);
                    }
                }
            });
            
            // å¤„ç† tbody ä¸­çš„ td
            document.querySelectorAll('tbody td').forEach(function(td) {
                var coordEl = td.querySelector('.coord');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\([\d]+(?:-\d+)?,([A-Z\-]+)\)/);
                    if (match) {
                        td.setAttribute('data-col', match[1]);
                    }
                }
            });
        }
        
        /**
         * ç»‘å®šæ‹–æ‹½äº‹ä»¶åˆ°å…ƒç´ 
         * @param {HTMLElement} element - è¦ç»‘å®šæ‹–æ‹½çš„å…ƒç´ 
         * @param {number} dragImageSize - æ‹–æ‹½å›¾åƒå¤§å°ï¼Œé»˜è®¤20
         */
        function bindDragEvents(element, dragImageSize) {
            dragImageSize = dragImageSize || 20;
            element.setAttribute('draggable', 'true');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æºæŠ€èƒ½è¡Œçš„å…ƒç´ ï¼ˆåªæœ‰æºæŠ€èƒ½è¡Œæ‰è§¦å‘é«˜äº®ï¼‰
            function isFromSourceRow(el) {
                var sourceRow = el.closest('.skill-source-row');
                // å¿…é¡»åœ¨æºæŠ€èƒ½è¡Œå†…ï¼Œä¸”ä¸æ˜¯æ¢äººè¡Œçš„æºæŠ€èƒ½
                return sourceRow && !sourceRow.classList.contains('swap-source-row');
            }
            
            // ç¬¬äºŒå±‚ï¼šæ‚¬åœé«˜äº® - åªæœ‰æºæŠ€èƒ½è¡Œçš„å…ƒç´ æ‰è§¦å‘
            element.addEventListener('mouseenter', function() {
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, true);
                }
            });
            element.addEventListener('mouseleave', function() {
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, false);
                }
            });
            
            element.addEventListener('dragstart', function(e) {
                draggedElement = this;
                e.dataTransfer.effectAllowed = 'copy';
                var img = this.querySelector('img');
                if (img) e.dataTransfer.setDragImage(img, dragImageSize, dragImageSize);
                statusBar.textContent = 'æ‹–æ‹½ä¸­...æ¾å¼€æ”¾ç½®';
                statusBar.style.display = 'block';
                // åªæœ‰æºæŠ€èƒ½è¡Œæ‰è§¦å‘é«˜äº®
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, true);
                }
            });
            element.addEventListener('dragend', function() {
                draggedElement = null;
                statusBar.style.display = 'none';
                // ç§»é™¤é«˜äº®ï¼ˆæ— è®ºæ˜¯å¦æ˜¯æºæŠ€èƒ½è¡Œéƒ½è¦æ¸…ç†ï¼‰
                smartColumnHighlight(this, false);
            });
        }
        
        /**
         * ç»‘å®šå‰ªè´´æ¿ç²˜è´´æŒ‰é’®äº‹ä»¶
         * @param {HTMLElement} btn - ç²˜è´´æŒ‰é’®å…ƒç´ 
         */
        function bindPasteButton(btn) {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                var inputElement = this.previousElementSibling;
                try {
                    var text = await navigator.clipboard.readText();
                    inputElement.value = text;
                    inputElement.dispatchEvent(new Event('input'));
                } catch (err) {
                    alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ï¼ˆCtrl+Vï¼‰');
                }
            });
        }
        
        /**
         * ç»‘å®šè¾“å…¥æ¡†æ‹–æ‹½åŠŸèƒ½
         * @param {HTMLElement} input - è¾“å…¥æ¡†å…ƒç´ 
         */
        function bindInputDragDrop(input) {
            input.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                this.classList.add('drag-over');
            });
            input.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            input.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                // æƒ…å†µ1ï¼šä»é¡µé¢å†…æ‹–æ‹½ skill-box
                if (draggedElement) {
                    var img = draggedElement.querySelector('img');
                    if (img) {
                        this.value = img.src;
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // æƒ…å†µ2ï¼šä»æµè§ˆå™¨æ‹–æ‹½å›¾ç‰‡ï¼ˆHTMLï¼‰
                if (e.dataTransfer.getData('text/html')) {
                    var html = e.dataTransfer.getData('text/html');
                    var match = html.match(/<img[^>]+src="([^">]+)"/);
                    if (match) {
                        this.value = match[1];
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // æƒ…å†µ3ï¼šæ‹–æ‹½URLæ–‡æœ¬
                if (e.dataTransfer.getData('text/plain')) {
                    var url = e.dataTransfer.getData('text/plain').trim();
                    if (url.match(/^https?:\/\//i)) {
                        this.value = url;
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // æƒ…å†µ4ï¼šæ‹–æ‹½æœ¬åœ°æ–‡ä»¶
                if (e.dataTransfer.files.length > 0) {
                    alert('æš‚ä¸æ”¯æŒæœ¬åœ°å›¾ç‰‡ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                }
            });
        }
        
        /**
         * åˆ›å»ºæŠ€èƒ½ç›’å­å…ƒç´ 
         * @param {string} url - å›¾ç‰‡URL
         * @param {Object} options - é…ç½®é€‰é¡¹
         * @param {string} options.className - CSSç±»åï¼Œé»˜è®¤ 'skill-box skill-source'
         * @param {number} options.size - å›¾ç‰‡å¤§å°ï¼Œé»˜è®¤40
         * @param {boolean} options.editable - æ˜¯å¦å¯åŒå‡»ç¼–è¾‘ï¼Œé»˜è®¤false
         * @param {boolean} options.deletable - æ˜¯å¦å¯å³é”®åˆ é™¤ï¼Œé»˜è®¤false
         * @param {number} options.dragImageSize - æ‹–æ‹½å›¾åƒå¤§å°ï¼Œé»˜è®¤20
         * @param {boolean} options.isSummon - æ˜¯å¦æ˜¯å¬å”¤çŸ³ï¼ˆä¸è®¾ç½®å›ºå®šå®½é«˜ï¼‰
         * @param {boolean} options.isSource - æ˜¯å¦æ˜¯æºæŠ€èƒ½ï¼ˆéœ€è¦ç¡®è®¤åˆ é™¤ï¼‰
         * @param {string} options.sourceType - æºç±»å‹ï¼š'skill'|'summon'|'status'
         * @returns {HTMLElement} åˆ›å»ºçš„skill-boxå…ƒç´ 
         */
        function createSkillBox(url, options) {
            options = options || {};
            var box = document.createElement('span');
            box.className = options.className || 'skill-box skill-source';
            
            var imgStyle = '';
            if (!options.isSummon) {
                var size = options.size || 40;
                imgStyle = 'width:' + size + 'px;height:' + size + 'px;';
            }
            box.innerHTML = '<img src="' + url + '"' + (imgStyle ? ' style="' + imgStyle + '"' : '') + '>';
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            bindDragEvents(box, options.dragImageSize || 20);
            
            // åŒå‡»ç¼–è¾‘
            if (options.editable) {
                var img = box.querySelector('img');
                img.style.cursor = 'pointer';
                img.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    editImageUrl(this);
                });
            }
            
            // æ‚¬åœåˆ é™¤æŒ‰é’®
            if (options.deletable) {
                addSourceDeleteButton(box, options.sourceType || 'skill', options.isSummon);
            }
            
            return box;
        }
        
        /**
         * ä¸ºæºæŠ€èƒ½/å¬å”¤çŸ³/çŠ¶æ€å›¾æ ‡æ·»åŠ åˆ é™¤æŒ‰é’®
         * @param {HTMLElement} box - skill-boxå…ƒç´ 
         * @param {string} sourceType - æºç±»å‹ï¼š'skill'|'summon'|'status'
         * @param {boolean} isSummon - æ˜¯å¦æ˜¯å¬å”¤çŸ³
         */
        function addSourceDeleteButton(box, sourceType, isSummon) {
            if (box.querySelector('.mini-fab.delete')) return; // å·²æœ‰åˆ é™¤æŒ‰é’®
            
            var delBtn = document.createElement('button');
            delBtn.className = 'mini-fab delete';
            delBtn.innerHTML = 'Ã—';
            delBtn.title = 'åˆ é™¤';
            delBtn.onclick = function(ev) {
                ev.stopPropagation();
                
                // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¡®è®¤ä¿¡æ¯
                var confirmMsg = '';
                var tipMsg = '';
                if (sourceType === 'summon') {
                    confirmMsg = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¬å”¤çŸ³å—ï¼Ÿ';
                    tipMsg = '\n\næç¤ºï¼šç‚¹å‡»å¬å”¤çŸ³æ ¼å³ä¸Šè§’çš„ âœ æŒ‰é’®å¯ä»¥æ‰¹é‡ç¼–è¾‘';
                } else if (sourceType === 'status') {
                    confirmMsg = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŠ¶æ€å›¾æ ‡å—ï¼Ÿ';
                    tipMsg = '\n\næç¤ºï¼šç‚¹å‡»çŠ¶æ€å›¾æ ‡è¡Œå³ä¸Šè§’çš„ âœ æŒ‰é’®å¯ä»¥æ‰¹é‡ç¼–è¾‘';
                } else {
                    confirmMsg = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ€èƒ½å›¾æ ‡å—ï¼Ÿ';
                    tipMsg = '\n\næç¤ºï¼šç‚¹å‡»è§’è‰²å¤´åƒå·¦ä¸Šè§’çš„ âˆ’ æŒ‰é’®å¯ä»¥å…¨éƒ¨æ¸…ç©ºè¯¥è§’è‰²çš„æŠ€èƒ½';
                }
                
                if (!confirm(confirmMsg + tipMsg)) return;
                
                var parentCell = box.closest('td, th');
                box.remove();
                GBFGuide.Storage.save();
                
                // æ›´æ–°ç©ºçŠ¶æ€
                if (parentCell) {
                    var coordEl = parentCell.querySelector('.coord');
                    if (coordEl) {
                        var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                        if (match) {
                            var colId = match[2];
                            if (sourceType === 'summon') {
                                var config = summonConfigs.find(function(c) { return c.coord === colId; });
                                if (config) {
                                    window.updateSummonEmptyState(colId, config.maxCount, config.showButton);
                                }
                            } else if (sourceType === 'skill') {
                                window.updateSkillSourceEmptyState(colId);
                            }
                        }
                    }
                }
            };
            box.appendChild(delBtn);
            box.classList.add('has-fab');
            
            // å¬å”¤çŸ³éœ€è¦è°ƒæ•´åˆ é™¤æŒ‰é’®ä½ç½®
            if (isSummon) {
                adjustSummonDeleteButton(box);
            }
        }
        
        /**
         * ä¸ºç°æœ‰çš„æºæŠ€èƒ½å›¾æ ‡æ‰¹é‡æ·»åŠ åˆ é™¤æŒ‰é’®
         */
        function initSourceDeleteButtons() {
            // 1. æŠ€èƒ½æºè¡Œçš„æŠ€èƒ½å›¾æ ‡
            document.querySelectorAll('.skill-source-row:not(.swap-source-row) td .skill-box.skill-source').forEach(function(box) {
                var cell = box.closest('td');
                var coordEl = cell ? cell.querySelector('.coord') : null;
                var isSummon = box.classList.contains('summon-box');
                var sourceType = isSummon ? 'summon' : 'skill';
                addSourceDeleteButton(box, sourceType, isSummon);
            });
            
            // 2. çŠ¶æ€å›¾æ ‡è¡Œçš„å›¾æ ‡
            var topRows = document.querySelectorAll('.top-row');
            if (topRows[1]) {
                topRows[1].querySelectorAll('.skill-box').forEach(function(box) {
                    addSourceDeleteButton(box, 'status', false);
                });
            }
        }
        
        // ========== ç¬¬äºŒé˜¶æ®µï¼šå¼¹çª—é€šç”¨å·¥å…·å‡½æ•° ==========
        
        /**
         * è®¾ç½®å¸®åŠ©æŒ‰é’®äº¤äº’ï¼ˆæ‚¬åœæ˜¾ç¤ºã€ç‚¹å‡»å›ºå®šï¼‰
         * @param {HTMLElement} modal - å¼¹çª—å…ƒç´ 
         */
        function setupHelpButton(modal) {
            var helpBtn = modal.querySelector('#modalHelpBtn');
            var helpTooltip = modal.querySelector('#helpTooltip');
            if (!helpBtn || !helpTooltip) return;
            
            var isHelpPinned = false;
            
            helpBtn.addEventListener('mouseenter', function() {
                if (!isHelpPinned) helpTooltip.style.display = 'block';
            });
            helpBtn.addEventListener('mouseleave', function() {
                if (!isHelpPinned) helpTooltip.style.display = 'none';
            });
            helpBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                isHelpPinned = !isHelpPinned;
                helpTooltip.style.display = 'block';
                helpBtn.textContent = isHelpPinned ? 'âœ•' : 'â“';
            });
            document.addEventListener('click', function closeHelp(e) {
                if (isHelpPinned && !helpTooltip.contains(e.target) && e.target !== helpBtn) {
                    isHelpPinned = false;
                    helpTooltip.style.display = 'none';
                    helpBtn.textContent = 'â“';
                }
            });
        }
        
        /**
         * åˆ›å»ºè¾“å…¥è¡Œæ›´æ–°æ ‡ç­¾å‡½æ•°
         * @param {HTMLElement} modal - å¼¹çª—å…ƒç´ 
         * @param {string} containerId - å®¹å™¨ID
         * @param {string} labelPrefix - æ ‡ç­¾å‰ç¼€ï¼ˆå¦‚"æŠ€èƒ½"ã€"å¬å”¤çŸ³"ã€"çŠ¶æ€"ï¼‰
         * @param {string} inputClass - è¾“å…¥æ¡†ç±»å
         * @returns {Function} æ›´æ–°æ ‡ç­¾çš„å‡½æ•°
         */
        function createLabelUpdater(modal, containerId, labelPrefix, inputClass) {
            return function() {
                var container = modal.querySelector('#' + containerId);
                var rows = container.querySelectorAll('.skill-input-row');
                rows.forEach(function(row, index) {
                    var label = row.querySelector('.skill-input-label');
                    if (label) label.textContent = labelPrefix + (index + 1) + ':';
                    var input = row.querySelector('.' + inputClass);
                    if (input) input.setAttribute('data-index', index);
                    row.setAttribute('data-row-index', index);
                });
            };
        }
        
        /**
         * è®¾ç½®è¾“å…¥è¡Œçš„ +/- æŒ‰é’®äº‹ä»¶å§”æ‰˜
         * @param {HTMLElement} modal - å¼¹çª—å…ƒç´ 
         * @param {string} containerId - å®¹å™¨ID
         * @param {string} inputClass - è¾“å…¥æ¡†ç±»å
         * @param {string} previewClass - é¢„è§ˆå›¾ç±»å
         * @param {string} labelPrefix - æ ‡ç­¾å‰ç¼€
         * @param {number} maxCount - æœ€å¤§è¡Œæ•°
         * @param {number} minCount - æœ€å°è¡Œæ•°ï¼Œé»˜è®¤1
         */
        function setupInputRowButtons(modal, containerId, inputClass, previewClass, labelPrefix, maxCount, minCount) {
            minCount = minCount || 1;
            var container = modal.querySelector('#' + containerId);
            var updateLabels = createLabelUpdater(modal, containerId, labelPrefix, inputClass);
            
            container.addEventListener('click', function(e) {
                // + æŒ‰é’®ï¼šåœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
                if (e.target.classList.contains('add-skill-row')) {
                    e.preventDefault();
                    var allRows = container.querySelectorAll('.skill-input-row');
                    
                    if (allRows.length >= maxCount) {
                        alert('æœ€å¤šæ·»åŠ ' + maxCount + 'ä¸ª' + labelPrefix + 'æ§½');
                        return;
                    }
                    
                    var currentRow = e.target.closest('.skill-input-row');
                    var newRow = document.createElement('div');
                    newRow.className = 'skill-input-row';
                    newRow.innerHTML = 
                        '<span class="skill-input-label">' + labelPrefix + 'X:</span>' +
                        '<div class="skill-url-input-wrapper">' +
                            '<input type="text" class="' + inputClass + '" placeholder="è¾“å…¥URLæˆ–ç•™ç©º">' +
                            '<button type="button" class="paste-btn-inline" title="ä»å‰ªè´´æ¿ç²˜è´´">ğŸ“‹</button>' +
                        '</div>' +
                        '<img class="' + previewClass + '" src="' + EMPTY_IMAGE_SRC + '">' +
                        '<button type="button" class="skill-inline-btn add-skill-row" title="åœ¨ä¸‹æ–¹æ’å…¥æ–°è¡Œ">+</button>' +
                        '<button type="button" class="skill-inline-btn remove-skill-row" title="åˆ é™¤æ­¤è¡Œ">âˆ’</button>';
                    
                    currentRow.insertAdjacentElement('afterend', newRow);
                    
                    // ä¸ºæ–°è¾“å…¥æ¡†æ·»åŠ å®æ—¶é¢„è§ˆ
                    var newInput = newRow.querySelector('.' + inputClass);
                    newInput.addEventListener('input', function() {
                        var wrapper = this.parentElement;
                        var preview = wrapper.nextElementSibling;
                        var url = this.value.trim();
                        preview.src = url || EMPTY_IMAGE_SRC;
                    });
                    
                    // ä¸ºæ–°ç²˜è´´æŒ‰é’®æ·»åŠ äº‹ä»¶
                    var newPasteBtn = newRow.querySelector('.paste-btn-inline');
                    bindPasteButton(newPasteBtn);
                    
                    // ä¸ºæ–°è¾“å…¥æ¡†æ·»åŠ æ‹–æ‹½åŠŸèƒ½
                    bindInputDragDrop(newInput);
                    
                    updateLabels();
                }
                
                // - æŒ‰é’®ï¼šåˆ é™¤å½“å‰è¡Œ
                if (e.target.classList.contains('remove-skill-row')) {
                    e.preventDefault();
                    var allRows = container.querySelectorAll('.skill-input-row');
                    
                    if (allRows.length <= minCount) {
                        if (minCount === 1) {
                            // åªæœ‰ä¸€è¡Œæ—¶ï¼Œæ¸…ç©ºå†…å®¹è€Œä¸æ˜¯åˆ é™¤
                            var input = e.target.closest('.skill-input-row').querySelector('.' + inputClass);
                            input.value = '';
                            input.dispatchEvent(new Event('input'));
                        } else {
                            alert('è‡³å°‘ä¿ç•™' + minCount + 'ä¸ª' + labelPrefix + 'æ§½');
                        }
                        return;
                    }
                    
                    e.target.closest('.skill-input-row').remove();
                    updateLabels();
                }
            });
        }
        
        /**
         * ä¸ºå¼¹çª—ä¸­çš„æ‰€æœ‰è¾“å…¥æ¡†ç»‘å®šé€šç”¨äº‹ä»¶ï¼ˆç²˜è´´ã€æ‹–æ‹½ã€å®æ—¶é¢„è§ˆï¼‰
         * @param {HTMLElement} modal - å¼¹çª—å…ƒç´ 
         * @param {string} inputClass - è¾“å…¥æ¡†ç±»å
         */
        function bindModalInputEvents(modal, inputClass) {
            // å‰ªè´´æ¿ç²˜è´´åŠŸèƒ½
            modal.querySelectorAll('.paste-btn-inline').forEach(function(btn) {
                bindPasteButton(btn);
            });
            
            // æ‹–æ‹½å›¾ç‰‡åŠŸèƒ½
            modal.querySelectorAll('.' + inputClass).forEach(function(input) {
                bindInputDragDrop(input);
            });
            
            // å®æ—¶é¢„è§ˆåŠŸèƒ½
            modal.querySelectorAll('.' + inputClass).forEach(function(input) {
                input.addEventListener('input', function() {
                    var wrapper = this.parentElement;
                    var preview = wrapper.nextElementSibling;
                    var url = this.value.trim();
                    if (url) {
                        preview.src = url;
                    } else {
                        preview.src = EMPTY_IMAGE_SRC;
                    }
                });
            });
        }
        
        /**
         * ç”Ÿæˆå¸®åŠ©æç¤ºHTML
         * @param {Object} options - é…ç½®é€‰é¡¹
         * @param {string} options.wikiType - Wikiç±»å‹æè¿°ï¼ˆå¦‚"BOSS"ã€"è§’è‰²"ï¼‰
         * @returns {string} å¸®åŠ©æç¤ºHTML
         */
        function generateHelpTooltipHtml(options) {
            var wikiType = options.wikiType || '';
            return '<button type="button" class="modal-help-btn" id="modalHelpBtn">â“</button>' +
                '<div class="help-tooltip" id="helpTooltip">' +
                    '<h4>ğŸ’¡ å¦‚ä½•å¤åˆ¶å›¾ç‰‡URL</h4>' +
                    '<ol>' +
                        '<li>ç‚¹å‡»"ç¼–é˜Ÿå¤åˆ¶å›¾ç‰‡URL"æ‰“å¼€æ¸¸æˆé¡µé¢</li>' +
                        '<li>é•¿æŒ‰å³é”®æ‹–åŠ¨åˆ°å›¾ç‰‡ä¸Šï¼Œå†æ¾å¼€å³é”®</li>' +
                        '<li>é€‰æ‹©"å¤åˆ¶å›¾ç‰‡åœ°å€"</li>' +
                        '<li>ä½¿ç”¨ Win+V æŸ¥çœ‹å¤åˆ¶å†å²</li>' +
                        '<li>ä½¿ç”¨ Win+å·¦/å³ åˆ†å±æ˜¾ç¤ºä¸¤ä¸ªçª—å£</li>' +
                    '</ol>' +
                    '<div class="help-section">' +
                        '<strong>ğŸ’¡ å¿«æ·æ–¹å¼ï¼š</strong><br>' +
                        'â€¢ ç‚¹å‡» ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´<br>' +
                        'â€¢ æ‹–æ‹½å›¾ç‰‡åˆ°è¾“å…¥æ¡†' +
                    '</div>' +
                '</div>';
        }
        
        /**
         * ç”Ÿæˆè¾“å…¥è¡ŒHTML
         * @param {Object} options - é…ç½®é€‰é¡¹
         * @param {Array} options.existingUrls - ç°æœ‰URLæ•°ç»„
         * @param {number} options.slotCount - æ§½ä½æ•°é‡
         * @param {string} options.labelPrefix - æ ‡ç­¾å‰ç¼€
         * @param {string} options.inputClass - è¾“å…¥æ¡†ç±»å
         * @param {string} options.previewClass - é¢„è§ˆå›¾ç±»å
         * @returns {string} è¾“å…¥è¡ŒHTML
         */
        function generateInputRowsHtml(options) {
            var html = '';
            for (var i = 0; i < options.slotCount; i++) {
                var currentUrl = options.existingUrls[i] || '';
                html += '<div class="skill-input-row" data-row-index="' + i + '">' +
                    '<span class="skill-input-label">' + options.labelPrefix + (i + 1) + ':</span>' +
                    '<div class="skill-url-input-wrapper">' +
                        '<input type="text" class="' + options.inputClass + '" data-index="' + i + '" value="' + currentUrl + '" placeholder="è¾“å…¥URLæˆ–ç•™ç©º">' +
                        '<button type="button" class="paste-btn-inline" title="ä»å‰ªè´´æ¿ç²˜è´´">ğŸ“‹</button>' +
                    '</div>' +
                    '<img class="' + options.previewClass + '" src="' + (currentUrl || EMPTY_IMAGE_SRC) + '">' +
                    '<button type="button" class="skill-inline-btn add-skill-row" title="åœ¨ä¸‹æ–¹æ’å…¥æ–°è¡Œ">+</button>' +
                    '<button type="button" class="skill-inline-btn remove-skill-row" title="åˆ é™¤æ­¤è¡Œ">âˆ’</button>' +
                '</div>';
            }
            return html;
        }
        
        // ========== ç¬¬äºŒé˜¶æ®µå·¥å…·å‡½æ•°ç»“æŸ ==========
        
        // ========== ç¬¬ä¸‰é˜¶æ®µï¼šç©ºçŠ¶æ€é€šç”¨å·¥å…·å‡½æ•° ==========
        
        /**
         * æ£€æŸ¥å…ƒç´ ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆå›¾ç‰‡
         * @param {HTMLElement} element - è¦æ£€æŸ¥çš„å…ƒç´ 
         * @param {string} selector - å›¾ç‰‡é€‰æ‹©å™¨ï¼Œé»˜è®¤ 'img'
         * @returns {boolean} æ˜¯å¦æœ‰æœ‰æ•ˆå›¾ç‰‡
         */
        function hasValidImages(element, selector) {
            selector = selector || 'img';
            var images = element.querySelectorAll(selector);
            var valid = false;
            images.forEach(function(img) {
                if (img.src && img.src !== EMPTY_IMAGE_SRC && !img.src.includes('data:image/gif;base64') && img.src.trim() !== '') {
                    valid = true;
                }
            });
            return valid;
        }
        
        /**
         * æ£€æŸ¥å•ä¸ªå›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ
         * @param {HTMLImageElement} img - å›¾ç‰‡å…ƒç´ 
         * @returns {boolean} æ˜¯å¦æœ‰æ•ˆ
         */
        function isValidImage(img) {
            return img && img.src && img.src !== EMPTY_IMAGE_SRC && !img.src.includes('data:image/gif;base64') && img.src.trim() !== '';
        }
        
        /**
         * åˆ›å»ºç©ºçŠ¶æ€æç¤ºå…ƒç´ 
         * @param {Object} options - é…ç½®é€‰é¡¹
         * @param {string} options.className - CSSç±»å
         * @param {string} options.text - æç¤ºæ–‡å­—
         * @param {Array} options.buttons - æŒ‰é’®é…ç½®æ•°ç»„ [{text, url}]
         * @param {string} options.textClass - æ–‡å­—CSSç±»åï¼Œé»˜è®¤ 'empty-text'
         * @param {string} options.buttonsClass - æŒ‰é’®å®¹å™¨CSSç±»åï¼Œé»˜è®¤ 'empty-buttons'
         * @returns {HTMLElement} æç¤ºå…ƒç´ 
         */
        function createEmptyHint(options) {
            var hint = document.createElement('div');
            hint.className = options.className || 'empty-state-hint';
            
            var textClass = options.textClass || 'empty-text';
            var html = '<div class="' + textClass + '">' + options.text + '</div>';
            
            if (options.buttons && options.buttons.length > 0) {
                var buttonsClass = options.buttonsClass || 'empty-buttons';
                html += '<div class="' + buttonsClass + '">';
                options.buttons.forEach(function(btn) {
                    // åˆ¤æ–­æ˜¯å¦ä¸º Wiki é“¾æ¥ï¼ˆåŒ…å« huijiwiki.comï¼‰ï¼Œæ·»åŠ  wiki-warning ç±»
                    var isWikiLink = btn.url && btn.url.indexOf('huijiwiki.com') > -1;
                    var btnClass = isWikiLink ? 'wiki-btn-small wiki-warning' : 'wiki-btn-small';
                    html += '<button class="' + btnClass + '" onclick="window.open(\'' + btn.url + '\',\'_blank\')">' + btn.text + '</button>';
                });
                html += '</div>';
            }
            
            hint.innerHTML = html;
            return hint;
        }
        
        /**
         * é€šè¿‡åæ ‡æŸ¥æ‰¾æŠ€èƒ½æºè¡Œä¸­çš„å•å…ƒæ ¼
         * @param {string} coord - åæ ‡å­—ç¬¦ä¸²ï¼ˆå¦‚ 'E', 'A-B'ï¼‰
         * @returns {HTMLElement|null} æ‰¾åˆ°çš„å•å…ƒæ ¼
         */
        function findSkillSourceCell(coord) {
            var skillSourceRow = document.querySelector('.skill-source-row');
            if (!skillSourceRow) return null;
            
            var targetCell = null;
            skillSourceRow.querySelectorAll('td').forEach(function(cell) {
                var coordEl = cell.querySelector('.coord');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if (match && match[2] === coord) {
                        targetCell = cell;
                    }
                }
            });
            return targetCell;
        }
        
        /**
         * é€šè¿‡åæ ‡æŸ¥æ‰¾è§’è‰²å¤´åƒå•å…ƒæ ¼
         * @param {string} coord - åæ ‡å­—ç¬¦ä¸²ï¼ˆå¦‚ 'E', 'F'ï¼‰
         * @returns {HTMLElement|null} æ‰¾åˆ°çš„å•å…ƒæ ¼
         */
        function findCharacterHeader(coord) {
            var targetHeader = null;
            document.querySelectorAll('.character-header').forEach(function(header) {
                var coordEl = header.querySelector('.coord-header');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                    if (match && match[2] === coord) {
                        targetHeader = header;
                    }
                }
            });
            return targetHeader;
        }
        
        // ========== ç¬¬ä¸‰é˜¶æ®µå·¥å…·å‡½æ•°ç»“æŸ ==========
        
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme(){
            var html=document.documentElement;
            var current=html.getAttribute('data-theme');
            var newTheme=current==='dark'?'light':'dark';
            html.setAttribute('data-theme',newTheme);
            localStorage.setItem(THEME_KEY,newTheme);
            updateThemeButton(newTheme);
        }
        function updateThemeButton(theme){
            var btn=document.querySelector('.theme-toggle');
            if(btn){btn.textContent=theme==='dark'?'â˜€ï¸ åˆ‡æ¢ä¸»é¢˜':'ğŸŒ™ åˆ‡æ¢ä¸»é¢˜';}
        }
        function loadTheme(){
            var saved=localStorage.getItem(THEME_KEY)||'light';
            document.documentElement.setAttribute('data-theme',saved);
            updateThemeButton(saved);
        }
        loadTheme();
        
        // åæ ‡æ˜¾ç¤ºå¼€å…³ (æ–°ç‰ˆï¼šé€‚é…æŒ‰é’®æ ·å¼)
        var COORDS_KEY='gbf_guide_coords';
        function toggleCoords(){
            var btn = document.getElementById('btnCoordToggle');
            var table = document.getElementById('guideTable');
            // æ£€æŸ¥å½“å‰æ˜¯å¦å·²éšè—ï¼ˆé€šè¿‡ç±»ååˆ¤æ–­ï¼‰
            var isHidden = table.classList.contains('hide-coords');
            if(isHidden){
                // åŠ¨ä½œï¼šæ˜¾ç¤º
                table.classList.remove('hide-coords');
                btn.style.color = '#2196f3'; // é«˜äº®å›¾æ ‡
                localStorage.setItem(COORDS_KEY, 'show');
            } else {
                // åŠ¨ä½œï¼šéšè—
                table.classList.add('hide-coords');
                btn.style.color = ''; // æ¢å¤é»˜è®¤è‰²
                localStorage.setItem(COORDS_KEY, 'hide');
            }
        }
        function loadCoordsState(){
            var saved = localStorage.getItem(COORDS_KEY) || 'show';
            var btn = document.getElementById('btnCoordToggle');
            var table = document.getElementById('guideTable');
            if(saved === 'hide'){
                table.classList.add('hide-coords');
                if(btn) btn.style.color = '';
            } else {
                table.classList.remove('hide-coords');
                // åˆå§‹åŒ–æ—¶é«˜äº®
                if(btn) btn.style.color = '#2196f3';
            }
        }
        
        // é»˜è®¤å­—å·
        var FONTSIZE_KEY='gbf_guide_fontsize';
        var ICONSCALE_KEY='gbf_guide_iconscale';
        
        function saveDefaultFontSize(){
            var size=document.getElementById('defaultFontSize').value;
            localStorage.setItem(FONTSIZE_KEY,size);
            applyDefaultFontSize();
        }
        function loadDefaultFontSize(){
            var saved=localStorage.getItem(FONTSIZE_KEY)||'11';
            document.getElementById('defaultFontSize').value=saved;
            return parseInt(saved);
        }
        function getDefaultFontSize(){
            return parseInt(document.getElementById('defaultFontSize').value)||11;
        }
        
        // å›¾æ ‡å¤§å°æ§åˆ¶
        function saveIconScale(){
            var displayValue = document.getElementById('iconScale').value;
            // å°†æ˜¾ç¤ºå€¼è½¬æ¢ä¸ºç™¾åˆ†æ¯”å­˜å‚¨ï¼ˆ10å¯¹åº”100%ï¼‰
            var scalePercent = displayValue * 10;
            localStorage.setItem(ICONSCALE_KEY, scalePercent);
            applyIconScaling();
        }
        function loadIconScale(){
            var savedPercent = localStorage.getItem(ICONSCALE_KEY) || '100';
            // å°†ç™¾åˆ†æ¯”è½¬æ¢ä¸ºæ˜¾ç¤ºå€¼ï¼ˆ100%å¯¹åº”10ï¼‰
            var displayValue = parseInt(savedPercent) / 10;
            document.getElementById('iconScale').value = displayValue;
            return parseInt(savedPercent);
        }
        function getIconScale(){
            var displayValue = parseInt(document.getElementById('iconScale').value) || 10;
            // å°†æ˜¾ç¤ºå€¼è½¬æ¢ä¸ºç™¾åˆ†æ¯”ç”¨äºè®¡ç®—ï¼ˆ10å¯¹åº”100%ï¼‰
            return displayValue * 10;
        }
        function applyDefaultFontSize(){
            var size=getDefaultFontSize()+'px';
            document.querySelectorAll('.t-text').forEach(function(el){
                if(!el.hasAttribute('data-custom-size')){el.style.fontSize=size;}
            });
            // åŒæ—¶åº”ç”¨åˆ°ç”¨æˆ·æ–‡å­—
            document.querySelectorAll('.user-text').forEach(function(el){
                if(!el.hasAttribute('data-custom-size')){el.style.fontSize=size;}
            });
            // åŒæ—¶åº”ç”¨åˆ°ç¬¬2è¡ŒåŠä»¥ä¸‹çš„æ‰€æœ‰æŒ‰é’®ï¼ˆAåˆ—+âˆ’ã€Båˆ—âˆ’ï¼‰
            document.querySelectorAll('.del-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            document.querySelectorAll('.phase-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            document.querySelectorAll('.phase-del-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            // åŒæ—¶åº”ç”¨åˆ°Cåˆ—å’ŒE-Håˆ—çš„å¾®å‹æŒ‰é’®
            document.querySelectorAll('.micro-fab').forEach(function(el){
                el.style.fontSize=size;
            });
            // åŒæ—¶åº”ç”¨åˆ°è§’è‰²æ åˆ é™¤é”®å’Œå¬å”¤çŸ³æ çš„ç¼–è¾‘/åˆ é™¤é”®
            document.querySelectorAll('.mini-fab').forEach(function(el){
                el.style.fontSize=size;
            });
        }
        
        // å›¾æ ‡ç¼©æ”¾åŠŸèƒ½ - ä¿®å¤ç‰ˆ
        function applyIconScaling() {
            var iconScale = getIconScale() / 100; // è½¬æ¢ä¸ºå°æ•°æ¯”ä¾‹
            
            // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé¿å…è¿‡å¤§æˆ–è¿‡å°
            iconScale = Math.max(0.5, Math.min(2.0, iconScale));
            
            // 1. åº”ç”¨åˆ°æŠ€èƒ½å›¾æ ‡
            document.querySelectorAll('.skill-box img').forEach(function(img) {
                if (img.closest('.summon-box')) {
                    // å¬å”¤çŸ³ç‰¹æ®Šå¤„ç†
                    var baseWidth = 40;
                    var baseMaxHeight = 48;
                    img.style.maxWidth = (baseWidth * iconScale) + 'px';
                    img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
                } else {
                    // æ™®é€šæŠ€èƒ½å›¾æ ‡
                    var baseSize = 40;
                    var newSize = baseSize * iconScale;
                    img.style.width = newSize + 'px';
                    img.style.height = newSize + 'px';
                }
            });
            
            // 2. åº”ç”¨åˆ°å¬å”¤çŸ³å®¹å™¨
            document.querySelectorAll('.skill-box.summon-box').forEach(function(box) {
                var baseSize = 40;
                var newSize = baseSize * iconScale;
                box.style.width = newSize + 'px';
                box.style.height = newSize + 'px';
            });
            
            // 3. åº”ç”¨åˆ°æ™®é€šæŠ€èƒ½å®¹å™¨
            document.querySelectorAll('.skill-box:not(.summon-box)').forEach(function(box) {
                var baseSize = 44;
                var newSize = baseSize * iconScale;
                box.style.width = newSize + 'px';
                box.style.height = newSize + 'px';
            });
            
            // 4. åº”ç”¨åˆ°è§’è‰²å¤´åƒ
            document.querySelectorAll('.character-header img').forEach(function(img) {
                var baseWidth = 70;
                var baseMaxHeight = 120;
                img.style.width = (baseWidth * iconScale) + 'px';
                img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
            });
            
            // 5. åº”ç”¨åˆ°è¿·ä½ æŒ‰é’® (åˆ é™¤é”®/åŠ å·é”®)
            document.querySelectorAll('.mini-fab').forEach(function(btn) {
                // é»˜è®¤å°æŒ‰é’®åŸºç¡€å¤§å°ä¸º 24
                var baseSize = 24;
                // [ä¿®æ”¹] å¦‚æœæ˜¯å·¦ä¸Šè§’çš„åˆ é™¤å¤§æŒ‰é’®ï¼ŒåŸºç¡€å¤§å°è®¾ä¸º 32 (åŒæ­¥ç¼–è¾‘æŒ‰é’®)
                if (btn.classList.contains('delete-char-btn')) {
                    baseSize = 32;
                }
                var newSize = baseSize * iconScale;
                btn.style.width = newSize + 'px';
                btn.style.height = newSize + 'px';
                // [ä¿®æ”¹] åŠ¨æ€è®¡ç®—å­—å· (çº¦ä¸ºæŒ‰é’®å¤§å°çš„ 0.65 å€)
                btn.style.fontSize = (baseSize * 0.65 * iconScale) + 'px';
            });
            
            // 6. [æ–°å¢] åº”ç”¨åˆ°æ–°ç‰ˆç»ç’ƒæ‹Ÿæ€ç¼–è¾‘æŒ‰é’® (.btn-edit-glass)
            document.querySelectorAll('.btn-edit-glass').forEach(function(btn) {
                var baseSize = 32; // ç¼–è¾‘æŒ‰é’®åŸºç¡€å°ºå¯¸è¾ƒå¤§
                var newSize = baseSize * iconScale;
                btn.style.width = newSize + 'px';
                btn.style.height = newSize + 'px';
                // åŒæ—¶ç¼©æ”¾å†…éƒ¨çš„ SVG å›¾æ ‡
                var svg = btn.querySelector('svg');
                if(svg) {
                    var baseSvgSize = 16;
                    var newSvgSize = baseSvgSize * iconScale;
                    svg.setAttribute('width', newSvgSize);
                    svg.setAttribute('height', newSvgSize);
                }
            });
            
            // é‡æ–°è°ƒæ•´å¬å”¤çŸ³åˆ é™¤æŒ‰é’®ä½ç½®
            setTimeout(function() {
                adjustAllSummonDeleteButtons();
            }, 50);
        }
        
        // å¯¹å•ä¸ªå…ƒç´ åº”ç”¨å›¾æ ‡ç¼©æ”¾
        function applyIconScalingToElement(element) {
            var iconScale = getIconScale() / 100;
            iconScale = Math.max(0.5, Math.min(2.0, iconScale));
            
            if (element.classList.contains('skill-box')) {
                var img = element.querySelector('img');
                if (img) {
                    if (element.classList.contains('summon-box')) {
                        // å¬å”¤çŸ³ç‰¹æ®Šå¤„ç†
                        var baseWidth = 40;
                        var baseMaxHeight = 48;
                        img.style.maxWidth = (baseWidth * iconScale) + 'px';
                        img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
                        
                        // è°ƒæ•´å®¹å™¨å°ºå¯¸
                        var baseSize = 40;
                        var newSize = baseSize * iconScale;
                        element.style.width = newSize + 'px';
                        element.style.height = newSize + 'px';
                    } else {
                        // æ™®é€šæŠ€èƒ½å›¾æ ‡
                        var baseImgSize = 40;
                        var newImgSize = baseImgSize * iconScale;
                        img.style.width = newImgSize + 'px';
                        img.style.height = newImgSize + 'px';
                        
                        // è°ƒæ•´å®¹å™¨å°ºå¯¸
                        var baseBoxSize = 44;
                        var newBoxSize = baseBoxSize * iconScale;
                        element.style.width = newBoxSize + 'px';
                        element.style.height = newBoxSize + 'px';
                    }
                }
                
                // è°ƒæ•´åˆ é™¤æŒ‰é’®
                var deleteBtn = element.querySelector('.mini-fab');
                if (deleteBtn) {
                    var baseSize = 22;
                    var newSize = baseSize * iconScale;
                    deleteBtn.style.width = newSize + 'px';
                    deleteBtn.style.height = newSize + 'px';
                    deleteBtn.style.fontSize = (14 * iconScale) + 'px';
                }
            }
        }
        
        // å³é”®èœå•
        var currentContextTarget=null;
        var currentContextType=null; // 'user-text' or 't-text'
        function showContextMenu(e,target,type){
            e.preventDefault();
            closeContextMenu();
            currentContextTarget=target;
            currentContextType=type||'user-text';
            var menu=document.createElement('div');
            menu.className='context-menu';
            menu.id='contextMenu';
            var menuHtml='<div class="context-menu-item" onclick="editTextSize()">ğŸ“ ä¿®æ”¹å­—å·</div><div class="context-menu-item" onclick="editTextColor()">ğŸ¨ ä¿®æ”¹é¢œè‰²</div><div class="context-menu-item" onclick="resetTextStyle()">ğŸ”„ è¿˜åŸé»˜è®¤</div>';
            if(currentContextType==='user-text'){
                menuHtml+='<div class="context-menu-divider"></div><div class="context-menu-item" onclick="deleteContextTarget()" style="color:#c62828;">ğŸ—‘ï¸ åˆ é™¤</div>';
            }
            menu.innerHTML=menuHtml;
            menu.style.left=e.clientX+'px';
            menu.style.top=e.clientY+'px';
            document.body.appendChild(menu);
            setTimeout(function(){document.addEventListener('click',closeContextMenu,{once:true});},10);
        }
        function closeContextMenu(){
            var menu=document.getElementById('contextMenu');
            if(menu)menu.remove();
        }
        function editTextSize(){
            if(!currentContextTarget)return;
            var currentSize=parseInt(currentContextTarget.style.fontSize)||getDefaultFontSize();
            var newSize=prompt('è¾“å…¥å­—å· (10-24):',currentSize);
            if(newSize!==null){
                newSize=parseInt(newSize);
                if(newSize>=10&&newSize<=24){
                    currentContextTarget.style.fontSize=newSize+'px';
                    currentContextTarget.setAttribute('data-custom-size','true');
                    GBFGuide.Storage.save();
                }else{
                    alert('å­—å·èŒƒå›´: 10-24');
                }
            }
        }
        function editTextColor(){
            if(!currentContextTarget)return;
            var colorInput=document.createElement('input');
            colorInput.type='color';
            colorInput.value=rgbToHex(currentContextTarget.style.color)||'#333333';
            colorInput.style.position='fixed';
            colorInput.style.opacity='0';
            document.body.appendChild(colorInput);
            colorInput.click();
            colorInput.addEventListener('change',function(){
                currentContextTarget.style.color=this.value;
                currentContextTarget.setAttribute('data-custom-color','true');
                GBFGuide.Storage.save();
                this.remove();
            });
            colorInput.addEventListener('blur',function(){this.remove();});
        }
        function rgbToHex(rgb){
            if(!rgb)return '#333333';
            if(rgb.startsWith('#'))return rgb;
            var match=rgb.match(/\d+/g);
            if(!match||match.length<3)return '#333333';
            return '#'+match.slice(0,3).map(function(x){return parseInt(x).toString(16).padStart(2,'0');}).join('');
        }
        function deleteContextTarget(){
            if(currentContextTarget){
                // å¦‚æœæ˜¯user-textï¼Œæ£€æŸ¥æ˜¯å¦åœ¨wrapperä¸­
                var wrapper=currentContextTarget.closest('.user-text-wrapper');
                if(wrapper){
                    wrapper.remove();
                }else{
                    currentContextTarget.remove();
                }
                GBFGuide.Storage.save();
            }
        }
        function resetTextStyle(){
            if(currentContextTarget){
                currentContextTarget.removeAttribute('data-custom-size');
                currentContextTarget.removeAttribute('data-custom-color');
                currentContextTarget.style.fontSize='';
                currentContextTarget.style.color='';
                applyDefaultFontSize();
                GBFGuide.Storage.save();
            }
        }
        
        // å®šä¹‰é˜¶æ®µé¢œè‰²å¾ªç¯é¡ºåº
        var PHASE_CLASSES = ['phase-100-80', 'phase-80-60', 'phase-60-20', 'phase-20-0'];
        
        // å¿«é€Ÿæ·»åŠ BOSSå›¾å¼¹çª—
        function showQuickAddBoss(btn){
            var th = btn.closest('th');
            var img = th.querySelector('img');
            var currentUrl = img ? img.src : '';
            
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            modal.innerHTML = 
                '<h3>ğŸ‰ å¿«é€Ÿæ·»åŠ BOSSå¤§å›¾</h3>'+
                '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8\',\'_blank\')">ğŸ”— WikiæŸ¥è¯¢BOSS</button>'+
                '<label>BOSSå›¾ç‰‡URL:</label>'+
                '<input type="text" id="bossImageUrl" placeholder="å³é”®Wiki BOSSå›¾ç‰‡ â†’ å¤åˆ¶å›¾ç‰‡åœ°å€ â†’ ç²˜è´´åˆ°è¿™é‡Œ" value="'+currentUrl+'">'+
                '<div class="hint">æ”¯æŒæ ¼å¼: huijistatic.com / granbluefantasy.akamaized.net</div>'+
                '<label>é¢„è§ˆ:</label>'+
                '<div class="preview-area">'+
                    '<img id="previewBoss" src="'+(currentUrl||EMPTY_IMAGE_SRC)+'" style="max-width:200px;max-height:100px;border:1px solid var(--border-color);border-radius:4px;">'+
                '</div>'+
                '<div class="btn-row">'+
                    '<button class="btn-secondary" id="bossAddCancel">å–æ¶ˆ</button>'+
                    '<button class="btn-primary" id="bossAddConfirm">ç¡®å®š</button>'+
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            var urlInput = modal.querySelector('#bossImageUrl');
            var previewImg = modal.querySelector('#previewBoss');
            
            // å®æ—¶é¢„è§ˆ
            urlInput.addEventListener('input', function(){
                var url = this.value.trim();
                if(url){
                    previewImg.src = url;
                }
            });
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirm = function(){
                var newUrl = urlInput.value.trim();
                if(img){
                    if(newUrl){
                        img.src = newUrl;
                    } else {
                        // å¦‚æœURLä¸ºç©ºï¼Œè®¾ç½®ä¸ºå ä½ç¬¦
                        img.src = EMPTY_IMAGE_SRC;
                    }
                    GBFGuide.Storage.save();
                    if(window.updateBossEmptyState) window.updateBossEmptyState();
                }
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#bossAddCancel').onclick = close;
            modal.querySelector('#bossAddConfirm').onclick = confirm;
            urlInput.focus();
            urlInput.select();
            
            urlInput.onkeydown = function(e){
                if(e.key === 'Enter') confirm();
                if(e.key === 'Escape') close();
            };
        }
        
        // å¿«é€Ÿæ·»åŠ çŠ¶æ€å›¾æ ‡å¼¹çª—ï¼ˆä½¿ç”¨é€šç”¨å·¥å…·å‡½æ•°é‡æ„ï¼‰
        function showQuickAddStatus(btn){
            var th = btn.closest('th');
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // è¯»å–ç°æœ‰çŠ¶æ€å›¾æ ‡URL
            var existingUrls = [];
            th.querySelectorAll('.skill-box img').forEach(function(img){
                existingUrls.push(img.src);
            });
            
            // æ ¹æ®ç°æœ‰çŠ¶æ€å›¾æ ‡æ•°é‡å†³å®šåˆå§‹æ§½æ•°ï¼ˆè‡³å°‘1ä¸ªï¼‰
            var statusSlotCount = Math.max(1, existingUrls.length);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç”Ÿæˆè¾“å…¥è¡ŒHTML
            var inputsHtml = generateInputRowsHtml({
                existingUrls: existingUrls,
                slotCount: statusSlotCount,
                labelPrefix: 'çŠ¶æ€',
                inputClass: 'status-url-input',
                previewClass: 'skill-input-preview'
            });
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: 'BOSS' }) +
                '<h3>ğŸ”® ç¼–è¾‘çŠ¶æ€å›¾æ ‡</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8\',\'_blank\')">ğŸ”— WikiæŸ¥è¯¢BOSS</button>' +
                '</div>' +
                '<label style="margin-top:10px;display:block;">çŠ¶æ€å›¾æ ‡:</label>' +
                '<div class="skill-inputs-container" id="statusInputsContainer">' + inputsHtml + '</div>' +
                '<div class="hint">ç•™ç©º = åˆ é™¤è¯¥ä½ç½®çš„çŠ¶æ€å›¾æ ‡</div>' +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="statusAddCancel">å–æ¶ˆ</button>' +
                    '<button class="btn-primary" id="statusAddConfirm">ç¡®å®šä¿å­˜</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½®å¸®åŠ©æŒ‰é’®
            setupHelpButton(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶ï¼ˆç²˜è´´ã€æ‹–æ‹½ã€é¢„è§ˆï¼‰
            bindModalInputEvents(modal, 'status-url-input');
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½® +/- æŒ‰é’®
            setupInputRowButtons(modal, 'statusInputsContainer', 'status-url-input', 'skill-input-preview', 'çŠ¶æ€', 20, 1);
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                // æ”¶é›†æ‰€æœ‰çŠ¶æ€å›¾æ ‡URL
                var newUrls = [];
                modal.querySelectorAll('.status-url-input').forEach(function(input) {
                    var url = input.value.trim();
                    if (url) newUrls.push(url);
                });
                
                // æ¸…ç©ºç°æœ‰çŠ¶æ€å›¾æ ‡
                th.querySelectorAll('.skill-box').forEach(function(box) {
                    box.remove();
                });
                
                // æ·»åŠ æ–°çŠ¶æ€å›¾æ ‡
                var editBtn = th.querySelector('.mini-fab.edit, .btn-edit-glass');
                newUrls.forEach(function(url) {
                    var box = createSkillBox(url, {
                        className: 'skill-box skill-source',
                        size: 33,
                        editable: true,
                        deletable: true,
                        sourceType: 'status',
                        dragImageSize: 16
                    });
                    
                    if (editBtn) {
                        th.insertBefore(box, editBtn);
                    } else {
                        th.appendChild(box);
                    }
                });
                
                GBFGuide.Storage.save();
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#statusAddCancel').onclick = close;
            modal.querySelector('#statusAddConfirm').onclick = confirmSave;
        }
        
        // åŒå‡»å›¾ç‰‡ä¿®æ”¹URL
        function editImageUrl(img){
            var currentUrl = img.src;
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'text-input-modal';
            modal.innerHTML = '<div style="margin-bottom:10px;color:var(--text-primary);">ä¿®æ”¹å›¾ç‰‡URL:</div><input type="text" style="width:400px;" value="'+currentUrl+'"><button>ç¡®å®š</button><button style="margin-left:5px;">å–æ¶ˆ</button>';
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            var input = modal.querySelector('input');
            input.focus();
            input.select();
            var submit = function(){
                var newUrl = input.value.trim();
                if(newUrl && newUrl !== currentUrl){
                    img.src = newUrl;
                    GBFGuide.Storage.save();
                }
                overlay.remove();
                modal.remove();
            };
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            modal.querySelectorAll('button')[0].onclick = submit;
            modal.querySelectorAll('button')[1].onclick = close;
            overlay.onclick = close;
            input.onkeydown = function(e){
                if(e.key === 'Enter') submit();
                if(e.key === 'Escape') close();
            };
        }
        
        // å¿«é€Ÿæ·»åŠ è§’è‰²å¼¹çª—
        function showQuickAddCharacter(headerCell){
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // è·å–å½“å‰åˆ—çš„åæ ‡ (ä¿®å¤ç‰ˆ - æ”¯æŒæ¢äººè¡Œåæ ‡)
            var coordEl = headerCell.querySelector('.coord-header');
            var colId = '';
            var rowId = '';
            var isSwapRow = false;
            if(coordEl){
                // [ä¿®å¤] æ­£åˆ™æ”¹ä¸ºæ”¯æŒ 'SW1' è¿™æ ·çš„åæ ‡
                var match = coordEl.textContent.match(/\(([\w\d]+),([A-Z])\)/);
                if(match) {
                    rowId = match[1];
                    colId = match[2];
                    isSwapRow = rowId.startsWith('SW');
                }
            }
            
            // Eåˆ—æ˜¯ä¸»è§’ï¼Œä½¿ç”¨èŒä¸šç¼–è¾‘æ¨¡å¼ï¼ˆä»…é™æ™®é€šè¡Œï¼‰
            var isMainChar = (colId === 'E' && !isSwapRow);
            
            // è¯»å–ç°æœ‰æ•°æ®
            var existingAvatarUrl = '';
            var avatarImg = headerCell.querySelector('img');
            if(avatarImg) existingAvatarUrl = avatarImg.src;
            
            var existingSkillUrls = [];
            // [ä¿®å¤] æ¢äººè¡Œéœ€è¦ä»å¯¹åº”çš„ swap-source-row è¯»å–æŠ€èƒ½
            var skillSourceRow = isSwapRow 
                ? document.querySelector('.swap-source-row[data-swap-id="' + headerCell.closest('.swap-header-row').getAttribute('data-swap-id') + '"]')
                : document.querySelector('.skill-source-row');
            if(skillSourceRow){
                var skillCells = skillSourceRow.querySelectorAll('td');
                skillCells.forEach(function(cell){
                    var cellCoordEl = cell.querySelector('.coord');
                    if(cellCoordEl){
                        // [ä¿®å¤] æ­£åˆ™æ”¹ä¸ºæ”¯æŒ 'SRC1' è¿™æ ·çš„åæ ‡
                        var cellMatch = cellCoordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                        if(cellMatch && cellMatch[2] === colId){
                            cell.querySelectorAll('.skill-box img').forEach(function(img){
                                existingSkillUrls.push(img.src);
                            });
                        }
                    }
                });
            }
            
            // æ ¹æ®ç°æœ‰æŠ€èƒ½æ•°é‡å†³å®šåˆå§‹æ§½æ•°ï¼ˆè‡³å°‘4ä¸ªï¼‰
            var skillSlotCount = Math.max(4, existingSkillUrls.length);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç”ŸæˆæŠ€èƒ½è¾“å…¥è¡ŒHTML
            var skillInputsHtml = generateInputRowsHtml({
                existingUrls: existingSkillUrls,
                slotCount: skillSlotCount,
                labelPrefix: 'æŠ€èƒ½',
                inputClass: 'skill-url-input',
                previewClass: 'skill-input-preview'
            });
            
            // ä¸»è§’å¸¸ç”¨æŠ€èƒ½å¿«æ·æŒ‰é’®
            var quickSkillsHtml = '';
            if(isMainChar){
                var quickSkills = [
                    {name: 'æ—¶é¾™', url: 'https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2516_3.png', special: true},
                    {name: 'åŒæ”»', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/26_2.png', special: false},
                    {name: 'è¿½å‡»', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/44_4.png', special: false},
                    {name: 'å›å¤', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/58_4.png', special: false},
                    {name: 'å¥¥ä¹‰', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/188_3.png', special: false}
                ];
                quickSkillsHtml = '<div class="quick-skills-section">' +
                    '<div class="quick-skill-btns">';
                quickSkills.forEach(function(skill){
                    quickSkillsHtml += '<button type="button" class="quick-skill-btn' + (skill.special ? ' special' : '') + '" ' +
                        'data-url="' + skill.url + '" data-special="' + skill.special + '" title="' + skill.name + '">' +
                        '<img src="' + skill.url + '"></button>';
                });
                quickSkillsHtml += '<button class="wiki-btn wiki-warning more-skills-inline-btn" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E8%B5%84%E6%96%99/EX%E6%8A%80%E8%83%BD\',\'_blank\')">ğŸ”— æ›´å¤šæŠ€èƒ½</button>';
                quickSkillsHtml += '</div></div>';
            }
            
            var title = isMainChar ? 'ç¼–è¾‘èŒä¸š' : 'ç¼–è¾‘è§’è‰²';
            var wikiUrl = isMainChar ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95' : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
            var wikiText = isMainChar ? 'ğŸ”— WikiæŸ¥è¯¢èŒä¸š' : 'ğŸ”— WikiæŸ¥è¯¢è§’è‰²';
            var avatarLabel = isMainChar ? 'èŒä¸šå¤´åƒURL:' : 'è§’è‰²å¤´åƒURL:';
            var partyLinkBtn = '<button class="wiki-btn" onclick="window.open(\'https://game.granbluefantasy.jp/#party/index/0/npc/0\',\'_blank\')">ğŸ”— ç¼–é˜Ÿæ‹–å…¥å›¾ç‰‡</button>';
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: 'è§’è‰²' }) +
                '<h3>' + title + '</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'' + wikiUrl + '\',\'_blank\')">' + wikiText + '</button>' +
                    partyLinkBtn +
                '</div>' +
                '<div class="char-input-row">' +
                    '<span class="char-input-label">' + avatarLabel + '</span>' +
                    '<input type="text" class="char-avatar-input" value="' + existingAvatarUrl + '" placeholder="è¾“å…¥URL">' +
                    '<img class="char-avatar-preview" src="' + (existingAvatarUrl || EMPTY_IMAGE_SRC) + '">' +
                '</div>' +
                '<div class="hint">æ”¯æŒæ ¼å¼: huijistatic.com / granbluefantasy.akamaized.net</div>' +
                '<label style="margin-top:10px;display:block;">æŠ€èƒ½å›¾æ ‡:</label>' +
                '<div class="skill-inputs-container" id="skillInputsContainer">' + skillInputsHtml + '</div>' +
                '<div class="hint">ç•™ç©º = åˆ é™¤è¯¥ä½ç½®çš„æŠ€èƒ½</div>' +
                quickSkillsHtml +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="charAddCancel">å–æ¶ˆ</button>' +
                    '<button class="btn-primary" id="charAddConfirm">ç¡®å®šä¿å­˜</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½®å¸®åŠ©æŒ‰é’®
            setupHelpButton(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç»‘å®šæŠ€èƒ½è¾“å…¥æ¡†äº‹ä»¶ï¼ˆç²˜è´´ã€æ‹–æ‹½ã€é¢„è§ˆï¼‰
            bindModalInputEvents(modal, 'skill-url-input');
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½® +/- æŒ‰é’®
            setupInputRowButtons(modal, 'skillInputsContainer', 'skill-url-input', 'skill-input-preview', 'æŠ€èƒ½', 10, 1);
            
            var avatarInput = modal.querySelector('.char-avatar-input');
            var avatarPreview = modal.querySelector('.char-avatar-preview');
            
            // å®æ—¶é¢„è§ˆå¤´åƒ
            avatarInput.addEventListener('input', function(){
                var url = this.value.trim();
                if(url){
                    avatarPreview.src = url;
                }else{
                    avatarPreview.src = EMPTY_IMAGE_SRC;
                }
            });
            
            // å¿«æ·æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            modal.querySelectorAll('.quick-skill-btn').forEach(function(btn){
                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    var url = this.getAttribute('data-url');
                    var isSpecial = this.getAttribute('data-special') === 'true';
                    var container = modal.querySelector('#skillInputsContainer');
                    var inputs = container.querySelectorAll('.skill-url-input');
                    
                    if(isSpecial){
                        // æ—¶é¾™ç‰¹æ®Šé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ§½ï¼Œå¦‚æœæœ‰åˆ™æ’å…¥æŠ€èƒ½1ï¼Œå…¶ä»–é¡ºå»¶
                        var hasEmptySlot = false;
                        for(var i = 0; i < inputs.length; i++){
                            if(!inputs[i].value.trim()){
                                hasEmptySlot = true;
                                break;
                            }
                        }
                        
                        if(hasEmptySlot){
                            for(var i = inputs.length - 1; i > 0; i--){
                                inputs[i].value = inputs[i-1].value;
                                var preview = inputs[i].parentElement.nextElementSibling;
                                preview.src = inputs[i].value || EMPTY_IMAGE_SRC;
                            }
                            inputs[0].value = url;
                            inputs[0].parentElement.nextElementSibling.src = url;
                        } else {
                            alert('æŠ€èƒ½æ§½å·²æ»¡ï¼Œè¯·å…ˆä½¿ç”¨ + æŒ‰é’®æ·»åŠ æ–°æ§½ä½');
                        }
                    } else {
                        // æ™®é€šæŠ€èƒ½ï¼šå¡«å…¥æœ€åä¸€ä¸ªç©ºæ§½ï¼Œæ²¡ç©ºæ§½å¡«æœ€åä¸€ä¸ª
                        var emptySlot = null;
                        for(var i = 0; i < inputs.length; i++){
                            if(!inputs[i].value.trim()){
                                emptySlot = inputs[i];
                                break;
                            }
                        }
                        if(emptySlot){
                            emptySlot.value = url;
                            emptySlot.parentElement.nextElementSibling.src = url;
                        } else {
                            var lastInput = inputs[inputs.length - 1];
                            lastInput.value = url;
                            lastInput.parentElement.nextElementSibling.src = url;
                        }
                    }
                });
            });
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                var newAvatarUrl = avatarInput.value.trim();
                
                // æ›´æ–°å¤´åƒï¼ˆåŒ…æ‹¬æ¸…ç©ºçš„æƒ…å†µï¼‰
                var avatarImgEl = headerCell.querySelector('img');
                if(avatarImgEl){
                    if(newAvatarUrl){
                        avatarImgEl.src = newAvatarUrl;
                    } else {
                        // å¦‚æœURLä¸ºç©ºï¼Œè®¾ç½®ä¸ºå ä½ç¬¦ï¼ˆä¼šåœ¨ä¿å­˜æ—¶è¢«è¿‡æ»¤æ‰ï¼‰
                        avatarImgEl.src = EMPTY_IMAGE_SRC;
                    }
                }
                
                // æ”¶é›†æŠ€èƒ½URL
                var newSkillUrls = [];
                modal.querySelectorAll('.skill-url-input').forEach(function(input){
                    var url = input.value.trim();
                    if(url) newSkillUrls.push(url);
                });
                
                // æ›´æ–°æŠ€èƒ½æº
                if(skillSourceRow){
                    var skillCells = skillSourceRow.querySelectorAll('td');
                    var targetCell = null;
                    
                    skillCells.forEach(function(cell){
                        var cellCoordEl = cell.querySelector('.coord');
                        if(cellCoordEl){
                            // [ä¿®å¤] æ­£åˆ™æ”¹ä¸ºæ”¯æŒ 'SRC1' è¿™æ ·çš„åæ ‡
                            var cellMatch = cellCoordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                            if(cellMatch && cellMatch[2] === colId){
                                targetCell = cell;
                            }
                        }
                    });
                    
                    if(targetCell){
                        // æ¸…ç©ºç°æœ‰æŠ€èƒ½å›¾æ ‡
                        var existingBoxes = targetCell.querySelectorAll('.skill-box');
                        existingBoxes.forEach(function(box){box.remove();});
                        
                        // ä¿ç•™åæ ‡
                        var coord = targetCell.querySelector('.coord');
                        targetCell.innerHTML = '';
                        if(coord) targetCell.appendChild(coord);
                        
                        // æ·»åŠ æ–°æŠ€èƒ½å›¾æ ‡
                        newSkillUrls.forEach(function(url){
                            var box = createSkillBox(url, {
                                className: 'skill-box skill-source',
                                size: 40,
                                editable: true,
                                deletable: true,
                                sourceType: 'skill',
                                dragImageSize: 20
                            });
                            targetCell.appendChild(box);
                        });
                    }
                }
                
                GBFGuide.Storage.save();
                
                // æ›´æ–°è§’è‰²å¤´åƒçš„ç©ºçŠ¶æ€ (ä¿®å¤ç‰ˆ - æ”¯æŒæ¢äººè¡Œåæ ‡)
                var coordEl = headerCell.querySelector('.coord-header');
                if (coordEl) {
                    var coordText = coordEl.textContent;
                    // [ä¿®å¤] å°è¯•è§£æåæ ‡ï¼Œæ”¯æŒ SW å¼€å¤´çš„æ¢äººè¡Œ
                    var match = coordText.match(/\(([\w\d]+),([A-Z])\)/);
                    if (match && match[1].startsWith('SW')) {
                        // å¦‚æœæ˜¯æ¢äººè¡Œï¼Œè°ƒç”¨æ¢äººè¡Œçš„æ›´æ–°å‡½æ•°
                        if (window.updateSwapCharEmptyState) {
                            window.updateSwapCharEmptyState(headerCell);
                        }
                    } else {
                        // æ™®é€šè¡Œï¼Œè°ƒç”¨åŸæœ‰é€»è¾‘
                        window.updateCharEmptyStateByCoord(coordText);
                    }
                }
                
                // æ›´æ–°æŠ€èƒ½æºçš„ç©ºçŠ¶æ€
                if (colId) {
                    window.updateSkillSourceEmptyState(colId);
                }
                
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#charAddCancel').onclick = close;
            modal.querySelector('#charAddConfirm').onclick = confirmSave;
            
            avatarInput.focus();
        }
        
        // å¿«é€Ÿæ·»åŠ å¬å”¤çŸ³å¼¹çª—ï¼ˆç‹¬ç«‹è¾“å…¥æ¡†ç‰ˆæœ¬ï¼Œå¸¦+/-æŒ‰é’®ï¼‰
        function showQuickAddSummon(cell){
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // è·å–å½“å‰å•å…ƒæ ¼çš„åæ ‡ (ä¿®å¤ç‰ˆ - æ”¯æŒæ¢äººè¡Œåæ ‡)
            var coordEl = cell.querySelector('.coord');
            var colId = '';
            var rowId = '';
            var isSwapRow = false;
            if(coordEl){
                // [ä¿®å¤] æ­£åˆ™æ”¹ä¸ºæ”¯æŒ 'SRC1' è¿™æ ·çš„åæ ‡
                var match = coordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                if(match) {
                    rowId = match[1];
                    colId = match[2];
                    isSwapRow = rowId.startsWith('SRC');
                }
            }
            
            // è¯»å–ç°æœ‰å¬å”¤çŸ³URL
            var existingUrls = [];
            cell.querySelectorAll('.skill-box img').forEach(function(img){
                existingUrls.push(img.src);
            });
            
            // æ ¹æ®ç°æœ‰å¬å”¤çŸ³æ•°é‡å†³å®šåˆå§‹æ§½æ•°ï¼ˆè‡³å°‘1ä¸ªï¼Œæœ€å¤š6ä¸ªï¼‰
            var summonSlotCount = Math.max(1, Math.min(6, existingUrls.length || 1));
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç”Ÿæˆè¾“å…¥è¡ŒHTML
            var inputsHtml = generateInputRowsHtml({
                existingUrls: existingUrls,
                slotCount: summonSlotCount,
                labelPrefix: 'å¬å”¤çŸ³',
                inputClass: 'summon-url-input',
                previewClass: 'summon-input-preview'
            });
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: 'å¬å”¤çŸ³' }) +
                '<h3>ç¼–è¾‘å¬å”¤çŸ³ (' + colId + 'åˆ—)</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/SSR%E5%8F%AC%E5%94%A4%E7%9F%B3\',\'_blank\')">ğŸ”— wikiæ‹–å…¥å¬å”¤çŸ³</button>' +
                    '<button class="wiki-btn" onclick="window.open(\'https://game.granbluefantasy.jp/#party/index/0/npc/0\',\'_blank\')">ğŸ”— ç¼–é˜Ÿæ‹–å…¥å›¾ç‰‡</button>' +
                '</div>' +
                '<label style="margin-top:10px;display:block;">å¬å”¤çŸ³å›¾æ ‡:</label>' +
                '<div class="skill-inputs-container" id="summonInputsContainer">' + inputsHtml + '</div>' +
                '<div class="hint">ç•™ç©º = åˆ é™¤è¯¥ä½ç½®çš„å¬å”¤çŸ³ï¼ˆæœ€å¤š6ä¸ªï¼‰</div>' +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="summonAddCancel">å–æ¶ˆ</button>' +
                    '<button class="btn-primary" id="summonAddConfirm">ç¡®å®šä¿å­˜</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½®å¸®åŠ©æŒ‰é’®
            setupHelpButton(modal);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶ï¼ˆç²˜è´´ã€æ‹–æ‹½ã€é¢„è§ˆï¼‰
            bindModalInputEvents(modal, 'summon-url-input');
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°è®¾ç½® +/- æŒ‰é’®
            setupInputRowButtons(modal, 'summonInputsContainer', 'summon-url-input', 'summon-input-preview', 'å¬å”¤çŸ³', 6, 1);
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                // æ”¶é›†æ‰€æœ‰éç©ºURL
                var newUrls = [];
                modal.querySelectorAll('.summon-url-input').forEach(function(input){
                    var url = input.value.trim();
                    if(url) newUrls.push(url);
                });
                
                // æ¸…ç©ºç°æœ‰å¬å”¤çŸ³å›¾æ ‡
                var existingBoxes = cell.querySelectorAll('.skill-box');
                existingBoxes.forEach(function(box){box.remove();});
                
                // ä¿ç•™åæ ‡å’Œæ·»åŠ æŒ‰é’®
                var coord = cell.querySelector('.coord');
                var addBtn = cell.querySelector('.mini-fab');
                cell.innerHTML = '';
                if(coord) cell.appendChild(coord);
                
                // æ·»åŠ æ–°å¬å”¤çŸ³å›¾æ ‡
                newUrls.forEach(function(url){
                    var box = createSkillBox(url, {
                        className: 'skill-box summon-box skill-source',
                        isSummon: true,
                        editable: true,
                        deletable: true,
                        sourceType: 'summon',
                        dragImageSize: 20
                    });
                    cell.appendChild(box);
                });
                
                // é‡æ–°æ·»åŠ æ·»åŠ æŒ‰é’®
                if(addBtn){
                    cell.appendChild(addBtn);
                }else{
                    var newAddBtn = document.createElement('button');
                    newAddBtn.className = 'mini-fab add';
                    newAddBtn.innerHTML = '+';
                    newAddBtn.title = 'æ·»åŠ å¬å”¤çŸ³';
                    newAddBtn.onclick = function(){ showQuickAddSummon(cell); };
                    cell.appendChild(newAddBtn);
                }
                
                GBFGuide.Storage.save();
                
                // æ›´æ–°å¬å”¤çŸ³ç©ºçŠ¶æ€ (ä¿®å¤ç‰ˆ - æ”¯æŒæ¢äººè¡Œåæ ‡)
                var coordEl = cell.querySelector('.coord');
                if (coordEl) {
                    var coordText = coordEl.textContent;
                    // [ä¿®å¤] æ­£åˆ™æ”¹ä¸ºæ”¯æŒ 'SRC1' è¿™æ ·çš„åæ ‡
                    var match = coordText.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                    if (match) {
                        var rowId = match[1]; // ä¾‹å¦‚ '1' æˆ– 'SRC1'
                        var colId = match[2]; // ä¾‹å¦‚ 'A-B'
                        
                        // åˆ¤æ–­æ˜¯å¦ä¸ºæ¢äººè¡Œ (SRCå¼€å¤´)
                        if (rowId.startsWith('SRC')) {
                            if (window.updateSwapSummonEmptyState) {
                                window.updateSwapSummonEmptyState(cell);
                            }
                        } else {
                            // æ™®é€šè¡Œ
                            var config = summonConfigs.find(function(c) {
                                return c.coord === colId;
                            });
                            if (config) {
                                window.updateSummonEmptyState(colId, config.maxCount, config.showButton);
                            }
                        }
                    }
                }
                
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#summonAddCancel').onclick = close;
            modal.querySelector('#summonAddConfirm').onclick = confirmSave;
            
            // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            modal.querySelector('.summon-url-input').focus();
        }
        
        // ========== é€šç”¨å‡½æ•°ï¼šæ›´æ–°è§’è‰²ç©ºçŠ¶æ€ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰==========
        // [ä¿®æ”¹] ä¿®å¤å›¾ç‰‡ display:none å¯¼è‡´ä¸æ˜¾ç¤ºçš„é—®é¢˜
        window.updateCharEmptyState = function(charHeader, config) {
            if (!charHeader) return;
            
            var img = charHeader.querySelector('img');
            var isEmpty = !isValidImage(img);
            var existingHint = charHeader.querySelector('.empty-state-hint');
            
            if (isEmpty) {
                // [ä¿®å¤] å¦‚æœä¸ºç©ºï¼Œéšè— img æ ‡ç­¾ï¼Œé˜²æ­¢æ˜¾ç¤ºç ´ç¢å›¾æ ‡
                if(img) img.style.display = 'none';
                charHeader.classList.add('has-empty-state');
                if (!existingHint) {
                    var wikiUrl = config.coord === '(0,E)' 
                        ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95'
                        : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
                    var hint = createEmptyHint({
                        className: 'empty-state-hint',
                        text: 'æ‹–å…¥' + config.name + 'å›¾ç‰‡',
                        buttons: [
                            { text: 'ğŸ”— WikiæŸ¥è¯¢', url: wikiUrl },
                            { text: 'ğŸ”— ç¼–é˜ŸæŸ¥è¯¢', url: 'https://game.granbluefantasy.jp/#party/index/0/npc/0' }
                        ]
                    });
                    charHeader.appendChild(hint);
                }
            } else {
                // [ä¿®å¤] å…³é”®ç‚¹ï¼šå¦‚æœæœ‰å›¾ç‰‡ï¼Œå¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡ï¼
                if(img) img.style.display = '';
                charHeader.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== é€šç”¨å‡½æ•°ï¼šæ›´æ–°æŠ€èƒ½æºç©ºçŠ¶æ€ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰==========
        window.updateSkillSourceEmptyState = function(skillCoord) {
            var skillSourceCell = findSkillSourceCell(skillCoord);
            if (!skillSourceCell) return;
            
            var isEmpty = !hasValidImages(skillSourceCell, '.skill-box img');
            var existingHint = skillSourceCell.querySelector('.empty-state-hint');
            
            if (isEmpty) {
                skillSourceCell.classList.add('has-empty-state');
                if(!existingHint) {
                    var hint = createEmptyHint({
                        className: 'empty-state-hint',
                        text: 'æ‹–å…¥æŠ€èƒ½å›¾ç‰‡<br>(æœ€å¤š10ä¸ª)',
                        buttons: []
                    });
                    skillSourceCell.appendChild(hint);
                }
            } else {
                skillSourceCell.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== è¾…åŠ©å‡½æ•°ï¼šé€šè¿‡åæ ‡æ›´æ–°è§’è‰²ç©ºçŠ¶æ€ ==========
        window.updateCharEmptyStateByCoord = function(coordText) {
            var config = characterConfigs.find(function(c) {
                return c.coord === coordText;
            });
            if (config) {
                var charHeader = Array.from(document.querySelectorAll('.character-header')).find(function(th) {
                    var coord = th.querySelector('.coord-header');
                    return coord && coord.textContent.includes(coordText);
                });
                if (charHeader) {
                    window.updateCharEmptyState(charHeader, config);
                }
            }
        };
        
        // ========== é€šç”¨å‡½æ•°ï¼šæ›´æ–°å¬å”¤çŸ³ç©ºçŠ¶æ€ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰==========
        window.updateSummonEmptyState = function(summonCoord, maxCount, showButton) {
            var summonCell = findSkillSourceCell(summonCoord);
            if (!summonCell) return;
            
            var isEmpty = !hasValidImages(summonCell, '.skill-box img');
            var existingHint = summonCell.querySelector('.empty-state-hint, .summon-empty-state-hint');
            
            if (isEmpty) {
                summonCell.classList.add('has-empty-state');
                if(!existingHint) {
                    var buttons = showButton ? [
                        { text: 'ğŸ”— WikiæŸ¥è¯¢', url: 'https://gbf.huijiwiki.com/wiki/SSR%E5%8F%AC%E5%94%A4%E7%9F%B3' },
                        { text: 'ğŸ”— ç¼–é˜ŸæŸ¥è¯¢', url: 'https://game.granbluefantasy.jp/#party/index/0/npc/0' }
                    ] : [];
                    
                    var hint = createEmptyHint({
                        className: 'summon-empty-state-hint',
                        text: 'æ‹–å…¥å¬å”¤çŸ³å›¾ç‰‡<br>(æœ€å¤š' + maxCount + 'ä¸ª)',
                        textClass: 'summon-empty-text',
                        buttonsClass: 'summon-empty-buttons summon-empty-buttons-vertical',
                        buttons: buttons
                    });
                    summonCell.appendChild(hint);
                }
            } else {
                summonCell.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== é€šç”¨å‡½æ•°ï¼šæ›´æ–°BOSSæ ç©ºçŠ¶æ€ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰==========
        window.updateBossEmptyState = function() {
            var topRows = document.querySelectorAll('.top-row');
            if (!topRows[0]) return;
            
            var bossTh = topRows[0].querySelector('th');
            if (!bossTh) return;
            
            var bossImg = bossTh.querySelector('img');
            var isEmpty = !isValidImage(bossImg);
            var existingHint = bossTh.querySelector('.boss-empty-state-hint');
            
            if (isEmpty && !existingHint) {
                var hint = createEmptyHint({
                    className: 'boss-empty-state-hint',
                    text: 'æ‹–å…¥BOSSå›¾ç‰‡',
                    textClass: 'boss-empty-text',
                    buttonsClass: 'boss-empty-buttons',
                    buttons: [{ text: 'ğŸ”— WikiæŸ¥è¯¢BOSS', url: 'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8' }]
                });
                var wikiBtn = hint.querySelector('.wiki-btn-small');
                if (wikiBtn) wikiBtn.className = 'wiki-btn';
                bossTh.appendChild(hint);
                if (bossImg) bossImg.style.display = 'none';
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                if (bossImg) bossImg.style.display = '';
            }
        };
        
        // ========== é€šç”¨å‡½æ•°ï¼šæ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€ï¼ˆå·²ç¦ç”¨ï¼‰==========
        window.updateNoteEmptyState = function(noteCell) {
            // åŠŸèƒ½å·²ç¦ç”¨ - ä¸å†æ˜¾ç¤º"ç‚¹å‡»ç¼–è¾‘"æç¤º
        };
        
        // ========== åˆå§‹åŒ–æ‰€æœ‰å¤‡æ³¨å•å…ƒæ ¼çš„ç©ºçŠ¶æ€ï¼ˆå·²ç¦ç”¨ï¼‰==========
        window.initNoteEmptyStates = function() {
            // åŠŸèƒ½å·²ç¦ç”¨
        };
        
        // ========== é€šç”¨çš„ä¸å¯åˆ é™¤æ–‡å­—è®¾ç½®å‡½æ•° ==========
        function setupUndeletableText(textSpan, defaultName) {
            if (!textSpan) return;
            
            if (textSpan.textContent.trim() === '') {
                textSpan.textContent = defaultName;
            }
            
            // ä½¿ç”¨ onblur æ›¿ä»£ addEventListener é˜²æ­¢é‡å¤ç»‘å®š
            textSpan.onblur = function() {
                var text = this.textContent.trim();
                if (text === '') {
                    this.textContent = defaultName;
                    GBFGuide.Storage.save();
                }
            };
            
            textSpan.oninput = function() {
                var text = this.textContent.trim();
                var self = this;
                if (text === '') {
                    setTimeout(function() {
                        if (self.textContent.trim() === '') {
                            self.textContent = defaultName;
                            GBFGuide.Storage.save();
                        }
                    }, 5000);
                }
            };
        }
        
        // æš´éœ²ç»™å…¨å±€ä½¿ç”¨
        window.setupUndeletableText = setupUndeletableText;
        
        // ========== [é‡æ„] åˆå§‹åŒ–åŠ¨æ€å…ƒç´ å‡½æ•° ==========
        // æ­¤å‡½æ•°åŒ…å«åŸ window.onload ä¸­çš„å¤§éƒ¨åˆ†é€»è¾‘ï¼Œå¯åœ¨é¡µé¢åŠ è½½å’Œåˆ‡æ¢æ¨¡æ¿æ—¶é‡å¤è°ƒç”¨
        function initDynamicElements() {
            // 0. ä¸ºæ‰€æœ‰å•å…ƒæ ¼æ·»åŠ  data-col å±æ€§ï¼ˆç”¨äºæ™ºèƒ½é«˜äº®ç³»ç»Ÿï¼‰
            initColumnDataAttributes();
            
            // 1. ä¸ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å•å…ƒæ ¼æ·»åŠ æŒ‰é’®ï¼ˆåŒ…æ‹¬Dåˆ—ï¼‰
            document.querySelectorAll('tbody td').forEach(function(cell){
                addCellButtons(cell);
            });
            
            // 2. ä¸ºæ‰€æœ‰ I åˆ— (6äºº) æˆ– M åˆ— (9äºº) æ·»åŠ è¡Œæ§é¢æ¿ (åˆå¹¶/æ‹†åˆ†)
            document.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                // [ä¿®æ”¹] å¢åŠ å¯¹ M åˆ—çš„åˆ¤æ–­
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });
            
            // 3. è°ƒæ•´å¬å”¤çŸ³åˆ é™¤æŒ‰é’®ä½ç½®
            setTimeout(function() { adjustAllSummonDeleteButtons(); }, 100);
            
            // 4. è§’è‰²å¤´åƒåŒå‡»ç¼–è¾‘
            document.querySelectorAll('.character-header').forEach(function(th){
                th.style.cursor = 'pointer';
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œä½¿ç”¨ ondblclick æ›¿ä»£ addEventListener é˜²æ­¢é‡å¤ç»‘å®š
                th.ondblclick = function(e){
                    if(e.target.closest('.t-text')) return;
                    e.stopPropagation();
                    showQuickAddCharacter(this);
                };
            });
            
            // 5. åˆå§‹åŒ–ä¸å¯åˆ é™¤çš„æ–‡å­—
            // 5.1 0A-0D è¡¨å¤´
            var headerConfigs = [
                { coord: '(0,A)', name: 'é˜¶æ®µ/HP' },
                { coord: '(0,B)', name: 'è§¦å‘/å›åˆ' },
                { coord: '(0,C)', name: 'å¤‡æ³¨' },
                { coord: '(0,D)', name: 'å¬å”¤çŸ³' }
            ];
            
            headerConfigs.forEach(function(config) {
                var headerTh = Array.from(document.querySelectorAll('thead th')).find(function(th) {
                    var coordEl = th.querySelector('.coord-header');
                    return coordEl && coordEl.textContent.includes(config.coord);
                });
                if (headerTh) {
                    var textSpan = headerTh.querySelector('.t-text');
                    if(textSpan && window.setupUndeletableText) window.setupUndeletableText(textSpan, config.name);
                }
            });
            
            // 5.2 é˜¶æ®µåå’ŒT
            document.querySelectorAll('.t-text.phase-name').forEach(function(textSpan) {
                if(window.setupUndeletableText) window.setupUndeletableText(textSpan, 'é˜¶æ®µçŠ¶æ€');
            });
            document.querySelectorAll('.b-cell-content .t-text').forEach(function(textSpan) {
                if(window.setupUndeletableText) window.setupUndeletableText(textSpan, 'T');
            });
            
            // 6. ä¸ºè§’è‰²æ åˆå§‹åŒ–ï¼šåˆ é™¤æŒ‰é’®ã€ç©ºçŠ¶æ€ã€æ‹–æ‹½
            characterConfigs.forEach(function(config) {
                var charHeader = Array.from(document.querySelectorAll('.character-header')).find(function(th) {
                    var coord = th.querySelector('.coord-header');
                    return coord && coord.textContent.includes(config.coord);
                });
                
                if (!charHeader) return;
                
                // 6.1 æ·»åŠ åˆ é™¤æŒ‰é’®
                if (!charHeader.querySelector('.delete-char-btn')) {
                    var deleteBtn = document.createElement('button');
                    deleteBtn.className = 'mini-fab delete delete-char-btn';
                    deleteBtn.innerHTML = 'âˆ’';
                    deleteBtn.title = 'æ¸…ç©º' + config.name + 'ã€æŠ€èƒ½æºåŠæ–‡å­—';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (!confirm('ç¡®å®šè¦é‡ç½®' + config.name + 'çš„æ‰€æœ‰å†…å®¹å—ï¼Ÿ')) return;
                        
                        var img = charHeader.querySelector('img');
                        if (img) img.src = EMPTY_IMAGE_SRC;
                        
                        var nameSpan = charHeader.querySelector('.char-name');
                        if (nameSpan) nameSpan.textContent = config.name;
                        
                        var skillSourceRow = document.querySelector('.skill-source-row');
                        if (skillSourceRow) {
                            var skillCells = skillSourceRow.querySelectorAll('td');
                            skillCells.forEach(function(cell) {
                                var coordEl = cell.querySelector('.coord');
                                if (coordEl) {
                                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                    if (match && match[2] === config.skillCoord) {
                                        cell.querySelectorAll('.skill-box').forEach(function(b) { b.remove(); });
                                    }
                                }
                            });
                        }
                        
                        GBFGuide.Storage.save();
                        window.updateCharEmptyState(charHeader, config);
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    };
                    charHeader.appendChild(deleteBtn);
                }
                
                // 6.2 ç¡®ä¿è§’è‰²åå­˜åœ¨
                var charNameSpan = charHeader.querySelector('.char-name');
                if (!charNameSpan) {
                    charNameSpan = document.createElement('span');
                    charNameSpan.className = 'header-text t-text char-name';
                    charNameSpan.setAttribute('contenteditable', 'true');
                    charNameSpan.setAttribute('onblur', 'GBFGuide.Storage.save()');
                    charNameSpan.textContent = config.name;
                    var editBtn = charHeader.querySelector('.mini-fab.edit, .btn-edit-glass');
                    if (editBtn) {
                        charHeader.insertBefore(charNameSpan, editBtn);
                    } else {
                        charHeader.appendChild(charNameSpan);
                    }
                }
                
                if (charNameSpan.textContent.trim() === '') {
                    charNameSpan.textContent = config.name;
                }
                
                // 6.3 ç»‘å®šå¤–éƒ¨æ‹–æ‹½ (ä½¿ç”¨ on* å±æ€§é˜²æ­¢é‡å¤ç»‘å®š)
                charHeader.classList.add('drag-drop-zone');
                charHeader.ondragover = function(e) { e.preventDefault(); this.classList.add('drag-over'); };
                charHeader.ondragleave = function(e) { this.classList.remove('drag-over'); };
                charHeader.ondrop = function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('ä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                        return;
                    }
                    if (url) {
                        var img = this.querySelector('img');
                        if (img) {
                            img.src = url;
                        } else {
                            img = document.createElement('img');
                            img.src = url;
                            var br = this.querySelector('br');
                            if (br) this.insertBefore(img, br.nextSibling);
                            else this.appendChild(img);
                        }
                        GBFGuide.Storage.save();
                        window.updateCharEmptyState(charHeader, config);
                    }
                };
                
                // 6.4 åˆå§‹åŒ–ç©ºçŠ¶æ€
                window.updateCharEmptyState(charHeader, config);
                window.updateSkillSourceEmptyState(config.skillCoord);
            });
            
            // 7. æŠ€èƒ½æºæ ¼å­çš„æ‹–æ‹½
            characterConfigs.forEach(function(config) {
                var skillSourceCell = null;
                var skillSourceRow = document.querySelector('.skill-source-row');
                if (skillSourceRow) {
                    var skillCells = skillSourceRow.querySelectorAll('td');
                    skillCells.forEach(function(cell) {
                        var coordEl = cell.querySelector('.coord');
                        if (coordEl) {
                            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                            if (match && match[2] === config.skillCoord) {
                                skillSourceCell = cell;
                            }
                        }
                    });
                }
                
                if (!skillSourceCell) return;
                
                skillSourceCell.classList.add('drag-drop-zone');
                skillSourceCell.ondragover = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (isExternal) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    }
                };
                skillSourceCell.ondragleave = function(e) { this.classList.remove('drag-over'); };
                skillSourceCell.ondrop = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (!isExternal) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('drag-over');
                    
                    var currentCount = this.querySelectorAll('.skill-box').length;
                    if (currentCount >= 10) {
                        alert('æŠ€èƒ½å·²è¾¾ä¸Šé™ï¼ˆ10ä¸ªï¼‰ï¼Œè¯·å…ˆåˆ é™¤éƒ¨åˆ†æŠ€èƒ½');
                        return;
                    }
                    
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('ä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                        return;
                    }
                    
                    if (url) {
                        var box = createSkillBox(url, {
                            className: 'skill-box skill-source',
                            size: 40,
                            editable: true,
                            deletable: true,
                            sourceType: 'skill',
                            dragImageSize: 20
                        });
                        this.appendChild(box);
                        GBFGuide.Storage.save();
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    }
                };
            });
            
            // 8. å¬å”¤çŸ³é…ç½®åˆå§‹åŒ–
            summonConfigs.forEach(function(config) {
                var summonCell = null;
                var skillSourceRow = document.querySelector('.skill-source-row');
                if (skillSourceRow) {
                    var cells = skillSourceRow.querySelectorAll('td');
                    cells.forEach(function(cell) {
                        var coordEl = cell.querySelector('.coord');
                        if (coordEl) {
                            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                            if (match && match[2] === config.coord) {
                                summonCell = cell;
                            }
                        }
                    });
                }
                
                if (!summonCell) return;
                
                // 8.1 æ·»åŠ åˆ é™¤æŒ‰é’®
                if (!summonCell.querySelector('.delete-char-btn')) {
                    var db = document.createElement('button');
                    db.className = 'mini-fab delete delete-char-btn';
                    db.innerHTML = 'âˆ’';
                    db.title = 'æ¸…ç©º' + config.name;
                    db.style.left = '2px';
                    db.style.top = '2px';
                    db.onclick = function(e) {
                        e.stopPropagation();
                        if (confirm('ç¡®å®šè¦æ¸…ç©º' + config.name + 'å—ï¼Ÿ')) {
                            summonCell.querySelectorAll('.skill-box').forEach(function(b) { b.remove(); });
                            GBFGuide.Storage.save();
                            window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                        }
                    };
                    summonCell.appendChild(db);
                    summonCell.classList.add('has-fab');
                }
                
                // 8.2 å¤–éƒ¨æ‹–æ‹½åŠŸèƒ½
                summonCell.classList.add('drag-drop-zone');
                summonCell.ondragover = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (isExternal) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    }
                };
                summonCell.ondragleave = function(e) { this.classList.remove('drag-over'); };
                summonCell.ondrop = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (!isExternal) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('drag-over');
                    
                    var currentCount = this.querySelectorAll('.skill-box').length;
                    if (currentCount >= config.maxCount) {
                        alert('å¬å”¤çŸ³å·²è¾¾ä¸Šé™ï¼ˆ' + config.maxCount + 'ä¸ªï¼‰ï¼Œè¯·å…ˆåˆ é™¤éƒ¨åˆ†å¬å”¤çŸ³');
                        return;
                    }
                    
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('ä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                        return;
                    }
                    
                    if (url) {
                        var box = createSkillBox(url, {
                            className: 'skill-box summon-box skill-source',
                            isSummon: true,
                            editable: true,
                            deletable: true,
                            sourceType: 'summon',
                            dragImageSize: 20
                        });
                        var addBtn = this.querySelector('.mini-fab.add');
                        if (addBtn) this.insertBefore(box, addBtn);
                        else this.appendChild(box);
                        GBFGuide.Storage.save();
                        window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                    }
                };
                
                // 8.3 åˆå§‹åŒ–ç©ºçŠ¶æ€
                window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
            });
            
            // 9. å¬å”¤çŸ³åŒå‡»å¿«é€Ÿæ·»åŠ 
            // [ä¿®å¤] åªä¸ºä¸»è¡¨å¤´çš„å¬å”¤çŸ³æ ¼ç»‘å®šåŒå‡»äº‹ä»¶ï¼Œæ¢äººè¡Œç”± initSwapRowElements å¤„ç†
            document.querySelectorAll('.skill-source-row:not(.swap-source-row) td').forEach(function(cell){
                var coordEl = cell.querySelector('.coord');
                if(coordEl){
                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if(match){
                        var col = match[2];
                        if(col === 'A-B' || col === 'C'){
                            cell.style.cursor = 'pointer';
                            cell.ondblclick = function(e){
                                if(e.target.tagName === 'IMG') return;
                                e.stopPropagation();
                                showQuickAddSummon(this);
                            };
                        }
                    }
                }
            });
            
            // 10. BOSSæ åˆå§‹åŒ–
            if(window.updateBossEmptyState) window.updateBossEmptyState();
            
            // 10.5 å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€åˆå§‹åŒ–
            if(window.initNoteEmptyStates) window.initNoteEmptyStates();
            
            // 11. BOSSæ æ‹–æ‹½
            var topRows = document.querySelectorAll('.top-row');
            if(topRows[0]){
                var bossTh = topRows[0].querySelector('th');
                if(bossTh){
                    bossTh.classList.add('drag-drop-zone');
                    bossTh.ondragover = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (isExternal) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        }
                    };
                    bossTh.ondragleave = function(e) { this.classList.remove('drag-over'); };
                    bossTh.ondrop = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (!isExternal) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');
                        
                        var url = '';
                        if (e.dataTransfer.getData('text/html')) {
                            var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                            if (match) url = match[1];
                        }
                        if (!url && e.dataTransfer.getData('text/plain')) {
                            var text = e.dataTransfer.getData('text/plain').trim();
                            if (text.match(/^https?:\/\//i)) url = text;
                        }
                        if (!url && e.dataTransfer.files.length > 0) {
                            alert('ä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                            return;
                        }
                        
                        if (url) {
                            var bossImg = this.querySelector('img');
                            if(bossImg) bossImg.src = url;
                            GBFGuide.Storage.save();
                            if(window.updateBossEmptyState) window.updateBossEmptyState();
                        }
                    };
                }
            }
            
            // 12. çŠ¶æ€å›¾æ ‡è¡Œæ‹–æ‹½
            if(topRows[1]){
                var statusTh = topRows[1].querySelector('th');
                if(statusTh){
                    statusTh.classList.add('drag-drop-zone');
                    statusTh.ondragover = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (isExternal) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        }
                    };
                    statusTh.ondragleave = function(e) { this.classList.remove('drag-over'); };
                    statusTh.ondrop = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (!isExternal) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');
                        
                        var url = '';
                        if (e.dataTransfer.getData('text/html')) {
                            var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                            if (match) url = match[1];
                        }
                        if (!url && e.dataTransfer.getData('text/plain')) {
                            var text = e.dataTransfer.getData('text/plain').trim();
                            if (text.match(/^https?:\/\//i)) url = text;
                        }
                        if (!url && e.dataTransfer.files.length > 0) {
                            alert('ä¸æ”¯æŒæœ¬åœ°æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åœ¨çº¿å›¾ç‰‡URL');
                            return;
                        }
                        
                        if (url) {
                            var box = createSkillBox(url, {
                                className: 'skill-box skill-source',
                                size: 33,
                                editable: true,
                                deletable: true,
                                sourceType: 'status',
                                dragImageSize: 16
                            });
                            var editBtn = this.querySelector('.mini-fab.edit, .btn-edit-glass');
                            if(editBtn) this.insertBefore(box, editBtn);
                            else this.appendChild(box);
                            GBFGuide.Storage.save();
                        }
                    };
                }
            }
            
            // 13. ç»‘å®šåŸºæœ¬æ‹–æ‹½
            document.querySelectorAll('.skill-source').forEach(function(el){
                bindDragEvents(el, 20);
            });
            // [ä¿®å¤] æ’é™¤æ¢äººè¡Œçš„æ ¼å­ï¼Œé¿å…ä¸ initSwapRowElements çš„äº‹ä»¶ç›‘å¬å™¨å†²çªå¯¼è‡´åŒé‡å›¾æ ‡
            document.querySelectorAll('tbody td').forEach(function(cell){
                // è·³è¿‡æ¢äººè¡Œçš„æ ¼å­ï¼ˆswap-header-row å’Œ swap-source-rowï¼‰
                var parentRow = cell.closest('tr');
                if(parentRow && (parentRow.classList.contains('swap-header-row') || parentRow.classList.contains('swap-source-row'))) {
                    return; // è¿™äº›æ ¼å­ç”± initSwapRowElements ä¸“é—¨å¤„ç†
                }
                bindCellEvents(cell);
            });
            
            // 14. å›¾ç‰‡åŒå‡»ç¼–è¾‘
            document.querySelectorAll('.skill-source-row img, .top-row img').forEach(function(img){
                img.style.cursor = 'pointer';
                img.ondblclick = function(e){
                    e.stopPropagation();
                    editImageUrl(this);
                };
            });
            
            // 15. ä¸ºæºæŠ€èƒ½/å¬å”¤çŸ³/çŠ¶æ€å›¾æ ‡æ·»åŠ åˆ é™¤æŒ‰é’®
            initSourceDeleteButtons();
        }
        
        // [æ–°å¢] é›†ä¸­ç®¡ç†å·¥å…·æ æŒ‰é’®çŠ¶æ€
        function updateSwapButtonState() {
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            
            // 1. æ§åˆ¶"å¢åŠ æ¢äººè¡Œ"æŒ‰é’®æ˜¾éš
            var swapBtn = document.getElementById('btnAddSwapRow');
            if (swapBtn) {
                swapBtn.style.display = is9Man ? 'inline-flex' : 'none';
            }
            
            // 2. åŠ¨æ€æ›´æ–°"é‡ç½®"æŒ‰é’®çš„æç¤º
            var resetBtn = document.getElementById('btnReset');
            if (resetBtn) {
                if (is9Man) {
                    resetBtn.setAttribute('data-tooltip', 'âš ï¸ é‡ç½®ä¸ºã€9äººæ¨¡å¼ã€‘é»˜è®¤çŠ¶æ€');
                } else {
                    resetBtn.setAttribute('data-tooltip', 'âš ï¸ é‡ç½®ä¸ºã€6äººæ¨¡å¼ã€‘é»˜è®¤çŠ¶æ€');
                }
            }
        }
        
        window.onload=function(){
            loadDefaultFontSize();
            loadIconScale();
            // applyDefaultFontSize(); // [åˆ é™¤] loadTemplate å†…éƒ¨ä¼šè°ƒç”¨
            loadCoordsState();
            
            // åˆå§‹åŒ–åˆ›ä½œè€…ç³»ç»Ÿ
            initAuthorSystem();
            
            // åŠ è½½æ•°æ® (å†…éƒ¨é€»è¾‘å·²ç»åŒ…å«äº† initDynamicElements)
            loadFromStorage();
            
            // [åˆ é™¤] ä¸‹é¢è¿™è¡Œæ˜¯é‡å¤è°ƒç”¨ï¼ŒloadFromStorage -> loadTemplate å·²ç»åšè¿‡äº†
            // initDynamicElements();
            
            // [æ–°å¢] åˆ·æ–°é˜¶æ®µé¢œè‰²ï¼Œç¡®ä¿é¡µé¢åŠ è½½æ—¶é¢œè‰²æ­£ç¡®
            refreshPhaseColors();
            
            // [ä¿®æ”¹] ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æ£€æŸ¥æŒ‰é’®çŠ¶æ€
            updateSwapButtonState();
            
            // ç›‘å¬çª—å£è°ƒæ•´
            window.addEventListener('resize', function() {
                setTimeout(adjustAllSummonDeleteButtons, 100);
            });
        };
        
        // [é‡æ„] é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜å¾…å¤„ç†çš„æ•°æ®
        window.addEventListener('beforeunload', function() {
            GBFGuide.Storage.flush();
        });
        
        function bindCellEvents(cell){
            // 1. æ‹–æ‹½è¿›å…¥ï¼šæ·»åŠ é«˜äº®æ ·å¼
            cell.addEventListener('dragenter', function(e){
                e.preventDefault();
                if(draggedElement || e.dataTransfer.types.length > 0) {
                    this.classList.add('drag-feedback');
                }
            });
            
            // 2. æ‹–æ‹½æ‚¬åœï¼šä¿æŒå…è®¸æ”¾ç½®çŠ¶æ€
            cell.addEventListener('dragover',function(e){
                e.preventDefault();
                e.dataTransfer.dropEffect='copy';
                if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)){
                    this.classList.add('drag-feedback');
                }
            });
            
            // 3. æ‹–æ‹½ç¦»å¼€ï¼šç§»é™¤é«˜äº®æ ·å¼
            cell.addEventListener('dragleave', function(e){
                if (e.target === this) {
                    this.classList.remove('drag-feedback');
                }
            });
            
            // 4. æ”¾ç½®ï¼šç§»é™¤é«˜äº®å¹¶å¤„ç†é€»è¾‘
            cell.addEventListener('drop',function(e){
                e.preventDefault();
                this.classList.remove('drag-feedback');
                if(draggedElement){
                    var targetBox=e.target.closest('.skill-box');
                    var clone=draggedElement.cloneNode(true);
                    clone.classList.remove('skill-source');
                    clone.classList.add('has-fab');
                    bindDragEvents(clone, 20);
                    clone.addEventListener('contextmenu',function(ev){ev.preventDefault();this.remove();GBFGuide.Storage.save();});
                    // æ·»åŠ åˆ é™¤æŒ‰é’®
                    var delBtn = document.createElement('button');
                    delBtn.className = 'mini-fab delete';
                    delBtn.innerHTML = 'Ã—';
                    delBtn.title = 'åˆ é™¤';
                    delBtn.onclick = function(ev){
                        ev.stopPropagation();
                        clone.remove();
                        GBFGuide.Storage.save();
                    };
                    clone.appendChild(delBtn);
                    
                    // å¦‚æœæ˜¯å¬å”¤çŸ³ï¼Œè°ƒæ•´åˆ é™¤æŒ‰é’®ä½ç½®
                    if (clone.classList.contains('summon-box')) {
                        adjustSummonDeleteButton(clone);
                        applyIconScalingToElement(clone);
                    } else {
                        applyIconScalingToElement(clone);
                    }
                    if(targetBox&&!targetBox.classList.contains('skill-source')){
                        targetBox.before(clone);
                    }else{
                        this.appendChild(clone);
                    }
                    if(!draggedElement.classList.contains('skill-source')){var sourceCell=draggedElement.closest('td')||draggedElement.closest('th');if(sourceCell===this){draggedElement.remove();}}
                    GBFGuide.Storage.save();
                }
            });
            
            cell.addEventListener('dblclick',function(e){
                // åŒå‡»æ·»åŠ æ–‡å­—åŠŸèƒ½å·²ç”±æŒ‰é’®æ›¿ä»£
            });
            
            // ä¸ºç¬¦åˆæ¡ä»¶çš„å•å…ƒæ ¼æ·»åŠ æŒ‰é’®ï¼ˆå‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­åˆ—å·ï¼‰
            addCellButtons(cell);
        }
        
        document.addEventListener('contextmenu',function(e){
            // åŸæœ‰çš„æŠ€èƒ½/æ–‡å­—å³é”®é€»è¾‘
            var box=e.target.closest('.skill-box');
            if(box&&!box.classList.contains('skill-source')){e.preventDefault();box.remove();GBFGuide.Storage.save();return;}
            var text=e.target.closest('.user-text');
            if(text){showContextMenu(e,text,'user-text');return;}
            var ttext=e.target.closest('.t-text');
            if(ttext){showContextMenu(e,ttext,'t-text');return;}
        });
        
        function getCellCoord(cell){
            var coord=cell.querySelector('.coord');
            if(coord){
                // æ”¯æŒ (2,B) å’Œ (2-6,A) ä¸¤ç§æ ¼å¼
                var match=coord.textContent.match(/\((\d+)(?:-\d+)?,([A-Z\-]+)\)/);
                if(match)return{row:parseInt(match[1]),col:match[2]};
            }
            return null;
        }
        function findCellByCoord(row,col){
            var cells=document.querySelectorAll('tbody td');
            for(var i=0;i<cells.length;i++){
                var c=getCellCoord(cells[i]);
                if(c&&c.col===col){
                    // Aåˆ—æ˜¯rowspanå•å…ƒæ ¼ï¼Œæ£€æŸ¥rowæ˜¯å¦åœ¨èŒƒå›´å†…
                    if(col==='A'){
                        var rowspan=parseInt(cells[i].getAttribute('rowspan'))||1;
                        if(row>=c.row&&row<c.row+rowspan)return cells[i];
                    }else if(c.row===row){
                        return cells[i];
                    }
                }
            }
            return null;
        }
        
        // è·å–å•å…ƒæ ¼çš„è¡Œç´¢å¼•(åŸºäºDOMä½ç½®)
        function getCellRowIndex(cell){
            var row=cell.closest('tr');
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            return rows.indexOf(row);
        }
        
        // è·å–å•å…ƒæ ¼çš„åˆ—æ ‡è¯†(åŸºäºDOMä½ç½®)
        // [ä¿®æ”¹] åˆ—æ˜ å°„æ‰©å……åˆ° M åˆ—ï¼Œæ”¯æŒ 9 äººæ¨¡å¼
        function getCellColId(cell){
            var row=cell.closest('tr');
            var cells=Array.from(row.querySelectorAll('td'));
            var cellIndex=cells.indexOf(cell);
            var hasRowspanCell=row.querySelector('td[rowspan]');
            // åˆ—æ˜ å°„: æœ‰rowspançš„è¡Œä»Aå¼€å§‹ï¼Œæ²¡æœ‰çš„ä»Bå¼€å§‹ï¼ˆè¢«rowspanè¦†ç›–ï¼‰
            var cols=['A','B','C','D','E','F','G','H','I','J','K','L','M'];
            if(!hasRowspanCell){
                // æ£€æŸ¥æ˜¯å¦æ˜¯è¢«rowspanè¦†ç›–çš„è¡Œ
                var rowIdx=getCellRowIndex(cell);
                var isInPhase=false;
                var tbody=document.querySelector('tbody');
                var rows=Array.from(tbody.querySelectorAll('tr'));
                for(var i=rowIdx;i>=0;i--){
                    var rs=rows[i].querySelector('td[rowspan]');
                    if(rs){
                        var rowspan=parseInt(rs.getAttribute('rowspan'))||1;
                        if(i+rowspan>rowIdx){isInPhase=true;break;}
                    }
                }
                if(isInPhase){cols=['B','C','D','E','F','G','H','I','J','K','L','M'];}
            }else{
                cols=['A','B','C','D','E','F','G','H','I','J','K','L','M'];
            }
            return cols[cellIndex]||'?';
        }
        
        // é‡æ–°è®¡ç®—æ‰€æœ‰åæ ‡
        // [ä¿®æ”¹] åˆ—æ•°ç»„æ‰©å……åˆ° M åˆ—ï¼Œæ”¯æŒ 6äºº/9äºº æ¨¡å¼è‡ªé€‚åº”
        function recalculateAllCoords(){
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            var currentRow=1; // ä»ç¬¬1è¡Œå¼€å§‹(ç¬¬0è¡Œæ˜¯è¡¨å¤´)
            var phaseStartRow=currentRow;
            
            rows.forEach(function(row,idx){
                // [ä¿®å¤] è·³è¿‡æ¢äººè¡Œï¼Œä¿ç•™å…¶ç‰¹æ®Šåæ ‡æ ¼å¼ (SRC1,A-B) ç­‰
                if(row.classList.contains('swap-header-row') || row.classList.contains('swap-source-row')) {
                    return;
                }
                
                var phaseCell=row.querySelector('td[rowspan]');
                if(phaseCell){
                    // è¿™æ˜¯é˜¶æ®µèµ·å§‹è¡Œ
                    phaseStartRow=currentRow+1; // é˜¶æ®µæ•°æ®è¡Œä»ä¸‹ä¸€è¡Œå¼€å§‹
                    var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
                    var endRow=currentRow+rowspan;
                    var coordSpan=phaseCell.querySelector('.coord');
                    if(coordSpan){
                        if(rowspan>1){
                            coordSpan.textContent='('+(currentRow+1)+'-'+endRow+',A)';
                        }else{
                            coordSpan.textContent='('+(currentRow+1)+',A)';
                        }
                    }
                }
                // æ›´æ–°è¯¥è¡Œæ‰€æœ‰å•å…ƒæ ¼çš„åæ ‡
                var cells=Array.from(row.querySelectorAll('td'));
                var colOffset=phaseCell?0:0;
                // [ä¿®æ”¹] æ‰©å……åˆ—æ•°ç»„åˆ° Mï¼ŒJS ä¼šæ ¹æ® cellIdx è‡ªåŠ¨å–å€¼
                var cols=phaseCell?['A','B','C','D','E','F','G','H','I','J','K','L','M']:['B','C','D','E','F','G','H','I','J','K','L','M'];
                
                cells.forEach(function(cell,cellIdx){
                    if(cell===phaseCell)return; // è·³è¿‡é˜¶æ®µå•å…ƒæ ¼
                    var coordSpan=cell.querySelector('.coord');
                    if(coordSpan){
                        var colId=cols[phaseCell?cellIdx:cellIdx];
                        if(colId){
                            coordSpan.textContent='('+(currentRow+1)+','+colId+')';
                        }
                    }
                });
                currentRow++;
            });
        }
        
        function collectData(){
            recalculateAllCoords(); // å…ˆç¡®ä¿åæ ‡æ˜¯æœ€æ–°çš„
            // [ä¿®å¤] å¢åŠ  mode å­—æ®µï¼Œä¿å­˜å½“å‰æ˜¯ 6äºº è¿˜æ˜¯ 9äºº æ¨¡å¼
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            var data={version:3,mode: is9Man ? 9 : 6,savedAt:new Date().toISOString(),skills:[],texts:[],phases:[],tTexts:[],rows:[],headerImages:[]};
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            
            // ä¿å­˜è¡Œç»“æ„
            rows.forEach(function(row,rowIdx){
                // [ä¿®å¤] è·³è¿‡æ¢äººè¡Œï¼Œå®ƒä»¬ç”± collectSwapSections ä¸“é—¨å¤„ç†
                if(row.classList.contains('swap-header-row') || row.classList.contains('swap-source-row')) {
                    return;
                }
                var phaseCell=row.querySelector('td[rowspan]');
                var rowData={index:rowIdx,hasPhase:!!phaseCell};
                if(phaseCell){
                    rowData.rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
                    var phaseName=phaseCell.querySelector('.phase-name');
                    if(phaseName)rowData.phaseName=phaseName.textContent;
                    rowData.phaseClass=row.className||'';
                }
                data.rows.push(rowData);
            });
            
            // ä¿å­˜æŠ€èƒ½å’Œæ–‡å­—(ä½¿ç”¨å®é™…åæ ‡)
            document.querySelectorAll('tbody td').forEach(function(cell){
                // [ä¿®å¤] è·³è¿‡æ¢äººè¡Œçš„æ ¼å­ï¼Œå®ƒä»¬ç”± collectSwapSections ä¸“é—¨å¤„ç†
                var parentRow = cell.closest('tr');
                if(parentRow && (parentRow.classList.contains('swap-header-row') || parentRow.classList.contains('swap-source-row'))) {
                    return;
                }
                var coord=getCellCoord(cell);if(!coord)return;
                cell.querySelectorAll('.skill-box:not(.skill-source)').forEach(function(box){
                    var img=box.querySelector('img');
                    // åªä¿å­˜æœ‰æ•ˆçš„å›¾ç‰‡ï¼ˆæœ‰ src ä¸”ä¸ä¸ºç©ºï¼Œä¸”ä¸æ˜¯å ä½ç¬¦å›¾ç‰‡ï¼‰
                    if(img && img.src && img.src.trim() && img.src !== EMPTY_IMAGE_SRC){
                        data.skills.push({row:coord.row,col:coord.col,imgSrc:img.src});
                    }
                });
                cell.querySelectorAll('.user-text').forEach(function(txt){
                    // åªä¿å­˜éç©ºæ–‡å­—
                    if(txt.textContent && txt.textContent.trim()){
                        data.texts.push({row:coord.row,col:coord.col,text:txt.textContent,color:txt.style.color||"",bold:txt.style.fontWeight==="bold",fontSize:txt.style.fontSize||""});
                    }
                });
            });
            
            // ä¿å­˜é˜¶æ®µä¿¡æ¯ - æ”¹è¿›ç‰ˆï¼šä¿å­˜æ¯ä¸ªé˜¶æ®µçš„è¯¦ç»†è¡Œä¿¡æ¯
            var phaseDetails = [];
            document.querySelectorAll('td[rowspan]').forEach(function(cell, phaseIndex){
                var rs=parseInt(cell.getAttribute('rowspan'));
                var phaseName=cell.querySelector('.phase-name');
                var phaseRow = cell.closest('tr');
                var tbody = document.querySelector('tbody');
                var allRows = Array.from(tbody.querySelectorAll('tr'));
                var phaseRowIndex = allRows.indexOf(phaseRow);
                
                // æ”¶é›†è¿™ä¸ªé˜¶æ®µå†…æ‰€æœ‰è¡Œçš„ä¿¡æ¯
                var phaseRowsInfo = [];
                for(var i = 0; i < rs; i++){
                    var currentRow = allRows[phaseRowIndex + i];
                    if(currentRow){
                        var rowCoord = null;
                        var bCell = currentRow.querySelector('td:not([rowspan])');
                        if(bCell){
                            var coordEl = bCell.querySelector('.coord');
                            if(coordEl){
                                var match = coordEl.textContent.match(/\((\d+),B\)/);
                                if(match) rowCoord = parseInt(match[1]);
                            }
                        }
                        
                        var rowText = '';
                        var tTextEl = bCell ? bCell.querySelector('.t-text') : null;
                        if(tTextEl) rowText = tTextEl.textContent;
                        
                        phaseRowsInfo.push({
                            index: i,
                            coord: rowCoord,
                            text: rowText,
                            exists: true
                        });
                    }
                }
                
                phaseDetails.push({
                    name: phaseName ? phaseName.textContent : '',
                    rowspan: rs,
                    rows: phaseRowsInfo,
                    className: phaseRow.className || ''
                });
            });
            data.phases = phaseDetails;
            
            // ä¿å­˜Tæ•°æ–‡å­—(ä½¿ç”¨å®é™…åæ ‡)ï¼ŒåŒ…æ‹¬è¡¨å¤´
            document.querySelectorAll('.t-text').forEach(function(el){
                var cell=el.closest('td')||el.closest('th');
                if(!cell)return;
                var coord=null;
                var coordEl=cell.querySelector('.coord')||cell.querySelector('.coord-header');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+)(?:-\d+)?,([A-Z\-]+)\)/);
                    if(match)coord={row:parseInt(match[1]),col:match[2]};
                }
                if(coord){
                    data.tTexts.push({
                        row:coord.row,
                        col:coord.col,
                        text:el.textContent,
                        fontSize:el.style.fontSize||"",
                        color:el.style.color||"",
                        customSize:el.hasAttribute('data-custom-size'),
                        customColor:el.hasAttribute('data-custom-color'),
                        isHeader:!!el.closest('th')
                    });
                }
            });
            
            // ä¿å­˜è¡¨å¤´å›¾ç‰‡URLï¼ˆè§’è‰²å¤´åƒã€æŠ€èƒ½æºã€BOSSå›¾ã€çŠ¶æ€å›¾æ ‡ï¼‰
            // [ä¿®å¤] é™åˆ¶é€‰æ‹©å™¨åªè·å– thead ä¸­çš„è§’è‰²å¤´åƒï¼Œé¿å…è·å–åˆ°æ¢äººè¡Œçš„ td å¯¼è‡´ closest('th') æŠ¥é”™
            document.querySelectorAll('thead .character-header img').forEach(function(img){
                var th=img.closest('th');
                if(!th) return; // åŒé‡ä¿é™©
                var coordEl=th.querySelector('.coord-header');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                    if(match){
                        // åªä¿å­˜æœ‰æ•ˆå›¾ç‰‡ï¼Œè¿‡æ»¤æ‰ç©ºçš„base64å›¾ç‰‡
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                            data.headerImages.push({
                                type:'character',
                                row:parseInt(match[1]),
                                col:match[2],
                                src:img.src
                            });
                        }
                    }
                }
            });
            
            // [ä¼˜åŒ–] åªæ”¶é›†ä¸»è¡¨å¤´çš„æŠ€èƒ½æºï¼Œæ¢äººè¡Œçš„æŠ€èƒ½æºåœ¨ swapSections ä¸­å•ç‹¬å¤„ç†
            document.querySelectorAll('thead .skill-source-row img').forEach(function(img){
                var cell=img.closest('td');
                var coordEl=cell.querySelector('.coord');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if(match){
                        var skillBox=img.closest('.skill-box');
                        var index=Array.from(cell.querySelectorAll('.skill-box img')).indexOf(img);
                        // åªä¿å­˜æœ‰æ•ˆå›¾ç‰‡ï¼Œè¿‡æ»¤æ‰ç©ºçš„base64å›¾ç‰‡
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                            data.headerImages.push({
                                type:'skill-source',
                                row:parseInt(match[1]),
                                col:match[2],
                                index:index,
                                src:img.src
                            });
                        }
                    }
                }
            });
            
            // ä¿å­˜BOSSå›¾å’ŒçŠ¶æ€å›¾æ ‡
            var topRows = document.querySelectorAll('.top-row');
            topRows.forEach(function(row, rowIndex){
                if(rowIndex === 0){
                    // BOSSå›¾è¡Œ - åªæœ‰ä¸€å¼ å›¾ç‰‡
                    var bossImg = row.querySelector('th > img');
                    if(bossImg && bossImg.src && bossImg.src !== EMPTY_IMAGE_SRC && bossImg.src.trim() !== ''){
                        data.headerImages.push({
                            type: 'boss-image',
                            src: bossImg.src
                        });
                    }
                } else if(rowIndex === 1){
                    // çŠ¶æ€å›¾æ ‡è¡Œ - å¤šä¸ª skill-box
                    row.querySelectorAll('.skill-box img').forEach(function(img, imgIndex){
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== ''){
                            data.headerImages.push({
                                type: 'status-icon',
                                index: imgIndex,
                                src: img.src
                            });
                        }
                    });
                }
            });
            
            // [æ–°å¢] ä¿å­˜æ¢äººè¡Œæ•°æ® (å«ä½ç½®ä¿¡æ¯)
            data.swapSections = [];
            var swapHeaderRows = document.querySelectorAll('.swap-header-row');
            var allTbodyRows = Array.from(document.querySelector('tbody').querySelectorAll('tr'));
            
            swapHeaderRows.forEach(function(headerRow, swapIndex) {
                var swapId = headerRow.getAttribute('data-swap-id') || ('swap-' + swapIndex);
                var sourceRow = document.querySelector('.swap-source-row[data-swap-id="' + swapId + '"]');
                
                // [æ–°å¢] è®¡ç®—æ¢äººè¡Œåœ¨è¡¨æ ¼ä¸­çš„ä½ç½®ï¼ˆæ’é™¤å…¶ä»–æ¢äººè¡Œåçš„ç´¢å¼•ï¼‰
                var rowIndexInTable = 0;
                for(var i = 0; i < allTbodyRows.length; i++) {
                    var row = allTbodyRows[i];
                    if(row === headerRow) break;
                    // åªè®¡ç®—éæ¢äººè¡Œ
                    if(!row.classList.contains('swap-header-row') && !row.classList.contains('swap-source-row')) {
                        rowIndexInTable++;
                    }
                }
                
                var swapData = {
                    id: swapId,
                    index: swapIndex,
                    characters: [],
                    skills: [],
                    // [æ–°å¢] ä½ç½®ä¿¡æ¯ï¼šæ¢äººè¡Œå‰é¢æœ‰å¤šå°‘ä¸ªæ™®é€šæ•°æ®è¡Œ
                    positionIndex: rowIndexInTable
                };
                
                // ä¿å­˜è§’è‰²å¤´åƒå’Œåç§°
                headerRow.querySelectorAll('.swap-char-cell').forEach(function(cell, cellIndex) {
                    var coordEl = cell.querySelector('.coord-header');
                    var img = cell.querySelector('img');
                    var nameEl = cell.querySelector('.char-name');
                    var coord = '';
                    if(coordEl) {
                        var match = coordEl.textContent.match(/\((SW\d+),([A-Z])\)/);
                        if(match) coord = match[2];
                    }
                    
                    var charData = {
                        col: coord,
                        index: cellIndex,
                        name: nameEl ? nameEl.textContent : '',
                        src: ''
                    };
                    
                    if(img && img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                        charData.src = img.src;
                    }
                    
                    swapData.characters.push(charData);
                });
                
                // ä¿å­˜æŠ€èƒ½æºå›¾ç‰‡
                if(sourceRow) {
                    sourceRow.querySelectorAll('.source-cell').forEach(function(cell, cellIndex) {
                        var coordEl = cell.querySelector('.coord');
                        var coord = '';
                        if(coordEl) {
                            var match = coordEl.textContent.match(/\((SRC\d+),([A-Z\-]+)\)/);
                            if(match) coord = match[2];
                        }
                        
                        // [ä¿®å¤] è·³è¿‡ D åˆ—ï¼Œå› ä¸º FC å›¾æ ‡æ˜¯å›ºå®šçš„ï¼Œä¸éœ€è¦ä¿å­˜
                        if(coord === 'D') return;
                        
                        cell.querySelectorAll('.skill-box img').forEach(function(img, imgIndex) {
                            if(img && img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                                swapData.skills.push({
                                    col: coord,
                                    cellIndex: cellIndex,
                                    imgIndex: imgIndex,
                                    src: img.src
                                });
                            }
                        });
                    });
                }
                
                data.swapSections.push(swapData);
            });
            
            // [æ–°å¢] ä¿å­˜åˆ›ä½œè€…ä¿¡æ¯
            var finalHistory = [...AuthorSystem.history];
            var currentAuthor = AuthorSystem.currentAuthor;
            // å¦‚æœå½“å‰ä½œè€…ä¸æ˜¯è®¿å®¢ï¼Œä¸”ä¸åœ¨å†å²è®°å½•çš„æœ€åä¸€ä½ï¼Œåˆ™åŠ å…¥
            if (currentAuthor !== 'è®¿å®¢' && currentAuthor !== 'Guest' && finalHistory[finalHistory.length - 1] !== currentAuthor) {
                finalHistory.push(currentAuthor);
            }
            data.metadata = {
                authors: finalHistory,
                lastEditor: currentAuthor
            };
            
            return data;
        }
        
        function restoreData(data){
            // å…ˆæ¢å¤è¡Œç»“æ„ - æ”¹è¿›ç‰ˆï¼šæ ¹æ®è¯¦ç»†çš„è¡Œä¿¡æ¯æ¢å¤
            if(data.phases && data.phases.length > 0){
                var existingPhaseCells = document.querySelectorAll('td[rowspan]');
                var existingCount = existingPhaseCells.length;
                var targetCount = data.phases.length;
                
                // å¦‚æœéœ€è¦æ›´å¤šé˜¶æ®µï¼Œå…ˆåˆ›å»ºæ–°é˜¶æ®µ
                if(targetCount > existingCount){
                    for(var i = 0; i < targetCount - existingCount; i++){
                        // ä¸´æ—¶åˆ›å»ºæ–°é˜¶æ®µï¼ˆä¸ä¿å­˜ï¼‰- åœ¨æœ€åä¸€ä¸ªé˜¶æ®µåé¢æ’å…¥
                        var tbody = document.querySelector('tbody');
                        var lastPhaseCell = tbody.querySelector('tr:last-child td[rowspan]') || tbody.querySelector('td[rowspan]:last-of-type');
                        var phaseRow = document.createElement('tr');
                        // [ä¿®å¤] ä½¿ç”¨ getDataCellsHtml åŠ¨æ€ç”Ÿæˆåˆ—ï¼Œæ”¯æŒ 9 äººæ¨¡å¼
                        var extraCells = getDataCellsHtml(0);
                        phaseRow.innerHTML = '<td rowspan="1"><span class="coord">(0,A)</span><span class="t-text phase-name" contenteditable="true" onblur="GBFGuide.Storage.save()">é˜¶æ®µçŠ¶æ€</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="åˆ é™¤æ­¤é˜¶æ®µ">âˆ’</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="åœ¨ä¸‹æ–¹æ’å…¥æ–°é˜¶æ®µ">+</button></div></td><td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;
                        tbody.appendChild(phaseRow);
                        phaseRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
                        // ç»‘å®šä¸å¯åˆ é™¤é€»è¾‘
                        var phaseName = phaseRow.querySelector('.t-text.phase-name');
                        if(phaseName && window.setupUndeletableText) window.setupUndeletableText(phaseName, 'é˜¶æ®µçŠ¶æ€');
                        var bText = phaseRow.querySelector('.b-cell-content .t-text');
                        if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
                    }
                }
                // å¦‚æœéœ€è¦æ›´å°‘é˜¶æ®µï¼Œåˆ é™¤å¤šä½™é˜¶æ®µ
                else if(targetCount < existingCount){
                    var phaseCells = document.querySelectorAll('td[rowspan]');
                    for(var i = existingCount - 1; i >= targetCount; i--){
                        var phaseCell = phaseCells[i];
                        if(phaseCell){
                            var phaseRow = phaseCell.closest('tr');
                            var rowspan = parseInt(phaseCell.getAttribute('rowspan')) || 1;
                            var tbody = document.querySelector('tbody');
                            var rows = Array.from(tbody.querySelectorAll('tr'));
                            var phaseIndex = rows.indexOf(phaseRow);
                            // åˆ é™¤è¯¥é˜¶æ®µçš„æ‰€æœ‰è¡Œ
                            for(var j = rowspan - 1; j >= 0; j--){
                                var rowToDelete = rows[phaseIndex + j];
                                if(rowToDelete && !rowToDelete.classList.contains('add-phase-row')){
                                    rowToDelete.remove();
                                }
                            }
                        }
                    }
                }
                
                // é‡æ–°è·å–é˜¶æ®µå•å…ƒæ ¼
                var cells = document.querySelectorAll('td[rowspan]');
                
                data.phases.forEach(function(phaseData, phaseIndex){
                    if(cells[phaseIndex]){
                        var currentRs = parseInt(cells[phaseIndex].getAttribute('rowspan')) || 1;
                        var targetRs = phaseData.rowspan;
                        
                        // å¦‚æœéœ€è¦æ›´å¤šè¡Œï¼Œæ·»åŠ è¡Œ
                        if(targetRs > currentRs){
                            var diff = targetRs - currentRs;
                            for(var i = 0; i < diff; i++){
                                var btn = cells[phaseIndex].querySelector('.phase-btn');
                                if(btn) addRowToPhaseNoSave(btn);
                            }
                        }
                        // å¦‚æœéœ€è¦æ›´å°‘è¡Œï¼Œåˆ é™¤è¡Œ
                        else if(targetRs < currentRs){
                            var phaseRow = cells[phaseIndex].closest('tr');
                            var tbody = document.querySelector('tbody');
                            var allRows = Array.from(tbody.querySelectorAll('tr'));
                            var phaseRowIndex = allRows.indexOf(phaseRow);
                            
                            // ä»åå¾€å‰åˆ é™¤å¤šä½™çš„è¡Œ
                            var diff = currentRs - targetRs;
                            for(var i = 0; i < diff; i++){
                                var rowToDelete = allRows[phaseRowIndex + currentRs - 1 - i];
                                if(rowToDelete && !rowToDelete.querySelector('td[rowspan]')){
                                    rowToDelete.remove();
                                }
                            }
                            
                            // æ›´æ–°rowspan
                            cells[phaseIndex].setAttribute('rowspan', targetRs);
                        }
                        
                        // æ¢å¤é˜¶æ®µåç§°
                        var phaseName = cells[phaseIndex].querySelector('.phase-name');
                        if(phaseName && phaseData.name){
                            phaseName.textContent = phaseData.name;
                        }
                    }
                });
            }
            
            // é‡æ–°è®¡ç®—åæ ‡
            recalculateAllCoords();
            
            // æ¸…ç©ºå·²æ”¾ç½®çš„æŠ€èƒ½å’Œæ–‡å­—
            clearAllSilent();
            
            // æ¢å¤Tæ•°æ–‡å­—
            if(data.tTexts){
                data.tTexts.forEach(function(t){
                    var cell=null;
                    if(t.isHeader||t.row===0){
                        // è¡¨å¤´è¡Œ
                        var ths=document.querySelectorAll('thead th');
                        ths.forEach(function(th){
                            var coordEl=th.querySelector('.coord-header');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                if(match&&parseInt(match[1])===t.row&&match[2]===t.col){
                                    cell=th;
                                }
                            }
                        });
                    }else{
                        cell=findCellByCoord(t.row,t.col);
                    }
                    if(cell){
                        var tText=cell.querySelector('.t-text');
                        if(tText){
                            tText.textContent=t.text;
                            if(t.fontSize){tText.style.fontSize=t.fontSize;}
                            if(t.color){tText.style.color=t.color;}
                            if(t.customSize){tText.setAttribute('data-custom-size','true');}
                            if(t.customColor){tText.setAttribute('data-custom-color','true');}
                        }
                    }
                });
            }
            
            // æ¢å¤æŠ€èƒ½
            if(data.skills){
                data.skills.forEach(function(s){
                    // åªæ¢å¤æœ‰æ•ˆçš„æŠ€èƒ½ï¼ˆæœ‰ imgSrc ä¸”ä¸ä¸ºç©ºï¼Œä¸”ä¸æ˜¯å ä½ç¬¦å›¾ç‰‡ï¼‰
                    if(!s.imgSrc || !s.imgSrc.trim() || s.imgSrc === EMPTY_IMAGE_SRC) return;
                    
                    var cell=findCellByCoord(s.row,s.col);
                    if(cell){
                        var box=document.createElement('span');
                        box.className='skill-box has-fab';
                        box.innerHTML='<img src="'+s.imgSrc+'" style="width:40px;height:40px;">';
                        bindDragEvents(box, 20);
                        box.addEventListener('contextmenu',function(e){e.preventDefault();this.remove();GBFGuide.Storage.save();});
                        // æ·»åŠ åˆ é™¤æŒ‰é’®
                        var delBtn = document.createElement('button');
                        delBtn.className = 'mini-fab delete';
                        delBtn.innerHTML = 'Ã—';
                        delBtn.title = 'åˆ é™¤';
                        delBtn.onclick = function(ev){
                            ev.stopPropagation();
                            box.remove();
                            GBFGuide.Storage.save();
                        };
                        box.appendChild(delBtn);
                        
                        // å¦‚æœæ˜¯å¬å”¤çŸ³ï¼Œè°ƒæ•´åˆ é™¤æŒ‰é’®ä½ç½®
                        if (s.imgSrc && (s.imgSrc.includes('/summon/') || box.classList.contains('summon-box'))) {
                            box.classList.add('summon-box');
                            adjustSummonDeleteButton(box);
                        }
                        
                        cell.appendChild(box);
                    }
                });
            }
            
            // æ¢å¤ç”¨æˆ·æ–‡å­—
            if(data.texts){
                data.texts.forEach(function(t){
                    // åªæ¢å¤éç©ºæ–‡å­—
                    if(!t.text || !t.text.trim()) return;
                    
                    var cell=findCellByCoord(t.row,t.col);
                    if(cell){
                        // åˆ›å»ºwrapperåŒ…è£¹ç”¨æˆ·æ–‡å­—å’Œåˆ é™¤æŒ‰é’®
                        var wrapper=document.createElement('span');
                        wrapper.className='user-text-wrapper';
                        
                        var span=document.createElement('span');
                        span.className='user-text';
                        span.textContent=t.text;
                        span.setAttribute('contenteditable','true');
                        if(t.color){span.style.color=t.color;}
                        if(t.bold){span.style.fontWeight='bold';}
                        if(t.fontSize){span.style.fontSize=t.fontSize;}
                        
                        // æ¢å¤ä¼˜å…ˆçº§å±æ€§ï¼ˆç”¨äºä¿æŒæ ·å¼ï¼‰
                        if(t.color){
                            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
                            var p1Color=isDark?'#ff6b6b':'#c62828';
                            var p2Color=isDark?'#ff8a80':'#c62828';
                            if(t.color===p1Color||t.color==='#c62828'||t.color==='rgb(198, 40, 40)'||t.color==='rgb(255, 107, 107)'){
                                span.setAttribute('data-priority','1');
                            }else if(t.color===p2Color||t.color==='#ff8a80'||t.color==='rgb(255, 138, 128)'){
                                span.setAttribute('data-priority','2');
                            }else if(t.bold){
                                span.setAttribute('data-priority','3');
                            }else{
                                span.setAttribute('data-priority','4');
                            }
                        }
                        
                        // æ·»åŠ åˆ é™¤æŒ‰é’®
                        var delBtn=document.createElement('button');
                        delBtn.className='mini-fab delete';
                        delBtn.innerHTML='Ã—';
                        delBtn.title='åˆ é™¤';
                        delBtn.onclick=function(ev){
                            ev.stopPropagation();
                            wrapper.remove();
                            GBFGuide.Storage.save();
                        };
                        
                        wrapper.appendChild(span);
                        wrapper.appendChild(delBtn);
                        
                        // æ·»åŠ äº‹ä»¶ç›‘å¬
                        span.addEventListener('blur',function(){
                            if(!this.textContent.trim()){
                                wrapper.remove();
                            }
                            GBFGuide.Storage.save();
                        });
                        
                        span.addEventListener('paste',function(e){
                            e.preventDefault();
                            var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                            document.execCommand('insertText',false,text.substring(0,50));
                        });
                        
                        span.addEventListener('keydown',function(e){
                            if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                                e.preventDefault();
                            }
                            if(e.key==='Enter'){
                                e.preventDefault();
                                this.blur();
                            }
                        });
                        
                        span.addEventListener('input',function(){
                            var priority=this.getAttribute('data-priority');
                            var currentColor=this.style.color;
                            var currentWeight=this.style.fontWeight;
                            var currentSize=this.style.fontSize;
                            setTimeout(function(){
                                if(span.style.color!==currentColor)span.style.color=currentColor;
                                if(span.style.fontWeight!==currentWeight)span.style.fontWeight=currentWeight;
                                if(span.style.fontSize!==currentSize)span.style.fontSize=currentSize;
                            },0);
                        });
                        
                        cell.appendChild(wrapper);
                    }
                });
            }
            
            // æ¢å¤è¡¨å¤´å›¾ç‰‡URL
            if(data.headerImages){
                // ç”¨äºæ”¶é›†çŠ¶æ€å›¾æ ‡æ•°æ®
                var statusIconsToRestore = [];
                
                // å…ˆåˆ é™¤æ‰€æœ‰æºæŠ€èƒ½åŒºåŸŸçš„ skill-boxï¼ˆæ¸…é™¤HTMLæ¨¡æ¿ä¸­çš„é»˜è®¤å…ƒç´ ï¼‰
                // [ä¿®å¤] åªæ¸…é™¤ä¸»è¡¨å¤´çš„ skill-source-rowï¼Œä¸æ¸…é™¤æ¢äººè¡Œçš„ swap-source-row
                document.querySelectorAll('.skill-source-row:not(.swap-source-row) td').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    var editBtn = cell.querySelector('.mini-fab.edit, .btn-edit-glass');
                    // åˆ é™¤æ‰€æœ‰ skill-box
                    cell.querySelectorAll('.skill-box').forEach(function(box){
                        box.remove();
                    });
                });
                
                // è§’è‰²å¤´åƒåªè®¾ç½® src ä¸ºå ä½ç¬¦ï¼ˆå› ä¸ºå¤´åƒå…ƒç´ éœ€è¦ä¿ç•™ï¼‰
                document.querySelectorAll('.character-header img').forEach(function(img){
                    img.src = EMPTY_IMAGE_SRC;
                });
                
                // ç„¶åæ¢å¤ä¿å­˜çš„å›¾ç‰‡ï¼ˆè‡ªåŠ¨è¿‡æ»¤å ä½ç¬¦ï¼‰
                data.headerImages.forEach(function(img){
                    // è·³è¿‡å ä½ç¬¦å›¾ç‰‡
                    if(!img.src || img.src === EMPTY_IMAGE_SRC || img.src.trim() === '') {
                        return;
                    }
                    
                    if(img.type==='character'){
                        // æ¢å¤è§’è‰²å¤´åƒ
                        var ths=document.querySelectorAll('.character-header');
                        ths.forEach(function(th){
                            var coordEl=th.querySelector('.coord-header');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                                if(match&&parseInt(match[1])===img.row&&match[2]===img.col){
                                    var imgEl=th.querySelector('img');
                                    if(imgEl) {
                                        imgEl.src=img.src;
                                        // [ä¿®å¤] æ¢å¤æ•°æ®æ—¶ï¼Œç¡®ä¿å›¾ç‰‡å¯è§
                                        imgEl.style.display = '';
                                    }
                                }
                            }
                        });
                    }else if(img.type==='skill-source'){
                        // æ¢å¤æŠ€èƒ½æºå›¾ç‰‡ - åˆ›å»ºæ–°çš„ skill-box å…ƒç´ 
                        // [ä¿®å¤] åªæ¢å¤ä¸»è¡¨å¤´çš„æŠ€èƒ½æºï¼Œä¸æ¢å¤æ¢äººè¡Œçš„
                        var cells=document.querySelectorAll('.skill-source-row:not(.swap-source-row) td');
                        cells.forEach(function(cell){
                            var coordEl=cell.querySelector('.coord');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                if(match&&parseInt(match[1])===img.row&&match[2]===img.col){
                                    // åˆ›å»ºæ–°çš„ skill-box å…ƒç´ 
                                    var isSummon = (img.col === 'A-B' || img.col === 'C');
                                    var sourceType = isSummon ? 'summon' : 'skill';
                                    var box = createSkillBox(img.src, {
                                        className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                                        size: 40,
                                        editable: true,
                                        deletable: true,
                                        sourceType: sourceType,
                                        isSummon: isSummon,
                                        dragImageSize: 20
                                    });
                                    cell.appendChild(box);
                                }
                            }
                        });
                    }else if(img.type==='top-row'){
                        // å…¼å®¹æ—§æ•°æ®æ ¼å¼ - æ¢å¤BOSSå›¾å’ŒçŠ¶æ€å›¾æ ‡
                        var topRows=document.querySelectorAll('.top-row');
                        if(topRows[img.rowIndex]){
                            var imgs=topRows[img.rowIndex].querySelectorAll('img');
                            if(imgs[img.imgIndex])imgs[img.imgIndex].src=img.src;
                        }
                    }else if(img.type==='boss-image'){
                        // æ–°æ ¼å¼ - æ¢å¤BOSSå›¾
                        var topRows=document.querySelectorAll('.top-row');
                        if(topRows[0]){
                            var bossImg=topRows[0].querySelector('th > img');
                            if(bossImg)bossImg.src=img.src;
                        }
                    }else if(img.type==='status-icon'){
                        // æ–°æ ¼å¼ - æ¢å¤çŠ¶æ€å›¾æ ‡ï¼ˆå…ˆæ”¶é›†ï¼Œåé¢ç»Ÿä¸€å¤„ç†ï¼‰
                        statusIconsToRestore.push(img);
                    }
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ BOSS å›¾æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ¸…ç©º
                var hasBossData = data.headerImages.some(function(img){
                    return img.type === 'boss-image' || (img.type === 'top-row' && img.rowIndex === 0);
                });
                if(!hasBossData){
                    var topRows = document.querySelectorAll('.top-row');
                    if(topRows[0]){
                        var bossImg = topRows[0].querySelector('th > img');
                        if(bossImg) bossImg.src = EMPTY_IMAGE_SRC;
                    }
                }
                
                // æ¢å¤çŠ¶æ€å›¾æ ‡ - å…ˆåˆ é™¤ç°æœ‰çš„ï¼Œå†åˆ›å»ºæ–°çš„
                if(statusIconsToRestore && statusIconsToRestore.length > 0){
                    var topRows = document.querySelectorAll('.top-row');
                    if(topRows[1]){
                        var statusTh = topRows[1].querySelector('th');
                        var editBtn = statusTh.querySelector('.mini-fab.edit, .btn-edit-glass');
                        // åˆ é™¤æ‰€æœ‰ç°æœ‰çš„ skill-box
                        statusTh.querySelectorAll('.skill-box').forEach(function(box){
                            box.remove();
                        });
                        // æŒ‰ index æ’åºååˆ›å»ºæ–°çš„ skill-box
                        statusIconsToRestore.sort(function(a, b){ return a.index - b.index; });
                        statusIconsToRestore.forEach(function(iconData){
                            var box = createSkillBox(iconData.src, {
                                className: 'skill-box skill-source',
                                size: 33,
                                editable: false,
                                deletable: true,
                                sourceType: 'status',
                                dragImageSize: 16
                            });
                            // æ’å…¥åˆ°ç¼–è¾‘æŒ‰é’®ä¹‹å‰
                            if(editBtn){
                                statusTh.insertBefore(box, editBtn);
                            } else {
                                statusTh.appendChild(box);
                            }
                        });
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰çŠ¶æ€å›¾æ ‡æ•°æ®ï¼Œæ¸…ç©ºç°æœ‰çš„ï¼ˆç”¨æˆ·å·²æ¸…ç©ºï¼‰
                    var hasStatusData = data.headerImages.some(function(img){
                        return img.type === 'status-icon' || (img.type === 'top-row' && img.rowIndex === 1);
                    });
                    if(!hasStatusData){
                        var topRows = document.querySelectorAll('.top-row');
                        if(topRows[1]){
                            var statusTh = topRows[1].querySelector('th');
                            statusTh.querySelectorAll('.skill-box').forEach(function(box){
                                box.remove();
                            });
                        }
                    }
                }
                
                // æ›´æ–°æ‰€æœ‰æºæŠ€èƒ½åŒºåŸŸå’Œè§’è‰²å¤´åƒçš„ç©ºçŠ¶æ€æ˜¾ç¤º
                // [ä¿®æ”¹] æ‰©å±•åˆ° M åˆ—ï¼Œæ”¯æŒ 9 äººæ¨¡å¼
                var characterConfigs = [
                    { coord: '(0,E)', name: 'ä¸»è§’', skillCoord: 'E' },
                    { coord: '(0,F)', name: '2å·ä½', skillCoord: 'F' },
                    { coord: '(0,G)', name: '3å·ä½', skillCoord: 'G' },
                    { coord: '(0,H)', name: '4å·ä½', skillCoord: 'H' },
                    { coord: '(0,I)', name: 'åæ’1', skillCoord: 'I' },
                    { coord: '(0,J)', name: 'åæ’2', skillCoord: 'J' },
                    { coord: '(0,K)', name: 'åæ’3', skillCoord: 'K' },
                    { coord: '(0,L)', name: 'åæ’4', skillCoord: 'L' },
                    { coord: '(0,M)', name: 'åæ’5', skillCoord: 'M' }
                ];
                var summonConfigs = [
                    { coord: 'A-B', fullCoord: '(1,A-B)', name: 'ä¸»å¬å”¤çŸ³', maxCount: 6, showButton: true },
                    { coord: 'C', fullCoord: '(1,C)', name: 'å‰¯å¬å”¤çŸ³', maxCount: 3, showButton: false }
                ];
                
                characterConfigs.forEach(function(config) {
                    if(window.updateSkillSourceEmptyState) {
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    }
                    if(window.updateCharEmptyStateByCoord) {
                        window.updateCharEmptyStateByCoord(config.coord);
                    }
                });
                
                summonConfigs.forEach(function(config) {
                    if(window.updateSummonEmptyState) {
                        window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                    }
                });
                
                // æ›´æ–°BOSSæ ç©ºçŠ¶æ€
                if(window.updateBossEmptyState) {
                    window.updateBossEmptyState();
                }
            }
            
            // [æ–°å¢] æ¢å¤æ¢äººè¡Œæ•°æ® (ä¿®å¤ä½ç½®é—®é¢˜)
            if(data.swapSections && data.swapSections.length > 0) {
                // å…ˆåˆ é™¤ç°æœ‰çš„æ¢äººè¡Œ
                document.querySelectorAll('.swap-header-row').forEach(function(row) { row.remove(); });
                document.querySelectorAll('.swap-source-row').forEach(function(row) { row.remove(); });
                
                // æŒ‰ positionIndex æ’åºï¼Œç¡®ä¿æŒ‰æ­£ç¡®é¡ºåºæ’å…¥
                var sortedSwapSections = data.swapSections.slice().sort(function(a, b) {
                    return (a.positionIndex || 0) - (b.positionIndex || 0);
                });
                
                // é‡å»ºæ¢äººè¡Œ
                sortedSwapSections.forEach(function(swapData, swapIndex) {
                    // æ›´æ–°å…¨å±€è®¡æ•°å™¨
                    swapRowCounter = Math.max(swapRowCounter, swapIndex + 1);
                    
                    // è°ƒç”¨ insertSwapRow åˆ›å»ºç»“æ„ï¼Œä½†ä¸ä¿å­˜
                    var tbody = document.querySelector('tbody');
                    var is9ManMode = document.querySelector('thead .back-row-2') !== null;
                    var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
                    
                    var swapId = swapData.id || ('swap-restore-' + swapIndex);
                    var swapNum = swapIndex + 1;
                    
                    // [ä¿®å¤] æ¢å¤æ—¶åŒæ ·åˆå¹¶ A+B åˆ—
                    var labelColsHtml = '<td colspan="2" class="swap-label-cell" style="vertical-align:middle; text-align:center;">' +
                        '<div style="font-weight:bold; color:var(--text-secondary); font-size:12px;">ğŸ”„ æ¢äºº</div>' +
                        '<button class="swap-delete-btn" onclick="removeSwapSection(this)" title="åˆ é™¤æ­¤æ¢äººåŒºå—">Ã—</button>' +
                        '</td>' +
                        '<td class="swap-label-cell"></td>' +
                        '<td class="swap-label-cell"></td>';
                    
                    // æ„å»ºè§’è‰²å¤´åƒæ 
                    var cols = ['E','F','G','H','I','J'];
                    var defaultNames = ['ä¸»è§’','2å·ä½','3å·ä½','4å·ä½','åæ’1','åæ’2'];
                    if(is9ManMode) {
                        cols.push('K','L','M');
                        defaultNames.push('åæ’3','åæ’4','åæ’5');
                    }
                    
                    var charColsHtml = '';
                    cols.forEach(function(col, idx) {
                        var backClass = '';
                        if(idx >= 4 && idx <= 5) backClass = ' back-row';
                        if(idx >= 6) backClass = ' back-row-2';
                        
                        // ä»ä¿å­˜çš„æ•°æ®ä¸­è·å–è§’è‰²ä¿¡æ¯
                        var charData = swapData.characters && swapData.characters[idx];
                        var charName = charData && charData.name ? charData.name : defaultNames[idx];
                        var charSrc = charData && charData.src ? charData.src : EMPTY_IMAGE_SRC;
                        var imgStyle = charSrc === EMPTY_IMAGE_SRC ? 'display:none' : '';
                        
                        // [ä¿®å¤] æ·»åŠ  position:relative ç¡®ä¿ç¼–è¾‘æŒ‰é’®å®šä½æ­£ç¡®
                        charColsHtml += '<td class="swap-char-cell character-header has-fab' + backClass + '" style="position:relative;">' +
                            '<span class="coord-header">(SW' + swapNum + ',' + col + ')</span><br>' +
                            '<img src="' + charSrc + '" style="' + imgStyle + '">' +
                            '<span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">' + charName + '</span>' +
                            '<div class="btn-edit-glass" onclick="showQuickAddCharacterForSwap(this.closest(\'.swap-char-cell\'))">' + editIcon + '</div>' +
                            '</td>';
                    });
                    
                    var trHeader = document.createElement('tr');
                    trHeader.className = 'swap-header-row';
                    trHeader.setAttribute('data-swap-id', swapId);
                    trHeader.innerHTML = labelColsHtml + charColsHtml;
                    
                    // æ„å»ºæŠ€èƒ½æºæ 
                    var sourceColsHtml = '';
                    cols.forEach(function(col, idx) {
                        var backClass = '';
                        if(idx >= 4 && idx <= 5) backClass = ' back-row';
                        if(idx >= 6) backClass = ' back-row-2';
                        sourceColsHtml += '<td class="source-cell' + backClass + '"><span class="coord">(SRC' + swapNum + ',' + col + ')</span></td>';
                    });
                    
                    var trSource = document.createElement('tr');
                    trSource.className = 'skill-source-row swap-source-row';
                    trSource.setAttribute('data-swap-id', swapId);
                    // [ä¿®å¤] A-Bã€C åˆ—ç§»é™¤ç¼–è¾‘æŒ‰é’®ï¼Œç»Ÿä¸€ä½¿ç”¨æ‚¬åœåˆ é™¤
                    trSource.innerHTML = 
                        '<td colspan="2" class="source-cell" style="vertical-align:middle;position:relative;">' +
                            '<span class="coord">(SRC' + swapNum + ',A-B)</span>' +
                        '</td>' +
                        '<td class="source-cell" style="vertical-align:middle;position:relative;">' +
                            '<span class="coord">(SRC' + swapNum + ',C)</span>' +
                        '</td>' +
                        '<td class="source-cell">' +
                            '<span class="coord">(SRC' + swapNum + ',D)</span>' +
                            '<span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span>' +
                        '</td>' +
                        sourceColsHtml;
                    
                    // [ä¿®å¤] æ ¹æ® positionIndex æ‰¾åˆ°æ­£ç¡®çš„æ’å…¥ä½ç½®
                    var insertAfterRow = null;
                    if(typeof swapData.positionIndex === 'number' && swapData.positionIndex > 0) {
                        // è·å–å½“å‰æ‰€æœ‰éæ¢äººè¡Œ
                        var normalRows = Array.from(tbody.querySelectorAll('tr')).filter(function(row) {
                            return !row.classList.contains('swap-header-row') && !row.classList.contains('swap-source-row');
                        });
                        // positionIndex è¡¨ç¤ºæ¢äººè¡Œå‰é¢æœ‰å¤šå°‘ä¸ªæ™®é€šè¡Œï¼Œæ‰€ä»¥æ’å…¥ç‚¹æ˜¯ç¬¬ positionIndex-1 è¡Œä¹‹å
                        if(swapData.positionIndex <= normalRows.length) {
                            insertAfterRow = normalRows[swapData.positionIndex - 1];
                        }
                    }
                    
                    // æ’å…¥åˆ°æ­£ç¡®ä½ç½®æˆ–è¿½åŠ åˆ°æœ«å°¾
                    if(insertAfterRow && insertAfterRow.nextSibling) {
                        tbody.insertBefore(trHeader, insertAfterRow.nextSibling);
                        tbody.insertBefore(trSource, trHeader.nextSibling);
                    } else if(insertAfterRow) {
                        // insertAfterRow æ˜¯æœ€åä¸€è¡Œ
                        tbody.appendChild(trHeader);
                        tbody.appendChild(trSource);
                    } else {
                        // æ²¡æœ‰ä½ç½®ä¿¡æ¯æˆ–ä½ç½®æ— æ•ˆï¼Œè¿½åŠ åˆ°æœ«å°¾
                        tbody.appendChild(trHeader);
                        tbody.appendChild(trSource);
                    }
                    
                    // æ¢å¤æŠ€èƒ½æºå›¾ç‰‡
                    if(swapData.skills && swapData.skills.length > 0) {
                        swapData.skills.forEach(function(skillData) {
                            var cells = trSource.querySelectorAll('.source-cell');
                            cells.forEach(function(cell) {
                                var coordEl = cell.querySelector('.coord');
                                if(coordEl) {
                                    var match = coordEl.textContent.match(/\(SRC\d+,([A-Z\-]+)\)/);
                                    if(match && match[1] === skillData.col) {
                                        var isSummon = (skillData.col === 'A-B' || skillData.col === 'C');
                                        // [ä¿®å¤] æ‰€æœ‰åˆ—ç»Ÿä¸€ä½¿ç”¨æ‚¬åœåˆ é™¤æŒ‰é’®
                                        var box = createSkillBox(skillData.src, {
                                            className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                                            size: 40,
                                            editable: true,
                                            deletable: true, // æ‰€æœ‰åˆ—éƒ½æœ‰åˆ é™¤æŒ‰é’®
                                            dragImageSize: 20
                                        });
                                        cell.appendChild(box);
                                    }
                                }
                            });
                        });
                    }
                    
                    // åˆå§‹åŒ–äº‹ä»¶ç»‘å®š
                    if(typeof initSwapRowElements === 'function') {
                        initSwapRowElements(trHeader, trSource);
                    }
                });
            }
            
            // [æ–°å¢] å¼ºåˆ¶åˆ·æ–°é˜¶æ®µé¢œè‰²ï¼Œè§£å†³å¯¼å…¥/åˆ·æ–°åé¢œè‰²ä¸å¯¹çš„é—®é¢˜
            if(typeof refreshPhaseColors === 'function') {
                refreshPhaseColors();
            }
            
            // [æ–°å¢] æ¢å¤åˆ›ä½œè€…ä¿¡æ¯
            if(data.metadata && data.metadata.authors) {
                AuthorSystem.history = data.metadata.authors;
                // åŠ è½½åˆ«äººçš„å­˜æ¡£æ—¶ï¼Œä¿æŒå½“å‰ç”¨æˆ·ä¸å˜ï¼ˆæˆ–ä¸ºè®¿å®¢ï¼‰
                // å†å²è®°å½•ä¼šåœ¨æ‰“å¼€å¼¹çª—æ—¶æ˜¾ç¤º
            }
            
            // [æ–°å¢] æ¢å¤æ•°æ®åï¼Œå¼ºåˆ¶æ£€æŸ¥æ¢äººè¡ŒæŒ‰é’®çŠ¶æ€
            updateSwapButtonState();
        }
        
        // æ·»åŠ è¡Œä½†ä¸ä¿å­˜(ç”¨äºæ¢å¤æ•°æ®æ—¶) (å·²æ›´æ–°ï¼šåŒ…å«å³ä¾§+å·)
        // [ä¿®æ”¹] ä½¿ç”¨ getDataCellsHtml åŠ¨æ€ç”Ÿæˆåˆ—
        function addRowToPhaseNoSave(btn){
            var phaseCell=btn.closest('td');
            var phaseRow=phaseCell.closest('tr');
            var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            var phaseIndex=rows.indexOf(phaseRow);
            var lastRowIndex=phaseIndex+rowspan-1;
            var newRow=document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // åæ ‡ç¨åä¼šé‡ç®—
            newRow.innerHTML='<td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;
            if(lastRowIndex<rows.length-1){rows[lastRowIndex].after(newRow);}else{tbody.appendChild(newRow);}
            phaseCell.setAttribute('rowspan',rowspan+1);
            newRow.querySelectorAll('td').forEach(function(cell){bindCellEvents(cell);});
            // ä¸ºæ–°æ·»åŠ çš„Båˆ—æ–‡å­—ç»‘å®šä¸å¯åˆ é™¤é€»è¾‘
            var bText = newRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
        }
        
        function saveToStorage(){
            // [é‡æ„] ä½¿ç”¨æ–°çš„ GBFGuide.Storage æ¨¡å—ï¼ˆå¸¦é˜²æŠ–ï¼‰
            GBFGuide.Storage.save();
        }
        function loadFromStorage(){
            try{
                var saved=localStorage.getItem(STORAGE_KEY);
                if(saved){
                    var data = JSON.parse(saved);
                    // [å…³é”®ä¿®å¤] å…ˆæ£€æŸ¥å­˜æ¡£é‡Œçš„æ¨¡å¼
                    // å¦‚æœå­˜æ¡£æ˜¯9äººæ¨¡å¼ï¼Œä½†å½“å‰é¡µé¢æ˜¯6äººéª¨æ¶ï¼ˆé»˜è®¤ï¼‰ï¼Œåˆ™å…ˆåˆ‡æ¢éª¨æ¶
                    var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                    var savedMode = data.mode || 6; // æ—§å­˜æ¡£é»˜è®¤ä¸º 6
                    if (savedMode === 9 && !currentIs9Man) {
                        // å¼ºåˆ¶åˆ‡æ¢åˆ° 9äººéª¨æ¶ï¼Œä¼ å…¥ true è¡¨ç¤ºæ˜¯æ¢å¤æ¨¡å¼ï¼ˆä¸ä¿å­˜ã€ä¸å¼¹çª—ï¼‰
                        loadTemplate(9, true);
                    } else if (savedMode === 6 && currentIs9Man) {
                        // å¦‚æœå­˜çš„æ˜¯6äººä½†å½“å‰æ˜¯9äººï¼Œåˆ‡å›6äºº
                        loadTemplate(6, true);
                    }
                    // éª¨æ¶æ­£ç¡®åï¼Œå†å¡«å……æ•°æ®
                    restoreData(data);
                }else{
                    // æ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œå°è¯•åŠ è½½ç”¨æˆ·é»˜è®¤é…ç½®
                    var defaultData=localStorage.getItem(STORAGE_KEY+'_default');
                    if(defaultData){
                        var data = JSON.parse(defaultData);
                        // åŒæ ·çš„é€»è¾‘åº”ç”¨äºé»˜è®¤é…ç½®
                        var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                        var savedMode = data.mode || 6;
                        if (savedMode !== (currentIs9Man ? 9 : 6)) {
                            loadTemplate(savedMode, true);
                        }
                        restoreData(data);
                    } else {
                        // [æ–°å¢] æ–°ç”¨æˆ·ï¼šæ²¡æœ‰ä»»ä½•å­˜æ¡£ï¼Œå…ˆåŠ è½½6äººç©ºæ¨¡æ¿ï¼Œå†å¼¹å‡ºBossé€‰æ‹©çª—å£
                        loadTemplate(6, true); // å…ˆåŠ è½½å¹²å‡€çš„6äººæ¨¡æ¿
                        setTimeout(function() {
                            showBossSelectModal();
                        }, 300);
                    }
                }
            }catch(e){
                console.error('åŠ è½½å­˜æ¡£å¤±è´¥:', e);
            }
        }
        function exportJSON(){var data=collectData();var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var link=document.createElement('a');link.download='gbf_guide_'+new Date().toISOString().slice(0,10)+'.json';link.href=URL.createObjectURL(blob);link.click();}
        function importJSON(e){
            var file=e.target.files[0];
            if(!file)return;
            var reader=new FileReader();
            reader.onload=function(ev){
                try{
                    var data=JSON.parse(ev.target.result);
                    // [æ–°å¢] å¯¼å…¥å‰å…ˆåˆ‡æ¢éª¨æ¶
                    var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                    var savedMode = data.mode || 6;
                    if (savedMode !== (currentIs9Man ? 9 : 6)) {
                        loadTemplate(savedMode, true);
                    }
                    restoreData(data);
                    GBFGuide.Storage.save();
                    alert('å¯¼å…¥æˆåŠŸ!');
                }catch(err){
                    alert('å¯¼å…¥å¤±è´¥');
                }
            };
            reader.readAsText(file);
            e.target.value='';
        }
        
        // ========== 6äºº/9äºº æ¨¡æ¿åˆ‡æ¢åŠŸèƒ½ ==========
        
        // ========== BOSSé€‰æ‹©å¼¹çª—æ§åˆ¶ ==========
        function showBossSelectModal() {
            document.getElementById('bossSelectModal').classList.add('active');
        }
        
        function closeBossSelectModal() {
            document.getElementById('bossSelectModal').classList.remove('active');
        }
        
        function confirmSwitchMode(mode) {
            var modeName = (mode === 9) ? 'æå¦ˆæ¨¡æ¿' : 'ææ³•æ¨¡æ¿';
            var msg = 'ã€é‡è¦æé†’ã€‘\n\n' +
                      'å³å°†åˆ‡æ¢åˆ° ' + modeName + '\n\n' +
                      'âš ï¸ æ­¤æ“ä½œå°†æ¸…ç©ºå½“å‰è¡¨æ ¼çš„æ‰€æœ‰å†…å®¹ï¼\n\n' +
                      'å¦‚æœæ‚¨æœ‰é‡è¦æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»ã€Œå–æ¶ˆã€\n' +
                      'ç„¶åä½¿ç”¨å·¥å…·æ çš„ã€Œå¯¼å‡ºã€æŒ‰é’®ä¿å­˜é…ç½®ã€‚\n\n' +
                      'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';
            
            if (confirm(msg)) {
                closeBossSelectModal();
                loadTemplate(mode);
            }
        }
        
        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
        document.addEventListener('click', function(e) {
            var modal = document.getElementById('bossSelectModal');
            if (e.target === modal) {
                closeBossSelectModal();
            }
        });

        // ========== é»˜è®¤æ¨¡æ¿ JSON é…ç½® ==========
        // ã€è¯´æ˜ã€‘å°†ä½ çš„é»˜è®¤ JSON ç²˜è´´åˆ°ä¸‹é¢å¯¹åº”çš„ä½ç½®
        // åˆ‡æ¢æ¨¡å¼æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™äº›é…ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        
        // ä¹äººæ¨¡å¼é»˜è®¤é…ç½® - å°†å®Œæ•´ JSON å­—ç¬¦ä¸²ç²˜è´´åˆ°è¿™é‡Œï¼ˆç”¨å•å¼•å·åŒ…è£¹ï¼‰
        var DEFAULT_9MAN_JSON = '{"version":3,"mode":9,"savedAt":"2026-01-12T16:18:47.690Z","skills":[{"row":5,"col":"C","imgSrc":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"},{"row":11,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":12,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":13,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":14,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":15,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":16,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":17,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":18,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":19,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":20,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":21,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":22,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":24,"col":"D","imgSrc":"https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png"},{"row":24,"col":"E","imgSrc":"https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png"},{"row":24,"col":"F","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png"},{"row":24,"col":"G","imgSrc":"https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png"},{"row":24,"col":"H","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"row":25,"col":"C","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"row":27,"col":"C","imgSrc":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png"}],"texts":[{"row":5,"col":"C","text":"æ‰€æœ‰äººå‡ºç‰åA","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":6,"col":"C","text":"å·Tå°½å¿«A2","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":7,"col":"C","text":"ç­‰90%","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"C","text":"å†ç”Ÿä¹‹ç¥æ„","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":"æœªæ»¡è¶³æ¡ä»¶æ—¶ï¼ŒBOSSè·å–è·å–ä»–åŒ–è‡ªåœ¨ï¼ˆå¼ºåŒ–æ»¡è±†Â·70%ç‰¹åŠ¨éš¾åº¦ï¼‰","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":"Â -50hitæˆ–6å›å¥¥ä¹‰","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":"-å¯¹bossé€ æˆä¸€å®šä¼¤å®³","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":12,"col":"C","text":"æ»¡è±†","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":13,"col":"C","text":"æ»¡è±†","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":14,"col":"C","text":"70% 1/3","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":15,"col":"C","text":"70%2/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":16,"col":"C","text":"70%3/3","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":17,"col":"C","text":"ç ´åä¹‹ç¥æ„","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":"æœªæ»¡è¶³æ¡ä»¶æ—¶ï¼ŒBOSSè·å–è·å–ä»–åŒ–è‡ªåœ¨ï¼ˆå¼ºåŒ–æ»¡è±†Â·70%ç‰¹åŠ¨éš¾åº¦ï¼‰","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":"Â -6å›è¡ŒåŠ¨æˆ–5å›æŠ€èƒ½","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":"-å¯¹bossé€ æˆä¸€å®šä¼¤å®³","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":18,"col":"C","text":"æ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":19,"col":"C","text":"æ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":20,"col":"C","text":"70%1/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":21,"col":"C","text":"70%2/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":22,"col":"C","text":"70%3/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"12å›æŠ€èƒ½","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"3000wæŠ€ä¼¤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"3000wå¥¥ä¹‰","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"æœªè¾¾æˆè§£é™¤éš¾åº¦æå‡","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"æ»¡è±†éš¾åº¦æå‡","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"BUFFæ•ˆæœæå‡","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"D","text":"40HIT/+20HIT","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"D","text":"BOSSè·å¾—BUFFè¿½ä¼¤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"æŠ€ä¼¤3000w/+500w","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"BOSSå¹³Aå¸¦DB","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"2çº§ä»¥ä¸Šç©¿ç›¾","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"è¡ŒåŠ¨5å›/+1å›","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"BOSSè·å¾—æ–©æ€","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"åˆå§‹20% æœ€å¤§60%","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"å¥¥ä¹‰6å›/+1å›","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"éšæœºè§’è‰²æŠ€èƒ½CD+2","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"åˆå§‹1äºº æå‡+1","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"TA3å›/+1å›","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"ä¾ç­‰çº§è·å¾—","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"äºŒåŠ¨","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"ç ´åè¿½ä¼¤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"ä¸‰åŠ¨","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":25,"col":"C","text":"è§£ä¸æ‰ä¼šæ—©ä¸€å›åˆæ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":27,"col":"C","text":"è§£æ»¡è±†å‡ºç‰","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":28,"col":"C","text":"ç‰¹åŠ¨éšæœº","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":29,"col":"C","text":"æ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":30,"col":"C","text":"æ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":31,"col":"C","text":"æ»¡è±†","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":32,"col":"C","text":"ç‰¹åŠ¨éšæœº","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":38,"col":"C","text":"ç‰¹åŠ¨éšæœº","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":38,"col":"C","text":"æ•°å€¼å¼ºåŒ–","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"}],"phases":[{"name":"100%-80%","rowspan":9,"rows":[{"index":0,"coord":2,"text":"1T","exists":true},{"index":1,"coord":3,"text":"2T","exists":true},{"index":2,"coord":4,"text":"3T","exists":true},{"index":3,"coord":5,"text":"4T","exists":true},{"index":4,"coord":6,"text":"5T","exists":true},{"index":5,"coord":7,"text":"6T","exists":true},{"index":6,"coord":8,"text":"1eä¼¤å®³","exists":true},{"index":7,"coord":9,"text":"6å¥¥ä¹‰","exists":true},{"index":8,"coord":10,"text":"80HIT+FC","exists":true}],"className":"phase-100-80"},{"name":"70-G50","rowspan":12,"rows":[{"index":0,"coord":11,"text":"å†ç”Ÿä¹‹ç¥æ„","exists":true},{"index":1,"coord":12,"text":"15å¼±ä½“+4TA","exists":true},{"index":2,"coord":13,"text":"5é©±æ•£/7å›200w","exists":true},{"index":3,"coord":14,"text":"6å›æŠ€èƒ½","exists":true},{"index":4,"coord":15,"text":"5å›é©±æ•£+5å›è¡ŒåŠ¨","exists":true},{"index":5,"coord":16,"text":"50HIT+5å›300w","exists":true},{"index":6,"coord":17,"text":"ç ´åä¹‹ç¥æ„","exists":true},{"index":7,"coord":18,"text":"12å›å¼±ä½“+50HIT","exists":true},{"index":8,"coord":19,"text":"5å›å¥¥ä¹‰+3å›çº¢æŠ€","exists":true},{"index":9,"coord":20,"text":"5å›å¥¥ä¹‰","exists":true},{"index":10,"coord":21,"text":"4TA+3é©±æ•£","exists":true},{"index":11,"coord":22,"text":"3å›800w+FC","exists":true}],"className":"phase-80-60"},{"name":"G50","rowspan":1,"rows":[{"index":0,"coord":23,"text":"G50ç‰¹åŠ¨","exists":true}],"className":"phase-60-20"},{"name":"G50-G100","rowspan":8,"rows":[{"index":0,"coord":24,"text":"å››ç‹å¤©ç±»BUFF","exists":true},{"index":1,"coord":25,"text":"1T","exists":true},{"index":2,"coord":26,"text":"2T","exists":true},{"index":3,"coord":27,"text":"æ»¡è±†","exists":true},{"index":4,"coord":28,"text":"æ»¡è±†","exists":true},{"index":5,"coord":29,"text":"3å›800w+2å›è“æŠ€","exists":true},{"index":6,"coord":30,"text":"15å›DB+8å›300wä¼¤å®³","exists":true},{"index":7,"coord":31,"text":"5å›é©±æ•£+FC","exists":true}],"className":"phase-20-0"},{"name":"G100-0%","rowspan":7,"rows":[{"index":0,"coord":32,"text":"ä¸€è½®è¯•ç‚¼","exists":true},{"index":1,"coord":33,"text":"15å›DB","exists":true},{"index":2,"coord":34,"text":"150HIT","exists":true},{"index":3,"coord":35,"text":"6å›é©±æ•£","exists":true},{"index":4,"coord":36,"text":"1eä¼¤å®³","exists":true},{"index":5,"coord":37,"text":"5å›600w","exists":true},{"index":6,"coord":38,"text":"äºŒè½®è¯•ç‚¼","exists":true}],"className":"phase-100-80"}],"tTexts":[{"row":0,"col":"A","text":"é˜¶æ®µ","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"B","text":"å›åˆ/ç‰¹åŠ¨","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"C","text":"å¤‡æ³¨","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"D","text":"å¬å”¤çŸ³","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"E","text":"ä¸»è§’","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"F","text":"2å·ä½","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"G","text":"3å·ä½","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"H","text":"4å·ä½","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"I","text":"åæ’1","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"J","text":"åæ’2","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"K","text":"åæ’3","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"L","text":"åæ’4","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"M","text":"åæ’5","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":2,"col":"A","text":"100%-80%","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":2,"col":"B","text":"1T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":3,"col":"B","text":"2T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":4,"col":"B","text":"3T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":5,"col":"B","text":"4T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":6,"col":"B","text":"5T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":7,"col":"B","text":"6T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":8,"col":"B","text":"1eä¼¤å®³","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":9,"col":"B","text":"6å¥¥ä¹‰","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":10,"col":"B","text":"80HIT+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":11,"col":"A","text":"70-G50","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":11,"col":"B","text":"å†ç”Ÿä¹‹ç¥æ„","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":12,"col":"B","text":"15å¼±ä½“+4TA","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":13,"col":"B","text":"5é©±æ•£/7å›200w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":14,"col":"B","text":"6å›æŠ€èƒ½","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":15,"col":"B","text":"5å›é©±æ•£+5å›è¡ŒåŠ¨","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":16,"col":"B","text":"50HIT+5å›300w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":17,"col":"B","text":"ç ´åä¹‹ç¥æ„","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":18,"col":"B","text":"12å›å¼±ä½“+50HIT","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":19,"col":"B","text":"5å›å¥¥ä¹‰+3å›çº¢æŠ€","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":20,"col":"B","text":"5å›å¥¥ä¹‰","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":21,"col":"B","text":"4TA+3é©±æ•£","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":22,"col":"B","text":"3å›800w+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":23,"col":"A","text":"G50","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":23,"col":"B","text":"G50ç‰¹åŠ¨","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":24,"col":"A","text":"G50-G100","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":24,"col":"B","text":"å››ç‹å¤©ç±»BUFF","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":25,"col":"B","text":"1T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":26,"col":"B","text":"2T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":27,"col":"B","text":"æ»¡è±†","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":28,"col":"B","text":"æ»¡è±†","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":29,"col":"B","text":"3å›800w+2å›è“æŠ€","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":30,"col":"B","text":"15å›DB+8å›300wä¼¤å®³","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":31,"col":"B","text":"5å›é©±æ•£+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":32,"col":"A","text":"G100-0%","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":32,"col":"B","text":"ä¸€è½®è¯•ç‚¼","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":33,"col":"B","text":"15å›DB","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":34,"col":"B","text":"150HIT","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":35,"col":"B","text":"6å›é©±æ•£","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":36,"col":"B","text":"1eä¼¤å®³","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":37,"col":"B","text":"5å›600w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":38,"col":"B","text":"äºŒè½®è¯•ç‚¼","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false}],"rows":[{"index":0,"hasPhase":true,"rowspan":9,"phaseName":"100%-80%","phaseClass":"phase-100-80"},{"index":1,"hasPhase":false},{"index":2,"hasPhase":false},{"index":3,"hasPhase":false},{"index":4,"hasPhase":false},{"index":5,"hasPhase":false},{"index":6,"hasPhase":false},{"index":7,"hasPhase":false},{"index":8,"hasPhase":false},{"index":9,"hasPhase":true,"rowspan":12,"phaseName":"70-G50","phaseClass":"phase-80-60"},{"index":10,"hasPhase":false},{"index":11,"hasPhase":false},{"index":12,"hasPhase":false},{"index":13,"hasPhase":false},{"index":14,"hasPhase":false},{"index":15,"hasPhase":false},{"index":16,"hasPhase":false},{"index":17,"hasPhase":false},{"index":18,"hasPhase":false},{"index":19,"hasPhase":false},{"index":20,"hasPhase":false},{"index":21,"hasPhase":true,"rowspan":1,"phaseName":"G50","phaseClass":"phase-60-20"},{"index":24,"hasPhase":true,"rowspan":8,"phaseName":"G50-G100","phaseClass":"phase-20-0"},{"index":25,"hasPhase":false},{"index":26,"hasPhase":false},{"index":27,"hasPhase":false},{"index":28,"hasPhase":false},{"index":29,"hasPhase":false},{"index":30,"hasPhase":false},{"index":31,"hasPhase":false},{"index":32,"hasPhase":true,"rowspan":7,"phaseName":"G100-0%","phaseClass":"phase-100-80"},{"index":33,"hasPhase":false},{"index":34,"hasPhase":false},{"index":35,"hasPhase":false},{"index":36,"hasPhase":false},{"index":37,"hasPhase":false},{"index":38,"hasPhase":false}],"headerImages":[{"type":"skill-source","row":1,"col":"D","index":0,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png"},{"type":"boss-image","src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/lobby/room_index/thumb/unlimited_versusia.png"},{"type":"status-icon","index":0,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"},{"type":"status-icon","index":1,"src":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"type":"status-icon","index":2,"src":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"type":"status-icon","index":3,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png"},{"type":"status-icon","index":4,"src":"https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png"},{"type":"status-icon","index":5,"src":"https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png"},{"type":"status-icon","index":6,"src":"https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png"},{"type":"status-icon","index":7,"src":"https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png"},{"type":"status-icon","index":8,"src":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"type":"status-icon","index":9,"src":"https://gbf.wiki/images/thumb/2/2f/Btn_singularity_chain_1_0.png/180px-Btn_singularity_chain_1_0.png"},{"type":"status-icon","index":10,"src":"https://gbf.wiki/images/thumb/7/76/Btn_singularity_chain_1_1.png/180px-Btn_singularity_chain_1_1.png"}],"swapSections":[{"id":"swap-1-1768228496333","index":0,"characters":[{"col":"E","index":0,"name":"ä¸»è§’","src":""},{"col":"F","index":1,"name":"2å·ä½","src":""},{"col":"G","index":2,"name":"3å·ä½","src":""},{"col":"H","index":3,"name":"4å·ä½","src":""},{"col":"I","index":4,"name":"åæ’1","src":""},{"col":"J","index":5,"name":"åæ’2","src":""},{"col":"K","index":6,"name":"åæ’3","src":""},{"col":"L","index":7,"name":"åæ’4","src":""},{"col":"M","index":8,"name":"åæ’5","src":""}],"skills":[],"positionIndex":22}],"metadata":{"authors":["çœŸå¯¦lowb"],"lastEditor":"çœŸå¯¦lowb"},"mergedCells":[{"row":11,"col":"E","colspan":4},{"row":17,"col":"E","colspan":4}]}'
      
      // å…­äººæ¨¡å¼é»˜è®¤é…ç½® - å°†å®Œæ•´ JSON å­—ç¬¦ä¸²ç²˜è´´åˆ°è¿™é‡Œï¼ˆç”¨å•å¼•å·åŒ…è£¹ï¼‰
        var DEFAULT_6MAN_JSON = '{ "version": 3, "mode": 6, "savedAt": "2026-01-12T16:18:10.568Z", "skills": [ { "row": 16, "col": "C", "imgSrc": "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png" }, { "row": 17, "col": "C", "imgSrc": "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png" } ], "texts": [ { "row": 10, "col": "C", "text": "å¼±ä½“7å›", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 11, "col": "C", "text": "é©±æ•£2å›", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 27, "col": "C", "text": "å¼±ä½“7å›", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 28, "col": "C", "text": "é©±æ•£2å›", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 30, "col": "C", "text": "éšæœºè¯•ç‚¼1/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 31, "col": "C", "text": "éšæœºè¯•ç‚¼2/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 32, "col": "C", "text": "éšæœºè¯•ç‚¼3/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" } ], "phases": [ { "name": "100%-80%", "rowspan": 10, "rows": [ { "index": 0, "coord": 2, "text": "1T", "exists": true }, { "index": 1, "coord": 3, "text": "2T", "exists": true }, { "index": 2, "coord": 4, "text": "3T", "exists": true }, { "index": 3, "coord": 5, "text": "4T", "exists": true }, { "index": 4, "coord": 6, "text": "5T", "exists": true }, { "index": 5, "coord": 7, "text": "TA4å›", "exists": true }, { "index": 6, "coord": 8, "text": "2000wå¥¥ä¹‰", "exists": true }, { "index": 7, "coord": 9, "text": "1500æŠ€ä¼¤", "exists": true }, { "index": 8, "coord": 10, "text": "æ»¡è±†1", "exists": true }, { "index": 9, "coord": 11, "text": "æ»¡è±†2", "exists": true } ], "className": "phase-100-80" }, { "name": "80%-60%", "rowspan": 6, "rows": [ { "index": 0, "coord": 12, "text": "80%", "exists": true }, { "index": 1, "coord": 13, "text": "40HIT", "exists": true }, { "index": 2, "coord": 14, "text": "1500wæŠ€ä¼¤", "exists": true }, { "index": 3, "coord": 15, "text": "TA4å›", "exists": true }, { "index": 4, "coord": 16, "text": "TA3å›", "exists": true }, { "index": 5, "coord": 17, "text": "å¥¥ä¹‰4å›", "exists": true } ], "className": "phase-80-60" }, { "name": "60%-20%", "rowspan": 11, "rows": [ { "index": 0, "coord": 18, "text": "60%", "exists": true }, { "index": 1, "coord": 19, "text": "è‹¹æœ", "exists": true }, { "index": 2, "coord": 20, "text": "æ— ç‰¹åŠ¨", "exists": true }, { "index": 3, "coord": 21, "text": "å¥¥ä¹‰5å›", "exists": true }, { "index": 4, "coord": 22, "text": "æ”»å‡»6å›", "exists": true }, { "index": 5, "coord": 23, "text": "3500wä¼¤å®³", "exists": true }, { "index": 6, "coord": 24, "text": "å¼±ä½“10å›", "exists": true }, { "index": 7, "coord": 25, "text": "FC", "exists": true }, { "index": 8, "coord": 26, "text": "60HIT", "exists": true }, { "index": 9, "coord": 27, "text": "æ»¡è±†1", "exists": true }, { "index": 10, "coord": 28, "text": "æ»¡è±†2", "exists": true } ], "className": "phase-60-20" }, { "name": "20%-0%", "rowspan": 7, "rows": [ { "index": 0, "coord": 29, "text": "20%", "exists": true }, { "index": 1, "coord": 30, "text": "6å›å¥¥ä¹‰", "exists": true }, { "index": 2, "coord": 31, "text": "12å›æŠ€èƒ½", "exists": true }, { "index": 3, "coord": 32, "text": "66æ¬¡ä¼¤å®³", "exists": true }, { "index": 4, "coord": 33, "text": "FC", "exists": true }, { "index": 5, "coord": 34, "text": "99e", "exists": true }, { "index": 6, "coord": 35, "text": "99HIT", "exists": true } ], "className": "phase-20-0" } ], "tTexts": [ { "row": 0, "col": "A", "text": "é˜¶æ®µ", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "B", "text": "å›åˆ/ç‰¹åŠ¨", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "C", "text": "å¤‡æ³¨", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "D", "text": "å¬å”¤çŸ³", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "E", "text": "ä¸»è§’", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "F", "text": "2å·ä½", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "G", "text": "3å·ä½", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "H", "text": "4å·ä½", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "I", "text": "åæ’1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "J", "text": "åæ’2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 2, "col": "A", "text": "100%-80%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 2, "col": "B", "text": "1T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 3, "col": "B", "text": "2T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 4, "col": "B", "text": "3T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 5, "col": "B", "text": "4T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 6, "col": "B", "text": "5T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 7, "col": "B", "text": "TA4å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 8, "col": "B", "text": "2000wå¥¥ä¹‰", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 9, "col": "B", "text": "1500æŠ€ä¼¤", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 10, "col": "B", "text": "æ»¡è±†1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 11, "col": "B", "text": "æ»¡è±†2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 12, "col": "A", "text": "80%-60%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 12, "col": "B", "text": "80%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 13, "col": "B", "text": "40HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 14, "col": "B", "text": "1500wæŠ€ä¼¤", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 15, "col": "B", "text": "TA4å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 16, "col": "B", "text": "TA3å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 17, "col": "B", "text": "å¥¥ä¹‰4å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 18, "col": "A", "text": "60%-20%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 18, "col": "B", "text": "60%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 19, "col": "B", "text": "è‹¹æœ", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 20, "col": "B", "text": "æ— ç‰¹åŠ¨", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 21, "col": "B", "text": "å¥¥ä¹‰5å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 22, "col": "B", "text": "æ”»å‡»6å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 23, "col": "B", "text": "3500wä¼¤å®³", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 24, "col": "B", "text": "å¼±ä½“10å›", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 25, "col": "B", "text": "FC", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 26, "col": "B", "text": "60HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 27, "col": "B", "text": "æ»¡è±†1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 28, "col": "B", "text": "æ»¡è±†2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 29, "col": "A", "text": "20%-0%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 29, "col": "B", "text": "20%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 30, "col": "B", "text": "6å›å¥¥ä¹‰", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 31, "col": "B", "text": "12å›æŠ€èƒ½", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 32, "col": "B", "text": "66æ¬¡ä¼¤å®³", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 33, "col": "B", "text": "FC", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 34, "col": "B", "text": "99e", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 35, "col": "B", "text": "99HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false } ], "rows": [ { "index": 0, "hasPhase": true, "rowspan": 10, "phaseName": "100%-80%", "phaseClass": "phase-100-80" }, { "index": 1, "hasPhase": false }, { "index": 2, "hasPhase": false }, { "index": 3, "hasPhase": false }, { "index": 4, "hasPhase": false }, { "index": 5, "hasPhase": false }, { "index": 6, "hasPhase": false }, { "index": 7, "hasPhase": false }, { "index": 8, "hasPhase": false }, { "index": 9, "hasPhase": false }, { "index": 10, "hasPhase": true, "rowspan": 6, "phaseName": "80%-60%", "phaseClass": "phase-80-60" }, { "index": 11, "hasPhase": false }, { "index": 12, "hasPhase": false }, { "index": 13, "hasPhase": false }, { "index": 14, "hasPhase": false }, { "index": 15, "hasPhase": false }, { "index": 16, "hasPhase": true, "rowspan": 11, "phaseName": "60%-20%", "phaseClass": "phase-60-20" }, { "index": 17, "hasPhase": false }, { "index": 18, "hasPhase": false }, { "index": 19, "hasPhase": false }, { "index": 20, "hasPhase": false }, { "index": 21, "hasPhase": false }, { "index": 22, "hasPhase": false }, { "index": 23, "hasPhase": false }, { "index": 24, "hasPhase": false }, { "index": 25, "hasPhase": false }, { "index": 26, "hasPhase": false }, { "index": 27, "hasPhase": true, "rowspan": 7, "phaseName": "20%-0%", "phaseClass": "phase-20-0" }, { "index": 28, "hasPhase": false }, { "index": 29, "hasPhase": false }, { "index": 30, "hasPhase": false }, { "index": 31, "hasPhase": false }, { "index": 32, "hasPhase": false }, { "index": 33, "hasPhase": false } ], "headerImages": [ { "type": "skill-source", "row": 1, "col": "D", "index": 0, "src": "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" }, { "type": "boss-image", "src": "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" }, { "type": "status-icon", "index": 0, "src": "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png" }, { "type": "status-icon", "index": 1, "src": "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png" } ], "swapSections": [], "metadata": { "authors": [ "çœŸå¯¦lowb" ], "lastEditor": "çœŸå¯¦lowb" }, "mergedCells": []}'


        // ========== é»˜è®¤æ¨¡æ¿ JSON é…ç½®ç»“æŸ ==========

        // 9äººé«˜éš¾æ¨¡æ¿ (ä¿ç•™å…¼å®¹æ€§)
        function bossTemplate() {
            showBossSelectModal();
        }
        
        // 6äººæ™®é€šæ¨¡æ¿ (ä¿ç•™å…¼å®¹æ€§)
        function normalTemplate() {
            showBossSelectModal();
        }
        
        // [ä¿®å¤] å¢åŠ  isRestoring å‚æ•°ï¼Œç”¨äºåœ¨åŠ è½½å­˜æ¡£æ—¶é™é»˜åˆ‡æ¢éª¨æ¶
        // [æŠ€æœ¯å€º - P2] å½“å‰ä½¿ç”¨ innerHTML å­—ç¬¦ä¸²æ‹¼æ¥æ„é€  HTMLï¼Œå­˜åœ¨ä»¥ä¸‹éšæ‚£ï¼š
        //   1. å¦‚æœæ•°æ®æºï¼ˆå¦‚ Excelï¼‰åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½å¯¼è‡´ XSS é£é™©
        //   2. ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§è¾ƒå·®
        //   3. æ€§èƒ½ç•¥ä½äº DOM API
        // å»ºè®®ï¼šæœªæ¥é‡æ„ä¸ºä½¿ç”¨ createElement/appendChild ç­‰ DOM API æ–¹æ³•
        function loadTemplate(mode, isRestoring) {
            var is9Man = (mode === 9);
            var thead = document.querySelector('thead');
            var tbody = document.querySelector('tbody');
            
            // å®šä¹‰ SVG ç¼–è¾‘å›¾æ ‡ï¼Œæ–¹ä¾¿å¤ç”¨
            var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            
            // å‡†å¤‡é»˜è®¤çŠ¶æ€æ å›¾æ ‡
            var statusHtml = '';
            if (is9Man) {
                // 9äººæ¨¡å¼ï¼šåŠ è½½æŒ‡å®šçš„8å¼ å›¾ç‰‡
                var icons9 = [
                    "https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png",
                    "https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png",
                    "https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png",
                    "https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png",
                    "https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png",
                    "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png",
                    "https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png",
                    "https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png",
                    "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"
                ];
                icons9.forEach(function(url){
                    statusHtml += '<span class="skill-box skill-source"><img src="' + url + '" style="width:33px;height:33px;"></span>';
                });
            } else {
                // 6äººæ¨¡å¼ï¼šä¿ç•™å‡ ä¸ªé»˜è®¤çš„
                var icons6 = [
                    "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png",
                    "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png"
                ];
                icons6.forEach(function(url){
                    statusHtml += '<span class="skill-box skill-source"><img src="' + url + '" style="width:33px;height:33px;"></span>';
                });
            }
            
            // 1. ç”Ÿæˆè¡¨å¤´ HTML
            var extraHeader = '';
            var extraSource = '';
            
            // å®šä¹‰åæ’é…ç½®
            var backs = [
                {c:'I', n:'åæ’1', cls:'back-row'},
                {c:'J', n:'åæ’2', cls:'back-row'}
            ];
            if(is9Man) {
                backs.push(
                    {c:'K', n:'åæ’3', cls:'back-row-2'},
                    {c:'L', n:'åæ’4', cls:'back-row-2'},
                    {c:'M', n:'åæ’5', cls:'back-row-2'}
                );
            }
            
            // å¾ªç¯ç”Ÿæˆè¡¨å¤´æ ¼ (æ³¨æ„ï¼šsrc å·²æ”¹ä¸º EMPTY_IMAGE_SRC)
            backs.forEach(function(b){
                extraHeader += '<th class="character-header ' + b.cls + ' has-fab"><span class="coord-header">(0,' + b.c + ')</span><br><img src="' + EMPTY_IMAGE_SRC + '" style="display:none"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">' + b.n + '</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="ç¼–è¾‘è§’è‰²">' + editIcon + '</div></th>';
                extraSource += '<td class="source-cell"><span class="coord">(1,' + b.c + ')</span></td>';
            });
            
            var colSpan = is9Man ? 13 : 10;
            
            // æ ¹æ®æ¨¡å¼é€‰æ‹©é»˜è®¤BOSSå›¾ç‰‡
            // 9äººæ¨¡å¼(æå¦ˆ) ç”¨ 2900032000_unlimited.pngï¼Œ6äººæ¨¡å¼(ææ³•) ç”¨ 305581.png
            var bossImgUrl = is9Man 
                ? 'https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305701.png'
                : 'https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png';
            
            // é‡å†™ thead
            thead.innerHTML = '<tr class="top-row has-fab"><th colspan="' + colSpan + '" style="padding:10px;position:relative;"><img src="' + bossImgUrl + '" style="max-width:100%;height:auto;"><button class="mini-fab edit" onclick="showQuickAddBoss(this)">' + editIcon + '</button></th></tr>' +
                '<tr class="top-row has-fab"><th colspan="' + colSpan + '" style="padding:8px;position:relative;min-height:50px;">' + statusHtml + '<button class="mini-fab edit" onclick="showQuickAddStatus(this)">' + editIcon + '</button></th></tr>' +
                '<tr>' +
                    '<th><span class="coord-header">(0,A)</span><br><span class="header-text t-text">é˜¶æ®µ</span></th>' +
                    '<th><span class="coord-header">(0,B)</span><br><span class="header-text t-text">å›åˆ/ç‰¹åŠ¨</span></th>' +
                    '<th><span class="coord-header">(0,C)</span><br><span class="header-text t-text">å¤‡æ³¨</span></th>' +
                    '<th><span class="coord-header">(0,D)</span><br><span class="header-text t-text">å¬å”¤çŸ³</span></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,E)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">ä¸»è§’</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="ç¼–è¾‘è§’è‰²">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,F)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">2å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="ç¼–è¾‘è§’è‰²">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,G)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">3å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="ç¼–è¾‘è§’è‰²">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,H)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">4å·ä½</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="ç¼–è¾‘è§’è‰²">' + editIcon + '</div></th>' +
                    extraHeader +
                '</tr>' +
                '<tr class="skill-source-row">' +
                    '<td colspan="2" class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,A-B)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest(\'.source-cell\'))">' + editIcon + '</button></td>' +
                    '<td class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,C)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest(\'.source-cell\'))">' + editIcon + '</button></td>' +
                    '<td class="source-cell"><span class="coord">(1,D)</span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span></td>' +
                    '<td class="source-cell"><span class="coord">(1,E)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,F)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,G)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,H)</span></td>' +
                    extraSource +
                '</tr>';
            
            // 2. é‡å†™ tbody (ç”Ÿæˆé»˜è®¤çš„ä¸€ä¸ªé˜¶æ®µ)
            tbody.innerHTML = '';
            
            // ç›´æ¥æ ¹æ® is9Man ç”Ÿæˆæ•°æ®æ ¼ï¼Œä¸ä¾èµ– DOM æ£€æµ‹
            var dataCellsHtml = '';
            var cols = is9Man ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            cols.forEach(function(col, i) {
                var cls = (i >= 4) ? 'note-cell' : 'data-cell';
                dataCellsHtml += '<td class="' + cls + '"><span class="coord">(2,' + col + ')</span></td>';
            });
            
            var rowHTML = '<tr>' +
                '<td rowspan="1"><span class="coord">(2,A)</span><span class="t-text phase-name" contenteditable="true" onblur="GBFGuide.Storage.save()">100%-?</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)">âˆ’</button><button class="phase-btn" onclick="insertPhaseBelow(this)">+</button></div></td>' +
                '<td><span class="coord">(2,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">1T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>' +
                '<td class="data-cell"><span class="coord">(2,C)</span></td>' +
                '<td><span class="coord">(2,D)</span></td>' +
                dataCellsHtml +
                '</tr>';
            tbody.innerHTML = rowHTML;
            
            // 3. é‡æ–°ç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ–
            // è°ƒç”¨ç»Ÿä¸€åˆå§‹åŒ–å‡½æ•°ï¼ˆå…³é”®ï¼ï¼‰
            initDynamicElements();
            
            // åˆ·æ–°åæ ‡å’Œä¿å­˜
            recalculateAllCoords();
            
            // [æ–°å¢] åˆ·æ–°é˜¶æ®µé¢œè‰²ï¼Œç¡®ä¿é¢œè‰²å¾ªç¯æ­£ç¡®
            refreshPhaseColors();
            
            // [æ–°å¢] å¼ºåˆ¶åº”ç”¨ä¸€æ¬¡é»˜è®¤å­—å·è®¾ç½®ï¼Œè§£å†³æ–‡å­—å’ŒæŒ‰é’®å¤§å°ä¸å¯¹çš„é—®é¢˜
            applyDefaultFontSize();
            
            // [æ–°å¢] å¼ºåˆ¶åº”ç”¨å›¾æ ‡ç¼©æ”¾è®¾ç½®ï¼Œç¡®ä¿æ–°ç”Ÿæˆçš„æŒ‰é’®åº”ç”¨å½“å‰çš„ç¼©æ”¾è®¾ç½®
            applyIconScaling();
            
            // [ä¿®æ”¹] ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æ§åˆ¶æ¢äººè¡ŒæŒ‰é’®çš„æ˜¾ç¤º
            updateSwapButtonState();
            
            // [ä¿®å¤] å¦‚æœæ˜¯æ¢å¤æ•°æ®æ¨¡å¼ï¼Œä¸è¦è§¦å‘ä¿å­˜ï¼Œä¸è¦å¼¹çª—æé†’
            if (!isRestoring) {
                // [æ–°å¢] æ£€æŸ¥æ˜¯å¦æœ‰é»˜è®¤ JSON é…ç½®ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨åŠ è½½
                var defaultJson = is9Man ? DEFAULT_9MAN_JSON : DEFAULT_6MAN_JSON;
                if (defaultJson) {
                    try {
                        var data = JSON.parse(defaultJson);
                        restoreData(data);
                        GBFGuide.Storage.save();
                        alert(is9Man ? 'å·²åˆ‡æ¢è‡³ã€9äººæ¨¡å¼ã€‘å¹¶åŠ è½½é»˜è®¤é…ç½®' : 'å·²åˆ‡æ¢è‡³ã€6äººæ¨¡å¼ã€‘å¹¶åŠ è½½é»˜è®¤é…ç½®');
                    } catch(e) {
                        console.error('é»˜è®¤JSONè§£æå¤±è´¥:', e);
                        GBFGuide.Storage.save();
                        alert(is9Man ? 'å·²åˆ‡æ¢è‡³ã€æå¦ˆæ¨¡æ¿ã€‘' : 'å·²åˆ‡æ¢è‡³ã€ææ³•æ¨¡æ¿ã€‘');
                    }
                } else {
                    GBFGuide.Storage.save();
                    alert(is9Man ? 'å·²åˆ‡æ¢è‡³ã€æå¦ˆæ¨¡æ¿ã€‘' : 'å·²åˆ‡æ¢è‡³ã€ææ³•æ¨¡æ¿ã€‘');
                }
            }
        }
        
        // ========== [æ–°å¢] æ¢äººè¡ŒåŠŸèƒ½ ==========
        // å…¨å±€è®¡æ•°å™¨ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€çš„æ¢äººè¡ŒID
        var swapRowCounter = 0;
        
        // [é‡æ„] æ’å…¥æ¢äºº/è½¬é˜¶æ®µåŠŸèƒ½ - ä¿®å¤ M æ ¼è¯¯è§¦å’Œ B åˆ—æ˜¾ç¤ºé—®é¢˜
        function insertSwapRow() {
            var tbody = document.querySelector('tbody');
            var is9ManMode = document.querySelector('thead .back-row-2') !== null;
            var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            
            // ç”Ÿæˆå”¯ä¸€ID
            swapRowCounter++;
            var swapId = 'swap-' + swapRowCounter + '-' + Date.now();
            
            // --- 1. æ„å»ºç¬¬ä¸€è¡Œï¼šè§’è‰²å¤´åƒæ  (swap-header-row) ---
            // [ä¿®å¤] A+B åˆ—åˆå¹¶ï¼Œç¡®ä¿ä¸å†å‡ºç°ç‹¬ç«‹çš„ "B" æ ¼å­
            var labelColsHtml = '<td colspan="2" class="swap-label-cell" style="vertical-align:middle; text-align:center; position:relative;">' +
                '<div style="font-weight:bold; color:var(--text-secondary); font-size:12px;">ğŸ”„ æ¢äºº</div>' +
                '<button class="swap-delete-btn" onclick="removeSwapSection(this)" title="åˆ é™¤æ­¤æ¢äººåŒºå—">Ã—</button>' +
                '</td>' +
                '<td class="swap-label-cell"></td>' +
                '<td class="swap-label-cell"></td>';
            
            // ç”Ÿæˆè§’è‰²åˆ— E-M
            var cols = is9ManMode ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            var names = ['ä¸»è§’','2å·ä½','3å·ä½','4å·ä½','åæ’1','åæ’2','åæ’3','åæ’4','åæ’5'];
            
            var charColsHtml = '';
            cols.forEach(function(col, idx) {
                var backClass = '';
                if(idx >= 4 && idx <= 5) backClass = ' back-row';
                if(idx >= 6) backClass = ' back-row-2';
                
                // [ä¿®å¤] æ·»åŠ  position:relative ç¡®ä¿ç¼–è¾‘æŒ‰é’®å®šä½æ­£ç¡®
                charColsHtml += '<td class="swap-char-cell character-header has-fab has-empty-state' + backClass + '" style="position:relative;">' +
                    '<span class="coord-header">(SW' + swapRowCounter + ',' + col + ')</span><br>' +
                    '<img src="' + EMPTY_IMAGE_SRC + '" style="display:none">' +
                    '<span class="header-text t-text char-name" contenteditable="true" onblur="GBFGuide.Storage.save()">' + names[idx] + '</span>' +
                    '<div class="btn-edit-glass" onclick="showQuickAddCharacterForSwap(this.closest(\'.swap-char-cell\'))">' + editIcon + '</div>' +
                    '</td>';
            });
            
            var trHeader = document.createElement('tr');
            trHeader.className = 'swap-header-row';
            trHeader.setAttribute('data-swap-id', swapId);
            trHeader.innerHTML = labelColsHtml + charColsHtml;
            
            // --- 2. æ„å»ºç¬¬äºŒè¡Œï¼šæºæŠ€èƒ½æ  (swap-source-row) ---
            // [ä¿®å¤] E-M åˆ—ä¸æ·»åŠ ä»»ä½• onclick æˆ–ç¼–è¾‘æŒ‰é’®ï¼Œåªèƒ½é€šè¿‡æ‹–æ‹½æ·»åŠ ï¼Œæ‚¬åœæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            var sourceColsHtml = '';
            cols.forEach(function(col, idx) {
                var backClass = '';
                if(idx >= 4 && idx <= 5) backClass = ' back-row';
                if(idx >= 6) backClass = ' back-row-2';
                // çº¯å‡€çš„æ ¼å­ï¼Œåªæœ‰åæ ‡ï¼Œæ— æŒ‰é’®
                sourceColsHtml += '<td class="source-cell' + backClass + '">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',' + col + ')</span>' +
                    '</td>';
            });
            
            var trSource = document.createElement('tr');
            trSource.className = 'skill-source-row swap-source-row';
            trSource.setAttribute('data-swap-id', swapId);
            // [ä¿®å¤] A-Bã€C åˆ—ç§»é™¤ç¼–è¾‘æŒ‰é’®ï¼Œç»Ÿä¸€ä½¿ç”¨æ‚¬åœåˆ é™¤
            trSource.innerHTML = 
                '<td colspan="2" class="source-cell" style="vertical-align:middle;position:relative;">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',A-B)</span>' +
                '</td>' +
                '<td class="source-cell" style="vertical-align:middle;position:relative;">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',C)</span>' +
                '</td>' +
                '<td class="source-cell">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',D)</span>' +
                    '<span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span>' +
                '</td>' +
                sourceColsHtml;
            
            // æ’å…¥åˆ°è¡¨æ ¼åº•éƒ¨
            tbody.appendChild(trHeader);
            tbody.appendChild(trSource);
            
            // åˆå§‹åŒ–åŠŸèƒ½ (æ‹–æ‹½ã€ç¼©æ”¾ç­‰)
            initSwapRowElements(trHeader, trSource);
            
            if(typeof applyIconScaling === 'function') applyIconScaling();
            GBFGuide.Storage.save();
            
            // æ»šåŠ¨åˆ°æ–°åŒºåŸŸ
            trHeader.scrollIntoView({behavior: "smooth"});
        }
        
        // åˆ é™¤æ¢äººåŒºå— (åŒæ—¶åˆ é™¤å¤´åƒè¡Œå’ŒæŠ€èƒ½è¡Œ)
        function removeSwapSection(btn) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¢äººåŒºå—å—ï¼Ÿ(å°†åˆ é™¤å¤´åƒè¡Œå’Œå¯¹åº”çš„æŠ€èƒ½è¡Œ)')) {
                var trHeader = btn.closest('tr');
                var swapId = trHeader.getAttribute('data-swap-id');
                
                // é€šè¿‡ data-swap-id æ‰¾åˆ°å¯¹åº”çš„æŠ€èƒ½è¡Œ
                var trSource = document.querySelector('tr.swap-source-row[data-swap-id="' + swapId + '"]');
                
                if(trSource) {
                    trSource.remove();
                }
                trHeader.remove();
                GBFGuide.Storage.save();
            }
        }
        
        // ä¸ºæ¢äººè¡Œçš„è§’è‰²æ ¼æ˜¾ç¤ºå¿«é€Ÿæ·»åŠ å¼¹çª—
        function showQuickAddCharacterForSwap(cell) {
            // å¤ç”¨ç°æœ‰çš„è§’è‰²æ·»åŠ é€»è¾‘ï¼Œä½†é’ˆå¯¹æ¢äººè¡Œçš„å•å…ƒæ ¼
            if(typeof showQuickAddCharacter === 'function') {
                // ä¸´æ—¶ç»™ cell æ·»åŠ  character-header ç±»ä»¥å¤ç”¨é€»è¾‘
                var originalClass = cell.className;
                cell.classList.add('character-header');
                showQuickAddCharacter(cell);
                // æ¢å¤åŸå§‹ç±»åï¼ˆåœ¨å¼¹çª—å…³é—­åä¼šè‡ªåŠ¨å¤„ç†ï¼‰
            }
        }
        
        // åˆå§‹åŒ–æ¢äººè¡Œå…ƒç´ çš„äº‹ä»¶ç»‘å®š
        function initSwapRowElements(headerRow, sourceRow) {
            // ä¸ºæ¢äººè¡Œçš„è§’è‰²æ ¼ç»‘å®šæ‹–æ”¾äº‹ä»¶
            headerRow.querySelectorAll('.swap-char-cell').forEach(function(cell, idx) {
                // 1. æ‹–æ‹½è¿›å…¥ï¼šæ·»åŠ é«˜äº®æ ·å¼
                cell.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    // æ£€æŸ¥å†…éƒ¨æ‹–æ‹½(draggedElement)æˆ–å¤–éƒ¨æ‹–æ‹½(dataTransfer)
                    if(draggedElement || e.dataTransfer.types.length > 0) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 2. æ‹–æ‹½æ‚¬åœï¼šä¿æŒå…è®¸æ”¾ç½®çŠ¶æ€
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 3. æ‹–æ‹½ç¦»å¼€ï¼šç§»é™¤é«˜äº®æ ·å¼
                cell.addEventListener('dragleave', function(e) {
                    if(e.target === this) {
                        this.classList.remove('drag-feedback');
                    }
                });
                
                // 4. æ”¾ç½®ï¼šå¤„ç†å†…éƒ¨æ‹–æ‹½å’Œå¤–éƒ¨æ‹–æ‹½
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // [ä¿®å¤] é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å…¶ä»–ç›‘å¬å™¨é‡å¤å¤„ç†
                    this.classList.remove('drag-feedback');
                    
                    var imgSrc = '';
                    
                    // ä¼˜å…ˆå¤„ç†å†…éƒ¨æ‹–æ‹½ (draggedElement)
                    if(draggedElement) {
                        var dragImg = draggedElement.querySelector('img');
                        if(dragImg) {
                            imgSrc = dragImg.src;
                        }
                    }
                    
                    // å…¶æ¬¡å¤„ç†å¤–éƒ¨æ‹–æ‹½
                    if(!imgSrc) {
                        // æ–¹å¼1: text/html
                        var htmlData = e.dataTransfer.getData('text/html');
                        if(htmlData) {
                            var match = htmlData.match(/<img[^>]+src=["']([^"']+)["']/i);
                            if(match && match[1]) imgSrc = match[1];
                        }
                        // æ–¹å¼2: text/plain
                        if(!imgSrc) {
                            var plainText = e.dataTransfer.getData('text/plain');
                            if(plainText && plainText.match(/^https?:\/\//i)) imgSrc = plainText;
                        }
                    }
                    
                    if(imgSrc) {
                        var img = this.querySelector('img');
                        if(img) {
                            img.src = imgSrc;
                            img.style.display = '';
                        }
                        // æ›´æ–°ç©ºçŠ¶æ€
                        updateSwapCharEmptyState(this);
                        GBFGuide.Storage.save();
                    }
                });
                
                // åˆå§‹è§¦å‘ç©ºçŠ¶æ€æ£€æµ‹
                updateSwapCharEmptyState(cell);
            });
            
            // ä¸ºæ¢äººè¡Œçš„æŠ€èƒ½æ ¼ç»‘å®šæ‹–æ”¾äº‹ä»¶
            sourceRow.querySelectorAll('.source-cell').forEach(function(cell) {
                var coordEl = cell.querySelector('.coord');
                var coordText = coordEl ? coordEl.textContent : '';
                var isSummonCell = coordText.indexOf('A-B') > -1 || coordText.indexOf(',C)') > -1;
                var isSkillCell = !isSummonCell && coordText.indexOf(',D)') === -1; // æ’é™¤Dåˆ—(FCæ ¼)
                
                // 1. æ‹–æ‹½è¿›å…¥ï¼šæ·»åŠ é«˜äº®æ ·å¼
                cell.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    // æ£€æŸ¥å†…éƒ¨æ‹–æ‹½(draggedElement)æˆ–å¤–éƒ¨æ‹–æ‹½(dataTransfer)
                    if(draggedElement || e.dataTransfer.types.length > 0) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 2. æ‹–æ‹½æ‚¬åœï¼šä¿æŒå…è®¸æ”¾ç½®çŠ¶æ€
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 3. æ‹–æ‹½ç¦»å¼€ï¼šç§»é™¤é«˜äº®æ ·å¼
                cell.addEventListener('dragleave', function(e) {
                    if(e.target === this) {
                        this.classList.remove('drag-feedback');
                    }
                });
                
                // 4. æ”¾ç½®ï¼šå¤„ç†å†…éƒ¨æ‹–æ‹½å’Œå¤–éƒ¨æ‹–æ‹½
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // [ä¿®å¤] é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å…¶ä»–ç›‘å¬å™¨é‡å¤å¤„ç†
                    this.classList.remove('drag-feedback');
                    
                    var imgSrc = '';
                    var cellRef = this;
                    var coordEl = cellRef.querySelector('.coord');
                    var isSummon = coordEl && 
                        (coordEl.textContent.indexOf('A-B') > -1 || 
                         coordEl.textContent.indexOf(',C)') > -1);
                    
                    // ä¼˜å…ˆå¤„ç†å†…éƒ¨æ‹–æ‹½ (draggedElement)
                    if(draggedElement) {
                        var dragImg = draggedElement.querySelector('img');
                        if(dragImg) {
                            imgSrc = dragImg.src;
                        }
                    }
                    
                    // å…¶æ¬¡å¤„ç†å¤–éƒ¨æ‹–æ‹½
                    if(!imgSrc) {
                        // æ–¹å¼1: text/html
                        var htmlData = e.dataTransfer.getData('text/html');
                        if(htmlData) {
                            var match = htmlData.match(/<img[^>]+src=["']([^"']+)["']/i);
                            if(match && match[1]) imgSrc = match[1];
                        }
                        // æ–¹å¼2: text/plain
                        if(!imgSrc) {
                            var plainText = e.dataTransfer.getData('text/plain');
                            if(plainText && plainText.match(/^https?:\/\//i)) imgSrc = plainText;
                        }
                    }
                    
                    if(imgSrc) {
                        // åˆ›å»ºæ–°çš„ skill-box
                        // [ä¿®å¤] æ‰€æœ‰åˆ—ç»Ÿä¸€ä½¿ç”¨æ‚¬åœåˆ é™¤æŒ‰é’®
                        var box = createSkillBox(imgSrc, {
                            className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                            size: 40,
                            editable: true,
                            deletable: true, // æ‰€æœ‰åˆ—éƒ½æœ‰åˆ é™¤æŒ‰é’®
                            dragImageSize: 20
                        });
                        cellRef.appendChild(box);
                        
                        // æ›´æ–°ç©ºçŠ¶æ€
                        if(isSummon) {
                            updateSwapSummonEmptyState(cellRef);
                        } else {
                            updateSwapSourceEmptyState(cellRef);
                        }
                        GBFGuide.Storage.save();
                    }
                });
                
                // ç§»é™¤åŒå‡»æ·»åŠ å¬å”¤çŸ³åŠŸèƒ½ï¼ˆç»Ÿä¸€ä½¿ç”¨æ‹–æ‹½ï¼‰
                
                // åˆå§‹è§¦å‘ç©ºçŠ¶æ€æ£€æµ‹
                if(isSummonCell) {
                    updateSwapSummonEmptyState(cell);
                } else if(isSkillCell) {
                    updateSwapSourceEmptyState(cell);
                }
            });
        }
        
        // [æ–°å¢] æ¢äººè¡Œè§’è‰²æ ¼ç©ºçŠ¶æ€æ£€æµ‹
        function updateSwapCharEmptyState(cell) {
            if (!cell) return;
            
            var img = cell.querySelector('img');
            var isEmpty = !img || !img.src || img.src === EMPTY_IMAGE_SRC || img.src.trim() === '' || img.style.display === 'none';
            var existingHint = cell.querySelector('.empty-state-hint');
            
            if (isEmpty && !existingHint) {
                // åˆ¤æ–­æ˜¯å¦ä¸ºä¸»è§’ä½ç½®
                var coordEl = cell.querySelector('.coord-header');
                var isMainChar = coordEl && coordEl.textContent.indexOf(',E)') > -1;
                var wikiUrl = isMainChar ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95' : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
                var wikiText = isMainChar ? 'ğŸ”— WikièŒä¸š' : 'ğŸ”— WikiæŸ¥è¯¢';
                var emptyText = isMainChar ? 'æ‹–å…¥èŒä¸šå›¾ç‰‡' : 'æ‹–å…¥è§’è‰²å›¾ç‰‡';
                
                var hint = document.createElement('div');
                hint.className = 'empty-state-hint';
                hint.innerHTML = '<span class="empty-text">' + emptyText + '</span>' +
                    '<div class="empty-buttons">' +
                    '<a href="' + wikiUrl + '" target="_blank" class="wiki-btn-small wiki-warning">' + wikiText + '</a>' +
                    '<a href="https://game.granbluefantasy.jp/#party/index/0/npc/0" target="_blank" class="wiki-btn-small">ğŸ”— ç¼–é˜Ÿ</a>' +
                    '</div>';
                cell.appendChild(hint);
                cell.classList.add('has-empty-state');
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }
        
        // [æ–°å¢] æ¢äººè¡ŒæŠ€èƒ½æºæ ¼ç©ºçŠ¶æ€æ£€æµ‹
        function updateSwapSourceEmptyState(cell) {
            if (!cell) return;
            
            var skillBoxes = cell.querySelectorAll('.skill-box');
            var isEmpty = skillBoxes.length === 0;
            var existingHint = cell.querySelector('.swap-source-empty-hint');
            
            // è·³è¿‡ D åˆ—ï¼ˆFCæ ¼ï¼‰å’Œ A-B/C åˆ—ï¼ˆå¬å”¤çŸ³æ ¼ï¼Œå·²æœ‰ç¼–è¾‘æŒ‰é’®ï¼‰
            var coordEl = cell.querySelector('.coord');
            if (coordEl) {
                var coordText = coordEl.textContent;
                if (coordText.indexOf(',D)') > -1 || coordText.indexOf('A-B') > -1 || coordText.indexOf(',C)') > -1) {
                    return;
                }
            }
            
            if (isEmpty && !existingHint) {
                var hint = document.createElement('div');
                hint.className = 'swap-source-empty-hint';
                hint.style.cssText = 'font-size:10px;color:#999;text-align:center;padding:5px;';
                hint.textContent = 'æ‹–å…¥æŠ€èƒ½';
                cell.appendChild(hint);
                cell.classList.add('has-empty-state');
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }
        
        // [æ–°å¢] æ¢äººè¡Œå¬å”¤çŸ³æ ¼ç©ºçŠ¶æ€æ£€æµ‹
        // [ä¿®æ”¹] ç§»é™¤æ¢äººè¡ŒBåˆ—çš„ç©ºå¬å”¤æç¤ºï¼Œåªä¿ç•™ç§»é™¤é€»è¾‘
        function updateSwapSummonEmptyState(cell) {
            if (!cell) return;
            
            // åªå¤„ç†ç§»é™¤å·²æœ‰æç¤ºçš„é€»è¾‘ï¼Œä¸å†æ·»åŠ æ–°æç¤º
            var existingHint = cell.querySelector('.swap-summon-empty-hint');
            var skillBoxes = cell.querySelectorAll('.skill-box');
            var isEmpty = skillBoxes.length === 0;
            
            if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }

        // åŠ è½½é…ç½®åŠŸèƒ½
        function loadConfig(){
            var defaultData = localStorage.getItem(STORAGE_KEY + '_default');
            if(defaultData){
                if(confirm('ç¡®å®šåŠ è½½ä¿å­˜çš„é…ç½®ï¼Ÿå½“å‰å†…å®¹å°†è¢«è¦†ç›–ã€‚')){
                    restoreData(JSON.parse(defaultData));
                    GBFGuide.Storage.save();
                    alert('é…ç½®å·²åŠ è½½');
                }
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„é…ç½®');
            }
        }
        
        // æ¢å¤åŠŸèƒ½ - é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
        function resetData(){
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ¢å¤åˆå§‹çŠ¶æ€å°†æ¸…ç©ºæ‰€æœ‰å½“å‰ç¼–è¾‘çš„å†…å®¹ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            // 1. æ¸…ç©ºæœ¬åœ°å­˜å‚¨
            localStorage.removeItem(STORAGE_KEY);
            // 2. é‡ç½®æ¢äººè¡Œè®¡æ•°å™¨
            swapRowCounter = 0;
            // 3. æ£€æµ‹å½“å‰æ˜¯ 6äºº è¿˜æ˜¯ 9äºº æ¨¡å¼
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            // 4. é‡æ–°åŠ è½½å¯¹åº”æ¨¡æ¿
            loadTemplate(is9Man ? 9 : 6);
        }
        
        function saveAsDefault(){if(confirm('ç¡®è®¤ä¿å­˜å½“å‰é…ç½®ï¼Ÿ')){localStorage.setItem(STORAGE_KEY+'_default',JSON.stringify(collectData()));alert('å·²ä¿å­˜ä¸ºé»˜è®¤');}}
        
        function showTextInput(cell){
            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
            var p1Color=isDark?'#ff6b6b':'#c62828';
            var p2Color=isDark?'#ff8a80':'#c62828';
            var p3Color=isDark?'#e0e0e0':'#333';
            var p4Color=isDark?'#bdbdbd':'#333';
            var defaultSize=getDefaultFontSize();
            var overlay=document.createElement('div');overlay.className='modal-overlay';
            var modal=document.createElement('div');modal.className='text-input-modal';
            modal.innerHTML='<div style="margin-bottom:12px;font-size:14px;font-weight:500;">æ·»åŠ å¤‡æ³¨æ–‡å­—</div><input type="text" placeholder="è¾“å…¥å¤‡æ³¨å†…å®¹" maxlength="50" style="width:100%;margin-bottom:14px;"><div style="margin-bottom:14px;display:flex;flex-wrap:wrap;gap:4px;"><label class="material-radio"><input type="radio" name="style" value="1" checked><span style="color:'+p1Color+';font-weight:bold;">ä¼˜å…ˆçº§1</span></label><label class="material-radio"><input type="radio" name="style" value="2"><span style="color:'+p2Color+';">ä¼˜å…ˆçº§2</span></label><label class="material-radio"><input type="radio" name="style" value="3"><span style="color:'+p3Color+';font-weight:bold;">ä¼˜å…ˆçº§3</span></label><label class="material-radio"><input type="radio" name="style" value="4"><span style="color:'+p4Color+';">ä¼˜å…ˆçº§4</span></label></div><div style="display:flex;gap:10px;justify-content:flex-end;"><button class="btn-cancel" style="background:#616161;">å–æ¶ˆ</button><button class="btn-confirm">ç¡®å®š</button></div>';
            document.body.appendChild(overlay);document.body.appendChild(modal);
            var input=modal.querySelector('input[type="text"]');input.focus();
            function close(){overlay.remove();modal.remove();}
            function submit(){
                var txt=input.value.trim();if(!txt){close();return;}
                var style=modal.querySelector('input[name="style"]:checked').value;
                
                // åˆ›å»ºwrapperåŒ…è£¹ç”¨æˆ·æ–‡å­—å’Œåˆ é™¤æŒ‰é’®
                var wrapper=document.createElement('span');
                wrapper.className='user-text-wrapper';
                
                var span=document.createElement('span');
                span.className='user-text';
                span.textContent=txt;
                span.setAttribute('contenteditable','true');
                span.setAttribute('data-priority',style);
                span.style.fontSize=defaultSize+'px';
                if(style==='1'){span.style.color=p1Color;span.style.fontWeight='bold';}
                else if(style==='2'){span.style.color=p2Color;}
                else if(style==='3'){span.style.color=p3Color;span.style.fontWeight='bold';}
                else{span.style.color=p4Color;}
                
                // æ ‡è®°ä¸ºå¯ä»¥è¢«é»˜è®¤å­—å·å½±å“ï¼ˆä¸è®¾ç½®data-custom-sizeï¼‰
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                var delBtn=document.createElement('button');
                delBtn.className='mini-fab delete';
                delBtn.innerHTML='Ã—';
                delBtn.title='åˆ é™¤';
                delBtn.onclick=function(ev){
                    ev.stopPropagation();
                    var parentCell = wrapper.closest('td');
                    wrapper.remove();
                    GBFGuide.Storage.save();
                    // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
                    if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                };
                
                wrapper.appendChild(span);
                wrapper.appendChild(delBtn);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                span.addEventListener('blur',function(){
                    // æ¸…ç†ç©ºæ–‡æœ¬
                    if(!this.textContent.trim()){
                        var parentCell = wrapper.closest('td');
                        wrapper.remove();
                        // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
                        if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                    }
                    GBFGuide.Storage.save();
                });
                
                span.addEventListener('paste',function(e){
                    // åªå…è®¸ç²˜è´´çº¯æ–‡æœ¬ï¼Œé˜²æ­¢æ ¼å¼æ±¡æŸ“
                    e.preventDefault();
                    var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                    document.execCommand('insertText',false,text.substring(0,50));
                });
                
                span.addEventListener('keydown',function(e){
                    // é™åˆ¶é•¿åº¦
                    if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                        e.preventDefault();
                    }
                    // é˜²æ­¢æ¢è¡Œ
                    if(e.key==='Enter'){
                        e.preventDefault();
                        this.blur();
                    }
                });
                
                span.addEventListener('input',function(){
                    // ä¿æŒæ ·å¼ä¸å˜ï¼Œç§»é™¤ä»»ä½•å†…è”æ ¼å¼
                    var priority=this.getAttribute('data-priority');
                    var currentColor=this.style.color;
                    var currentWeight=this.style.fontWeight;
                    var currentSize=this.style.fontSize;
                    
                    // å¦‚æœæ£€æµ‹åˆ°æ ·å¼è¢«æ”¹å˜ï¼Œæ¢å¤å®ƒ
                    setTimeout(function(){
                        if(span.style.color!==currentColor)span.style.color=currentColor;
                        if(span.style.fontWeight!==currentWeight)span.style.fontWeight=currentWeight;
                        if(span.style.fontSize!==currentSize)span.style.fontSize=currentSize;
                    },0);
                });
                
                cell.appendChild(wrapper);
                GBFGuide.Storage.save();
                // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
                if(window.updateNoteEmptyState) window.updateNoteEmptyState(cell);
                close();
            }
            overlay.onclick=close;
            modal.querySelector('.btn-confirm').onclick=submit;
            modal.querySelector('.btn-cancel').onclick=close;
            input.onkeydown=function(e){if(e.key==='Enter')submit();if(e.key==='Escape')close();};
        }
        
        // [ä¿®å¤] å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½ - ä½¿ç”¨ fetch + blob æ–¹å¼å¤„ç†è·¨åŸŸå›¾ç‰‡
        function exportAsImage(){
            var tableWrapper = document.querySelector('.table-wrapper');
            var table = document.getElementById('guideTable');
            if (!tableWrapper || !table) return;
            
            // éšè—çŠ¶æ€æ 
            if(typeof statusBar !== 'undefined') statusBar.style.display = 'none';
            
            // ç»™ç”¨æˆ·åé¦ˆ
            var btn = document.querySelector('button[onclick="exportAsImage()"]');
            var originalText = btn ? btn.innerHTML : '';
            if(btn) {
                btn.innerHTML = 'â³ æ­£åœ¨å¤„ç†å›¾ç‰‡...';
                btn.disabled = true;
            }
            
            // å¯¼å‡ºå‰éšè—æ‰€æœ‰Mini FABæŒ‰é’®
            table.classList.add('exporting');
            
            // æ£€æµ‹å½“å‰ä¸»é¢˜
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var bgColor = isDark ? '#1e1e1e' : '#ffffff';
            var textColor = isDark ? '#e0e0e0' : '#333333';
            var borderColor = isDark ? '#444' : '#ddd';
            
            // ğŸŒŸ åˆ›å»ºé«˜çº§æ„Ÿæ°´å° (High-End Watermark) - é¡¶éƒ¨ç‰ˆæœ¬
            var watermark = document.createElement('div');
            watermark.id = 'exportWatermark';
            
            // ä½œè€…ä¿¡æ¯ï¼ˆå·¦ä¾§ï¼Œå¤§å­—ï¼‰
            var authorName = AuthorSystem.currentAuthor;
            var authorHtml = (authorName === 'è®¿å®¢' || authorName === 'Guest') ? 
                '<span style="font-size: 28px; font-weight: 900; letter-spacing: 1px;">GBF ä¸€å›¾æµæ”»ç•¥</span>' : 
                '<span style="opacity: 0.6; font-size: 14px; margin-right: 8px;">ä¸€å›¾æµåˆ¶ä½œ by</span>' +
                '<span style="font-size: 28px; font-weight: 900; letter-spacing: 1px;">' + authorName + '</span>';
            
            // å†å²è´¡çŒ®è€…ï¼ˆå·¦ä¾§ä¸‹æ–¹ï¼‰
            var historyNames = AuthorSystem.history.filter(function(n) { return n !== authorName && n !== 'è®¿å®¢' && n !== 'Guest'; });
            var contributorsHtml = '';
            if (historyNames.length > 0) {
                contributorsHtml = '<div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">è´¡çŒ®è€…: ' + historyNames.join(', ') + '</div>';
            }
            
            // æ°´å° HTML å†…å®¹ï¼ˆå·¦ä¾§ä½œè€…ï¼Œå³ä¾§ç½‘å€ï¼‰
            watermark.innerHTML = 
                '<div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; line-height: 1.2;">' +
                    '<div style="display: flex; flex-direction: column;">' +
                        '<div style="display: flex; align-items: baseline;">' + authorHtml + '</div>' +
                        contributorsHtml +
                    '</div>' +
                    '<div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">' +
                        '<span style="font-size: 18px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 2px;">gbfop.com</span>' +
                        '<span style="font-size: 12px; opacity: 0.6; font-weight: 500; letter-spacing: 1px;">GranBlueFantasy One Picture</span>' +
                    '</div>' +
                '</div>';
            
            // æ°´å°å®¹å™¨æ ·å¼ï¼ˆé¡¶éƒ¨ç‰ˆæœ¬ï¼‰
            watermark.style.cssText = 
                'margin-bottom: 20px;' +
                'padding: 20px 30px;' +
                'border-bottom: 3px solid ' + borderColor + ';' +
                'background: ' + bgColor + ';' +
                'color: ' + textColor + ';' +
                'font-family: "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;' +
                'box-sizing: border-box;' +
                'border-radius: 12px 12px 0 0;';
            
            // æ’å…¥æ°´å°åˆ°è¡¨æ ¼å®¹å™¨é¡¶éƒ¨
            tableWrapper.insertBefore(watermark, tableWrapper.firstChild);
            
            // æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„å›¾ç‰‡
            var images = Array.from(table.querySelectorAll('img'));
            var originalSrcs = new Map();
            var processed = 0;
            var total = images.length;
            
            if (total === 0) {
                doCapture();
                return;
            }
            
            // é€ä¸ªå¤„ç†å›¾ç‰‡
            images.forEach(function(img) {
                var src = img.src;
                
                // è·³è¿‡å·²ç»æ˜¯ base64 æˆ–ç©ºçš„
                if (!src || src.startsWith('data:') || src.startsWith('blob:')) {
                    processed++;
                    checkComplete();
                    return;
                }
                
                // ä¿å­˜åŸå§‹ src
                originalSrcs.set(img, src);
                
                // ä½¿ç”¨ fetch é€šè¿‡ä»£ç†è·å–å›¾ç‰‡
                fetchImageAsBase64(src)
                    .then(function(base64) {
                        if (base64) {
                            img.src = base64;
                        }
                    })
                    .catch(function() {
                        // å¤±è´¥æ—¶ä¿æŒåŸæ ·
                    })
                    .finally(function() {
                        processed++;
                        if(btn) btn.innerHTML = 'â³ å¤„ç†ä¸­ ' + processed + '/' + total;
                        checkComplete();
                    });
            });
            
            function checkComplete() {
                if (processed >= total) {
                    if(btn) btn.innerHTML = 'â³ ç”Ÿæˆæˆªå›¾...';
                    setTimeout(doCapture, 300);
                }
            }
            
            function doCapture() {
                // ä¸´æ—¶å¤„ç† sticky å®šä½
                var stickyElements = document.querySelectorAll('.guide-table thead, .toolbar');
                var originalStyles = [];
                stickyElements.forEach(function(el) {
                    originalStyles.push({
                        position: el.style.position,
                        top: el.style.top
                    });
                    el.style.position = 'static';
                    el.style.top = 'auto';
                });
                
                setTimeout(function() {
                    // æˆªå›¾ç›®æ ‡æ”¹ä¸º tableWrapperï¼ˆåŒ…å«æ°´å°ï¼‰
                    html2canvas(tableWrapper, {
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: bgColor,
                        scale: 2,
                        scrollX: 0,
                        scrollY: -window.scrollY,
                        logging: false
                    }).then(function(canvas){
                        restoreAll();
                        downloadCanvas(canvas);
                    }).catch(function(error){
                        restoreAll();
                        console.error('æˆªå›¾å¤±è´¥:', error);
                        alert('å¯¼å‡ºå¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨æµè§ˆå™¨æˆªå›¾åŠŸèƒ½ï¼ˆå¦‚ Windows çš„ Win+Shift+Sï¼‰');
                    });
                }, 200);
                
                function restoreAll() {
                    stickyElements.forEach(function(el, i) {
                        el.style.position = originalStyles[i].position || '';
                        el.style.top = originalStyles[i].top || '';
                    });
                    originalSrcs.forEach(function(src, img) {
                        img.src = src;
                    });
                    table.classList.remove('exporting');
                    // ğŸŒŸ ç§»é™¤æ°´å°
                    if (watermark && watermark.parentNode) {
                        watermark.parentNode.removeChild(watermark);
                    }
                    if(btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            }
            
            function downloadCanvas(canvas) {
                var link = document.createElement('a');
                var date = new Date();
                var dateStr = date.getFullYear() + '-' + 
                              String(date.getMonth()+1).padStart(2,'0') + '-' + 
                              String(date.getDate()).padStart(2,'0');
                link.download = 'gbfop_Guide_' + dateStr + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }
        
        // é€šè¿‡å¤šä¸ªä»£ç†å°è¯•è·å–å›¾ç‰‡çš„ Base64
        function fetchImageAsBase64(url) {
            // ä»£ç†åˆ—è¡¨ï¼ˆæŒ‰å¯é æ€§æ’åºï¼‰
            var proxies = [
                function(u) { return 'https://corsproxy.io/?' + encodeURIComponent(u); },
                function(u) { return 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u); },
                function(u) { return 'https://proxy.cors.sh/' + u; }
            ];
            
            // å…ˆå°è¯•ç›´æ¥è·å–
            return tryFetch(url)
                .catch(function() {
                    // ä¾æ¬¡å°è¯•ä»£ç†
                    return proxies.reduce(function(promise, proxyFn) {
                        return promise.catch(function() {
                            return tryFetch(proxyFn(url));
                        });
                    }, Promise.reject());
                });
        }
        
        function tryFetch(url) {
            return new Promise(function(resolve, reject) {
                var timeout = setTimeout(function() { reject('timeout'); }, 8000);
                
                fetch(url, { mode: 'cors' })
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP error');
                        return response.blob();
                    })
                    .then(function(blob) {
                        clearTimeout(timeout);
                        var reader = new FileReader();
                        reader.onloadend = function() {
                            resolve(reader.result);
                        };
                        reader.onerror = function() { reject('read error'); };
                        reader.readAsDataURL(blob);
                    })
                    .catch(function(err) {
                        clearTimeout(timeout);
                        reject(err);
                    });
            });
        }
        function clearAllSilent(){document.querySelectorAll('tbody td').forEach(function(cell){cell.querySelectorAll('.skill-box:not(.skill-source)').forEach(function(box){box.remove();});cell.querySelectorAll('.user-text-wrapper').forEach(function(wrapper){wrapper.remove();});cell.querySelectorAll('.user-text').forEach(function(txt){txt.remove();});});}
        function clearAll(){if(confirm('æ¸…ç©ºæ‰€æœ‰?')){clearAllSilent();GBFGuide.Storage.save();}}
        function deleteRow(btn){
            var row=btn.closest('tr');
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr:not(.add-phase-row)'));
            var rowIndex=rows.indexOf(row);
            var phaseCell=null;
            var phaseCellRow=null;
            for(var i=rowIndex;i>=0;i--){var cell=rows[i].querySelector('td[rowspan]');if(cell){phaseCell=cell;phaseCellRow=rows[i];break;}}
            if(!phaseCell)return;
            var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
            if(rowspan<=1){alert('è‡³å°‘ä¿ç•™1è¡Œ');return;}
            
            // æ£€æŸ¥æ˜¯å¦åˆ é™¤çš„æ˜¯é˜¶æ®µç¬¬ä¸€è¡Œï¼ˆåŒ…å«rowspanå•å…ƒæ ¼çš„è¡Œï¼‰
            var isFirstRowOfPhase = (row === phaseCellRow);
            
            if(isFirstRowOfPhase && rowspan > 1){
                // åˆ é™¤é˜¶æ®µç¬¬ä¸€è¡Œï¼šéœ€è¦å°†é˜¶æ®µå•å…ƒæ ¼ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
                var nextRow = rows[rowIndex + 1];
                if(nextRow){
                    // ä¿å­˜é˜¶æ®µè¡Œçš„classï¼ˆå¦‚phase-80-60ï¼‰
                    var phaseClass = row.className;
                    
                    // æ›´æ–°rowspan
                    phaseCell.setAttribute('rowspan', rowspan - 1);
                    
                    // å°†é˜¶æ®µå•å…ƒæ ¼æ’å…¥åˆ°ä¸‹ä¸€è¡Œçš„å¼€å¤´
                    nextRow.insertBefore(phaseCell, nextRow.firstChild);
                    
                    // å°†é˜¶æ®µclassè½¬ç§»åˆ°æ–°çš„ç¬¬ä¸€è¡Œ
                    if(phaseClass){
                        nextRow.className = phaseClass;
                    }
                    
                    // åˆ é™¤åŸæ¥çš„ç¬¬ä¸€è¡Œ
                    row.remove();
                }
            } else {
                // åˆ é™¤éç¬¬ä¸€è¡Œï¼šåŸæœ‰é€»è¾‘
                phaseCell.setAttribute('rowspan', rowspan - 1);
                row.remove();
            }
            
            recalculateAllCoords();
            GBFGuide.Storage.save();
        }
        
        // [æ”¹è¿›] è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ¨¡å¼ç”Ÿæˆå¯¹åº”çš„æ•°æ®æ ¼
        // ä¸å†ä¾èµ– .character-header æ•°é‡ï¼Œé¿å…æ¢äººè¡Œå¹²æ‰°
        function getDataCellsHtml(rowIndex, is9Man) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥ is9Manï¼Œåˆ™é€šè¿‡ thead æ£€æµ‹ï¼ˆå…¼å®¹æ—§è°ƒç”¨ï¼‰
            if (typeof is9Man === 'undefined') {
                is9Man = document.querySelector('thead .back-row-2') !== null;
            }
            var cols = is9Man ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            var html = '';
            // ä½¿ç”¨ cols.length å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šè¶Šç•Œ
            for(var i = 0; i < cols.length; i++) {
                var col = cols[i];
                // Iåˆ—åŠä¹‹åé€šå¸¸ä½œä¸º note-cell (å¤‡æ³¨æ ¼)
                var cls = (i >= 4) ? 'note-cell' : 'data-cell';
                html += '<td class="' + cls + '"><span class="coord">(' + rowIndex + ',' + col + ')</span></td>';
            }
            return html;
        }
        
        // [æ–°å¢] åœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥æ–°è¡Œ
        // [ä¿®æ”¹] ä½¿ç”¨ getDataCellsHtml åŠ¨æ€ç”Ÿæˆåˆ—
        function insertRowBelow(btn) {
            var currentRow = btn.closest('tr');
            var tbody = document.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr:not(.add-phase-row)'));
            var currentRowIndex = rows.indexOf(currentRow);

            // 1. æ‰¾åˆ°è¯¥è¡Œæ‰€å±çš„é˜¶æ®µ (Phase)
            var phaseCell = null;
            // å‘å‰æŸ¥æ‰¾å¸¦æœ‰ rowspan çš„è¡Œ
            for (var i = currentRowIndex; i >= 0; i--) {
                var cell = rows[i].querySelector('td[rowspan]');
                if (cell) {
                    var rs = parseInt(cell.getAttribute('rowspan')) || 1;
                    // æ£€æŸ¥ rowspan æ˜¯å¦è¦†ç›–äº† currentRow
                    if (currentRowIndex <= i + rs - 1) {
                        phaseCell = cell;
                    }
                    break;
                }
            }

            // 2. åˆ›å»ºæ–°è¡Œ - [ä¿®æ”¹] åŠ¨æ€ç”ŸæˆååŠéƒ¨åˆ†
            var newRow = document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // åæ ‡ç¨åä¼šé‡ç®—
            newRow.innerHTML = '<td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;

            // 3. æ’å…¥æ–°è¡Œ
            currentRow.after(newRow);

            // 4. æ›´æ–°é˜¶æ®µçš„ rowspan
            if (phaseCell) {
                var currentRs = parseInt(phaseCell.getAttribute('rowspan')) || 1;
                phaseCell.setAttribute('rowspan', currentRs + 1);
            }

            // 5. ç»‘å®šäº‹ä»¶
            newRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
            // ç»‘å®šä¸å¯åˆ é™¤é€»è¾‘
            var bText = newRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
            
            // [æ–°å¢] ä¸ºæ–°è¡Œçš„ I/M åˆ—æ·»åŠ åˆå¹¶æ§åˆ¶æŒ‰é’®
            newRow.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });

            // 6. åˆ·æ–°
            recalculateAllCoords();
            applyDefaultFontSize();
            GBFGuide.Storage.save();
        }
        
        // åˆ é™¤æ•´ä¸ªé˜¶æ®µ
        function deletePhase(btn){
            var phaseCell = btn.closest('td');
            var phaseRow = phaseCell.closest('tr');
            var tbody = document.querySelector('tbody');
            var allPhaseCells = document.querySelectorAll('td[rowspan]');
            
            // æ£€æŸ¥æ˜¯å¦è‡³å°‘ä¿ç•™1ä¸ªé˜¶æ®µ
            if(allPhaseCells.length <= 1){
                alert('è‡³å°‘ä¿ç•™1ä¸ªé˜¶æ®µ');
                return;
            }
            
            // ç¡®è®¤å¯¹è¯æ¡†
            if(!confirm('ç¡®å®šåˆ é™¤æ­¤é˜¶æ®µï¼Ÿè¯¥é˜¶æ®µçš„æ‰€æœ‰è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚')){
                return;
            }
            
            var rowspan = parseInt(phaseCell.getAttribute('rowspan')) || 1;
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var phaseIndex = rows.indexOf(phaseRow);
            
            // åˆ é™¤è¯¥é˜¶æ®µçš„æ‰€æœ‰è¡Œï¼ˆä»åå¾€å‰åˆ é™¤ï¼‰
            for(var i = rowspan - 1; i >= 0; i--){
                var rowToDelete = rows[phaseIndex + i];
                if(rowToDelete && !rowToDelete.classList.contains('add-phase-row')){
                    rowToDelete.remove();
                }
            }
            
            recalculateAllCoords();
            refreshPhaseColors();
            GBFGuide.Storage.save();
        }
        
        // [æ–°å¢] åˆ·æ–°æ‰€æœ‰é˜¶æ®µçš„é¢œè‰² (çº¢->æ©™->é»„->ç»¿ å¾ªç¯)
        function refreshPhaseColors() {
            var phaseCells = document.querySelectorAll('tbody tr > td[rowspan]');
            var classes = ['phase-100-80', 'phase-80-60', 'phase-60-20', 'phase-20-0'];
            phaseCells.forEach(function(cell, index) {
                var row = cell.parentElement;
                // ç§»é™¤æ—§é¢œè‰²ç±»
                classes.forEach(function(c) { row.classList.remove(c); });
                // æ·»åŠ æ–°é¢œè‰²ç±» (å–æ¨¡å¾ªç¯)
                row.classList.add(classes[index % classes.length]);
            });
        }
        
        // [æ–°å¢] åœ¨å½“å‰é˜¶æ®µä¸‹æ–¹æ’å…¥æ–°é˜¶æ®µ
        // [ä¿®æ”¹] ä½¿ç”¨ getDataCellsHtml åŠ¨æ€ç”Ÿæˆåˆ—
        function insertPhaseBelow(btn) {
            var currentPhaseCell = btn.closest('td');
            var currentPhaseRow = currentPhaseCell.closest('tr');
            var rowspan = parseInt(currentPhaseCell.getAttribute('rowspan')) || 1;

            // 1. è®¡ç®—æ’å…¥ä½ç½® (å½“å‰é˜¶æ®µçš„æœ€åä¸€è¡Œä¹‹å)
            var tbody = document.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var currentIndex = rows.indexOf(currentPhaseRow);
            var insertIndex = currentIndex + rowspan;
            var referenceRow = rows[insertIndex];
            
            // [æ–°å¢] å¦‚æœä¸‹é¢ç´§è·Ÿçš„æ˜¯æ¢äººè¡Œï¼Œåˆ™è·³è¿‡æ¢äººè¡Œï¼ˆåŒ…æ‹¬ header å’Œ sourceï¼‰
            while (referenceRow && (referenceRow.classList.contains('swap-header-row') || referenceRow.classList.contains('swap-source-row'))) {
                referenceRow = referenceRow.nextElementSibling;
            }

            // 2. åˆ›å»ºæ–°é˜¶æ®µè¡Œ (é»˜è®¤1è¡Œé«˜åº¦) - [ä¿®æ”¹] åŠ¨æ€ç”ŸæˆååŠéƒ¨åˆ†
            var newPhaseRow = document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // åæ ‡ç¨åä¼šé‡ç®—
            newPhaseRow.innerHTML = '<td rowspan="1"><span class="coord">(0,A)</span><span class="t-text phase-name" contenteditable="true" onblur="GBFGuide.Storage.save()">æ–°é˜¶æ®µ</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="åˆ é™¤æ­¤é˜¶æ®µ">âˆ’</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="åœ¨ä¸‹æ–¹æ’å…¥æ–°é˜¶æ®µ">+</button></div></td><td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">âˆ’</button><span class="t-text" contenteditable="true" onblur="GBFGuide.Storage.save()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;

            // 3. æ’å…¥ DOM
            if (referenceRow) {
                referenceRow.before(newPhaseRow);
            } else {
                tbody.appendChild(newPhaseRow);
            }

            // 4. ç»‘å®šé€šç”¨äº‹ä»¶
            newPhaseRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
            // ç»‘å®šä¸å¯åˆ é™¤é€»è¾‘
            var phaseName = newPhaseRow.querySelector('.t-text.phase-name');
            if(phaseName && window.setupUndeletableText) window.setupUndeletableText(phaseName, 'æ–°é˜¶æ®µ');
            var bText = newPhaseRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
            
            // [æ–°å¢] ä¸ºæ–°é˜¶æ®µè¡Œçš„ I/M åˆ—æ·»åŠ åˆå¹¶æ§åˆ¶æŒ‰é’®
            newPhaseRow.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });

            // 5. åˆ·æ–°ä¸€åˆ‡
            refreshPhaseColors();
            recalculateAllCoords();
            applyDefaultFontSize();
            GBFGuide.Storage.save();
        }
        
        // ========== æ ¼å­åˆå¹¶åŠŸèƒ½ï¼ˆæ–°ç‰ˆï¼‰ ==========
        
        // ç›´æ¥æ·»åŠ ä¼˜å…ˆçº§1æ–‡å­—ï¼ˆä¸å¼¹çª—ï¼‰
        function addPriorityText(cell){
            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
            var p1Color=isDark?'#ff6b6b':'#c62828';
            var defaultSize=getDefaultFontSize();
            
            // åˆ›å»ºwrapperåŒ…è£¹ç”¨æˆ·æ–‡å­—å’Œåˆ é™¤æŒ‰é’®
            var wrapper=document.createElement('span');
            wrapper.className='user-text-wrapper';
            
            var span=document.createElement('span');
            span.className='user-text';
            span.textContent='æ–‡å­—';
            span.setAttribute('contenteditable','true');
            span.setAttribute('data-priority','1');
            span.style.fontSize=defaultSize+'px';
            span.style.color=p1Color;
            span.style.fontWeight='bold';
            
            // æ ‡è®°ä¸ºå¯ä»¥è¢«é»˜è®¤å­—å·å½±å“ï¼ˆä¸è®¾ç½®data-custom-sizeï¼‰
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®
            var delBtn=document.createElement('button');
            delBtn.className='mini-fab delete';
            delBtn.innerHTML='Ã—';
            delBtn.title='åˆ é™¤';
            delBtn.onclick=function(ev){
                ev.stopPropagation();
                var parentCell = wrapper.closest('td');
                wrapper.remove();
                GBFGuide.Storage.save();
                // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
                if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
            };
            
            wrapper.appendChild(span);
            wrapper.appendChild(delBtn);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            span.addEventListener('blur',function(){
                // æ¸…ç†ç©ºæ–‡æœ¬
                if(!this.textContent.trim()){
                    var parentCell = wrapper.closest('td');
                    wrapper.remove();
                    // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
                    if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                }
                GBFGuide.Storage.save();
            });
            
            span.addEventListener('paste',function(e){
                // åªå…è®¸ç²˜è´´çº¯æ–‡æœ¬ï¼Œé˜²æ­¢æ ¼å¼æ±¡æŸ“
                e.preventDefault();
                var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                document.execCommand('insertText',false,text.substring(0,50));
            });
            
            span.addEventListener('keydown',function(e){
                // é™åˆ¶é•¿åº¦
                if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                    e.preventDefault();
                }
                // é˜²æ­¢æ¢è¡Œ
                if(e.key==='Enter'){
                    e.preventDefault();
                    this.blur();
                }
            });
            
            // æ·»åŠ åˆ°å•å…ƒæ ¼
            cell.appendChild(wrapper);
            
            // æ›´æ–°å¤‡æ³¨å•å…ƒæ ¼ç©ºçŠ¶æ€
            if(window.updateNoteEmptyState) window.updateNoteEmptyState(cell);
            
            // è‡ªåŠ¨é€‰ä¸­æ–‡å­—è¿›è¡Œç¼–è¾‘
            span.focus();
            span.select();
            
            GBFGuide.Storage.save();
        }
        
        // å‘å³åˆå¹¶å•å…ƒæ ¼
        function mergeRight(cell){
            var row = cell.closest('tr');
            var cells = Array.from(row.querySelectorAll('td'));
            var currentIndex = cells.indexOf(cell);
            var currentColspan = parseInt(cell.getAttribute('colspan') || 1);
            
            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯è§çš„å•å…ƒæ ¼è¿›è¡Œåˆå¹¶
            var nextVisibleCell = null;
            var nextVisibleIndex = -1;
            
            // ä»å½“å‰å•å…ƒæ ¼åé¢å¼€å§‹æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯è§å•å…ƒæ ¼
            for(var i = currentIndex + 1; i < cells.length; i++){
                var testCell = cells[i];
                if(testCell.style.display !== 'none' && testCell.offsetParent !== null){
                    nextVisibleCell = testCell;
                    nextVisibleIndex = i;
                    break;
                }
            }
            
            if(!nextVisibleCell) return; // æ²¡æœ‰æ‰¾åˆ°å¯åˆå¹¶çš„å•å…ƒæ ¼
            
            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºHåˆ—èŒƒå›´ï¼ˆä¸èƒ½åˆå¹¶åˆ°Iæˆ–Jåˆ—ï¼‰
            var coord = getCellCoord(nextVisibleCell);
            if(coord && (coord.col === 'I' || coord.col === 'J')) return; // ä¸èƒ½åˆå¹¶åˆ°Iæˆ–Jåˆ—
            
            // ä¿å­˜è¢«åˆå¹¶å•å…ƒæ ¼çš„ä¿¡æ¯ï¼ˆç”¨äºæ‹†åˆ†æ—¶æ¢å¤ï¼‰
            if(!cell.mergedCells) {
                cell.mergedCells = [];
            }
            
            // ä¿å­˜å•å…ƒæ ¼ä¿¡æ¯
            var cellInfo = {
                coord: coord,
                innerHTML: nextVisibleCell.innerHTML,
                className: nextVisibleCell.className,
                index: nextVisibleIndex
            };
            cell.mergedCells.push(cellInfo);
            
            // å®Œå…¨ç§»é™¤è¢«åˆå¹¶çš„å•å…ƒæ ¼
            nextVisibleCell.remove();
            
            // å¢åŠ å½“å‰å•å…ƒæ ¼çš„colspan
            cell.setAttribute('colspan', currentColspan + 1);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateCellButtons(cell);
            
            GBFGuide.Storage.save();
        }
        
        // å®Œå…¨æ‹†åˆ†å•å…ƒæ ¼
        function splitCell(cell){
            var currentColspan = parseInt(cell.getAttribute('colspan') || 1);
            
            if(currentColspan <= 1) return; // æ²¡æœ‰åˆå¹¶ï¼Œæ— éœ€æ‹†åˆ†
            if(!cell.mergedCells || cell.mergedCells.length === 0) return; // æ²¡æœ‰ä¿å­˜çš„åˆå¹¶ä¿¡æ¯
            
            var row = cell.closest('tr');
            
            // æŒ‰ç…§ä¿å­˜çš„é¡ºåºæ¢å¤æ‰€æœ‰è¢«åˆå¹¶çš„å•å…ƒæ ¼
            var insertAfter = cell;
            
            cell.mergedCells.forEach(function(cellInfo){
                // åˆ›å»ºæ–°çš„å•å…ƒæ ¼
                var newCell = document.createElement('td');
                newCell.innerHTML = '<span class="coord">(' + cellInfo.coord.row + ',' + cellInfo.coord.col + ')</span>';
                newCell.className = 'data-cell';
                
                // æ’å…¥åˆ°å½“å‰ä½ç½®ä¹‹å
                insertAfter.after(newCell);
                insertAfter = newCell; // æ›´æ–°æ’å…¥ä½ç½®
                
                // ç»‘å®šäº‹ä»¶
                bindCellEvents(newCell);
                
                // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ·»åŠ æŒ‰é’®
                (function(targetCell){
                    setTimeout(function(){
                        addCellButtons(targetCell);
                    }, 0);
                })(newCell);
            });
            
            // é‡ç½®å½“å‰å•å…ƒæ ¼çš„colspan
            cell.removeAttribute('colspan');
            
            // æ¸…é™¤ä¿å­˜çš„åˆå¹¶ä¿¡æ¯
            delete cell.mergedCells;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateCellButtons(cell);
            
            GBFGuide.Storage.save();
        }
        
        // æ›´æ–°å•å…ƒæ ¼æŒ‰é’®çŠ¶æ€
        function updateCellButtons(cell){
            // ç§»é™¤ç°æœ‰æŒ‰é’®
            var existingButtons = cell.querySelectorAll('.micro-fab');
            existingButtons.forEach(function(btn){ btn.remove(); });
            
            // æ·»åŠ æ–°æŒ‰é’®
            addCellButtons(cell);
            
            // é‡æ–°åº”ç”¨é»˜è®¤å­—å·åˆ°æ–°åˆ›å»ºçš„æŒ‰é’®
            var size = getDefaultFontSize() + 'px';
            cell.querySelectorAll('.micro-fab').forEach(function(btn){
                btn.style.fontSize = size;
            });
        }
        
        // è°ƒæ•´å¬å”¤çŸ³åˆ é™¤æŒ‰é’®ä½ç½®çš„å‡½æ•°
        function adjustSummonDeleteButton(summonBox) {
            var img = summonBox.querySelector('img');
            var deleteBtn = summonBox.querySelector('.mini-fab.delete');
            
            if (!img || !deleteBtn) return;
            
            // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåè°ƒæ•´ä½ç½®
            function adjustPosition() {
                // è·å–å½“å‰çš„å›¾æ ‡ç¼©æ”¾æ¯”ä¾‹
                var iconScale = getIconScale() / 100;
                iconScale = Math.max(0.5, Math.min(2.0, iconScale));
                
                // ç”±äºå›¾ç‰‡ç°åœ¨æ˜¯ç»å¯¹å®šä½ä¸”å±…ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å…¶å®é™…æ˜¾ç¤ºå°ºå¯¸
                var naturalWidth = img.naturalWidth;
                var naturalHeight = img.naturalHeight;
                
                if (naturalWidth === 0 || naturalHeight === 0) return;
                
                // è®¡ç®—å›¾ç‰‡çš„å®é™…æ˜¾ç¤ºå°ºå¯¸ï¼ˆè€ƒè™‘ç¼©æ”¾å’Œmax-widthã€max-heightçº¦æŸï¼‰
                var maxWidth = 40 * iconScale;
                var maxHeight = 48 * iconScale;
                var containerSize = 40 * iconScale;
                
                var scaleX = maxWidth / naturalWidth;
                var scaleY = maxHeight / naturalHeight;
                var scale = Math.min(scaleX, scaleY, 1); // ä¸æ”¾å¤§ï¼Œåªç¼©å°
                
                var displayWidth = naturalWidth * scale;
                var displayHeight = naturalHeight * scale;
                
                // è®¡ç®—åˆ é™¤æŒ‰é’®ä½ç½®ï¼ˆç›¸å¯¹äºå›¾ç‰‡å³ä¸Šè§’ï¼‰
                var btnTop = (containerSize - displayHeight) / 2 - 6; // å®¹å™¨ä¸­å¿ƒ - å›¾ç‰‡é«˜åº¦çš„ä¸€åŠ - æŒ‰é’®åç§»
                var btnRight = (containerSize - displayWidth) / 2 - 6; // å®¹å™¨ä¸­å¿ƒ - å›¾ç‰‡å®½åº¦çš„ä¸€åŠ - æŒ‰é’®åç§»
                
                // è®¾ç½®åˆ é™¤æŒ‰é’®ä½ç½®
                deleteBtn.style.top = btnTop + 'px';
                deleteBtn.style.right = btnRight + 'px';
            }
            
            // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½ï¼Œç›´æ¥è°ƒæ•´
            if (img.complete && img.naturalHeight !== 0) {
                adjustPosition();
            } else {
                // å¦åˆ™ç­‰å¾…å›¾ç‰‡åŠ è½½
                img.addEventListener('load', adjustPosition);
            }
        }
        
        // ä¸ºæ‰€æœ‰ç°æœ‰çš„å¬å”¤çŸ³è°ƒæ•´åˆ é™¤æŒ‰é’®ä½ç½®
        function adjustAllSummonDeleteButtons() {
            document.querySelectorAll('.skill-box.summon-box:not(.skill-source)').forEach(function(summonBox) {
                adjustSummonDeleteButton(summonBox);
            });
        }
        
        // ä¸ºå•å…ƒæ ¼æ·»åŠ æŒ‰é’® (ä¼˜åŒ–ç‰ˆï¼šå‡€åŒ–E-Håˆ—ï¼Œæ“ä½œç§»è‡³Iåˆ—)
        function addCellButtons(cell){
            if(!cell) return;
            
            // è·å–åæ ‡ä¿¡æ¯
            var coordEl = cell.querySelector('.coord');
            if(!coordEl) return;
            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
            if(!match) return;
            var col = match[2];
            
            // ------------------------------------------------
            // 1. æ•°æ®åˆ— (E-H): åªä¿ç•™"æ·»åŠ æ–‡å­—"ï¼Œç§»é™¤æ‰€æœ‰åˆå¹¶æŒ‰é’®
            // ------------------------------------------------
            if(['E', 'F', 'G', 'H'].includes(col)) {
                // æ¸…ç†æ—§æŒ‰é’®
                cell.querySelectorAll('.micro-fab').forEach(function(btn){ btn.remove(); });
                
                // åªæ·»åŠ å·¦ä¸Šè§’çš„æ–‡å­—ç¼–è¾‘æŒ‰é’®
                var textBtn = document.createElement('button');
                textBtn.className = 'micro-fab text top-left';
                textBtn.innerHTML = 'âœ';
                textBtn.title = 'æ·»åŠ æ–‡å­—';
                textBtn.onclick = function(e){ e.stopPropagation(); addPriorityText(cell); };
                cell.appendChild(textBtn);
                
                // åº”ç”¨å­—å·
                var size = getDefaultFontSize() + 'px';
                textBtn.style.fontSize = size;
            }
            
            // Cåˆ—å’ŒDåˆ—ä¹Ÿä¿ç•™æ·»åŠ æ–‡å­—æŒ‰é’®
            if(col === 'C' || col === 'D') {
                cell.querySelectorAll('.micro-fab').forEach(function(btn){ btn.remove(); });
                var textBtn = document.createElement('button');
                textBtn.className = 'micro-fab text top-left';
                textBtn.innerHTML = 'âœ';
                textBtn.title = 'æ·»åŠ æ–‡å­—';
                textBtn.onclick = function(e){ e.stopPropagation(); addPriorityText(cell); };
                cell.appendChild(textBtn);
                var size = getDefaultFontSize() + 'px';
                textBtn.style.fontSize = size;
            }
            
            // ------------------------------------------------
            // 2. å¤‡æ³¨åˆ— (I): æ·»åŠ "æ•´è¡Œåˆå¹¶/æ‹†åˆ†"æ§åˆ¶é¢æ¿
            // ------------------------------------------------
            if(col === 'I') {
                updateRowControls(cell);
            }
        }
        
        // å®šä¹‰ SVG å›¾æ ‡å¸¸é‡ (Material Design é£æ ¼)
        var ICON_MERGE = '<svg viewBox="0 0 24 24"><path d="M20 9h-7.5l2.5-2.5-1.4-1.4L9 9.7l4.6 4.6 1.4-1.4L12.5 10.5H20v-1.5zm-16 6h7.5l-2.5 2.5 1.4 1.4L15 14.3l-4.6-4.6-1.4 1.4L11.5 13.5H4v1.5z"/></svg>'; // æ”¶ç¼©ç®­å¤´
        var ICON_SPLIT = '<svg viewBox="0 0 24 24"><path d="M15 15h7.5l-2.5 2.5 1.4 1.4 4.6-4.6-4.6-4.6-1.4 1.4 2.5 2.5H15v-1.5zM9 9H1.5l2.5-2.5L2.6 5.1-2 9.7l4.6 4.6 1.4-1.4L1.5 10.5H9v-1.5z"/></svg>'; // æ‰©æ•£ç®­å¤´
        
        // æ›´æ–°Iåˆ—çš„è¡Œæ§é¢æ¿
        function updateRowControls(noteCell) {
            // 1. æ¸…ç†æ—§é¢æ¿ï¼Œé˜²æ­¢é‡å¤å †å 
            var oldPanel = noteCell.querySelector('.note-cell-controls');
            if(oldPanel) oldPanel.remove();
            
            // éªŒè¯è¿™æ˜¯ I åˆ—
            var noteCellCoord = noteCell.querySelector('.coord');
            if(!noteCellCoord || !noteCellCoord.textContent.match(/,I\)$/)) return;
            
            var row = noteCell.parentElement;
            if(!row) return;
            
            // 2. é‡æ–°ä» DOM è·å–è¯¥è¡Œçš„æ‰€æœ‰å•å…ƒæ ¼ï¼ˆç¡®ä¿æ˜¯æœ€æ–°çŠ¶æ€ï¼‰
            var cells = Array.from(row.querySelectorAll('td'));
            
            // 3. ç»Ÿè®¡ E-H åˆ—çš„æ•°é‡æ¥åˆ¤æ–­æ˜¯å¦åˆå¹¶
            var dataColCount = 0;
            for(var i = 0; i < cells.length; i++) {
                var coordEl = cells[i].querySelector('.coord');
                if(coordEl) {
                    var text = coordEl.textContent;
                    if(text.match(/,[EFGH]\)$/)) {
                        dataColCount++;
                    }
                }
            }
            
            // å¦‚æœæœ‰4ä¸ªæ•°æ®åˆ—(E,F,G,H)ï¼Œè¯´æ˜æ˜¯æ‹†åˆ†çŠ¶æ€ï¼›å¦‚æœåªæœ‰1ä¸ª(E)ï¼Œè¯´æ˜æ˜¯åˆå¹¶çŠ¶æ€
            var isFullyMerged = (dataColCount === 1);
            var isFullySplit = (dataColCount === 4);
            
            // å¦‚æœæ—¢ä¸æ˜¯åˆå¹¶ä¹Ÿä¸æ˜¯æ‹†åˆ†ï¼ˆå¼‚å¸¸çŠ¶æ€ï¼‰ï¼Œä¸æ˜¾ç¤ºæŒ‰é’®
            if(!isFullyMerged && !isFullySplit) return;
            
            // 4. åˆ›å»ºé¢æ¿
            var panel = document.createElement('div');
            panel.className = 'note-cell-controls';
            
            // 5. æ ¹æ®çŠ¶æ€äº’æ–¥æ˜¾ç¤ºæŒ‰é’®
            if (isFullyMerged) {
                // çŠ¶æ€ï¼šå·²åˆå¹¶ -> æ˜¾ç¤ºã€æ‹†åˆ†ã€‘æŒ‰é’®
                var splitBtn = document.createElement('button');
                splitBtn.className = 'row-action-btn split';
                splitBtn.innerHTML = ICON_SPLIT;
                splitBtn.title = 'æ‹†åˆ†å•å…ƒæ ¼';
                splitBtn.onclick = function(e) { e.stopPropagation(); splitRowAll(row); };
                panel.appendChild(splitBtn);
            } else {
                // çŠ¶æ€ï¼šæœªåˆå¹¶ -> æ˜¾ç¤ºã€åˆå¹¶ã€‘æŒ‰é’®
                var mergeBtn = document.createElement('button');
                mergeBtn.className = 'row-action-btn merge';
                mergeBtn.innerHTML = ICON_MERGE;
                mergeBtn.title = 'åˆå¹¶æ•´è¡ŒæŠ€èƒ½';
                mergeBtn.onclick = function(e) { e.stopPropagation(); mergeRowAll(row); };
                panel.appendChild(mergeBtn);
            }
            
            noteCell.appendChild(panel);
        }
        
        // æ•´è¡Œåˆå¹¶é€»è¾‘
        function mergeRowAll(row) {
            var allCells = Array.from(row.querySelectorAll('td'));
            var targetCells = [];
            var targetCols = ['E', 'F', 'G', 'H'];
            
            // æ”¶é›†å½“å‰å­˜åœ¨çš„E-Håˆ—å•å…ƒæ ¼
            allCells.forEach(function(cell){
                var coord = getCellCoord(cell);
                if(coord && targetCols.includes(coord.col)) {
                    targetCells.push(cell);
                }
            });
            
            if(targetCells.length <= 1) return; // åªæœ‰ä¸€ä¸ªæ ¼å­ï¼Œæ— éœ€åˆå¹¶
            
            var firstCell = targetCells[0]; 
            
            // æ¬è¿å†…å®¹å¹¶åˆ é™¤åç»­æ ¼å­
            for(var i = 1; i < targetCells.length; i++) {
                var cell = targetCells[i];
                var skills = cell.querySelectorAll('.skill-box:not(.skill-source)');
                skills.forEach(function(s){ firstCell.appendChild(s); });
                var texts = cell.querySelectorAll('.user-text-wrapper');
                texts.forEach(function(t){ firstCell.appendChild(t); });
                cell.remove();
            }
            
            // è®¾ç½®è·¨åº¦
            firstCell.setAttribute('colspan', 4);
            
            // æ›´æ–°UIï¼šEåˆ—åªç•™é“…ç¬”
            addCellButtons(firstCell); 
            
            // æŸ¥æ‰¾ I åˆ—å¹¶åˆ·æ–°æ§åˆ¶é¢æ¿ï¼ˆä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼‰
            var iCell = null;
            for(var j = 0; j < allCells.length; j++) {
                var coord = allCells[j].querySelector('.coord');
                if(coord && coord.textContent.match(/,I\)$/)) {
                    iCell = allCells[j];
                    break;
                }
            }
            if(iCell) updateRowControls(iCell);
            
            GBFGuide.Storage.save();
        }
        
        // æ•´è¡Œæ‹†åˆ†é€»è¾‘
        function splitRowAll(row) {
            var allCells = Array.from(row.querySelectorAll('td'));
            var eCell = allCells.find(function(c) {
                var coord = c.querySelector('.coord');
                return coord && coord.textContent.includes(',E)');
            });
            
            if(!eCell) return;
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ˜¯æ‹†åˆ†çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤æ‹†åˆ†ï¼‰
            var currentColspan = parseInt(eCell.getAttribute('colspan') || 1);
            if(currentColspan <= 1) {
                // å·²ç»æ˜¯æ‹†åˆ†çŠ¶æ€ï¼Œåªéœ€è¦åˆ·æ–°æŒ‰é’®
                var existingICells = Array.from(row.querySelectorAll('td'));
                for(var k = 0; k < existingICells.length; k++) {
                    var coordEl = existingICells[k].querySelector('.coord');
                    if(coordEl && coordEl.textContent.match(/,I\)$/)) {
                        updateRowControls(existingICells[k]);
                        break;
                    }
                }
                return;
            }
            
            // æ¢å¤ä¸º1åˆ—
            eCell.setAttribute('colspan', 1);
            // åŒæ—¶ç§»é™¤ colspan å±æ€§ï¼ˆæŸäº›æµè§ˆå™¨å¯èƒ½éœ€è¦ï¼‰
            if(currentColspan <= 1) {
                eCell.removeAttribute('colspan');
            }
            
            // è·å–è¡Œå·
            var coordObj = getCellCoord(eCell);
            var rowNum = coordObj.row;
            
            // æ’å…¥ F, G, H
            var newCols = ['F', 'G', 'H'];
            var insertRef = eCell;
            
            for(var i=0; i < 3; i++) {
                var colChar = newCols[i];
                var newCell = document.createElement('td');
                newCell.className = 'data-cell';
                newCell.innerHTML = '<span class="coord">(' + rowNum + ',' + colChar + ')</span>';
                insertRef.after(newCell);
                insertRef = newCell;
                bindCellEvents(newCell);
            }
            
            // æ›´æ–°UI
            addCellButtons(eCell); // æ¢å¤Eåˆ—çš„é“…ç¬”
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å®Œå…¨æ›´æ–°åå†åˆ·æ–°æ§åˆ¶é¢æ¿
            setTimeout(function() {
                var freshCells = Array.from(row.querySelectorAll('td'));
                var iCell = null;
                for(var j = 0; j < freshCells.length; j++) {
                    var coordEl = freshCells[j].querySelector('.coord');
                    if(coordEl && coordEl.textContent.match(/,I\)$/)) {
                        iCell = freshCells[j];
                        break;
                    }
                }
                if(iCell) updateRowControls(iCell);
            }, 0);
            
            GBFGuide.Storage.save();
        }
        
        // ä¿®æ”¹collectDataä»¥ä¿å­˜åˆå¹¶ä¿¡æ¯
        var originalCollectData=collectData;
        collectData=function(){
            var data=originalCollectData();
            data.mergedCells=[];
            
            // æ”¶é›†åˆå¹¶ä¿¡æ¯
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(function(row){
                var cells=Array.from(row.querySelectorAll('td'));
                cells.forEach(function(cell){
                    var colspan=parseInt(cell.getAttribute('colspan'))||1;
                    if(colspan>1){
                        var coord=getCellCoord(cell);
                        if(coord&&coord.row>=3){
                            // åªä¿å­˜æ•°æ®è¡Œçš„åˆå¹¶ä¿¡æ¯ï¼Œæ’é™¤Iå’ŒJåˆ—
                            if(coord.col!=='I'&&coord.col!=='J'&&coord.col!=='H'){
                                data.mergedCells.push({
                                    row:coord.row,
                                    col:coord.col,
                                    colspan:colspan
                                });
                            }
                        }
                    }
                });
            });
            
            return data;
        };
        
        // ä¿®æ”¹restoreDataä»¥æ¢å¤åˆå¹¶ä¿¡æ¯
        var originalRestoreData=restoreData;
        restoreData=function(data){
            // å…ˆæ¢å¤åŸºç¡€æ•°æ®
            originalRestoreData(data);
            
            // ç„¶åæ¢å¤åˆå¹¶ä¿¡æ¯
            if(data.mergedCells&&data.mergedCells.length>0){
                data.mergedCells.forEach(function(merge){
                    var cell=findCellByCoord(merge.row,merge.col);
                    if(cell){
                        var row=cell.closest('tr');
                        var allCells=Array.from(row.querySelectorAll('td'));
                        var cellIndex=allCells.indexOf(cell);
                        var currentColspan=parseInt(cell.getAttribute('colspan'))||1;
                        var targetColspan=merge.colspan;
                        
                        // æ‰§è¡Œåˆå¹¶æ“ä½œ
                        for(var i=currentColspan;i<targetColspan;i++){
                            var nextCell=allCells[cellIndex+1];
                            if(nextCell){
                                // ä¿å­˜ä¸‹ä¸€ä¸ªå•å…ƒæ ¼çš„å†…å®¹ï¼ˆåŒ…æ‹¬wrapperï¼‰
                                var skills=nextCell.querySelectorAll('.skill-box:not(.skill-source)');
                                var wrappers=nextCell.querySelectorAll('.user-text-wrapper');
                                var texts=nextCell.querySelectorAll('.user-text:not(.user-text-wrapper .user-text)');
                                skills.forEach(function(skill){cell.appendChild(skill);});
                                wrappers.forEach(function(wrapper){cell.appendChild(wrapper);});
                                texts.forEach(function(text){cell.appendChild(text);});
                                
                                // åˆ é™¤ä¸‹ä¸€ä¸ªå•å…ƒæ ¼
                                nextCell.remove();
                                
                                // å¢åŠ colspan
                                cell.setAttribute('colspan',i+1);
                                
                                // æ›´æ–°allCellsæ•°ç»„
                                allCells=Array.from(row.querySelectorAll('td'));
                            }
                        }
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ˜¾ç¤ºæ‹†åˆ†æŒ‰é’®è€Œä¸æ˜¯åˆå¹¶æŒ‰é’®ï¼‰
                        updateCellButtons(cell);
                    }
                });
                
                recalculateAllCoords();
                
                // [æ–°å¢] æ¢å¤æ•°æ®åï¼Œåˆ·æ–°æ‰€æœ‰Iåˆ—çš„æ§åˆ¶æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.note-cell').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    if(coord && coord.textContent.includes(',I)')) {
                        updateRowControls(cell);
                    }
                });
                
                // åˆå¹¶å®Œæˆåç«‹å³åº”ç”¨å›¾æ ‡ç¼©æ”¾ï¼ˆä¿®å¤åˆå¹¶åå›¾æ ‡å¤§å°é‡ç½®çš„é—®é¢˜ï¼‰
                applyIconScaling();
            } else {
                // æ²¡æœ‰åˆå¹¶å•å…ƒæ ¼æ—¶ä¹Ÿè¦åº”ç”¨å›¾æ ‡ç¼©æ”¾
                applyIconScaling();
                
                // [æ–°å¢] å³ä½¿æ²¡æœ‰åˆå¹¶å•å…ƒæ ¼ï¼Œä¹Ÿåˆ·æ–°Iåˆ—æ§åˆ¶é¢æ¿
                document.querySelectorAll('.note-cell').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    if(coord && coord.textContent.includes(',I)')) {
                        updateRowControls(cell);
                    }
                });
            }
        };
    </script>

    <!-- BOSSé€‰æ‹©å¼¹çª— -->
    <div id="bossSelectModal" class="boss-select-modal">
        <div class="boss-select-content">
            <div class="boss-select-title">é€‰æ‹©å‰¯æœ¬æ¨¡å¼</div>
            <div class="boss-select-hint">âš ï¸ åˆ‡æ¢æ¨¡å¼å°†é‡ç½®è¡¨æ ¼ï¼Œè¯·å…ˆå¯¼å‡ºä¿å­˜å½“å‰é…ç½®</div>
            <div class="boss-select-grid">
                <div class="boss-option option-9man" onclick="confirmSwitchMode(9)">
                    <div class="boss-img-wrapper">
                        <img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305701.png" alt="9äººæ¨¡å¼">
                    </div>
                    <div class="boss-option-label">æå¦ˆæ¨¡æ¿</div>
                </div>
                <div class="boss-option option-6man" onclick="confirmSwitchMode(6)">
                    <div class="boss-img-wrapper">
                        <img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" alt="6äººæ¨¡å¼">
                    </div>
                    <div class="boss-option-label">ææ³•æ¨¡æ¿</div>
                </div>
            </div>
            <button class="boss-select-cancel" onclick="closeBossSelectModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- åˆ†äº«ä»£ç å¼¹çª— -->
    <div id="shareCodeModal" class="boss-select-modal" onclick="if(event.target===this) closeShareModal()">
        <div class="boss-select-content" style="max-width: 600px; width: 90%; position: relative;">
            <!-- å³ä¸Šè§’å…³é—­æŒ‰é’® -->
            <button class="share-modal-close-x" onclick="closeShareModal()" aria-label="å…³é—­">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="boss-select-title">ğŸ“‹ é…ç½®ä»£ç åˆ†äº«</div>
            <div class="boss-select-hint">åŸºäº Gzip å‹ç¼©çš„çº¯æ–‡æœ¬ä»£ç ï¼Œé€‚åˆåœ¨ NGA ç­‰è®ºå›åˆ†äº«ã€‚<br>å¤åˆ¶ä¸‹æ–¹ä»£ç åˆ†äº«ï¼Œæˆ–å°†ä»£ç ç²˜è´´åˆ°æ­¤å¤„å¯¼å…¥ã€‚</div>
            <textarea id="shareCodeInput" class="share-code-textarea" placeholder="åœ¨æ­¤å¤„ç²˜è´´åˆ†äº«ä»£ç ..." spellcheck="false"></textarea>
            <div style="display: flex; gap: 12px; justify-content: space-between; margin-top: 10px;">
                <button class="t-btn t-btn-primary" onclick="generateShareCode(this)" style="flex: 1; justify-content: center; min-width: 140px;">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px">
                        <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                        <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                    </svg>ç”Ÿæˆå¹¶å¤åˆ¶
                </button>
                <button class="t-btn t-btn-primary" onclick="importShareCode()" style="flex: 1; justify-content: center; min-width: 140px; background-color: var(--p-blue-border); border-color: var(--p-blue-border); color: #fff;">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>è¯»å–å¯¼å…¥
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== Toast æç¤ºç³»ç»Ÿ ==========
        function showToast(message, type = 'info') {
            var toast = document.createElement('div');
            toast.className = 'toast-notification ' + type;
            
            var icon = '';
            if (type === 'success') icon = 'âœ…';
            else if (type === 'error') icon = 'âŒ';
            else if (type === 'loading') icon = 'â³';
            else icon = 'â„¹ï¸';
            
            toast.innerHTML = '<span style="font-size:18px">' + icon + '</span><span>' + message + '</span>';
            document.body.appendChild(toast);
            
            if (type !== 'loading') {
                setTimeout(function() {
                    toast.classList.add('hiding');
                    setTimeout(function() {
                        if (toast.parentNode) toast.parentNode.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            return toast;
        }
        
        function hideToast(toast) {
            if (!toast || !toast.parentNode) return;
            toast.classList.add('hiding');
            setTimeout(function() {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }
        
        // ========== åˆ†äº«ä»£ç åŠŸèƒ½æ¨¡å— ==========
        
        function openShareModal() {
            var modal = document.getElementById('shareCodeModal');
            modal.classList.add('active');
            document.getElementById('shareCodeInput').value = '';
            document.getElementById('shareCodeInput').focus();
        }
        
        function closeShareModal() {
            var modal = document.getElementById('shareCodeModal');
            modal.classList.remove('active');
        }
        
        function validateImportData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
            }
            if (!data.version) {
                throw new Error('ç¼ºå°‘ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯æ—§ç‰ˆæœ¬æ•°æ®');
            }
            if (!data.mode || (data.mode !== 6 && data.mode !== 9)) {
                throw new Error('æ¨¡å¼ä¿¡æ¯æ— æ•ˆï¼ˆå¿…é¡»æ˜¯ 6 äººæˆ– 9 äººæ¨¡å¼ï¼‰');
            }
            if (!data.phases || !Array.isArray(data.phases)) {
                throw new Error('é˜¶æ®µæ•°æ®ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯');
            }
            return true;
        }
        
        async function generateShareCode(btn) {
            var input = document.getElementById('shareCodeInput');
            var loadingToast = null;
            
            try {
                loadingToast = showToast('æ­£åœ¨ç”Ÿæˆåˆ†äº«ä»£ç ...', 'loading');
                
                var data = collectData();
                data.isShareCode = true;
                data.exportTime = new Date().toISOString();
                var jsonStr = JSON.stringify(data);
                
                var finalCode = '';
                var compressionType = '';
                
                if (window.CompressionStream) {
                    try {
                        const stream = new Blob([jsonStr]).stream();
                        const compressedStream = stream.pipeThrough(new CompressionStream("gzip"));
                        const response = await new Response(compressedStream);
                        const blob = await response.blob();
                        
                        const buffer = await blob.arrayBuffer();
                        const base64 = btoa(new Uint8Array(buffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                        
                        finalCode = 'GBFOP_G1:' + base64;
                        compressionType = 'Gzip';
                    } catch (gzipErr) {
                        console.warn('Gzip å‹ç¼©å¤±è´¥ï¼Œé™çº§åˆ° Base64:', gzipErr);
                        throw gzipErr;
                    }
                } else {
                    throw new Error('ä¸æ”¯æŒ Gzip');
                }
                
                if (!finalCode) {
                    var base64 = btoa(unescape(encodeURIComponent(jsonStr)));
                    finalCode = 'GBFOP_B1:' + base64;
                    compressionType = 'Base64';
                }
                
                input.value = finalCode;
                input.select();
                
                try {
                    await navigator.clipboard.writeText(finalCode);
                    
                    hideToast(loadingToast);
                    
                    var originalHTML = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²å¤åˆ¶ï¼';
                    btn.disabled = true;
                    
                    var sizeInfo = 'åŸå§‹: ' + (jsonStr.length / 1024).toFixed(1) + 'KB â†’ å‹ç¼©: ' + (finalCode.length / 1024).toFixed(1) + 'KB';
                    showToast('ä»£ç å·²ç”Ÿæˆå¹¶å¤åˆ¶ï¼(' + compressionType + ')<br>' + sizeInfo, 'success');
                    
                    setTimeout(function() {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                    }, 2000);
                } catch (clipErr) {
                    hideToast(loadingToast);
                    showToast('ä»£ç å·²ç”Ÿæˆï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼', 'success');
                }
            } catch (err) {
                if (loadingToast) hideToast(loadingToast);
                console.error('ç”Ÿæˆä»£ç å¤±è´¥:', err);
                showToast('ç”Ÿæˆä»£ç å¤±è´¥ï¼š' + err.message, 'error');
            }
        }
        
        async function importShareCode() {
            var input = document.getElementById('shareCodeInput');
            var code = input.value.trim();
            
            if (!code) {
                showToast('è¯·å…ˆç²˜è´´åˆ†äº«ä»£ç ï¼', 'error');
                return;
            }
            
            var loadingToast = null;
            
            try {
                loadingToast = showToast('æ­£åœ¨è§£æä»£ç ...', 'loading');
                
                var jsonStr = '';
                var compressionType = '';
                
                if (code.startsWith('GBFOP_G1:')) {
                    code = code.substring(9);
                    compressionType = 'Gzip';
                    
                    if (!window.DecompressionStream) {
                        throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Gzip è§£å‹ï¼Œè¯·ä½¿ç”¨ Chrome 80+ æˆ– Edge 80+');
                    }
                    
                    const binaryString = atob(code);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const stream = new Blob([bytes]).stream();
                    const decompressedStream = stream.pipeThrough(new DecompressionStream("gzip"));
                    const response = await new Response(decompressedStream);
                    jsonStr = await response.text();
                    
                } else if (code.startsWith('GBFOP_B1:')) {
                    code = code.substring(9);
                    compressionType = 'Base64';
                    jsonStr = decodeURIComponent(escape(atob(code)));
                    
                } else if (code.startsWith('GBFOP:')) {
                    code = code.substring(6);
                    compressionType = 'Gzip (æ—§æ ¼å¼)';
                    
                    if (!window.DecompressionStream) {
                        throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Gzip è§£å‹');
                    }
                    
                    const binaryString = atob(code);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const stream = new Blob([bytes]).stream();
                    const decompressedStream = stream.pipeThrough(new DecompressionStream("gzip"));
                    const response = await new Response(decompressedStream);
                    jsonStr = await response.text();
                    
                } else {
                    throw new Error('ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„åˆ†äº«ä»£ç ï¼ˆåº”ä»¥ GBFOP_ å¼€å¤´ï¼‰');
                }
                
                var data = JSON.parse(jsonStr);
                
                validateImportData(data);
                
                if (confirm('ç¡®å®šè¦è¦†ç›–å½“å‰é…ç½®å—ï¼Ÿ\n\nå¯¼å…¥ä¿¡æ¯ï¼š\n- æ¨¡å¼ï¼š' + data.mode + 'äºº\n- é˜¶æ®µæ•°ï¼š' + (data.phases ? data.phases.length : 0) + '\n- å‹ç¼©æ–¹å¼ï¼š' + compressionType)) {
                    hideToast(loadingToast);
                    loadingToast = showToast('æ­£åœ¨å¯¼å…¥é…ç½®...', 'loading');
                    
                    restoreData(data);
                    
                    closeShareModal();
                    
                    hideToast(loadingToast);
                    
                    showToast('é…ç½®å¯¼å…¥æˆåŠŸï¼', 'success');
                }
                
            } catch (err) {
                if (loadingToast) hideToast(loadingToast);
                console.error('å¯¼å…¥å¤±è´¥:', err);
                
                var errorMsg = 'ä»£ç è§£æå¤±è´¥';
                if (err.message.includes('atob') || err.message.includes('invalid character')) {
                    errorMsg = 'ä»£ç æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæ•´å¤åˆ¶ï¼ˆä¸è¦æœ‰æ¢è¡Œæˆ–ç©ºæ ¼ï¼‰';
                } else if (err.message.includes('JSON')) {
                    errorMsg = 'æ•°æ®æ ¼å¼æŸåï¼Œæ— æ³•è§£æ JSON';
                } else if (err.message.includes('Decompression')) {
                    errorMsg = 'è§£å‹å¤±è´¥ï¼Œä»£ç å¯èƒ½å·²æŸåæˆ–ä¸å®Œæ•´';
                } else if (err.message.includes('ä¸æ”¯æŒ')) {
                    errorMsg = err.message;
                } else if (err.message.includes('ç‰ˆæœ¬') || err.message.includes('æ¨¡å¼') || err.message.includes('é˜¶æ®µ')) {
                    errorMsg = 'æ•°æ®éªŒè¯å¤±è´¥ï¼š' + err.message;
                } else {
                    errorMsg = err.message;
                }
                
                showToast(errorMsg, 'error');
            }
        }
    </script>
</body>
</html>
