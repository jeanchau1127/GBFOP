<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBF 攻略一图流模板 - 进阶版</title>
    <style>
        :root {
            --bg-body: #f5f5f5;
            --bg-table: #fff;
            --bg-toolbar: #fff;
            --bg-modal: #fff;
            --bg-header: #f8f9fa;
            --border-color: #eee;
            --text-primary: #333;
            --text-secondary: #666;
            --text-coord: #ccc;
            --text-on-dark: #fff;
            --shadow: rgba(0,0,0,0.08);
            --t-text-hover: #e3f2fd;
            /* 阶段颜色定义 */
            --p-red-border: #ff6b6b;
            --p-red-bg: linear-gradient(90deg, rgba(255,107,107,0.08) 0%, transparent 100%);
            --p-red-text: #c62828;
            --p-orange-border: #ffb347;
            --p-orange-bg: linear-gradient(90deg, rgba(255,179,71,0.08) 0%, transparent 100%);
            --p-orange-text: #e65100;
            --p-yellow-border: #fdd835;
            --p-yellow-bg: linear-gradient(90deg, rgba(255,241,118,0.08) 0%, transparent 100%);
            --p-yellow-text: #f9a825;
            --p-green-border: #66bb6a;
            --p-green-bg: linear-gradient(90deg, rgba(129,199,132,0.08) 0%, transparent 100%);
            --p-green-text: #2e7d32;
            /* 按钮渐变色 */
            --btn-gradient: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
            --btn-gradient-hover: linear-gradient(135deg, #386a8a 0%, #5d518a 100%);
            /* 🌌 极光高亮系统配色 */
            --beam-summon-color: 0, 188, 170;  /* 召唤石：极光青绿 */
            --beam-skill-color: 99, 102, 241;  /* 技能：电光蓝紫 */
        }
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-table: #1e1e1e;
            --bg-toolbar: #252525;
            --bg-modal: #2a2a2a;
            --bg-header: #2a2a2a;
            --border-color: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-coord: #555;
            --text-on-dark: #e0e0e0;
            --shadow: rgba(0,0,0,0.4);
            --t-text-hover: #333;
            --p-red-text: #ff8a80;
            --p-orange-text: #ffcc80;
            --p-yellow-text: #fff59d;
            --p-green-text: #a5d6a7;
            --text-on-dark: #e0e0e0;
            --shadow: rgba(0,0,0,0.4);
            --t-text-hover: #333;
            --phase-100-80-bg: #1e1e1e;
            --phase-100-80-text: #ff6b6b;
            --phase-80-60-bg: #1e1e1e;
            --phase-80-60-text: #ffb347;
            --phase-60-20-bg: #1e1e1e;
            --phase-60-20-text: #fff176;
            --phase-20-0-bg: #1e1e1e;
            --phase-20-0-text: #81c784;
            --user-text-p1: #ff6b6b;
            --user-text-p2: #ff8a80;
            --user-text-p3: #e0e0e0;
            --user-text-p4: #bdbdbd;
            --btn-bg: #424242;
            --btn-text: #fff;
            --btn-hover-bg: #616161;
            /* 🌌 暗色模式极光高亮 - 清透宝石风 */
            --beam-summon-color: 0, 210, 160;    /* 薄荷荧光 (Mint Glow) */
            --beam-skill-color: 110, 140, 255;   /* 月光蓝紫 (Periwinkle) */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: var(--bg-body); padding: 20px; user-select: none; transition: background 0.3s; }
        
        /* [优化] 表格容器 - 允许横向滚动 */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin: 0 auto;
        }
        
        /* [优化] 表格布局 - 根据内容自动撑开 */
        .guide-table { 
            width: auto;
            min-width: 100%;
            margin: 0 auto; 
            border-collapse: collapse; 
            table-layout: auto;
            background: var(--bg-table); 
            box-shadow: 0 4px 16px var(--shadow); 
            border-radius: 12px; 
            overflow: hidden; 
        }
        .guide-table thead { position: static; }
        .guide-table th, .guide-table td { 
            border: 1px solid var(--border-color); 
            padding: 8px 10px; 
            text-align: center; 
            vertical-align: middle; 
            color: var(--text-primary); 
            transition: background 0.15s ease; 
            position: relative;
            white-space: nowrap; /* 强制不换行 */
        }
        
        /* 表格行固定高度，确保基线一致 */
        .guide-table tbody tr {
            height: 50px; /* 固定行高 */
        }
        
        /* 确保表格单元格正常显示 */
        .guide-table td {
            display: table-cell !important;
            width: auto;
            height: 50px; /* 与表格行高度一致 */
            overflow: visible; /* 允许内容适当溢出 */
        }
        
        /* [优化] 阶段列（A列）保护最小宽度 */
        .guide-table td[rowspan] {
            min-width: 60px;
            white-space: normal; /* 阶段名允许换行 */
        }
        
        /* [优化] 备注列允许换行 */
        .guide-table .note-cell {
            white-space: normal;
            min-width: 80px;
            max-width: 200px;
        }
        
        .guide-table th { background: var(--bg-header); color: var(--text-on-dark); font-weight: bold; }
        /* 数据行悬停效果 */
        .guide-table tbody tr:not(.add-phase-row):hover td { background: rgba(33, 150, 243, 0.05); }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover td { background: rgba(33, 150, 243, 0.1); }
        .top-row th { background: var(--bg-top-row); }
        .source-cell { background: var(--bg-top-row); color: var(--text-on-dark); }
        .character-header { background: var(--bg-char-header) !important; position: relative; padding: 10px 4px 28px 4px !important; min-height: 180px; min-width: 110px; height: 180px; }
        .character-header img { width: auto; height: auto; max-height: 140px; max-width: 100%; display: block; margin: 5px auto 10px auto; object-fit: contain; }
        .character-header .char-name { font-size: 12px; color: var(--text-primary); position: absolute; bottom: 5px; left: 0; right: 0; text-align: center; border-bottom: none; }
        .character-header .char-name:hover,
        .character-header .char-name:focus { border-bottom: 1px dashed var(--text-coord); }
        .back-row { background: var(--bg-back-row) !important; }
        .skill-box { width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; margin: 2px; padding: 0; cursor: pointer; background: transparent; position: relative; }
        .skill-box img { width: 40px; height: 40px; object-fit: contain; }
        /* 召唤石专用样式 - 固定容器高度 + 绝对定位图片 */
        .skill-box.summon-box { 
            width: 40px; 
            height: 40px; /* 固定容器高度，不影响行高 */
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; /* 为绝对定位图片提供参考点 */
        }
        .skill-box.summon-box img { 
            position: absolute; /* 绝对定位，脱离文档流 */
            max-width: 40px; 
            max-height: 48px; /* 略大于容器，但不超过行高 */
            width: auto; 
            height: auto; 
            object-fit: contain; 
            z-index: 5; /* 确保在正确层级 */
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); /* 居中对齐 */
        }
        /* B列数据行的skill-box使用block布局，让图片独占一行 */
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:first-child:not([rowspan]) .skill-box,
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:nth-child(1):not([rowspan]) .skill-box {
            display: block;
            margin: 2px auto;
        }
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:first-child:not([rowspan]) .skill-box img,
        tbody tr:not(.skill-source-row):not(.add-phase-row) td:nth-child(1):not([rowspan]) .skill-box img {
            display: block;
            margin: 0 auto;
        }
        /* ========== 第一层：光标UX - 拖拽暗示 ========== */
        .skill-source { 
            cursor: grab; /* 张开的手掌，暗示"可以抓取" */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border-radius: 4px; 
        }
        .skill-source:active { 
            cursor: grabbing; /* 按下时显示"抓住的手" */
            transform: scale(1.05); 
        }
        .skill-source:hover { transform: scale(1.1) translateY(-2px); box-shadow: 0 4px 12px rgba(33,150,243,0.4); }
        .skill-source.selected { outline: 3px solid #2196f3; opacity: 0.7; }
        
        /* =========================================
           🌌 极光光束高亮系统 (Aurora Beam System)
           ========================================= */
        
        /* 1. 通用高亮过渡 */
        .guide-table th, .guide-table td {
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* 2. D列高亮 (召唤石/A-B/C/D源 -> D列) - 整列光柱 */
        .guide-table.highlight-col-D tbody td[data-col="D"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-summon-color), 0.15) 0%, 
                rgba(var(--beam-summon-color), 0.06) 50%, 
                rgba(var(--beam-summon-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-summon-color), 0.05);
            border-left: 1px solid rgba(var(--beam-summon-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-summon-color), 0.20) !important;
        }
        
        /* 3. E-J列高亮 (技能源 -> 对应列) - 整列光柱 */
        .guide-table.highlight-col-E tbody td[data-col="E"],
        .guide-table.highlight-col-F tbody td[data-col="F"],
        .guide-table.highlight-col-G tbody td[data-col="G"],
        .guide-table.highlight-col-H tbody td[data-col="H"],
        .guide-table.highlight-col-I tbody td[data-col="I"],
        .guide-table.highlight-col-J tbody td[data-col="J"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.15) 0%, 
                rgba(var(--beam-skill-color), 0.06) 50%, 
                rgba(var(--beam-skill-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-skill-color), 0.05);
            border-left: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
        }
        
        /* 4. 9人模式额外列 K-N - 整列光柱 */
        .guide-table.highlight-col-K tbody td[data-col="K"],
        .guide-table.highlight-col-L tbody td[data-col="L"],
        .guide-table.highlight-col-M tbody td[data-col="M"],
        .guide-table.highlight-col-N tbody td[data-col="N"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.15) 0%, 
                rgba(var(--beam-skill-color), 0.06) 50%, 
                rgba(var(--beam-skill-color), 0.01) 100%) !important;
            box-shadow: inset 0 0 15px rgba(var(--beam-skill-color), 0.05);
            border-left: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
            border-right: 1px solid rgba(var(--beam-skill-color), 0.20) !important;
        }
        
        /* 5. 表头高亮效果 - 作为光源 */
        .guide-table.highlight-col-D thead th[data-col="D"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-summon-color), 0.30) 0%, 
                rgba(var(--beam-summon-color), 0.15) 100%) !important;
            box-shadow: 0 3px 12px rgba(var(--beam-summon-color), 0.20);
            text-shadow: 0 0 8px rgba(var(--beam-summon-color), 0.5);
        }
        
        .guide-table.highlight-col-E thead th[data-col="E"],
        .guide-table.highlight-col-F thead th[data-col="F"],
        .guide-table.highlight-col-G thead th[data-col="G"],
        .guide-table.highlight-col-H thead th[data-col="H"],
        .guide-table.highlight-col-I thead th[data-col="I"],
        .guide-table.highlight-col-J thead th[data-col="J"],
        .guide-table.highlight-col-K thead th[data-col="K"],
        .guide-table.highlight-col-L thead th[data-col="L"],
        .guide-table.highlight-col-M thead th[data-col="M"],
        .guide-table.highlight-col-N thead th[data-col="N"] {
            background: linear-gradient(180deg, 
                rgba(var(--beam-skill-color), 0.30) 0%, 
                rgba(var(--beam-skill-color), 0.15) 100%) !important;
            box-shadow: 0 3px 12px rgba(var(--beam-skill-color), 0.20);
            text-shadow: 0 0 8px rgba(var(--beam-skill-color), 0.5);
        }
        .swap-row { background: var(--bg-header) !important; }
        .swap-row td { color: var(--text-on-dark); }
        .coord { font-size: 9px; color: var(--text-coord); display: block; }
        .coord-header { font-size: 9px; color: #ccc; }
        .note-cell { font-size: 11px; background: var(--bg-note-cell); color: var(--text-primary); }
        .note-cell-dark { font-size: 11px; background: var(--bg-back-row); color: var(--text-on-dark); }
        #floatingIcon { position: fixed; pointer-events: none; opacity: 0.7; z-index: 9999; display: none; }
        /* ========== Material Design 工具栏 ========== */
        .toolbar {
            max-width: 1800px;
            margin: 0 auto 15px;
            padding: 12px 16px;
            background: var(--bg-toolbar);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .toolbar button {
            padding: 8px 16px;
            /* 修改：使用渐变背景，文字白色 */
            background: var(--btn-gradient);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            display: inline-flex; /* 保证图标对齐 */
            align-items: center;
            gap: 4px;
        }
        .toolbar button:hover {
            /* 修改：悬停使用深色渐变 */
            background: var(--btn-gradient-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .toolbar button:active { transform: translateY(0); }
        .toolbar span { color: var(--text-secondary); font-size: 12px; margin-left: auto; }
        
        /* ========== 创作者徽章系统 ========== */
        .author-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            white-space: nowrap;
            height: 36px;
            box-sizing: border-box;
        }
        .author-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(var(--beam-skill-color), 0.15);
            border-color: rgba(var(--beam-skill-color), 0.4);
            color: rgb(var(--beam-skill-color));
        }
        .author-badge .author-icon {
            font-size: 14px;
            opacity: 0.7;
        }
        [data-theme="dark"] .author-badge {
            background: rgba(40, 40, 45, 0.8);
            backdrop-filter: blur(8px);
        }
        
        /* 🌟 呼吸灯动画 - 引导用户点击 */
        @keyframes badge-pulse {
            0% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 0 rgba(var(--beam-skill-color), 0.4); }
            70% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 8px rgba(var(--beam-skill-color), 0); }
            100% { box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 0 0 0 rgba(var(--beam-skill-color), 0); }
        }
        .author-badge.pulse {
            animation: badge-pulse 2s infinite;
            border-color: rgba(var(--beam-skill-color), 0.5);
        }
        
        /* 创作者弹窗遮罩 */
        .author-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        .author-modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        /* 创作者卡片 */
        .author-card {
            width: 380px;
            max-width: 90vw;
            background: var(--bg-modal);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--border-color);
            position: relative;
        }
        .author-modal-overlay.active .author-card {
            transform: scale(1);
        }
        .author-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .author-card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(90deg, rgb(var(--beam-skill-color)), rgb(var(--beam-summon-color)));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .author-card .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }
        .author-card .close-btn:hover {
            color: var(--text-primary);
        }
        
        /* 区块标签 */
        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* 历史贡献者列表 */
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
        }
        [data-theme="dark"] .history-list {
            background: rgba(255,255,255,0.03);
        }
        .history-tag {
            font-size: 12px;
            padding: 4px 10px;
            background: rgba(var(--beam-skill-color), 0.1);
            color: rgb(var(--beam-skill-color));
            border-radius: 12px;
            border: 1px solid rgba(var(--beam-skill-color), 0.2);
            transition: all 0.2s;
        }
        .history-tag:hover {
            background: rgba(var(--beam-skill-color), 0.15);
        }
        .empty-history {
            font-size: 13px;
            color: var(--text-coord);
            font-style: italic;
            padding: 8px;
        }
        
        /* 当前编辑者输入 */
        .current-author-section {
            margin-top: 16px;
        }
        .author-input-wrapper {
            position: relative;
            margin-bottom: 8px;
        }
        #authorInput {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-table);
            font-size: 15px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #authorInput:focus {
            border-color: rgb(var(--beam-skill-color));
            box-shadow: 0 0 0 3px rgba(var(--beam-skill-color), 0.1);
        }
        #authorInput::placeholder {
            color: var(--text-coord);
        }
        .input-hint {
            font-size: 11px;
            color: var(--text-coord);
            margin: 8px 0 0 0;
        }
        
        /* ========== Material Design 开关样式 ========== */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .toggle-switch input {
            display: none;
        }
        .toggle-slider {
            width: 36px;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s ease;
        }
        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: #2196f3;
        }
        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(16px);
        }
        .toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ========== 隐藏坐标样式 ========== */
        .hide-coords .coord,
        .hide-coords .coord-header {
            display: none !important;
        }
        .user-text { font-size: 11px; color: var(--text-primary); margin-top: 3px; display: block; word-break: break-all; cursor: text; outline: none; }
        .user-text:hover { background: var(--t-text-hover); }
        .user-text:focus { background: var(--t-text-hover); }
        
        /* ========== 第一层：光标UX - 备注编辑暗示 ========== */
        /* 备注单元格空状态时显示编辑光标和提示 */
        .note-cell {
            cursor: text; /* 文本编辑光标 */
        }
        
        /* 备注单元格悬停时的编辑提示边框 */
        .note-cell:hover {
            outline: 1px dashed var(--text-coord);
            outline-offset: -2px;
        }
        .note-cell:focus-within {
            outline: 2px solid #2196f3;
            outline-offset: -2px;
        }
        /* ========== Material Design 弹窗样式 ========== */
        .text-input-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.2), 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            color: var(--text-primary);
            animation: modalFadeIn 0.2s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .text-input-modal input {
            width: 220px;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        .text-input-modal input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .text-input-modal button {
            margin-left: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .text-input-modal button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            backdrop-filter: blur(2px);
            animation: overlayFadeIn 0.2s ease-out;
        }
        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ========== 阶段/行按钮（简洁文字风格） ========== */
        .phase-btn {
            padding: 0 2px;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .phase-btn:hover {
            color: #4caf50;
            transform: scale(1.3);
        }
        .phase-btn:active { transform: scale(1.1); }
        
        /* 删除阶段按钮 */
        .phase-del-btn {
            padding: 0 2px;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .phase-del-btn:hover {
            color: #f44336;
            transform: scale(1.3);
        }
        .phase-del-btn:active { transform: scale(1.1); }
        
        /* A列按钮容器 - 让+和-居中对称 */
        .a-cell-buttons {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .del-btn {
            padding: 0 2px;
            margin: 0;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .del-btn:hover {
            color: #f44336;
            transform: scale(1.3);
        }
        .del-btn:active { transform: scale(1.1); }
        
        /* B列单元格内容容器 - 优化版 */
        .b-cell-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 25px;
        }
        /* 左侧删除按钮 */
        .b-cell-content .del-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }
        /* 右侧添加行按钮 */
        .b-cell-content .add-row-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            padding: 0;
            background: transparent;
            color: var(--text-primary);
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .b-cell-content .add-row-btn:hover {
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            transform: translateY(-50%) scale(1.1);
        }
        .b-cell-content .add-row-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        [data-theme="dark"] .b-cell-content .add-row-btn:hover {
            color: #81c784;
            background: rgba(129, 199, 132, 0.1);
        }
        .b-cell-content .t-text {
            display: inline-block;
        }
        
        .t-text { cursor: pointer; border-bottom: 1px dashed var(--text-coord); color: var(--text-primary); }
        .t-text:hover { background: var(--t-text-hover); }
        .t-text.phase-name { font-weight: bold; border-bottom: none; }
        .header-text { cursor: pointer; }
        .header-text:hover { opacity: 0.8; }
        /* ========== Material Design 新增阶段按钮 ========== */
        .add-phase-row td { background: var(--bg-table); }
        .add-phase-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .add-phase-btn:hover {
            background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .add-phase-btn:active { transform: translateY(0); }
        /* ========== Material Design 右键菜单 ========== */
        .context-menu {
            position: fixed;
            background: var(--bg-modal);
            border: none;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10002;
            min-width: 180px;
            padding: 8px 0;
            animation: menuSlideIn 0.15s ease-out;
        }
        @keyframes menuSlideIn {
            from { opacity: 0; transform: translateY(-8px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: background 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .context-menu-item:hover { background: rgba(33, 150, 243, 0.1); }
        .context-menu-divider { height: 1px; background: var(--border-color); margin: 6px 0; }
        .context-menu-submenu { position: relative; }
        .context-menu-submenu::after { content: '▶'; position: absolute; right: 12px; font-size: 10px; opacity: 0.6; }
        .context-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: var(--bg-modal);
            border: none;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
            min-width: 140px;
            padding: 8px 0;
            display: none;
        }
        .context-menu-submenu:hover .context-submenu { display: block; }
        
        /* ========== Material Design 角色快速添加弹窗样式 ========== */
        .char-add-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.2), 0 8px 16px rgba(0,0,0,0.1);
            z-index: 10001;
            color: var(--text-primary);
            min-width: 420px;
            max-width: 90vw;
            animation: modalFadeIn 0.2s ease-out;
        }
        .char-add-modal h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 500;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
        }
        .char-add-modal .wiki-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 16px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            transition: all 0.2s ease;
        }
        .char-add-modal .wiki-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .char-add-modal .top-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .char-add-modal .more-skills-inline-btn {
            margin-left: auto;
            height: 36px;
            padding: 0 18px;
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
        }
        .char-add-modal label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .char-add-modal input[type="text"], .char-add-modal textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg-table);
            color: var(--text-primary);
            margin-bottom: 14px;
            transition: border-color 0.2s ease;
        }
        .char-add-modal input[type="text"]:focus, .char-add-modal textarea:focus {
            outline: none;
            border-color: #2196f3;
        }
        .char-add-modal textarea { height: 80px; resize: vertical; font-family: monospace; }
        .char-add-modal .preview-area {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            align-items: center;
            flex-wrap: wrap;
            padding: 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }
        [data-theme="dark"] .char-add-modal .preview-area { background: rgba(255,255,255,0.05); }
        .char-add-modal .preview-img {
            width: 50px;
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-table);
        }
        .char-add-modal .preview-skill {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-table);
        }
        .char-add-modal .preview-summon {
            width: 40px;
            height: auto;
            max-height: 56px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            object-fit: contain;
            background: var(--bg-table);
        }
        .char-add-modal .btn-row {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .char-add-modal .btn-row button {
            padding: 10px 24px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .char-add-modal .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .char-add-modal .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .char-add-modal .btn-secondary {
            background: #616161;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .char-add-modal .btn-secondary:hover {
            background: #757575;
            transform: translateY(-1px);
        }
        .char-add-modal .hint {
            font-size: 11px;
            color: var(--text-coord);
            margin-top: -10px;
            margin-bottom: 14px;
        }
        
        /* ========== 角色/职业独立输入框样式 ========== */
        .char-input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .char-input-label {
            width: 90px;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
            padding-bottom: 8px;
        }
        .char-avatar-input {
            flex: 1;
            padding: 8px 12px !important;
            margin: 0 !important;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        .char-avatar-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .char-avatar-preview {
            width: 50px;
            height: auto;
            max-height: 80px;
            object-fit: contain;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .skill-inputs-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
        }
        .skill-input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .skill-input-label {
            width: 60px;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
            padding-bottom: 8px;
        }
        .skill-url-input-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
            display: flex;
            align-items: center;
        }
        .skill-url-input {
            flex: 1;
            padding: 0 40px 0 12px !important;
            margin: 0 !important;
            height: 40px;
            line-height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .skill-url-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        /* 拖拽悬停效果 */
        .skill-url-input.drag-over {
            border-color: #4caf50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }
        .skill-url-input.drag-over::placeholder {
            content: '松开以粘贴';
        }
        
        /* 召唤石输入框专用样式 - 参照职业头像处理方式 */
        .summon-url-input {
            flex: 1;
            padding: 8px 40px 8px 12px !important;
            margin: 0 !important;
            height: auto;
            min-height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg-table);
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .summon-url-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .summon-url-input.drag-over {
            border-color: #4caf50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }
        
        /* 输入框内的粘贴按钮 */
        .paste-btn-inline {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .paste-btn-inline:hover {
            background: #f57c00;
            transform: translateY(-50%) scale(1.1);
        }
        .paste-btn-inline:active {
            transform: translateY(-50%) scale(0.95);
        }
        .skill-input-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* 召唤石预览图 - 参照职业头像处理方式 */
        .summon-input-preview {
            width: 40px;
            height: auto;
            max-height: 80px;
            object-fit: contain;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-table);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* ========== 1. 统一的圆形按钮基础样式 (Glass Bubble) ========== */
        .mini-fab, .micro-fab {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            /* 核心改动：使用半透明背景 + 阴影，而不是纯色块 */
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            line-height: 1;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* 弹性动画 */
            opacity: 0; /* 默认隐藏 */
            transform: scale(0.8);
        }
        
        /* 悬停显示逻辑 */
        .has-fab:hover .mini-fab,
        .skill-box:hover .mini-fab,
        .data-cell:hover .micro-fab {
            opacity: 1;
            transform: scale(1);
        }
        
        /* 按钮悬停交互 */
        .mini-fab:hover, .micro-fab:hover {
            transform: scale(1.15) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #fff; /* 悬停时变纯白 */
        }
        
        /* ========== 2. 颜色定义 (图标着色) ========== */
        /* 编辑 (蓝色) */
        .mini-fab.edit, .micro-fab.text { color: #2196f3; }
        /* 删除 (红色) */
        .mini-fab.delete, .delete-char-btn { color: #f44336; }
        /* 添加 (绿色) */
        .mini-fab.add { color: #4caf50; }
        /* 合并 (绿色) */
        .micro-fab.merge { color: #4caf50; }
        /* 拆分 (橙色) */
        .micro-fab.split { color: #ff9800; }
        /* 完全拆分 (红色) */
        .micro-fab.split-full { color: #f44336; }
        
        /* ========== 3. 暗色模式适配 ========== */
        [data-theme="dark"] .mini-fab, 
        [data-theme="dark"] .micro-fab {
            background: rgba(50, 50, 50, 0.9); /* 深色半透明底 */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        
        [data-theme="dark"] .mini-fab:hover, 
        [data-theme="dark"] .micro-fab:hover {
            background: #424242;
        }
        
        [data-theme="dark"] .mini-fab.edit, 
        [data-theme="dark"] .micro-fab.text { color: #64b5f6; }
        [data-theme="dark"] .mini-fab.delete { color: #ef5350; }
        [data-theme="dark"] .mini-fab.add { color: #81c784; }
        [data-theme="dark"] .micro-fab.merge { color: #81c784; }
        [data-theme="dark"] .micro-fab.split { color: #ffb74d; }
        [data-theme="dark"] .micro-fab.split-full { color: #ef5350; }
        
        /* ========== 4. 位置微调 ========== */
        /* 角色头像区域的编辑按钮 */
        .character-header .mini-fab { top: 6px; right: 6px; }
        /* 召唤石/技能源区域的按钮 */
        .source-cell .mini-fab { top: 6px; right: 6px; }
        
        /* 技能图标上的删除按钮 */
        .skill-box .mini-fab { 
            width: 18px; 
            height: 18px; 
            font-size: 12px;
            top: -6px; 
            right: -6px; 
        }
        
        /* 单元格操作按钮位置 */
        .micro-fab.top-left { top: 2px; left: 2px; }
        .micro-fab.top-right { top: 2px; right: 2px; }
        
        /* 数据单元格悬停时显示微型按钮 */
        .data-cell { 
            position: relative !important; 
            vertical-align: middle !important;
            text-align: center !important;
            height: 50px;
            padding: 4px;
            display: table-cell !important;
            overflow: visible !important; /* 确保按钮不被遮挡 */
        }
        .data-cell:hover .micro-fab,
        td:hover > .micro-fab.top-left { 
            opacity: 1; 
            transform: scale(1);
            transition-delay: 0s;
        }
        .data-cell .micro-fab,
        td > .micro-fab.top-left { 
            transition-delay: 0.3s;
        }
        
        /* 数据单元格内的技能图标容器 */
        .data-cell .skill-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            margin-bottom: 4px;
        }
        
        /* 数据单元格内的技能图标 */
        .data-cell .skill-box {
            margin: 1px;
            display: inline-block; /* 确保技能图标正常显示 */
        }
        
        /* 数据单元格内的文字 */
        .data-cell .user-text-wrapper {
            margin-top: 4px;
            text-align: center;
            display: block;
        }
        
        /* D列（召唤石列）内的文字 - 与data-cell保持一致 */
        td:not(.data-cell) .user-text-wrapper {
            margin-top: 4px;
            text-align: center;
            display: block;
        }
        
        /* 微型按钮定位 */
        .micro-fab.top-left { top: 2px; left: 2px; }
        .micro-fab.top-right { top: 2px; right: 2px; }
        
        /* 父元素悬停时显示按钮 */
        .has-fab { position: relative; }
        .has-fab:hover .mini-fab { opacity: 1; }
        
        /* ========== 优化左上角删除按钮 (与右上角风格统一) ========== */
        .delete-char-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* 升级为毛玻璃质感，与右侧按钮一致 */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f44336; /* 红色图标 */
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            /* 统一的阴影质感 */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* 悬停效果 */
        .delete-char-btn:hover {
            background: #fff;       /* 纯白高亮 */
            color: #d32f2f;         /* 图标变深红 */
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2); /* 红色系的淡阴影 */
        }

        .delete-char-btn:active {
            transform: scale(1);
        }

        /* 父元素悬停显示逻辑保持不变 */
        .has-fab:hover .delete-char-btn {
            opacity: 1;
        }

        /* 暗色模式适配 */
        [data-theme="dark"] .delete-char-btn {
            background: rgba(50, 50, 50, 0.9);
            color: #ef5350;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .delete-char-btn:hover {
            background: #424242;
        }
        
        /* 角色头像区域的编辑按钮 */
        .character-header .mini-fab { 
            top: 4px; 
            right: 4px;
        }
        .character-header:hover .mini-fab {
            opacity: 1;
        }
        
        /* 召唤石/技能源区域的添加按钮 */
        .source-cell .mini-fab { top: 2px; right: 2px; }
        
        /* BOSS图区域的编辑按钮 - 使用子选择器精确定位 */
        .top-row > th > .mini-fab.edit { top: 5px; right: 10px; }
        
        /* 表头状态图标的删除按钮 - 与内容行保持一致 */
        .top-row .skill-box.skill-source {
            position: relative;
        }
        .top-row .skill-box.skill-source .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.15s ease;
        }
        .top-row .skill-box.skill-source:hover .mini-fab {
            opacity: 1;
            transform: scale(1);
        }
        
        /* 数据格子的添加按钮 */
        .data-cell-fab { top: 2px; right: 2px; }
        
        /* 已放置技能的删除按钮 */
        .skill-box:not(.skill-source) { position: relative; }
        .skill-box:not(.skill-source) .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
        }
        
        /* 召唤石删除按钮特殊定位 - 相对于图片而非容器 */
        .skill-box.summon-box:not(.skill-source) .mini-fab {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            z-index: 10;
            /* 删除按钮将通过JavaScript动态调整位置 */
        }
        
        .skill-box:not(.skill-source):hover .mini-fab { opacity: 1; }
        
        /* 导出图片时隐藏按钮 */
        .exporting .mini-fab { display: none !important; }
        .exporting .empty-cell-hint { display: none !important; }
        
        /* ========== 空状态提示基础样式 ========== */
        .empty-state-hint,
        .summon-empty-state-hint,
        .boss-empty-state-hint {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
        }
        
        .empty-state-hint {
            top: 40%;
            text-align: center;
            width: 90%;
        }
        
        .summon-empty-state-hint {
            top: 50%;
            width: 90%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .boss-empty-state-hint {
            top: 50%;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
        }
        
        /* 空状态文字样式 */
        .empty-text,
        .summon-empty-text,
        .boss-empty-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .empty-text { margin-bottom: 12px; }
        .summon-empty-text { white-space: nowrap; }
        .boss-empty-text { font-size: 14px; text-align: center; }
        
        /* 空状态按钮容器 */
        .empty-buttons,
        .summon-empty-buttons,
        .boss-empty-buttons {
            pointer-events: auto;
            display: flex;
            gap: 6px;
        }
        
        .empty-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .summon-empty-buttons { gap: 8px; }
        .summon-empty-buttons-vertical {
            flex-direction: column;
            gap: 5px;
        }
        
        /* 小按钮样式 */
        .wiki-btn-small {
            padding: 6px 12px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .wiki-btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }
        
        .wiki-btn-small:active { transform: translateY(0); }
        
        /* 召唤石按钮缩小尺寸 */
        .summon-empty-buttons-vertical .wiki-btn-small {
            padding: 4px 8px;
            font-size: 10px;
            min-width: 80px;
        }
        
        /* 角色名称文字在空状态时提高层级 */
        .character-header .char-name {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 2;
        }
        
        /* 拖拽悬停效果 */
        .drag-drop-zone { position: relative; }
        .drag-drop-zone.drag-over {
            outline: 3px dashed #2196f3;
            outline-offset: -3px;
            background: rgba(33, 150, 243, 0.05);
        }
        [data-theme="dark"] .drag-drop-zone.drag-over { background: rgba(33, 150, 243, 0.1); }
        
        /* ========== 帮助按钮和提示框样式 ========== */
        .modal-help-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 28px;
            height: 28px;
            background: transparent;
            color: #2196f3;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-help-btn:hover {
            color: #1565c0;
            transform: scale(1.15);
        }
        .modal-help-btn:active {
            transform: scale(0.95);
        }
        
        .help-tooltip {
            position: absolute;
            top: 60px;
            right: 24px;
            width: 320px;
            background: var(--bg-modal);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            z-index: 9;
            display: none;
        }
        .help-tooltip h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #2196f3;
            font-weight: 600;
        }
        .help-tooltip ol {
            margin: 0 0 12px 0;
            padding-left: 20px;
        }
        .help-tooltip li {
            margin-bottom: 6px;
        }
        .help-tooltip .help-section {
            margin-bottom: 12px;
        }
        .help-tooltip .help-section:last-child {
            margin-bottom: 0;
        }
        
        /* ========== Material Design 输入框样式 ========== */
        .font-size-input {
            width: 55px;
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-table);
            color: var(--text-primary);
            font-size: 13px;
            transition: border-color 0.2s ease;
        }
        .font-size-input:focus {
            outline: none;
            border-color: #2196f3;
        }
        .toolbar-label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-right: 4px;
        }
        
        /* ========== Material Design 单选按钮样式 ========== */
        .material-radio {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.15s ease;
            margin-right: 8px;
        }
        .material-radio:hover { background: rgba(33, 150, 243, 0.1); }
        .material-radio input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .material-radio input[type="radio"]:checked {
            border-color: #2196f3;
        }
        .material-radio input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #2196f3;
            border-radius: 50%;
            animation: radioCheck 0.15s ease-out;
        }
        @keyframes radioCheck {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* ========== 用户文字删除按钮 ========== */
        .user-text-wrapper {
            position: relative;
            display: inline-block;
        }
        .user-text-wrapper .mini-fab {
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            font-size: 10px;
        }
        .user-text-wrapper:hover .mini-fab { opacity: 1; }
        
        /* ========== 空格子提示样式 ========== */
        .empty-cell-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-coord);
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        td:hover .empty-cell-hint { opacity: 0.6; }
        td.has-content .empty-cell-hint { display: none; }
        
        /* ========== Ripple 涟漪效果 ========== */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
        }
        .ripple:active::after {
            width: 200%;
            height: 200%;
            opacity: 0;
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        /* ========== 状态栏优化 ========== */
        #statusBar {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
            animation: statusSlideIn 0.2s ease-out;
        }
        @keyframes statusSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* ========== 主角常用技能快捷按钮 ========== */
        .quick-skills-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed var(--border-color);
        }
        .quick-skills-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .quick-skill-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .quick-skill-btn {
            padding: 4px;
            width: 36px;
            height: 36px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .quick-skill-btn:hover {
            background: #4caf50;
            color: #fff;
            transform: translateY(-1px) scale(1.05);
        }
        .quick-skill-btn.special:hover {
            background: #ff9800;
        }
        .quick-skill-btn img {
            width: 28px;
            height: 28px;
            border-radius: 4px;
        }
        
        /* ========== 技能槽内联增删按钮 ========== */
        .skill-inline-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .skill-inline-btn.add-skill-row {
            background: #4caf50;
        }
        .skill-inline-btn.add-skill-row:hover {
            background: #43a047;
            transform: scale(1.15);
        }
        .skill-inline-btn.remove-skill-row {
            background: #f44336;
        }
        .skill-inline-btn.remove-skill-row:hover {
            background: #e53935;
            transform: scale(1.15);
        }
        .skill-inline-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ========== 🎨 现代 UI 优化样式 (GBF Theme) ========== */
        
        /* Google Fonts 引入 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        /* 全局字体优化 */
        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
        }
        
        /* 数字使用 Roboto 字体 */
        .t-text, .phase-name, .coord, .coord-header, .font-size-input {
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
        }
        
        /* 1. 表格去边框化与圆角 */
        .guide-table {
            border-radius: 16px;
            border: none !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            /* [修改] 改为自动布局，允许内容撑开 */
            table-layout: auto;
            width: auto;
            min-width: 100%;
        }
        
        /* [修改] 单元格不换行，但不截断 */
        .guide-table td, .guide-table th {
            overflow: visible;
            white-space: nowrap;
        }
        /* 例外：允许换行的元素 */
        .guide-table .phase-name,
        .guide-table .user-text,
        .guide-table .char-name,
        .guide-table .t-text,
        .guide-table .note-cell,
        .guide-table td[rowspan] {
            white-space: normal;
        }
        
        .guide-table th, 
        .guide-table td {
            border-top: none !important;
            border-left: none !important;
            border-bottom: 1px solid rgba(0,0,0,0.06) !important;
            border-right: 1px solid rgba(0,0,0,0.04) !important; /* 极淡垂直线 */
            padding: 12px 14px;
        }
        
        /* 去掉最后一列的右边框 */
        .guide-table th:last-child,
        .guide-table td:last-child {
            border-right: none !important;
        }
        
        [data-theme="dark"] .guide-table th,
        [data-theme="dark"] .guide-table td {
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            border-right: 1px solid rgba(255,255,255,0.05) !important; /* 暗色模式垂直线 */
        }
        
        [data-theme="dark"] .guide-table th:last-child,
        [data-theme="dark"] .guide-table td:last-child {
            border-right: none !important;
        }
        
        /* 去掉最后一行的线 */
        .guide-table tbody tr:last-child td {
            border-bottom: none !important;
        }
        
        /* 斑马纹效果 */
        .guide-table tbody tr:nth-child(even):not(.add-phase-row) td {
            background-color: rgba(0,0,0,0.015);
        }
        [data-theme="dark"] .guide-table tbody tr:nth-child(even):not(.add-phase-row) td {
            /* 修改：使用极微弱的黑色叠加，比白色叠加更沉稳 */
            background-color: rgba(0,0,0,0.15);
        }
        
        /* 2. 表头 GBF 风格增强 */
        .guide-table thead tr.top-row th {
            background: var(--bg-header) !important; /* 背景改为与表格头部一致的浅灰色 */
            color: var(--text-primary);              /* 文字颜色改为深色 */
            border-bottom: none !important;          /* 去掉原本每行都有的边框 */
            padding-top: 15px;                       /* 增加一点顶部空间 */
        }
        
        /* 专门给第二行（状态图标行）底部加一条金线，作为与正文的分割 */
        .guide-table thead tr.top-row:nth-child(2) th {
            border-bottom: 3px solid #c2a05d !important; /* GBF 金色实线 */
            padding-bottom: 15px;
        }
        
        [data-theme="dark"] .guide-table thead tr.top-row th {
            background: var(--bg-header) !important; /* 暗色模式背景 */
            border-bottom: none !important;
        }
        
        /* 暗色模式下的金线调整 */
        [data-theme="dark"] .guide-table thead tr.top-row:nth-child(2) th {
            border-bottom: 3px solid #8b7355 !important;
        }
        
        /* 角色栏头部样式 */
        .character-header {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
            border-bottom: 2px solid #e0e4e8 !important;
            transition: all 0.3s ease;
        }
        
        .character-header:hover {
            background: linear-gradient(180deg, #fff 0%, #f5f7fa 100%) !important;
        }
        
        [data-theme="dark"] .character-header {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
            border-bottom: 2px solid #3a3a3a !important;
        }
        
        [data-theme="dark"] .character-header:hover {
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%) !important;
        }
        
        /* 后排角色特殊样式 (5-6号位 / I-J列) */
        .character-header.back-row {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
            opacity: 0.85;
        }
        
        [data-theme="dark"] .character-header.back-row {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* [新增] 后排的后排样式 (7-9号位 / K-M列) - 与后排1-2保持一致 */
        .character-header.back-row-2 {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
            opacity: 0.85;
        }
        
        [data-theme="dark"] .character-header.back-row-2 {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* 3. 阶段显示优化 - 左侧色条风格 */
        /* 100%-80% 阶段 - 红色 */
        tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(255,107,107,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #ff6b6b !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03); /* 右侧轻微阴影增加层次感 */
            position: relative;
            z-index: 5;
        }
        tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] .phase-name {
            color: #d32f2f;
            font-weight: 600;
        }
        [data-theme="dark"] tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] {
            /* 降低透明度到 0.05，让它隐约可见 */
            background: linear-gradient(90deg, rgba(255,107,107,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] tbody tr:not(.phase-80-60):not(.phase-60-20):not(.phase-20-0):not(.add-phase-row) td:first-child[rowspan] .phase-name {
            color: #ff8a80;
        }
        
        /* 80%-60% 阶段 - 橙色 */
        .phase-80-60 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(255,179,71,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #ffb347 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-80-60 td:first-child[rowspan] .phase-name {
            color: #e65100;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-80-60 td:first-child[rowspan] {
            /* 降低透明度到 0.05 */
            background: linear-gradient(90deg, rgba(255,179,71,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-80-60 td:first-child[rowspan] .phase-name {
            color: #ffb74d;
        }
        
        /* 60%-20% 阶段 - 黄色 */
        .phase-60-20 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(253,216,53,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #fdd835 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-60-20 td:first-child[rowspan] .phase-name {
            color: #f9a825;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-60-20 td:first-child[rowspan] {
            /* 降低透明度到 0.05 */
            background: linear-gradient(90deg, rgba(253,216,53,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-60-20 td:first-child[rowspan] .phase-name {
            color: #ffee58;
        }
        
        /* 20%-0% 阶段 - 绿色 */
        .phase-20-0 td:first-child[rowspan] {
            background: linear-gradient(90deg, rgba(102,187,106,0.08) 0%, transparent 100%) !important;
            border-left: 4px solid #66bb6a !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
            position: relative;
            z-index: 5;
        }
        .phase-20-0 td:first-child[rowspan] .phase-name {
            color: #2e7d32;
            font-weight: 600;
        }
        [data-theme="dark"] .phase-20-0 td:first-child[rowspan] {
            /* 降低透明度到 0.05 */
            background: linear-gradient(90deg, rgba(102,187,106,0.05) 0%, transparent 100%) !important;
        }
        [data-theme="dark"] .phase-20-0 td:first-child[rowspan] .phase-name {
            color: #81c784;
        }
        
        /* 4. 工具栏毛玻璃效果 */
        .toolbar {
            position: sticky;
            top: 10px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            z-index: 1000;
            border-radius: 16px;
            padding: 14px 20px;
        }
        
        [data-theme="dark"] .toolbar {
            background: rgba(30, 30, 30, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* 5. 按钮质感优化 */
        .toolbar button {
            font-weight: 600;
            letter-spacing: 0.3px;
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 13px;
        }
        
        .toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        
        /* 主题切换按钮 GBF 风格 */
        .theme-toggle {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid #c2a05d !important;
        }
        
        .theme-toggle:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4) !important;
        }
        
        /* 6. 输入框优化 */
        .font-size-input,
        .char-add-modal input,
        .text-input-modal input {
            border: 2px solid #e0e4e8;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.25s ease;
        }
        
        .font-size-input:focus,
        .char-add-modal input:focus,
        .text-input-modal input:focus {
            background: #fff;
            border-color: #1d4585;
            box-shadow: 0 0 0 4px rgba(29, 69, 133, 0.15);
        }
        
        [data-theme="dark"] .font-size-input,
        [data-theme="dark"] .char-add-modal input,
        [data-theme="dark"] .text-input-modal input {
            border-color: #444;
            background: #2a2a2a;
        }
        
        [data-theme="dark"] .font-size-input:focus,
        [data-theme="dark"] .char-add-modal input:focus,
        [data-theme="dark"] .text-input-modal input:focus {
            border-color: #4a7ab8;
            box-shadow: 0 0 0 4px rgba(74, 122, 184, 0.2);
        }
        
        /* 7. 空状态提示优化 - 中间按钮常驻且美化 */
        .empty-state-hint {
            opacity: 1 !important; /* 强制不透明，常驻显示 */
            pointer-events: auto;  /* 确保按钮可点击 */
            transition: opacity 0.3s ease;
        }
        
        /* 美化中间的 "Wiki查询/编队查询" 按钮 */
        .wiki-btn, .wiki-btn-small {
            /* 使用与顶部工具栏一致的深蓝渐变 */
            background: var(--btn-gradient) !important;
            color: #fff !important;
            border: none !important;
            border-radius: 20px !important; /* 圆角胶囊样式 */
            box-shadow: 0 4px 10px rgba(43, 88, 118, 0.2);
            font-weight: 500;
            padding: 6px 16px; /* 稍微加大点击区域 */
            transition: all 0.2s;
        }
        .wiki-btn:hover, .wiki-btn-small:hover {
            background: var(--btn-gradient-hover) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(43, 88, 118, 0.4);
        }
        
        .character-header:hover .empty-state-hint,
        .source-cell:hover .empty-state-hint {
            opacity: 1;
        }
        
        .empty-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* 8. 操作按钮隐藏优化已在上方统一定义 */
        
        /* 9. 数据单元格悬停效果优化 - 现代浮起卡片风格 */
        .guide-table tbody tr:not(.add-phase-row) {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .guide-table tbody tr:not(.add-phase-row):hover {
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .guide-table tbody tr:not(.add-phase-row):hover td {
            background: var(--bg-table) !important;
            border-bottom-color: transparent !important;
        }
        
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover td {
            background: #2a2a2a !important;
        }
        
        /* 10. 弹窗样式优化 */
        .text-input-modal,
        .char-add-modal {
            border: 1px solid rgba(194, 160, 93, 0.3);
            box-shadow: 0 24px 64px rgba(0,0,0,0.15), 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .char-add-modal h3 {
            color: #1d4585;
            border-bottom: 2px solid #c2a05d;
        }
        
        [data-theme="dark"] .char-add-modal h3 {
            color: #7ba3d4;
            border-bottom-color: #8b7355;
        }
        
        /* 11. 新增阶段按钮 GBF 风格 */
        .add-phase-btn {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid #c2a05d;
            box-shadow: 0 4px 12px rgba(29, 69, 133, 0.3);
        }
        
        .add-phase-btn:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 6px 20px rgba(29, 69, 133, 0.4);
        }
        
        /* 12. 技能图标悬停效果优化 */
        .skill-source:hover {
            transform: scale(1.12) translateY(-3px);
            box-shadow: 0 6px 16px rgba(29, 69, 133, 0.35);
        }
        
        /* 13. 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(29, 69, 133, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(29, 69, 133, 0.5);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* 14. 状态栏优化 */
        #statusBar {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%);
            border: 1px solid #c2a05d;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4);
        }
        
        /* 15. 右键菜单优化 */
        .context-menu {
            border: 1px solid rgba(194, 160, 93, 0.2);
            box-shadow: 0 12px 32px rgba(0,0,0,0.12);
        }
        
        .context-menu-item:hover {
            background: rgba(29, 69, 133, 0.08);
        }
        
        [data-theme="dark"] .context-menu-item:hover {
            background: rgba(74, 122, 184, 0.15);
        }
        
        /* 16. 备注单元格优化 */
        .note-cell {
            background: transparent !important; /* 修复：改为透明，与表格背景一致，消除色差 */
            font-size: 12px;
        }
        
        /* 白色主题下偶数行的 note-cell 也要有斑马纹效果 */
        .guide-table tbody tr:nth-child(even):not(.add-phase-row) .note-cell {
            background-color: rgba(0,0,0,0.015) !important;
        }
        
        /* 修改：暗色模式下备注栏不设置独立背景，让它跟随行的斑马纹 */
        [data-theme="dark"] .note-cell {
            background: none !important;
            background-color: transparent !important;
            border-left: 1px solid rgba(255,255,255,0.05); /* 加一条极淡的分割线增加精致感 */
        }
        
        /* 确保暗色模式下偶数行的 note-cell 也有正确的背景 */
        [data-theme="dark"] .guide-table tbody tr:nth-child(even):not(.add-phase-row) .note-cell {
            background-color: rgba(0,0,0,0.15) !important;
        }
        
        /* 确保悬停时 note-cell 也能正确高亮 */
        .guide-table tbody tr:not(.add-phase-row):hover .note-cell {
            background: rgba(29, 69, 133, 0.04) !important;
        }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):hover .note-cell {
            background: rgba(74, 122, 184, 0.08) !important;
        }
        
        /* 17. 角色名称样式优化 */
        .char-name {
            font-weight: 500;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        /* 18. Wiki 按钮 GBF 风格 */
        .wiki-btn,
        .wiki-btn-small {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%) !important;
            border: 1px solid rgba(194, 160, 93, 0.5);
            position: relative;
        }
        
        .wiki-btn:hover,
        .wiki-btn-small:hover {
            background: linear-gradient(135deg, #2b5876 0%, #1d4585 100%) !important;
            box-shadow: 0 4px 16px rgba(29, 69, 133, 0.4) !important;
        }
        
        /* Wiki 按钮悬停提示 - 只给带 wiki-warning 类的按钮显示警告 */
        .wiki-btn.wiki-warning::after,
        .wiki-btn-small.wiki-warning::after {
            content: '⚠️ Wiki图片可能导致导出空白';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #ffcc00;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10002;
        }
        
        .wiki-btn.wiki-warning:hover::after,
        .wiki-btn-small.wiki-warning:hover::after {
            opacity: 1;
        }
        
        /* 19. 确认按钮保持绿色 */
        .btn-primary,
        .char-add-modal .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #43a047 100%) !important;
        }
        
        /* 20. 源单元格（召唤石/技能源）样式优化 - 分组着色 */
        /* 基础重置：去除旧的蓝色背景 */
        .source-cell {
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color) !important; /* 底部加粗线，区分正文 */
        }
        
        /* === Group 1: 召唤石区域 (A-D 列 / 前3个td，第1个有colspan=2) === */
        /* 跟随左侧基础表头颜色 */
        .skill-source-row .source-cell:nth-child(1),
        .skill-source-row .source-cell:nth-child(2),
        .skill-source-row .source-cell:nth-child(3) {
            background: var(--bg-header) !important;
        }
        
        /* === Group 2: 前排角色技能 (E-H 列 / 中间4个td) === */
        /* 跟随前排角色表头 (.character-header) */
        .skill-source-row .source-cell:nth-child(4),
        .skill-source-row .source-cell:nth-child(5),
        .skill-source-row .source-cell:nth-child(6),
        .skill-source-row .source-cell:nth-child(7) {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
        }
        
        /* === Group 3: 后排角色技能 (I-J 列) === */
        /* 跟随后排角色表头 (.character-header.back-row) */
        .skill-source-row .source-cell:nth-child(8),
        .skill-source-row .source-cell:nth-child(9) {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
        }
        
        /* [新增] === Group 4: 后排的后排技能 (K-M 列 / 9人模式) === */
        /* 与 Group 3 保持一致 */
        .skill-source-row .source-cell:nth-child(10),
        .skill-source-row .source-cell:nth-child(11),
        .skill-source-row .source-cell:nth-child(12) {
            background: linear-gradient(180deg, #f0f0f0 0%, #e5e5e5 100%) !important;
        }
        
        /* ====== 暗色模式 (Dark Mode) 适配 ====== */
        [data-theme="dark"] .source-cell {
            color: var(--text-on-dark);
        }
        
        /* Dark Group 1 */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(1),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(2),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(3) {
            background: var(--bg-header) !important;
        }
        
        /* Dark Group 2 - 深灰渐变 */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(4),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(5),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(6),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(7) {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
        }
        
        /* Dark Group 3 - 更深的灰渐变 */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(8),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(9) {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* [新增] Dark Group 4 - 与 Dark Group 3 保持一致 (9人模式) */
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(10),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(11),
        [data-theme="dark"] .skill-source-row .source-cell:nth-child(12) {
            background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%) !important;
        }
        
        /* ========== [重构] 换人行样式 (与顶部一致) ========== */
        /* 1. 换人行头部 (Header Row) */
        .swap-header-row td,
        .swap-header-row td.character-header,
        .swap-header-row td,
        .swap-header-row th {
            background: linear-gradient(180deg, #f8f9fa 0%, #eef1f5 100%) !important;
            border-top: 2px solid #c2a05d !important; /* 金色分割线 */
            border-bottom: 1px solid var(--border-color) !important;
            position: relative;
            padding: 8px 4px !important;
        }
        [data-theme="dark"] .swap-header-row td.character-header,
        [data-theme="dark"] .swap-header-row td,
        [data-theme="dark"] .swap-header-row th {
            background: linear-gradient(180deg, #2a2a2a 0%, #222 100%) !important;
            border-top-color: #8b7355 !important;
        }
        
        /* 2. 换人行左侧标签格 (A-D列) - 简约风格 */
        .swap-header-row .swap-label-cell {
            background: var(--bg-header) !important;
            color: var(--text-secondary);
            font-size: 12px;
            vertical-align: middle;
            text-align: center;
            border-right: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .swap-header-row .swap-label-cell {
            background: #252525 !important;
            color: #888;
        }
        
        /* 3. 换人行删除按钮 - 简洁圆形 */
        .swap-delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-top: 4px;
            background: transparent;
            color: #ff5252;
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s;
        }
        .swap-delete-btn:hover {
            background: #ff5252;
            color: white;
            transform: scale(1.1);
        }
        
        /* 4. 换人行角色格 */
        .swap-header-row .swap-char-cell {
            min-width: 110px;
            min-height: 180px;
            height: 180px;
            padding: 10px 4px 28px 4px !important;
            vertical-align: middle;
            position: relative;
        }
        .swap-header-row .swap-char-cell img {
            width: auto;
            height: auto;
            max-height: 130px;
            max-width: 100%;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }
        .swap-header-row .swap-char-cell .char-name {
            font-size: 12px;
            color: var(--text-primary);
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
        }
        
        /* 5. 换人行技能源 (Source Row) */
        .swap-source-row .source-cell {
            position: static !important;
            background-color: #fafafa !important;
            border-bottom: 2px solid var(--border-color) !important;
            box-shadow: none !important;
        }
        [data-theme="dark"] .swap-source-row .source-cell {
            background-color: #1e1e1e !important;
            border-bottom-color: #444 !important;
        }
        
        /* 6. 拖拽高亮 */
        .swap-source-row .source-cell.drag-feedback,
        .swap-header-row .swap-char-cell.drag-feedback {
            background-color: rgba(33, 150, 243, 0.15) !important;
            box-shadow: inset 0 0 0 2px #2196f3 !important;
            z-index: 10;
        }
        
        /* 导出图片时隐藏换人行的删除按钮 */
        .exporting .swap-delete-btn {
            display: none !important;
        }

        /* ========== 优化: 拖拽反馈与空槽位质感 ========== */
        /* 1. 拖拽时的动态高亮反馈 (Active Drop Zone) */
        .drag-feedback {
            background-color: rgba(33, 150, 243, 0.15) !important;
            box-shadow: inset 0 0 0 2px #2196f3 !important;
            transition: all 0.1s;
        }
        
        /* 2. 空槽位的"容器凹陷"质感 */
        /* [修改] 增加选择器权重，确保空状态图标能显示在后排背景之上 */
        .character-header.has-empty-state,
        .character-header.back-row.has-empty-state,
        .character-header.back-row-2.has-empty-state,
        .source-cell.has-empty-state {
            background: rgba(0, 0, 0, 0.03) !important;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.06);
            border-radius: 8px;
        }
        
        /* 暗色模式下的凹陷质感适配 */
        [data-theme="dark"] .character-header.has-empty-state,
        [data-theme="dark"] .character-header.back-row.has-empty-state,
        [data-theme="dark"] .character-header.back-row-2.has-empty-state,
        [data-theme="dark"] .source-cell.has-empty-state {
            background: rgba(0, 0, 0, 0.25) !important;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* ========== 👻 幽灵图标系统：I列行控面板 (Ghost Icon) ========== */
        
        /* 1. 面板容器：居中定位，始终可见但透明度渐变 */
        .note-cell { position: relative; }
        .note-cell-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 0;
            z-index: 100;
            /* 👻 幽灵模式：默认极淡，始终存在 */
            opacity: 0.12;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            /* 胶囊背景 - 默认也是半透明 */
            background: rgba(255, 255, 255, 0.6);
            padding: 4px;
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.03);
            pointer-events: auto; /* 始终可点击 */
        }

        /* 2. 行悬停：整行悬停时按钮变明显 */
        .guide-table tbody tr:not(.add-phase-row):not(.swap-header-row):not(.swap-data-row):hover .note-cell-controls {
            opacity: 0.55;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* 3. 单元格悬停：进一步增强 */
        .note-cell:hover .note-cell-controls {
            opacity: 0.75;
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translate(-50%, -50%) scale(1.08);
        }

        /* 4. 按钮样式：使用 SVG 图标 */
        .row-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: #555;
            padding: 6px;
            position: relative;
        }

        .row-action-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
            display: block;
        }

        /* 5. 按钮悬停：完全高亮 + 发光效果 */
        .row-action-btn:hover {
            background: rgba(0,0,0,0.08);
            transform: scale(1.15);
        }
        
        /* 当按钮被悬停时，强制面板完全显示 */
        .note-cell-controls:hover {
            opacity: 1 !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
            transform: translate(-50%, -50%) scale(1.1) !important;
        }

        /* 颜色区分 */
        .row-action-btn.merge { color: #4caf50; }
        .row-action-btn.split { color: #ff9800; }
        
        /* 按钮悬停时的发光效果 */
        .row-action-btn.merge:hover { 
            color: #2e7d32;
            box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
        }
        .row-action-btn.split:hover { 
            color: #e65100;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.4);
        }

        /* 文字提示 Tooltip */
        .row-action-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 8px;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* ========== 暗色模式适配 ========== */
        [data-theme="dark"] .note-cell-controls { 
            background: rgba(50, 50, 50, 0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            opacity: 0.15; /* 暗色模式稍微亮一点 */
        }
        [data-theme="dark"] .guide-table tbody tr:not(.add-phase-row):not(.swap-header-row):not(.swap-data-row):hover .note-cell-controls {
            opacity: 0.6;
            background: rgba(60, 60, 60, 0.9);
        }
        [data-theme="dark"] .note-cell:hover .note-cell-controls {
            opacity: 0.8;
            background: rgba(70, 70, 70, 0.95);
        }
        [data-theme="dark"] .note-cell-controls:hover {
            opacity: 1 !important;
            background: rgba(80, 80, 80, 0.98) !important;
        }
        [data-theme="dark"] .row-action-btn { color: #aaa; }
        [data-theme="dark"] .row-action-btn:hover { background: rgba(255,255,255,0.1); }
        [data-theme="dark"] .row-action-btn.merge { color: #81c784; }
        [data-theme="dark"] .row-action-btn.split { color: #ffb74d; }
        [data-theme="dark"] .row-action-btn.merge:hover { 
            color: #a5d6a7;
            box-shadow: 0 0 12px rgba(129, 199, 132, 0.4);
        }
        [data-theme="dark"] .row-action-btn.split:hover { 
            color: #ffcc80;
            box-shadow: 0 0 12px rgba(255, 183, 77, 0.4);
        }

        /* ========== 🚀 新版悬浮控制台 (Toolbar Refactoring) ========== */
        .toolbar-console {
            position: sticky;
            top: 15px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            margin: 0 auto 25px;
            max-width: 1800px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        [data-theme="dark"] .toolbar-console {
            background: rgba(30, 32, 38, 0.85);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 右侧工具组 - 自动靠右 */
        .toolbar-group-end {
            margin-left: auto;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.1), transparent);
            margin: 0 12px;
        }
        [data-theme="dark"] .toolbar-divider {
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2), transparent);
        }

        .t-btn {
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-family: inherit;
            position: relative;
            outline: none;
        }
        .t-btn:active { transform: scale(0.96); }

        .t-btn-icon {
            width: 36px;
            height: 36px;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
        }
        .t-btn-icon:hover {
            background: rgba(0,0,0,0.05);
            color: #2196f3;
        }
        [data-theme="dark"] .t-btn-icon:hover { background: rgba(255,255,255,0.1); }

        .t-btn-ghost {
            background: transparent;
            border: 1px solid rgba(0,0,0,0.1);
            color: var(--text-secondary);
            padding: 6px 14px;
            font-size: 13px;
            gap: 6px;
        }
        .t-btn-ghost:hover {
            border-color: #2196f3;
            color: #2196f3;
            background: rgba(33, 150, 243, 0.05);
        }
        [data-theme="dark"] .t-btn-ghost { border-color: rgba(255,255,255,0.2); }
        [data-theme="dark"] .t-btn-ghost:hover { border-color: #64b5f6; color: #64b5f6; }

        .t-btn-primary {
            background: linear-gradient(135deg, #1d4585 0%, #2b5876 100%);
            color: white;
            padding: 8px 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(43, 88, 118, 0.3);
            gap: 8px;
        }
        .t-btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(43, 88, 118, 0.4);
        }

        .toolbar-input-group {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
            padding: 2px 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .toolbar-input-group { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .mini-label { font-size: 11px; color: var(--text-coord); margin-right: 4px; }
        .t-input {
            width: 36px;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 13px;
            padding: 4px 0;
        }
        .t-input:focus { outline: none; color: #2196f3; }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            text-align: center;
            pointer-events: none;
            animation: fadeInTooltip 0.2s;
            z-index: 1001;
        }
        @keyframes fadeInTooltip { from { opacity: 0; transform: translate(-50%, 5px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* ========== 素材网站下拉菜单 (Resource Dropdown) ========== */
        .resource-dropdown {
            position: relative;
            display: inline-block;
        }
        .resource-dropdown .t-btn .arrow {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.6;
            transition: transform 0.2s;
        }
        .resource-dropdown.active .t-btn .arrow {
            transform: rotate(180deg);
        }
        .resource-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;
            padding: 8px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1002;
        }
        .resource-dropdown:hover .resource-dropdown-menu,
        .resource-dropdown.active .resource-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        [data-theme="dark"] .resource-dropdown-menu {
            background: rgba(30, 32, 38, 0.95);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .resource-dropdown-item {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-primary);
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .resource-dropdown-item:hover {
            background: rgba(var(--beam-skill-color), 0.08);
            border-left-color: rgb(var(--beam-skill-color));
        }
        .resource-dropdown-item .item-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .resource-dropdown-item .item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }
        .resource-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 12px;
            opacity: 0.5;
        }
        /* 警告项样式 (灰机Wiki) */
        .resource-dropdown-item.warning-item .item-title {
            color: #ff9800;
        }
        .resource-dropdown-item.warning-item .item-desc {
            color: #ef5350;
        }
        .resource-dropdown-item.warning-item:hover {
            background: rgba(255, 152, 0, 0.08);
            border-left-color: #ff9800;
        }
        .warn-badge {
            font-size: 12px;
        }
        /* 推荐标签 */
        .recommend-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(var(--beam-summon-color), 0.15);
            color: rgb(var(--beam-summon-color));
            border-radius: 4px;
            font-weight: 500;
        }

        /* ========== 角色卡片 UI 升级 (Character Card Upgrade) ========== */
        /* 1. 卡片容器：增加溢出隐藏，为了图片的放大效果不超出去 */
        .character-header {
            position: relative;
            overflow: hidden; /* 关键：限制内部元素溢出 */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 2. 图片交互：悬停时轻微放大 + 稍微变暗 (提升文字可读性) */
        .character-header img {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s;
            transform-origin: center center;
        }
        .character-header:hover img {
            transform: scale(1.08); /* 悬停放大 */
            filter: brightness(0.9); /* 稍微变暗 */
        }

        /* 3. 新版编辑按钮：毛玻璃圆形按钮 */
        .btn-edit-glass {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* 玻璃质感 */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            /* 布局 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1d4585; /* GBF 深蓝 */
            cursor: pointer;
            z-index: 20;
            /* 默认隐藏状态：上移 + 透明 */
            opacity: 0;
            transform: translateY(-10px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* 弹性动画 */
        }

        /* 悬停卡片时：按钮浮现 */
        .character-header:hover .btn-edit-glass {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* 按钮自身悬停：变大变蓝 */
        .btn-edit-glass:hover {
            background: #fff;
            color: #2196f3;
            transform: translateY(0) scale(1.15) !important;
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3);
        }

        /* 点击反馈 */
        .btn-edit-glass:active {
            transform: translateY(0) scale(0.95) !important;
        }

        /* 暗色模式适配 */
        [data-theme="dark"] .btn-edit-glass {
            background: rgba(40, 40, 40, 0.85);
            border-color: rgba(255,255,255,0.1);
            color: #90caf9;
        }
        [data-theme="dark"] .btn-edit-glass:hover {
            background: #333;
            color: #fff;
        }

        /* ========== BOSS选择弹窗样式 (现代 WebApp 风格) ========== */
        .boss-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* 现代毛玻璃遮罩 */
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10000;
            /* 默认隐藏状态 */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            /* 柔和的过渡效果 */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* 激活状态 */
        .boss-select-modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .boss-select-content {
            background: var(--bg-modal);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            /* 更加柔和深邃的阴影 */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* 初始缩放状态 */
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        /* 内容激活状态 */
        .boss-select-modal.active .boss-select-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .boss-select-title {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .boss-select-hint {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .boss-select-grid {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        .boss-option {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            border-radius: 16px;
            padding: 12px;
        }
        .boss-option:hover {
            background: rgba(33, 150, 243, 0.05);
            transform: translateY(-6px);
        }
        .boss-option:active {
            transform: scale(0.97);
        }
        .boss-img-wrapper {
            width: 240px;
            height: 150px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-table);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        /* 9人模式 (极妈/Versusia) - 猩红光晕 */
        .boss-option.option-9man:hover .boss-img-wrapper {
            border-color: #ff5252;
            box-shadow: 0 12px 30px rgba(255, 82, 82, 0.35);
            transform: scale(1.02);
        }
        /* 6人模式 (极法/Lucilius) - 湛蓝光晕 */
        .boss-option.option-6man:hover .boss-img-wrapper {
            border-color: #2196f3;
            box-shadow: 0 12px 30px rgba(33, 150, 243, 0.35);
            transform: scale(1.02);
        }
        .boss-img-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .boss-option-label {
            margin-top: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .boss-select-cancel {
            display: block;
            margin: 24px auto 0;
            padding: 10px 32px;
            background: #616161;
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .boss-select-cancel:hover {
            background: #757575;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="statusBar">拖拽中...松开放置</div>
    <div id="floatingIcon"></div>
    <div class="toolbar-console">
        <div class="toolbar-group">
            <button class="t-btn t-btn-icon" onclick="toggleTheme()" data-tooltip="切换深色/浅色模式">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button class="t-btn t-btn-icon" id="btnCoordToggle" onclick="toggleCoords()" data-tooltip="显示/隐藏坐标">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
            </button>
            <div class="toolbar-divider"></div>
            <div class="toolbar-input-group" data-tooltip="默认字号 (px)">
                <span class="mini-label">Aa</span>
                <input type="number" id="defaultFontSize" class="t-input" value="11" min="10" max="24" onchange="saveDefaultFontSize()">
            </div>
            <div class="toolbar-input-group" data-tooltip="图标缩放 (10=100%)">
                <span class="mini-label">🔍</span>
                <input type="number" id="iconScale" class="t-input" value="10" min="5" max="20" onchange="saveIconScale()">
            </div>
        </div>
        <div class="toolbar-group">
            <!-- BOSS模板选择按钮 -->
            <button class="t-btn t-btn-ghost" onclick="showBossSelectModal()" data-tooltip="切换副本模式 (9人/6人)">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg>BOSS模板
            </button>
            <button class="t-btn t-btn-ghost" id="btnAddSwapRow" onclick="insertSwapRow()" data-tooltip="在底部增加换人行">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>增加换人行
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" id="btnReset" onclick="resetData()" data-tooltip="重置为当前模式默认状态">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 2v6h6M21.5 22v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.3"/></svg>重置
            </button>
            <button class="t-btn t-btn-ghost" onclick="clearAll()" data-tooltip="清空所有已放置的技能图标">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>清空技能
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" onclick="loadConfig()" data-tooltip="加载保存布局">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>加载配置
            </button>
            <button class="t-btn t-btn-ghost" onclick="saveAsDefault()" data-tooltip="保存当前布局">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>保存配置
            </button>
            <div class="toolbar-divider"></div>
            <button class="t-btn t-btn-ghost" onclick="exportJSON()" data-tooltip="导出配置 JSON">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>导出
            </button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
            <button class="t-btn t-btn-ghost" onclick="document.getElementById('importFile').click()" data-tooltip="导入配置 JSON">
                <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>导入
            </button>
        </div>
        <div class="toolbar-group toolbar-group-end">
            <!-- 素材网站下拉菜单 -->
            <div class="resource-dropdown" id="resourceDropdown">
                <button class="t-btn t-btn-ghost" onclick="toggleResourceDropdown(event)">
                    <svg style="margin-right:4px" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><line x1="12" y1="6" x2="12" y2="10"></line><line x1="12" y1="14" x2="12.01" y2="14"></line></svg>
                    素材网站
                    <span class="arrow">▼</span>
                </button>
                <div class="resource-dropdown-menu">
                    <a href="https://gbf.wiki/" target="_blank" class="resource-dropdown-item">
                        <div class="item-title">
                            GBF Wiki (English)
                            <span class="recommend-badge">推荐</span>
                        </div>
                        <div class="item-desc">✅ 图片可直接导出，资料全面</div>
                    </a>
                    <a href="https://mizagbf.github.io/GBFAL/" target="_blank" class="resource-dropdown-item">
                        <div class="item-title">
                            GBFAL (Asset Library)
                            <span class="recommend-badge">推荐</span>
                        </div>
                        <div class="item-desc">✅ 纯净素材库，支持搜索下载</div>
                    </a>
                    <div class="resource-dropdown-divider"></div>
                    <a href="https://gbf.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5" target="_blank" class="resource-dropdown-item warning-item">
                        <div class="item-title">
                            灰机 Wiki (中文)
                            <span class="warn-badge">⚠️</span>
                        </div>
                        <div class="item-desc">❌ 跨域限制，图片无法直接导出<br>请先保存图片再上传使用</div>
                    </a>
                </div>
            </div>
            <button class="t-btn t-btn-primary" onclick="exportAsImage()" data-tooltip="⚠️ Wiki/外网图片可能导出空白，建议截图">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                导出图片
            </button>
            <!-- 创作者徽章 -->
            <div class="author-badge" id="authorBadge" onclick="openAuthorModal()" data-tooltip="点击编辑创作者信息">
                <span class="author-icon">✎</span>
                <span id="currentAuthorDisplay">访客</span>
            </div>
        </div>
    </div>
    
    <!-- 创作者弹窗 -->
    <div id="authorModal" class="author-modal-overlay" onclick="closeAuthorModal(event)">
        <div class="author-card" onclick="event.stopPropagation()">
            <div class="author-card-header">
                <h3>📝 创作者信息</h3>
                <button class="close-btn" onclick="closeAuthorModal(null)">×</button>
            </div>
            <div class="author-history-section">
                <p class="section-label">历史贡献者</p>
                <div id="authorHistoryList" class="history-list">
                    <div class="empty-history">暂无历史编辑记录</div>
                </div>
            </div>
            <div class="current-author-section">
                <p class="section-label">当前编辑者</p>
                <div class="author-input-wrapper">
                    <input type="text" id="authorInput" placeholder="请输入您的昵称" maxlength="20" oninput="updateCurrentAuthor(this.value)">
                </div>
                <p class="input-hint">您的署名将在导出时自动记录到历史列表中。</p>
            </div>
        </div>
    </div>
    <div class="table-wrapper">
    <table class="guide-table" id="guideTable">
        <thead>
            <tr class="top-row has-fab"><th colspan="10" style="padding:10px;position:relative;"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" style="max-width:100%;height:auto;"><button class="mini-fab edit" onclick="showQuickAddBoss(this)" title="编辑BOSS图">✎</button></th></tr>
            <tr class="top-row has-fab"><th colspan="10" style="padding:8px;position:relative;"><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_3245.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://huiji-thumb.huijistatic.com/gbf/uploads/thumb/e/e4/Status_3246.png/33px-Status_3246.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_1.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_2.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_3.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_4.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_5.png" style="width:33px;height:33px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_7790_6.png" style="width:33px;height:33px;"></span><button class="mini-fab edit" onclick="showQuickAddStatus(this)" title="编辑状态图标">✎</button></th></tr>
            <tr>
                <th style="vertical-align:middle;"><span class="coord-header">(0,A)</span><br><span class="header-text t-text" contenteditable="true" onblur="saveToStorage()">阶段/HP</span></th>
                <th style="vertical-align:middle;"><span class="coord-header">(0,B)</span><br><span class="header-text t-text" contenteditable="true" onblur="saveToStorage()">回合/特动</span></th>
                <th style="vertical-align:middle;"><span class="coord-header">(0,C)</span><br><span class="header-text t-text" contenteditable="true" onblur="saveToStorage()">备注</span></th>
                <th style="vertical-align:middle;"><span class="coord-header">(0,D)</span><br><span class="header-text t-text" contenteditable="true" onblur="saveToStorage()">召唤石</span></th>
                <th class="character-header has-fab"><span class="coord-header">(0,E)</span><br><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/leader/raid_normal/270301_mc_1_01.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">主角</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
                <th class="character-header has-fab"><span class="coord-header">(0,F)</span><br><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/npc/raid_normal/3710217000_01.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">光龙</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
                <th class="character-header has-fab"><span class="coord-header">(0,G)</span><br><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/npc/raid_normal/3040497000_02.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">奶嘴</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
                <th class="character-header has-fab"><span class="coord-header">(0,H)</span><br><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/npc/f/3040291000_91.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">银姐</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
                <th class="character-header back-row has-fab"><span class="coord-header">(0,I)</span><br><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/npc/raid_normal/3040630000_02.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">后排 药师</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
                <th class="character-header back-row has-fab"><span class="coord-header">(0,J)</span><br><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/assets/npc/f/3040165000_03.jpg"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">后排 塔</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest('.character-header'))" title="编辑角色"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div></th>
            </tr>
            <tr class="skill-source-row">
                <td colspan="2" class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,A-B)</span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040084000_04.jpg"></span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040425000.jpg"></span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040433000.jpg"></span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040203000.jpg"></span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040408000.jpg"></span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest('.source-cell'))" title="编辑召唤石">✎</button></td>
                <td class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,C)</span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040065000_02.jpg"></span><span class="skill-box summon-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/assets/summon/s/2040448000.jpg"></span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest('.source-cell'))" title="编辑召唤石">✎</button></td>
                <td class="source-cell" style="vertical-align:middle;"><span class="coord">(1,D)</span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png"></span></td>
                <td class="source-cell"><span class="coord">(1,E)</span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2516_3.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/1031_3.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2184_1.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/1034_1.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/26_2.png"></span>
                </td>
                <td class="source-cell"><span class="coord">(1,F)</span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2575_1.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2576_3.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2577_2.png"></span>
                </td>
                <td class="source-cell"><span class="coord">(1,G)</span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2215_4.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2216_4.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2217_3.png"></span>
                </td>
                <td class="source-cell"><span class="coord">(1,H)</span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/1252_3.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/1253_4.png"></span>
                    <span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/714_3.png"></span>
                </td>
                <td class="source-cell"><span class="coord">(1,I)</span><span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2779_1.png" style="width:40px;height:40px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2780_3.png" style="width:40px;height:40px;"></span><span class="skill-box skill-source"><img src="https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2781_3.png" style="width:40px;height:40px;"></span></td>
                <td class="source-cell"><span class="coord">(1,J)</span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span></td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td rowspan="5"><span class="coord">(2-6,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">100%-80%</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td>
                <td><span class="coord">(2,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">1T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
                <td class="data-cell"><span class="coord">(2,C)</span></td>
                <td><span class="coord">(2,D)</span></td>
                <td class="data-cell"><span class="coord">(2,E)</span></td>
                <td class="data-cell"><span class="coord">(2,F)</span></td>
                <td class="data-cell"><span class="coord">(2,G)</span></td>
                <td class="data-cell"><span class="coord">(2,H)</span></td>
                <td class="note-cell"><span class="coord">(2,I)</span></td>
                <td class="note-cell"><span class="coord">(2,J)</span></td>
            </tr>
            <tr>
                <td><span class="coord">(3,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">2T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
                <td class="data-cell"><span class="coord">(3,C)</span></td>
                <td><span class="coord">(3,D)</span></td>
                <td class="data-cell"><span class="coord">(3,E)</span></td>
                <td class="data-cell"><span class="coord">(3,F)</span></td>
                <td class="data-cell"><span class="coord">(3,G)</span></td>
                <td class="data-cell"><span class="coord">(3,H)</span></td>
                <td class="note-cell"><span class="coord">(3,I)</span></td>
                <td class="note-cell"><span class="coord">(3,J)</span></td>
            </tr>
            <tr>
                <td><span class="coord">(4,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">3T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
                <td class="data-cell"><span class="coord">(4,C)</span></td>
                <td><span class="coord">(4,D)</span></td>
                <td class="data-cell"><span class="coord">(4,E)</span></td>
                <td class="data-cell"><span class="coord">(4,F)</span></td>
                <td class="data-cell"><span class="coord">(4,G)</span></td>
                <td class="data-cell"><span class="coord">(4,H)</span></td>
                <td class="note-cell"><span class="coord">(4,I)</span></td>
                <td class="note-cell"><span class="coord">(4,J)</span></td>
            </tr>
            <tr>
                <td><span class="coord">(5,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">换人</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
                <td class="data-cell"><span class="coord">(5,C)</span></td>
                <td><span class="coord">(5,D)</span></td>
                <td class="data-cell"><span class="coord">(5,E)</span></td>
                <td class="data-cell"><span class="coord">(5,F)</span></td>
                <td class="data-cell"><span class="coord">(5,G)</span></td>
                <td class="data-cell"><span class="coord">(5,H)</span></td>
                <td class="note-cell"><span class="coord">(5,I)</span></td>
                <td class="note-cell"><span class="coord">(5,J)</span></td>
            </tr>
            <tr>
                <td><span class="coord">(6,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">4T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>
                <td class="data-cell"><span class="coord">(6,C)</span></td>
                <td><span class="coord">(6,D)</span></td>
                <td class="data-cell"><span class="coord">(6,E)</span></td>
                <td class="data-cell"><span class="coord">(6,F)</span></td>
                <td class="data-cell"><span class="coord">(6,G)</span></td>
                <td class="data-cell"><span class="coord">(6,H)</span></td>
                <td class="note-cell"><span class="coord">(6,I)</span></td>
                <td class="note-cell"><span class="coord">(6,J)</span></td>
            </tr>
            <tr class="phase-80-60">
                <td rowspan="3"><span class="coord">(7-9,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">80%-60%</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td>
                <td><span class="coord">(7,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">阶段说明</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(7,C)</span></td><td><span class="coord">(7,D)</span></td><td class="data-cell"><span class="coord">(7,E)</span></td><td class="data-cell"><span class="coord">(7,F)</span></td><td class="data-cell"><span class="coord">(7,G)</span></td><td class="data-cell"><span class="coord">(7,H)</span></td><td class="note-cell"><span class="coord">(7,I)</span></td><td class="note-cell"><span class="coord">(7,J)</span></td>
            </tr>
            <tr><td><span class="coord">(8,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">满豆</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(8,C)</span></td><td><span class="coord">(8,D)</span></td><td class="data-cell"><span class="coord">(8,E)</span></td><td class="data-cell"><span class="coord">(8,F)</span></td><td class="data-cell"><span class="coord">(8,G)</span></td><td class="data-cell"><span class="coord">(8,H)</span></td><td class="note-cell"><span class="coord">(8,I)</span></td><td class="note-cell"><span class="coord">(8,J)</span></td></tr>
            <tr><td><span class="coord">(9,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">75%</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(9,C)</span></td><td><span class="coord">(9,D)</span></td><td class="data-cell"><span class="coord">(9,E)</span></td><td class="data-cell"><span class="coord">(9,F)</span></td><td class="data-cell"><span class="coord">(9,G)</span></td><td class="data-cell"><span class="coord">(9,H)</span></td><td class="note-cell"><span class="coord">(9,I)</span></td><td class="note-cell"><span class="coord">(9,J)</span></td></tr>
            <tr class="phase-60-20">
                <td rowspan="3"><span class="coord">(10-12,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">60%-20%</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td>
                <td><span class="coord">(10,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">阶段说明</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(10,C)</span></td><td><span class="coord">(10,D)</span></td><td class="data-cell"><span class="coord">(10,E)</span></td><td class="data-cell"><span class="coord">(10,F)</span></td><td class="data-cell"><span class="coord">(10,G)</span></td><td class="data-cell"><span class="coord">(10,H)</span></td><td class="note-cell"><span class="coord">(10,I)</span></td><td class="note-cell"><span class="coord">(10,J)</span></td>
            </tr>
            <tr><td><span class="coord">(11,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">试炼</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(11,C)</span></td><td><span class="coord">(11,D)</span></td><td class="data-cell"><span class="coord">(11,E)</span></td><td class="data-cell"><span class="coord">(11,F)</span></td><td class="data-cell"><span class="coord">(11,G)</span></td><td class="data-cell"><span class="coord">(11,H)</span></td><td class="note-cell"><span class="coord">(11,I)</span></td><td class="note-cell"><span class="coord">(11,J)</span></td></tr>
            <tr><td><span class="coord">(12,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">50%</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(12,C)</span></td><td><span class="coord">(12,D)</span></td><td class="data-cell"><span class="coord">(12,E)</span></td><td class="data-cell"><span class="coord">(12,F)</span></td><td class="data-cell"><span class="coord">(12,G)</span></td><td class="data-cell"><span class="coord">(12,H)</span></td><td class="note-cell"><span class="coord">(12,I)</span></td><td class="note-cell"><span class="coord">(12,J)</span></td></tr>
            <tr class="phase-20-0">
                <td rowspan="2"><span class="coord">(13-14,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">20%-0%</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td>
                <td><span class="coord">(13,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">收尾</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(13,C)</span></td><td><span class="coord">(13,D)</span></td><td class="data-cell"><span class="coord">(13,E)</span></td><td class="data-cell"><span class="coord">(13,F)</span></td><td class="data-cell"><span class="coord">(13,G)</span></td><td class="data-cell"><span class="coord">(13,H)</span></td><td class="note-cell"><span class="coord">(13,I)</span></td><td class="note-cell"><span class="coord">(13,J)</span></td>
            </tr>
            <tr><td><span class="coord">(14,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">击杀</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(14,C)</span></td><td><span class="coord">(14,D)</span></td><td class="data-cell"><span class="coord">(14,E)</span></td><td class="data-cell"><span class="coord">(14,F)</span></td><td class="data-cell"><span class="coord">(14,G)</span></td><td class="data-cell"><span class="coord">(14,H)</span></td><td class="note-cell"><span class="coord">(14,I)</span></td><td class="note-cell"><span class="coord">(14,J)</span></td></tr>
        </tbody>
    </table>
    </div><!-- .table-wrapper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script>
        var STORAGE_KEY='gbf_guide_data';
        var THEME_KEY='gbf_guide_theme';
        var AUTHOR_KEY='gbf_guide_author'; // 创作者昵称存储键
        var draggedElement=null;
        var floatingIcon=document.getElementById('floatingIcon');
        var statusBar=document.getElementById('statusBar');
        var selectedCells=[]; // 保留变量定义以防其他代码引用
        
        // [P4-34] 空图片占位符常量 - 移至全局作用域顶部
        var EMPTY_IMAGE_SRC = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
        
        // ========== 创作者系统 (Author System) ==========
        var AuthorSystem = {
            currentAuthor: '访客',
            history: [] // 存储之前的作者名 ["UserA", "UserB"]
        };
        
        // ========== [全局配置] 角色和召唤石配置（移至全局作用域）==========
        var characterConfigs = [
            { coord: '(0,E)', name: '主角', skillCoord: 'E' },
            { coord: '(0,F)', name: '2号位', skillCoord: 'F' },
            { coord: '(0,G)', name: '3号位', skillCoord: 'G' },
            { coord: '(0,H)', name: '4号位', skillCoord: 'H' },
            { coord: '(0,I)', name: '后排1', skillCoord: 'I' },
            { coord: '(0,J)', name: '后排2', skillCoord: 'J' },
            { coord: '(0,K)', name: '后排3', skillCoord: 'K' },
            { coord: '(0,L)', name: '后排4', skillCoord: 'L' },
            { coord: '(0,M)', name: '后排5', skillCoord: 'M' }
        ];
        
        var summonConfigs = [
            { coord: 'A-B', fullCoord: '(1,A-B)', name: '主召唤石', maxCount: 6, showButton: true },
            { coord: 'C', fullCoord: '(1,C)', name: '副召唤石', maxCount: 3, showButton: false }
        ];
        
        // ========== 创作者系统函数 ==========
        
        // 打开创作者弹窗
        function openAuthorModal() {
            var modal = document.getElementById('authorModal');
            modal.classList.add('active');
            // 填充输入框
            document.getElementById('authorInput').value = AuthorSystem.currentAuthor === '访客' ? '' : AuthorSystem.currentAuthor;
            // 渲染历史记录
            renderAuthorHistory();
        }
        
        // 关闭创作者弹窗
        function closeAuthorModal(e) {
            if (!e || e.target.id === 'authorModal') {
                document.getElementById('authorModal').classList.remove('active');
            }
        }
        
        // 实时更新当前作者名
        function updateCurrentAuthor(name) {
            var safeName = name.trim() || '访客';
            AuthorSystem.currentAuthor = safeName;
            // 更新徽章显示
            document.getElementById('currentAuthorDisplay').textContent = safeName;
            // 保存到 localStorage
            localStorage.setItem(AUTHOR_KEY, safeName);
            // 更新呼吸灯状态
            updateBadgePulse();
        }
        
        // 更新徽章呼吸灯状态
        function updateBadgePulse() {
            var badge = document.getElementById('authorBadge');
            if (!badge) return;
            if (AuthorSystem.currentAuthor === '访客') {
                badge.classList.add('pulse');
            } else {
                badge.classList.remove('pulse');
            }
        }
        
        // ========== 素材网站下拉菜单控制 ==========
        function toggleResourceDropdown(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('resourceDropdown');
            dropdown.classList.toggle('active');
        }
        
        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(e) {
            var dropdown = document.getElementById('resourceDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // 渲染历史贡献者列表
        function renderAuthorHistory() {
            var listEl = document.getElementById('authorHistoryList');
            listEl.innerHTML = '';
            
            if (AuthorSystem.history.length === 0) {
                listEl.innerHTML = '<div class="empty-history">暂无历史编辑记录</div>';
                return;
            }
            
            // 去重并显示
            var uniqueAuthors = [...new Set(AuthorSystem.history)];
            uniqueAuthors.forEach(function(name) {
                var tag = document.createElement('span');
                tag.className = 'history-tag';
                tag.textContent = name;
                listEl.appendChild(tag);
            });
        }
        
        // 初始化创作者系统（从 localStorage 恢复）
        function initAuthorSystem() {
            var savedAuthor = localStorage.getItem(AUTHOR_KEY);
            // 兼容旧版本的 Guest
            if (savedAuthor && savedAuthor !== '访客' && savedAuthor !== 'Guest') {
                AuthorSystem.currentAuthor = savedAuthor;
                document.getElementById('currentAuthorDisplay').textContent = savedAuthor;
            }
            // 初始化呼吸灯状态
            updateBadgePulse();
        }
        
        // ========== 通用工具函数 ==========
        
        /**
         * 🌌 智能高亮系统 - 根据源技能坐标高亮对应列
         * @param {HTMLElement} element - 拖拽的源技能元素
         * @param {boolean} activate - true=激活高亮, false=移除高亮
         */
        function smartColumnHighlight(element, activate) {
            var table = document.querySelector('.guide-table');
            if (!table) return;
            
            // 移除所有高亮类
            var highlightClasses = ['highlight-col-D', 'highlight-col-E', 'highlight-col-F', 
                'highlight-col-G', 'highlight-col-H', 'highlight-col-I', 'highlight-col-J',
                'highlight-col-K', 'highlight-col-L', 'highlight-col-M', 'highlight-col-N'];
            highlightClasses.forEach(function(cls) {
                table.classList.remove(cls);
            });
            
            if (!activate) return;
            
            // 获取源技能所在单元格的坐标
            var parentCell = element.closest('td');
            if (!parentCell) return;
            
            var coordEl = parentCell.querySelector('.coord');
            if (!coordEl) return;
            
            var coordText = coordEl.textContent; // 例如 "(1,E)" 或 "(1,A-B)"
            var match = coordText.match(/\([\d]+,([A-Z\-]+)\)/);
            if (!match) return;
            
            var sourceCol = match[1]; // 例如 "E", "A-B", "C"
            
            // 根据源列确定目标高亮列
            var targetCol = '';
            if (sourceCol === 'A-B' || sourceCol === 'C' || sourceCol === 'D') {
                // 召唤石区域 -> 高亮 D 列
                targetCol = 'D';
            } else if (['E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'].includes(sourceCol)) {
                // 技能区域 -> 高亮对应列
                targetCol = sourceCol;
            }
            
            if (targetCol) {
                table.classList.add('highlight-col-' + targetCol);
            }
        }
        
        /**
         * 🏷️ 为所有单元格添加 data-col 属性
         * 用于智能高亮系统的 CSS 选择器
         */
        function initColumnDataAttributes() {
            // 处理 thead 中的 th
            document.querySelectorAll('thead th').forEach(function(th) {
                var coordEl = th.querySelector('.coord-header');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\([\d]+,([A-Z\-]+)\)/);
                    if (match) {
                        th.setAttribute('data-col', match[1]);
                    }
                }
            });
            
            // 处理 tbody 中的 td
            document.querySelectorAll('tbody td').forEach(function(td) {
                var coordEl = td.querySelector('.coord');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\([\d]+(?:-\d+)?,([A-Z\-]+)\)/);
                    if (match) {
                        td.setAttribute('data-col', match[1]);
                    }
                }
            });
        }
        
        /**
         * 绑定拖拽事件到元素
         * @param {HTMLElement} element - 要绑定拖拽的元素
         * @param {number} dragImageSize - 拖拽图像大小，默认20
         */
        function bindDragEvents(element, dragImageSize) {
            dragImageSize = dragImageSize || 20;
            element.setAttribute('draggable', 'true');
            
            // 检查是否是源技能行的元素（只有源技能行才触发高亮）
            function isFromSourceRow(el) {
                var sourceRow = el.closest('.skill-source-row');
                // 必须在源技能行内，且不是换人行的源技能
                return sourceRow && !sourceRow.classList.contains('swap-source-row');
            }
            
            // 第二层：悬停高亮 - 只有源技能行的元素才触发
            element.addEventListener('mouseenter', function() {
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, true);
                }
            });
            element.addEventListener('mouseleave', function() {
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, false);
                }
            });
            
            element.addEventListener('dragstart', function(e) {
                draggedElement = this;
                e.dataTransfer.effectAllowed = 'copy';
                var img = this.querySelector('img');
                if (img) e.dataTransfer.setDragImage(img, dragImageSize, dragImageSize);
                statusBar.textContent = '拖拽中...松开放置';
                statusBar.style.display = 'block';
                // 只有源技能行才触发高亮
                if (isFromSourceRow(this)) {
                    smartColumnHighlight(this, true);
                }
            });
            element.addEventListener('dragend', function() {
                draggedElement = null;
                statusBar.style.display = 'none';
                // 移除高亮（无论是否是源技能行都要清理）
                smartColumnHighlight(this, false);
            });
        }
        
        /**
         * 绑定剪贴板粘贴按钮事件
         * @param {HTMLElement} btn - 粘贴按钮元素
         */
        function bindPasteButton(btn) {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                var inputElement = this.previousElementSibling;
                try {
                    var text = await navigator.clipboard.readText();
                    inputElement.value = text;
                    inputElement.dispatchEvent(new Event('input'));
                } catch (err) {
                    alert('无法访问剪贴板，请手动粘贴（Ctrl+V）');
                }
            });
        }
        
        /**
         * 绑定输入框拖拽功能
         * @param {HTMLElement} input - 输入框元素
         */
        function bindInputDragDrop(input) {
            input.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                this.classList.add('drag-over');
            });
            input.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            input.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                // 情况1：从页面内拖拽 skill-box
                if (draggedElement) {
                    var img = draggedElement.querySelector('img');
                    if (img) {
                        this.value = img.src;
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // 情况2：从浏览器拖拽图片（HTML）
                if (e.dataTransfer.getData('text/html')) {
                    var html = e.dataTransfer.getData('text/html');
                    var match = html.match(/<img[^>]+src="([^">]+)"/);
                    if (match) {
                        this.value = match[1];
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // 情况3：拖拽URL文本
                if (e.dataTransfer.getData('text/plain')) {
                    var url = e.dataTransfer.getData('text/plain').trim();
                    if (url.match(/^https?:\/\//i)) {
                        this.value = url;
                        this.dispatchEvent(new Event('input'));
                        return;
                    }
                }
                
                // 情况4：拖拽本地文件
                if (e.dataTransfer.files.length > 0) {
                    alert('暂不支持本地图片，请使用在线图片URL');
                }
            });
        }
        
        /**
         * 创建技能盒子元素
         * @param {string} url - 图片URL
         * @param {Object} options - 配置选项
         * @param {string} options.className - CSS类名，默认 'skill-box skill-source'
         * @param {number} options.size - 图片大小，默认40
         * @param {boolean} options.editable - 是否可双击编辑，默认false
         * @param {boolean} options.deletable - 是否可右键删除，默认false
         * @param {number} options.dragImageSize - 拖拽图像大小，默认20
         * @param {boolean} options.isSummon - 是否是召唤石（不设置固定宽高）
         * @param {boolean} options.isSource - 是否是源技能（需要确认删除）
         * @param {string} options.sourceType - 源类型：'skill'|'summon'|'status'
         * @returns {HTMLElement} 创建的skill-box元素
         */
        function createSkillBox(url, options) {
            options = options || {};
            var box = document.createElement('span');
            box.className = options.className || 'skill-box skill-source';
            
            var imgStyle = '';
            if (!options.isSummon) {
                var size = options.size || 40;
                imgStyle = 'width:' + size + 'px;height:' + size + 'px;';
            }
            box.innerHTML = '<img src="' + url + '"' + (imgStyle ? ' style="' + imgStyle + '"' : '') + '>';
            
            // 绑定拖拽事件
            bindDragEvents(box, options.dragImageSize || 20);
            
            // 双击编辑
            if (options.editable) {
                var img = box.querySelector('img');
                img.style.cursor = 'pointer';
                img.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    editImageUrl(this);
                });
            }
            
            // 悬停删除按钮
            if (options.deletable) {
                addSourceDeleteButton(box, options.sourceType || 'skill', options.isSummon);
            }
            
            return box;
        }
        
        /**
         * 为源技能/召唤石/状态图标添加删除按钮
         * @param {HTMLElement} box - skill-box元素
         * @param {string} sourceType - 源类型：'skill'|'summon'|'status'
         * @param {boolean} isSummon - 是否是召唤石
         */
        function addSourceDeleteButton(box, sourceType, isSummon) {
            if (box.querySelector('.mini-fab.delete')) return; // 已有删除按钮
            
            var delBtn = document.createElement('button');
            delBtn.className = 'mini-fab delete';
            delBtn.innerHTML = '×';
            delBtn.title = '删除';
            delBtn.onclick = function(ev) {
                ev.stopPropagation();
                
                // 根据类型显示不同的确认信息
                var confirmMsg = '';
                var tipMsg = '';
                if (sourceType === 'summon') {
                    confirmMsg = '确定要删除这个召唤石吗？';
                    tipMsg = '\n\n提示：点击召唤石格右上角的 ✎ 按钮可以批量编辑';
                } else if (sourceType === 'status') {
                    confirmMsg = '确定要删除这个状态图标吗？';
                    tipMsg = '\n\n提示：点击状态图标行右上角的 ✎ 按钮可以批量编辑';
                } else {
                    confirmMsg = '确定要删除这个技能图标吗？';
                    tipMsg = '\n\n提示：点击角色头像左上角的 − 按钮可以全部清空该角色的技能';
                }
                
                if (!confirm(confirmMsg + tipMsg)) return;
                
                var parentCell = box.closest('td, th');
                box.remove();
                saveToStorage();
                
                // 更新空状态
                if (parentCell) {
                    var coordEl = parentCell.querySelector('.coord');
                    if (coordEl) {
                        var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                        if (match) {
                            var colId = match[2];
                            if (sourceType === 'summon') {
                                var config = summonConfigs.find(function(c) { return c.coord === colId; });
                                if (config) {
                                    window.updateSummonEmptyState(colId, config.maxCount, config.showButton);
                                }
                            } else if (sourceType === 'skill') {
                                window.updateSkillSourceEmptyState(colId);
                            }
                        }
                    }
                }
            };
            box.appendChild(delBtn);
            box.classList.add('has-fab');
            
            // 召唤石需要调整删除按钮位置
            if (isSummon) {
                adjustSummonDeleteButton(box);
            }
        }
        
        /**
         * 为现有的源技能图标批量添加删除按钮
         */
        function initSourceDeleteButtons() {
            // 1. 技能源行的技能图标
            document.querySelectorAll('.skill-source-row:not(.swap-source-row) td .skill-box.skill-source').forEach(function(box) {
                var cell = box.closest('td');
                var coordEl = cell ? cell.querySelector('.coord') : null;
                var isSummon = box.classList.contains('summon-box');
                var sourceType = isSummon ? 'summon' : 'skill';
                addSourceDeleteButton(box, sourceType, isSummon);
            });
            
            // 2. 状态图标行的图标
            var topRows = document.querySelectorAll('.top-row');
            if (topRows[1]) {
                topRows[1].querySelectorAll('.skill-box').forEach(function(box) {
                    addSourceDeleteButton(box, 'status', false);
                });
            }
        }
        
        // ========== 第二阶段：弹窗通用工具函数 ==========
        
        /**
         * 设置帮助按钮交互（悬停显示、点击固定）
         * @param {HTMLElement} modal - 弹窗元素
         */
        function setupHelpButton(modal) {
            var helpBtn = modal.querySelector('#modalHelpBtn');
            var helpTooltip = modal.querySelector('#helpTooltip');
            if (!helpBtn || !helpTooltip) return;
            
            var isHelpPinned = false;
            
            helpBtn.addEventListener('mouseenter', function() {
                if (!isHelpPinned) helpTooltip.style.display = 'block';
            });
            helpBtn.addEventListener('mouseleave', function() {
                if (!isHelpPinned) helpTooltip.style.display = 'none';
            });
            helpBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                isHelpPinned = !isHelpPinned;
                helpTooltip.style.display = 'block';
                helpBtn.textContent = isHelpPinned ? '✕' : '❓';
            });
            document.addEventListener('click', function closeHelp(e) {
                if (isHelpPinned && !helpTooltip.contains(e.target) && e.target !== helpBtn) {
                    isHelpPinned = false;
                    helpTooltip.style.display = 'none';
                    helpBtn.textContent = '❓';
                }
            });
        }
        
        /**
         * 创建输入行更新标签函数
         * @param {HTMLElement} modal - 弹窗元素
         * @param {string} containerId - 容器ID
         * @param {string} labelPrefix - 标签前缀（如"技能"、"召唤石"、"状态"）
         * @param {string} inputClass - 输入框类名
         * @returns {Function} 更新标签的函数
         */
        function createLabelUpdater(modal, containerId, labelPrefix, inputClass) {
            return function() {
                var container = modal.querySelector('#' + containerId);
                var rows = container.querySelectorAll('.skill-input-row');
                rows.forEach(function(row, index) {
                    var label = row.querySelector('.skill-input-label');
                    if (label) label.textContent = labelPrefix + (index + 1) + ':';
                    var input = row.querySelector('.' + inputClass);
                    if (input) input.setAttribute('data-index', index);
                    row.setAttribute('data-row-index', index);
                });
            };
        }
        
        /**
         * 设置输入行的 +/- 按钮事件委托
         * @param {HTMLElement} modal - 弹窗元素
         * @param {string} containerId - 容器ID
         * @param {string} inputClass - 输入框类名
         * @param {string} previewClass - 预览图类名
         * @param {string} labelPrefix - 标签前缀
         * @param {number} maxCount - 最大行数
         * @param {number} minCount - 最小行数，默认1
         */
        function setupInputRowButtons(modal, containerId, inputClass, previewClass, labelPrefix, maxCount, minCount) {
            minCount = minCount || 1;
            var container = modal.querySelector('#' + containerId);
            var updateLabels = createLabelUpdater(modal, containerId, labelPrefix, inputClass);
            
            container.addEventListener('click', function(e) {
                // + 按钮：在当前行下方插入新行
                if (e.target.classList.contains('add-skill-row')) {
                    e.preventDefault();
                    var allRows = container.querySelectorAll('.skill-input-row');
                    
                    if (allRows.length >= maxCount) {
                        alert('最多添加' + maxCount + '个' + labelPrefix + '槽');
                        return;
                    }
                    
                    var currentRow = e.target.closest('.skill-input-row');
                    var newRow = document.createElement('div');
                    newRow.className = 'skill-input-row';
                    newRow.innerHTML = 
                        '<span class="skill-input-label">' + labelPrefix + 'X:</span>' +
                        '<div class="skill-url-input-wrapper">' +
                            '<input type="text" class="' + inputClass + '" placeholder="输入URL或留空">' +
                            '<button type="button" class="paste-btn-inline" title="从剪贴板粘贴">📋</button>' +
                        '</div>' +
                        '<img class="' + previewClass + '" src="' + EMPTY_IMAGE_SRC + '">' +
                        '<button type="button" class="skill-inline-btn add-skill-row" title="在下方插入新行">+</button>' +
                        '<button type="button" class="skill-inline-btn remove-skill-row" title="删除此行">−</button>';
                    
                    currentRow.insertAdjacentElement('afterend', newRow);
                    
                    // 为新输入框添加实时预览
                    var newInput = newRow.querySelector('.' + inputClass);
                    newInput.addEventListener('input', function() {
                        var wrapper = this.parentElement;
                        var preview = wrapper.nextElementSibling;
                        var url = this.value.trim();
                        preview.src = url || EMPTY_IMAGE_SRC;
                    });
                    
                    // 为新粘贴按钮添加事件
                    var newPasteBtn = newRow.querySelector('.paste-btn-inline');
                    bindPasteButton(newPasteBtn);
                    
                    // 为新输入框添加拖拽功能
                    bindInputDragDrop(newInput);
                    
                    updateLabels();
                }
                
                // - 按钮：删除当前行
                if (e.target.classList.contains('remove-skill-row')) {
                    e.preventDefault();
                    var allRows = container.querySelectorAll('.skill-input-row');
                    
                    if (allRows.length <= minCount) {
                        if (minCount === 1) {
                            // 只有一行时，清空内容而不是删除
                            var input = e.target.closest('.skill-input-row').querySelector('.' + inputClass);
                            input.value = '';
                            input.dispatchEvent(new Event('input'));
                        } else {
                            alert('至少保留' + minCount + '个' + labelPrefix + '槽');
                        }
                        return;
                    }
                    
                    e.target.closest('.skill-input-row').remove();
                    updateLabels();
                }
            });
        }
        
        /**
         * 为弹窗中的所有输入框绑定通用事件（粘贴、拖拽、实时预览）
         * @param {HTMLElement} modal - 弹窗元素
         * @param {string} inputClass - 输入框类名
         */
        function bindModalInputEvents(modal, inputClass) {
            // 剪贴板粘贴功能
            modal.querySelectorAll('.paste-btn-inline').forEach(function(btn) {
                bindPasteButton(btn);
            });
            
            // 拖拽图片功能
            modal.querySelectorAll('.' + inputClass).forEach(function(input) {
                bindInputDragDrop(input);
            });
            
            // 实时预览功能
            modal.querySelectorAll('.' + inputClass).forEach(function(input) {
                input.addEventListener('input', function() {
                    var wrapper = this.parentElement;
                    var preview = wrapper.nextElementSibling;
                    var url = this.value.trim();
                    if (url) {
                        preview.src = url;
                    } else {
                        preview.src = EMPTY_IMAGE_SRC;
                    }
                });
            });
        }
        
        /**
         * 生成帮助提示HTML
         * @param {Object} options - 配置选项
         * @param {string} options.wikiType - Wiki类型描述（如"BOSS"、"角色"）
         * @returns {string} 帮助提示HTML
         */
        function generateHelpTooltipHtml(options) {
            var wikiType = options.wikiType || '';
            return '<button type="button" class="modal-help-btn" id="modalHelpBtn">❓</button>' +
                '<div class="help-tooltip" id="helpTooltip">' +
                    '<h4>💡 如何复制图片URL</h4>' +
                    '<ol>' +
                        '<li>点击"编队复制图片URL"打开游戏页面</li>' +
                        '<li>长按右键拖动到图片上，再松开右键</li>' +
                        '<li>选择"复制图片地址"</li>' +
                        '<li>使用 Win+V 查看复制历史</li>' +
                        '<li>使用 Win+左/右 分屏显示两个窗口</li>' +
                    '</ol>' +
                    '<div class="help-section">' +
                        '<strong>💡 快捷方式：</strong><br>' +
                        '• 点击 📋 从剪贴板粘贴<br>' +
                        '• 拖拽图片到输入框' +
                    '</div>' +
                '</div>';
        }
        
        /**
         * 生成输入行HTML
         * @param {Object} options - 配置选项
         * @param {Array} options.existingUrls - 现有URL数组
         * @param {number} options.slotCount - 槽位数量
         * @param {string} options.labelPrefix - 标签前缀
         * @param {string} options.inputClass - 输入框类名
         * @param {string} options.previewClass - 预览图类名
         * @returns {string} 输入行HTML
         */
        function generateInputRowsHtml(options) {
            var html = '';
            for (var i = 0; i < options.slotCount; i++) {
                var currentUrl = options.existingUrls[i] || '';
                html += '<div class="skill-input-row" data-row-index="' + i + '">' +
                    '<span class="skill-input-label">' + options.labelPrefix + (i + 1) + ':</span>' +
                    '<div class="skill-url-input-wrapper">' +
                        '<input type="text" class="' + options.inputClass + '" data-index="' + i + '" value="' + currentUrl + '" placeholder="输入URL或留空">' +
                        '<button type="button" class="paste-btn-inline" title="从剪贴板粘贴">📋</button>' +
                    '</div>' +
                    '<img class="' + options.previewClass + '" src="' + (currentUrl || EMPTY_IMAGE_SRC) + '">' +
                    '<button type="button" class="skill-inline-btn add-skill-row" title="在下方插入新行">+</button>' +
                    '<button type="button" class="skill-inline-btn remove-skill-row" title="删除此行">−</button>' +
                '</div>';
            }
            return html;
        }
        
        // ========== 第二阶段工具函数结束 ==========
        
        // ========== 第三阶段：空状态通用工具函数 ==========
        
        /**
         * 检查元素中是否有有效图片
         * @param {HTMLElement} element - 要检查的元素
         * @param {string} selector - 图片选择器，默认 'img'
         * @returns {boolean} 是否有有效图片
         */
        function hasValidImages(element, selector) {
            selector = selector || 'img';
            var images = element.querySelectorAll(selector);
            var valid = false;
            images.forEach(function(img) {
                if (img.src && img.src !== EMPTY_IMAGE_SRC && !img.src.includes('data:image/gif;base64') && img.src.trim() !== '') {
                    valid = true;
                }
            });
            return valid;
        }
        
        /**
         * 检查单个图片是否有效
         * @param {HTMLImageElement} img - 图片元素
         * @returns {boolean} 是否有效
         */
        function isValidImage(img) {
            return img && img.src && img.src !== EMPTY_IMAGE_SRC && !img.src.includes('data:image/gif;base64') && img.src.trim() !== '';
        }
        
        /**
         * 创建空状态提示元素
         * @param {Object} options - 配置选项
         * @param {string} options.className - CSS类名
         * @param {string} options.text - 提示文字
         * @param {Array} options.buttons - 按钮配置数组 [{text, url}]
         * @param {string} options.textClass - 文字CSS类名，默认 'empty-text'
         * @param {string} options.buttonsClass - 按钮容器CSS类名，默认 'empty-buttons'
         * @returns {HTMLElement} 提示元素
         */
        function createEmptyHint(options) {
            var hint = document.createElement('div');
            hint.className = options.className || 'empty-state-hint';
            
            var textClass = options.textClass || 'empty-text';
            var html = '<div class="' + textClass + '">' + options.text + '</div>';
            
            if (options.buttons && options.buttons.length > 0) {
                var buttonsClass = options.buttonsClass || 'empty-buttons';
                html += '<div class="' + buttonsClass + '">';
                options.buttons.forEach(function(btn) {
                    // 判断是否为 Wiki 链接（包含 huijiwiki.com），添加 wiki-warning 类
                    var isWikiLink = btn.url && btn.url.indexOf('huijiwiki.com') > -1;
                    var btnClass = isWikiLink ? 'wiki-btn-small wiki-warning' : 'wiki-btn-small';
                    html += '<button class="' + btnClass + '" onclick="window.open(\'' + btn.url + '\',\'_blank\')">' + btn.text + '</button>';
                });
                html += '</div>';
            }
            
            hint.innerHTML = html;
            return hint;
        }
        
        /**
         * 通过坐标查找技能源行中的单元格
         * @param {string} coord - 坐标字符串（如 'E', 'A-B'）
         * @returns {HTMLElement|null} 找到的单元格
         */
        function findSkillSourceCell(coord) {
            var skillSourceRow = document.querySelector('.skill-source-row');
            if (!skillSourceRow) return null;
            
            var targetCell = null;
            skillSourceRow.querySelectorAll('td').forEach(function(cell) {
                var coordEl = cell.querySelector('.coord');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if (match && match[2] === coord) {
                        targetCell = cell;
                    }
                }
            });
            return targetCell;
        }
        
        /**
         * 通过坐标查找角色头像单元格
         * @param {string} coord - 坐标字符串（如 'E', 'F'）
         * @returns {HTMLElement|null} 找到的单元格
         */
        function findCharacterHeader(coord) {
            var targetHeader = null;
            document.querySelectorAll('.character-header').forEach(function(header) {
                var coordEl = header.querySelector('.coord-header');
                if (coordEl) {
                    var match = coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                    if (match && match[2] === coord) {
                        targetHeader = header;
                    }
                }
            });
            return targetHeader;
        }
        
        // ========== 第三阶段工具函数结束 ==========
        
        // 主题切换
        function toggleTheme(){
            var html=document.documentElement;
            var current=html.getAttribute('data-theme');
            var newTheme=current==='dark'?'light':'dark';
            html.setAttribute('data-theme',newTheme);
            localStorage.setItem(THEME_KEY,newTheme);
            updateThemeButton(newTheme);
        }
        function updateThemeButton(theme){
            var btn=document.querySelector('.theme-toggle');
            if(btn){btn.textContent=theme==='dark'?'☀️ 切换主题':'🌙 切换主题';}
        }
        function loadTheme(){
            var saved=localStorage.getItem(THEME_KEY)||'light';
            document.documentElement.setAttribute('data-theme',saved);
            updateThemeButton(saved);
        }
        loadTheme();
        
        // 坐标显示开关 (新版：适配按钮样式)
        var COORDS_KEY='gbf_guide_coords';
        function toggleCoords(){
            var btn = document.getElementById('btnCoordToggle');
            var table = document.getElementById('guideTable');
            // 检查当前是否已隐藏（通过类名判断）
            var isHidden = table.classList.contains('hide-coords');
            if(isHidden){
                // 动作：显示
                table.classList.remove('hide-coords');
                btn.style.color = '#2196f3'; // 高亮图标
                localStorage.setItem(COORDS_KEY, 'show');
            } else {
                // 动作：隐藏
                table.classList.add('hide-coords');
                btn.style.color = ''; // 恢复默认色
                localStorage.setItem(COORDS_KEY, 'hide');
            }
        }
        function loadCoordsState(){
            var saved = localStorage.getItem(COORDS_KEY) || 'show';
            var btn = document.getElementById('btnCoordToggle');
            var table = document.getElementById('guideTable');
            if(saved === 'hide'){
                table.classList.add('hide-coords');
                if(btn) btn.style.color = '';
            } else {
                table.classList.remove('hide-coords');
                // 初始化时高亮
                if(btn) btn.style.color = '#2196f3';
            }
        }
        
        // 默认字号
        var FONTSIZE_KEY='gbf_guide_fontsize';
        var ICONSCALE_KEY='gbf_guide_iconscale';
        
        function saveDefaultFontSize(){
            var size=document.getElementById('defaultFontSize').value;
            localStorage.setItem(FONTSIZE_KEY,size);
            applyDefaultFontSize();
        }
        function loadDefaultFontSize(){
            var saved=localStorage.getItem(FONTSIZE_KEY)||'11';
            document.getElementById('defaultFontSize').value=saved;
            return parseInt(saved);
        }
        function getDefaultFontSize(){
            return parseInt(document.getElementById('defaultFontSize').value)||11;
        }
        
        // 图标大小控制
        function saveIconScale(){
            var displayValue = document.getElementById('iconScale').value;
            // 将显示值转换为百分比存储（10对应100%）
            var scalePercent = displayValue * 10;
            localStorage.setItem(ICONSCALE_KEY, scalePercent);
            applyIconScaling();
        }
        function loadIconScale(){
            var savedPercent = localStorage.getItem(ICONSCALE_KEY) || '100';
            // 将百分比转换为显示值（100%对应10）
            var displayValue = parseInt(savedPercent) / 10;
            document.getElementById('iconScale').value = displayValue;
            return parseInt(savedPercent);
        }
        function getIconScale(){
            var displayValue = parseInt(document.getElementById('iconScale').value) || 10;
            // 将显示值转换为百分比用于计算（10对应100%）
            return displayValue * 10;
        }
        function applyDefaultFontSize(){
            var size=getDefaultFontSize()+'px';
            document.querySelectorAll('.t-text').forEach(function(el){
                if(!el.hasAttribute('data-custom-size')){el.style.fontSize=size;}
            });
            // 同时应用到用户文字
            document.querySelectorAll('.user-text').forEach(function(el){
                if(!el.hasAttribute('data-custom-size')){el.style.fontSize=size;}
            });
            // 同时应用到第2行及以下的所有按钮（A列+−、B列−）
            document.querySelectorAll('.del-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            document.querySelectorAll('.phase-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            document.querySelectorAll('.phase-del-btn').forEach(function(el){
                el.style.fontSize=size;
            });
            // 同时应用到C列和E-H列的微型按钮
            document.querySelectorAll('.micro-fab').forEach(function(el){
                el.style.fontSize=size;
            });
            // 同时应用到角色栏删除键和召唤石栏的编辑/删除键
            document.querySelectorAll('.mini-fab').forEach(function(el){
                el.style.fontSize=size;
            });
        }
        
        // 图标缩放功能 - 修复版
        function applyIconScaling() {
            var iconScale = getIconScale() / 100; // 转换为小数比例
            
            // 限制缩放范围，避免过大或过小
            iconScale = Math.max(0.5, Math.min(2.0, iconScale));
            
            // 1. 应用到技能图标
            document.querySelectorAll('.skill-box img').forEach(function(img) {
                if (img.closest('.summon-box')) {
                    // 召唤石特殊处理
                    var baseWidth = 40;
                    var baseMaxHeight = 48;
                    img.style.maxWidth = (baseWidth * iconScale) + 'px';
                    img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
                } else {
                    // 普通技能图标
                    var baseSize = 40;
                    var newSize = baseSize * iconScale;
                    img.style.width = newSize + 'px';
                    img.style.height = newSize + 'px';
                }
            });
            
            // 2. 应用到召唤石容器
            document.querySelectorAll('.skill-box.summon-box').forEach(function(box) {
                var baseSize = 40;
                var newSize = baseSize * iconScale;
                box.style.width = newSize + 'px';
                box.style.height = newSize + 'px';
            });
            
            // 3. 应用到普通技能容器
            document.querySelectorAll('.skill-box:not(.summon-box)').forEach(function(box) {
                var baseSize = 44;
                var newSize = baseSize * iconScale;
                box.style.width = newSize + 'px';
                box.style.height = newSize + 'px';
            });
            
            // 4. 应用到角色头像
            document.querySelectorAll('.character-header img').forEach(function(img) {
                var baseWidth = 70;
                var baseMaxHeight = 120;
                img.style.width = (baseWidth * iconScale) + 'px';
                img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
            });
            
            // 5. 应用到迷你按钮 (删除键/加号键)
            document.querySelectorAll('.mini-fab').forEach(function(btn) {
                // 默认小按钮基础大小为 24
                var baseSize = 24;
                // [修改] 如果是左上角的删除大按钮，基础大小设为 32 (同步编辑按钮)
                if (btn.classList.contains('delete-char-btn')) {
                    baseSize = 32;
                }
                var newSize = baseSize * iconScale;
                btn.style.width = newSize + 'px';
                btn.style.height = newSize + 'px';
                // [修改] 动态计算字号 (约为按钮大小的 0.65 倍)
                btn.style.fontSize = (baseSize * 0.65 * iconScale) + 'px';
            });
            
            // 6. [新增] 应用到新版玻璃拟态编辑按钮 (.btn-edit-glass)
            document.querySelectorAll('.btn-edit-glass').forEach(function(btn) {
                var baseSize = 32; // 编辑按钮基础尺寸较大
                var newSize = baseSize * iconScale;
                btn.style.width = newSize + 'px';
                btn.style.height = newSize + 'px';
                // 同时缩放内部的 SVG 图标
                var svg = btn.querySelector('svg');
                if(svg) {
                    var baseSvgSize = 16;
                    var newSvgSize = baseSvgSize * iconScale;
                    svg.setAttribute('width', newSvgSize);
                    svg.setAttribute('height', newSvgSize);
                }
            });
            
            // 重新调整召唤石删除按钮位置
            setTimeout(function() {
                adjustAllSummonDeleteButtons();
            }, 50);
        }
        
        // 对单个元素应用图标缩放
        function applyIconScalingToElement(element) {
            var iconScale = getIconScale() / 100;
            iconScale = Math.max(0.5, Math.min(2.0, iconScale));
            
            if (element.classList.contains('skill-box')) {
                var img = element.querySelector('img');
                if (img) {
                    if (element.classList.contains('summon-box')) {
                        // 召唤石特殊处理
                        var baseWidth = 40;
                        var baseMaxHeight = 48;
                        img.style.maxWidth = (baseWidth * iconScale) + 'px';
                        img.style.maxHeight = (baseMaxHeight * iconScale) + 'px';
                        
                        // 调整容器尺寸
                        var baseSize = 40;
                        var newSize = baseSize * iconScale;
                        element.style.width = newSize + 'px';
                        element.style.height = newSize + 'px';
                    } else {
                        // 普通技能图标
                        var baseImgSize = 40;
                        var newImgSize = baseImgSize * iconScale;
                        img.style.width = newImgSize + 'px';
                        img.style.height = newImgSize + 'px';
                        
                        // 调整容器尺寸
                        var baseBoxSize = 44;
                        var newBoxSize = baseBoxSize * iconScale;
                        element.style.width = newBoxSize + 'px';
                        element.style.height = newBoxSize + 'px';
                    }
                }
                
                // 调整删除按钮
                var deleteBtn = element.querySelector('.mini-fab');
                if (deleteBtn) {
                    var baseSize = 22;
                    var newSize = baseSize * iconScale;
                    deleteBtn.style.width = newSize + 'px';
                    deleteBtn.style.height = newSize + 'px';
                    deleteBtn.style.fontSize = (14 * iconScale) + 'px';
                }
            }
        }
        
        // 右键菜单
        var currentContextTarget=null;
        var currentContextType=null; // 'user-text' or 't-text'
        function showContextMenu(e,target,type){
            e.preventDefault();
            closeContextMenu();
            currentContextTarget=target;
            currentContextType=type||'user-text';
            var menu=document.createElement('div');
            menu.className='context-menu';
            menu.id='contextMenu';
            var menuHtml='<div class="context-menu-item" onclick="editTextSize()">📏 修改字号</div><div class="context-menu-item" onclick="editTextColor()">🎨 修改颜色</div><div class="context-menu-item" onclick="resetTextStyle()">🔄 还原默认</div>';
            if(currentContextType==='user-text'){
                menuHtml+='<div class="context-menu-divider"></div><div class="context-menu-item" onclick="deleteContextTarget()" style="color:#c62828;">🗑️ 删除</div>';
            }
            menu.innerHTML=menuHtml;
            menu.style.left=e.clientX+'px';
            menu.style.top=e.clientY+'px';
            document.body.appendChild(menu);
            setTimeout(function(){document.addEventListener('click',closeContextMenu,{once:true});},10);
        }
        function closeContextMenu(){
            var menu=document.getElementById('contextMenu');
            if(menu)menu.remove();
        }
        function editTextSize(){
            if(!currentContextTarget)return;
            var currentSize=parseInt(currentContextTarget.style.fontSize)||getDefaultFontSize();
            var newSize=prompt('输入字号 (10-24):',currentSize);
            if(newSize!==null){
                newSize=parseInt(newSize);
                if(newSize>=10&&newSize<=24){
                    currentContextTarget.style.fontSize=newSize+'px';
                    currentContextTarget.setAttribute('data-custom-size','true');
                    saveToStorage();
                }else{
                    alert('字号范围: 10-24');
                }
            }
        }
        function editTextColor(){
            if(!currentContextTarget)return;
            var colorInput=document.createElement('input');
            colorInput.type='color';
            colorInput.value=rgbToHex(currentContextTarget.style.color)||'#333333';
            colorInput.style.position='fixed';
            colorInput.style.opacity='0';
            document.body.appendChild(colorInput);
            colorInput.click();
            colorInput.addEventListener('change',function(){
                currentContextTarget.style.color=this.value;
                currentContextTarget.setAttribute('data-custom-color','true');
                saveToStorage();
                this.remove();
            });
            colorInput.addEventListener('blur',function(){this.remove();});
        }
        function rgbToHex(rgb){
            if(!rgb)return '#333333';
            if(rgb.startsWith('#'))return rgb;
            var match=rgb.match(/\d+/g);
            if(!match||match.length<3)return '#333333';
            return '#'+match.slice(0,3).map(function(x){return parseInt(x).toString(16).padStart(2,'0');}).join('');
        }
        function deleteContextTarget(){
            if(currentContextTarget){
                // 如果是user-text，检查是否在wrapper中
                var wrapper=currentContextTarget.closest('.user-text-wrapper');
                if(wrapper){
                    wrapper.remove();
                }else{
                    currentContextTarget.remove();
                }
                saveToStorage();
            }
        }
        function resetTextStyle(){
            if(currentContextTarget){
                currentContextTarget.removeAttribute('data-custom-size');
                currentContextTarget.removeAttribute('data-custom-color');
                currentContextTarget.style.fontSize='';
                currentContextTarget.style.color='';
                applyDefaultFontSize();
                saveToStorage();
            }
        }
        
        // 定义阶段颜色循环顺序
        var PHASE_CLASSES = ['phase-100-80', 'phase-80-60', 'phase-60-20', 'phase-20-0'];
        
        // 快速添加BOSS图弹窗
        function showQuickAddBoss(btn){
            var th = btn.closest('th');
            var img = th.querySelector('img');
            var currentUrl = img ? img.src : '';
            
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            modal.innerHTML = 
                '<h3>🐉 快速添加BOSS大图</h3>'+
                '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8\',\'_blank\')">🔗 Wiki查询BOSS</button>'+
                '<label>BOSS图片URL:</label>'+
                '<input type="text" id="bossImageUrl" placeholder="右键Wiki BOSS图片 → 复制图片地址 → 粘贴到这里" value="'+currentUrl+'">'+
                '<div class="hint">支持格式: huijistatic.com / granbluefantasy.akamaized.net</div>'+
                '<label>预览:</label>'+
                '<div class="preview-area">'+
                    '<img id="previewBoss" src="'+(currentUrl||EMPTY_IMAGE_SRC)+'" style="max-width:200px;max-height:100px;border:1px solid var(--border-color);border-radius:4px;">'+
                '</div>'+
                '<div class="btn-row">'+
                    '<button class="btn-secondary" id="bossAddCancel">取消</button>'+
                    '<button class="btn-primary" id="bossAddConfirm">确定</button>'+
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            var urlInput = modal.querySelector('#bossImageUrl');
            var previewImg = modal.querySelector('#previewBoss');
            
            // 实时预览
            urlInput.addEventListener('input', function(){
                var url = this.value.trim();
                if(url){
                    previewImg.src = url;
                }
            });
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirm = function(){
                var newUrl = urlInput.value.trim();
                if(img){
                    if(newUrl){
                        img.src = newUrl;
                    } else {
                        // 如果URL为空，设置为占位符
                        img.src = EMPTY_IMAGE_SRC;
                    }
                    saveToStorage();
                    if(window.updateBossEmptyState) window.updateBossEmptyState();
                }
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#bossAddCancel').onclick = close;
            modal.querySelector('#bossAddConfirm').onclick = confirm;
            urlInput.focus();
            urlInput.select();
            
            urlInput.onkeydown = function(e){
                if(e.key === 'Enter') confirm();
                if(e.key === 'Escape') close();
            };
        }
        
        // 快速添加状态图标弹窗（使用通用工具函数重构）
        function showQuickAddStatus(btn){
            var th = btn.closest('th');
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // 读取现有状态图标URL
            var existingUrls = [];
            th.querySelectorAll('.skill-box img').forEach(function(img){
                existingUrls.push(img.src);
            });
            
            // 根据现有状态图标数量决定初始槽数（至少1个）
            var statusSlotCount = Math.max(1, existingUrls.length);
            
            // 使用通用函数生成输入行HTML
            var inputsHtml = generateInputRowsHtml({
                existingUrls: existingUrls,
                slotCount: statusSlotCount,
                labelPrefix: '状态',
                inputClass: 'status-url-input',
                previewClass: 'skill-input-preview'
            });
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: 'BOSS' }) +
                '<h3>🔮 编辑状态图标</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8\',\'_blank\')">🔗 Wiki查询BOSS</button>' +
                '</div>' +
                '<label style="margin-top:10px;display:block;">状态图标:</label>' +
                '<div class="skill-inputs-container" id="statusInputsContainer">' + inputsHtml + '</div>' +
                '<div class="hint">留空 = 删除该位置的状态图标</div>' +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="statusAddCancel">取消</button>' +
                    '<button class="btn-primary" id="statusAddConfirm">确定保存</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // 使用通用函数设置帮助按钮
            setupHelpButton(modal);
            
            // 使用通用函数绑定输入框事件（粘贴、拖拽、预览）
            bindModalInputEvents(modal, 'status-url-input');
            
            // 使用通用函数设置 +/- 按钮
            setupInputRowButtons(modal, 'statusInputsContainer', 'status-url-input', 'skill-input-preview', '状态', 20, 1);
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                // 收集所有状态图标URL
                var newUrls = [];
                modal.querySelectorAll('.status-url-input').forEach(function(input) {
                    var url = input.value.trim();
                    if (url) newUrls.push(url);
                });
                
                // 清空现有状态图标
                th.querySelectorAll('.skill-box').forEach(function(box) {
                    box.remove();
                });
                
                // 添加新状态图标
                var editBtn = th.querySelector('.mini-fab.edit, .btn-edit-glass');
                newUrls.forEach(function(url) {
                    var box = createSkillBox(url, {
                        className: 'skill-box skill-source',
                        size: 33,
                        editable: true,
                        deletable: true,
                        sourceType: 'status',
                        dragImageSize: 16
                    });
                    
                    if (editBtn) {
                        th.insertBefore(box, editBtn);
                    } else {
                        th.appendChild(box);
                    }
                });
                
                saveToStorage();
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#statusAddCancel').onclick = close;
            modal.querySelector('#statusAddConfirm').onclick = confirmSave;
        }
        
        // 双击图片修改URL
        function editImageUrl(img){
            var currentUrl = img.src;
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'text-input-modal';
            modal.innerHTML = '<div style="margin-bottom:10px;color:var(--text-primary);">修改图片URL:</div><input type="text" style="width:400px;" value="'+currentUrl+'"><button>确定</button><button style="margin-left:5px;">取消</button>';
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            var input = modal.querySelector('input');
            input.focus();
            input.select();
            var submit = function(){
                var newUrl = input.value.trim();
                if(newUrl && newUrl !== currentUrl){
                    img.src = newUrl;
                    saveToStorage();
                }
                overlay.remove();
                modal.remove();
            };
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            modal.querySelectorAll('button')[0].onclick = submit;
            modal.querySelectorAll('button')[1].onclick = close;
            overlay.onclick = close;
            input.onkeydown = function(e){
                if(e.key === 'Enter') submit();
                if(e.key === 'Escape') close();
            };
        }
        
        // 快速添加角色弹窗
        function showQuickAddCharacter(headerCell){
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // 获取当前列的坐标 (修复版 - 支持换人行坐标)
            var coordEl = headerCell.querySelector('.coord-header');
            var colId = '';
            var rowId = '';
            var isSwapRow = false;
            if(coordEl){
                // [修复] 正则改为支持 'SW1' 这样的坐标
                var match = coordEl.textContent.match(/\(([\w\d]+),([A-Z])\)/);
                if(match) {
                    rowId = match[1];
                    colId = match[2];
                    isSwapRow = rowId.startsWith('SW');
                }
            }
            
            // E列是主角，使用职业编辑模式（仅限普通行）
            var isMainChar = (colId === 'E' && !isSwapRow);
            
            // 读取现有数据
            var existingAvatarUrl = '';
            var avatarImg = headerCell.querySelector('img');
            if(avatarImg) existingAvatarUrl = avatarImg.src;
            
            var existingSkillUrls = [];
            // [修复] 换人行需要从对应的 swap-source-row 读取技能
            var skillSourceRow = isSwapRow 
                ? document.querySelector('.swap-source-row[data-swap-id="' + headerCell.closest('.swap-header-row').getAttribute('data-swap-id') + '"]')
                : document.querySelector('.skill-source-row');
            if(skillSourceRow){
                var skillCells = skillSourceRow.querySelectorAll('td');
                skillCells.forEach(function(cell){
                    var cellCoordEl = cell.querySelector('.coord');
                    if(cellCoordEl){
                        // [修复] 正则改为支持 'SRC1' 这样的坐标
                        var cellMatch = cellCoordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                        if(cellMatch && cellMatch[2] === colId){
                            cell.querySelectorAll('.skill-box img').forEach(function(img){
                                existingSkillUrls.push(img.src);
                            });
                        }
                    }
                });
            }
            
            // 根据现有技能数量决定初始槽数（至少4个）
            var skillSlotCount = Math.max(4, existingSkillUrls.length);
            
            // 使用通用函数生成技能输入行HTML
            var skillInputsHtml = generateInputRowsHtml({
                existingUrls: existingSkillUrls,
                slotCount: skillSlotCount,
                labelPrefix: '技能',
                inputClass: 'skill-url-input',
                previewClass: 'skill-input-preview'
            });
            
            // 主角常用技能快捷按钮
            var quickSkillsHtml = '';
            if(isMainChar){
                var quickSkills = [
                    {name: '时龙', url: 'https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/2516_3.png', special: true},
                    {name: '双攻', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/26_2.png', special: false},
                    {name: '追击', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/44_4.png', special: false},
                    {name: '回复', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/58_4.png', special: false},
                    {name: '奥义', url: 'https://prd-game-a-granbluefantasy.akamaized.net/assets_en/img/sp/ui/icon/ability/m/188_3.png', special: false}
                ];
                quickSkillsHtml = '<div class="quick-skills-section">' +
                    '<div class="quick-skill-btns">';
                quickSkills.forEach(function(skill){
                    quickSkillsHtml += '<button type="button" class="quick-skill-btn' + (skill.special ? ' special' : '') + '" ' +
                        'data-url="' + skill.url + '" data-special="' + skill.special + '" title="' + skill.name + '">' +
                        '<img src="' + skill.url + '"></button>';
                });
                quickSkillsHtml += '<button class="wiki-btn wiki-warning more-skills-inline-btn" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E8%B5%84%E6%96%99/EX%E6%8A%80%E8%83%BD\',\'_blank\')">🔗 更多技能</button>';
                quickSkillsHtml += '</div></div>';
            }
            
            var title = isMainChar ? '编辑职业' : '编辑角色';
            var wikiUrl = isMainChar ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95' : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
            var wikiText = isMainChar ? '🔗 Wiki查询职业' : '🔗 Wiki查询角色';
            var avatarLabel = isMainChar ? '职业头像URL:' : '角色头像URL:';
            var partyLinkBtn = '<button class="wiki-btn" onclick="window.open(\'https://game.granbluefantasy.jp/#party/index/0/npc/0\',\'_blank\')">🔗 编队拖入图片</button>';
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: '角色' }) +
                '<h3>' + title + '</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'' + wikiUrl + '\',\'_blank\')">' + wikiText + '</button>' +
                    partyLinkBtn +
                '</div>' +
                '<div class="char-input-row">' +
                    '<span class="char-input-label">' + avatarLabel + '</span>' +
                    '<input type="text" class="char-avatar-input" value="' + existingAvatarUrl + '" placeholder="输入URL">' +
                    '<img class="char-avatar-preview" src="' + (existingAvatarUrl || EMPTY_IMAGE_SRC) + '">' +
                '</div>' +
                '<div class="hint">支持格式: huijistatic.com / granbluefantasy.akamaized.net</div>' +
                '<label style="margin-top:10px;display:block;">技能图标:</label>' +
                '<div class="skill-inputs-container" id="skillInputsContainer">' + skillInputsHtml + '</div>' +
                '<div class="hint">留空 = 删除该位置的技能</div>' +
                quickSkillsHtml +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="charAddCancel">取消</button>' +
                    '<button class="btn-primary" id="charAddConfirm">确定保存</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // 使用通用函数设置帮助按钮
            setupHelpButton(modal);
            
            // 使用通用函数绑定技能输入框事件（粘贴、拖拽、预览）
            bindModalInputEvents(modal, 'skill-url-input');
            
            // 使用通用函数设置 +/- 按钮
            setupInputRowButtons(modal, 'skillInputsContainer', 'skill-url-input', 'skill-input-preview', '技能', 10, 1);
            
            var avatarInput = modal.querySelector('.char-avatar-input');
            var avatarPreview = modal.querySelector('.char-avatar-preview');
            
            // 实时预览头像
            avatarInput.addEventListener('input', function(){
                var url = this.value.trim();
                if(url){
                    avatarPreview.src = url;
                }else{
                    avatarPreview.src = EMPTY_IMAGE_SRC;
                }
            });
            
            // 快捷技能按钮点击事件
            modal.querySelectorAll('.quick-skill-btn').forEach(function(btn){
                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    var url = this.getAttribute('data-url');
                    var isSpecial = this.getAttribute('data-special') === 'true';
                    var container = modal.querySelector('#skillInputsContainer');
                    var inputs = container.querySelectorAll('.skill-url-input');
                    
                    if(isSpecial){
                        // 时龙特殊逻辑：检查是否有空槽，如果有则插入技能1，其他顺延
                        var hasEmptySlot = false;
                        for(var i = 0; i < inputs.length; i++){
                            if(!inputs[i].value.trim()){
                                hasEmptySlot = true;
                                break;
                            }
                        }
                        
                        if(hasEmptySlot){
                            for(var i = inputs.length - 1; i > 0; i--){
                                inputs[i].value = inputs[i-1].value;
                                var preview = inputs[i].parentElement.nextElementSibling;
                                preview.src = inputs[i].value || EMPTY_IMAGE_SRC;
                            }
                            inputs[0].value = url;
                            inputs[0].parentElement.nextElementSibling.src = url;
                        } else {
                            alert('技能槽已满，请先使用 + 按钮添加新槽位');
                        }
                    } else {
                        // 普通技能：填入最后一个空槽，没空槽填最后一个
                        var emptySlot = null;
                        for(var i = 0; i < inputs.length; i++){
                            if(!inputs[i].value.trim()){
                                emptySlot = inputs[i];
                                break;
                            }
                        }
                        if(emptySlot){
                            emptySlot.value = url;
                            emptySlot.parentElement.nextElementSibling.src = url;
                        } else {
                            var lastInput = inputs[inputs.length - 1];
                            lastInput.value = url;
                            lastInput.parentElement.nextElementSibling.src = url;
                        }
                    }
                });
            });
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                var newAvatarUrl = avatarInput.value.trim();
                
                // 更新头像（包括清空的情况）
                var avatarImgEl = headerCell.querySelector('img');
                if(avatarImgEl){
                    if(newAvatarUrl){
                        avatarImgEl.src = newAvatarUrl;
                    } else {
                        // 如果URL为空，设置为占位符（会在保存时被过滤掉）
                        avatarImgEl.src = EMPTY_IMAGE_SRC;
                    }
                }
                
                // 收集技能URL
                var newSkillUrls = [];
                modal.querySelectorAll('.skill-url-input').forEach(function(input){
                    var url = input.value.trim();
                    if(url) newSkillUrls.push(url);
                });
                
                // 更新技能源
                if(skillSourceRow){
                    var skillCells = skillSourceRow.querySelectorAll('td');
                    var targetCell = null;
                    
                    skillCells.forEach(function(cell){
                        var cellCoordEl = cell.querySelector('.coord');
                        if(cellCoordEl){
                            // [修复] 正则改为支持 'SRC1' 这样的坐标
                            var cellMatch = cellCoordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                            if(cellMatch && cellMatch[2] === colId){
                                targetCell = cell;
                            }
                        }
                    });
                    
                    if(targetCell){
                        // 清空现有技能图标
                        var existingBoxes = targetCell.querySelectorAll('.skill-box');
                        existingBoxes.forEach(function(box){box.remove();});
                        
                        // 保留坐标
                        var coord = targetCell.querySelector('.coord');
                        targetCell.innerHTML = '';
                        if(coord) targetCell.appendChild(coord);
                        
                        // 添加新技能图标
                        newSkillUrls.forEach(function(url){
                            var box = createSkillBox(url, {
                                className: 'skill-box skill-source',
                                size: 40,
                                editable: true,
                                deletable: true,
                                sourceType: 'skill',
                                dragImageSize: 20
                            });
                            targetCell.appendChild(box);
                        });
                    }
                }
                
                saveToStorage();
                
                // 更新角色头像的空状态 (修复版 - 支持换人行坐标)
                var coordEl = headerCell.querySelector('.coord-header');
                if (coordEl) {
                    var coordText = coordEl.textContent;
                    // [修复] 尝试解析坐标，支持 SW 开头的换人行
                    var match = coordText.match(/\(([\w\d]+),([A-Z])\)/);
                    if (match && match[1].startsWith('SW')) {
                        // 如果是换人行，调用换人行的更新函数
                        if (window.updateSwapCharEmptyState) {
                            window.updateSwapCharEmptyState(headerCell);
                        }
                    } else {
                        // 普通行，调用原有逻辑
                        window.updateCharEmptyStateByCoord(coordText);
                    }
                }
                
                // 更新技能源的空状态
                if (colId) {
                    window.updateSkillSourceEmptyState(colId);
                }
                
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#charAddCancel').onclick = close;
            modal.querySelector('#charAddConfirm').onclick = confirmSave;
            
            avatarInput.focus();
        }
        
        // 快速添加召唤石弹窗（独立输入框版本，带+/-按钮）
        function showQuickAddSummon(cell){
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'char-add-modal';
            
            // 获取当前单元格的坐标 (修复版 - 支持换人行坐标)
            var coordEl = cell.querySelector('.coord');
            var colId = '';
            var rowId = '';
            var isSwapRow = false;
            if(coordEl){
                // [修复] 正则改为支持 'SRC1' 这样的坐标
                var match = coordEl.textContent.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                if(match) {
                    rowId = match[1];
                    colId = match[2];
                    isSwapRow = rowId.startsWith('SRC');
                }
            }
            
            // 读取现有召唤石URL
            var existingUrls = [];
            cell.querySelectorAll('.skill-box img').forEach(function(img){
                existingUrls.push(img.src);
            });
            
            // 根据现有召唤石数量决定初始槽数（至少1个，最多6个）
            var summonSlotCount = Math.max(1, Math.min(6, existingUrls.length || 1));
            
            // 使用通用函数生成输入行HTML
            var inputsHtml = generateInputRowsHtml({
                existingUrls: existingUrls,
                slotCount: summonSlotCount,
                labelPrefix: '召唤石',
                inputClass: 'summon-url-input',
                previewClass: 'summon-input-preview'
            });
            
            modal.innerHTML = 
                generateHelpTooltipHtml({ wikiType: '召唤石' }) +
                '<h3>编辑召唤石 (' + colId + '列)</h3>' +
                '<div class="top-buttons">' +
                    '<button class="wiki-btn wiki-warning" onclick="window.open(\'https://gbf.huijiwiki.com/wiki/SSR%E5%8F%AC%E5%94%A4%E7%9F%B3\',\'_blank\')">🔗 wiki拖入召唤石</button>' +
                    '<button class="wiki-btn" onclick="window.open(\'https://game.granbluefantasy.jp/#party/index/0/npc/0\',\'_blank\')">🔗 编队拖入图片</button>' +
                '</div>' +
                '<label style="margin-top:10px;display:block;">召唤石图标:</label>' +
                '<div class="skill-inputs-container" id="summonInputsContainer">' + inputsHtml + '</div>' +
                '<div class="hint">留空 = 删除该位置的召唤石（最多6个）</div>' +
                '<div class="btn-row">' +
                    '<button class="btn-secondary" id="summonAddCancel">取消</button>' +
                    '<button class="btn-primary" id="summonAddConfirm">确定保存</button>' +
                '</div>';
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // 使用通用函数设置帮助按钮
            setupHelpButton(modal);
            
            // 使用通用函数绑定输入框事件（粘贴、拖拽、预览）
            bindModalInputEvents(modal, 'summon-url-input');
            
            // 使用通用函数设置 +/- 按钮
            setupInputRowButtons(modal, 'summonInputsContainer', 'summon-url-input', 'summon-input-preview', '召唤石', 6, 1);
            
            var close = function(){
                overlay.remove();
                modal.remove();
            };
            
            var confirmSave = function(){
                // 收集所有非空URL
                var newUrls = [];
                modal.querySelectorAll('.summon-url-input').forEach(function(input){
                    var url = input.value.trim();
                    if(url) newUrls.push(url);
                });
                
                // 清空现有召唤石图标
                var existingBoxes = cell.querySelectorAll('.skill-box');
                existingBoxes.forEach(function(box){box.remove();});
                
                // 保留坐标和添加按钮
                var coord = cell.querySelector('.coord');
                var addBtn = cell.querySelector('.mini-fab');
                cell.innerHTML = '';
                if(coord) cell.appendChild(coord);
                
                // 添加新召唤石图标
                newUrls.forEach(function(url){
                    var box = createSkillBox(url, {
                        className: 'skill-box summon-box skill-source',
                        isSummon: true,
                        editable: true,
                        deletable: true,
                        sourceType: 'summon',
                        dragImageSize: 20
                    });
                    cell.appendChild(box);
                });
                
                // 重新添加添加按钮
                if(addBtn){
                    cell.appendChild(addBtn);
                }else{
                    var newAddBtn = document.createElement('button');
                    newAddBtn.className = 'mini-fab add';
                    newAddBtn.innerHTML = '+';
                    newAddBtn.title = '添加召唤石';
                    newAddBtn.onclick = function(){ showQuickAddSummon(cell); };
                    cell.appendChild(newAddBtn);
                }
                
                saveToStorage();
                
                // 更新召唤石空状态 (修复版 - 支持换人行坐标)
                var coordEl = cell.querySelector('.coord');
                if (coordEl) {
                    var coordText = coordEl.textContent;
                    // [修复] 正则改为支持 'SRC1' 这样的坐标
                    var match = coordText.match(/\(([\w\d]+),([A-Z\-]+)\)/);
                    if (match) {
                        var rowId = match[1]; // 例如 '1' 或 'SRC1'
                        var colId = match[2]; // 例如 'A-B'
                        
                        // 判断是否为换人行 (SRC开头)
                        if (rowId.startsWith('SRC')) {
                            if (window.updateSwapSummonEmptyState) {
                                window.updateSwapSummonEmptyState(cell);
                            }
                        } else {
                            // 普通行
                            var config = summonConfigs.find(function(c) {
                                return c.coord === colId;
                            });
                            if (config) {
                                window.updateSummonEmptyState(colId, config.maxCount, config.showButton);
                            }
                        }
                    }
                }
                
                close();
            };
            
            overlay.onclick = close;
            modal.querySelector('#summonAddCancel').onclick = close;
            modal.querySelector('#summonAddConfirm').onclick = confirmSave;
            
            // 聚焦第一个输入框
            modal.querySelector('.summon-url-input').focus();
        }
        
        // ========== 通用函数：更新角色空状态（全局作用域）==========
        // [修改] 修复图片 display:none 导致不显示的问题
        window.updateCharEmptyState = function(charHeader, config) {
            if (!charHeader) return;
            
            var img = charHeader.querySelector('img');
            var isEmpty = !isValidImage(img);
            var existingHint = charHeader.querySelector('.empty-state-hint');
            
            if (isEmpty) {
                // [修复] 如果为空，隐藏 img 标签，防止显示破碎图标
                if(img) img.style.display = 'none';
                charHeader.classList.add('has-empty-state');
                if (!existingHint) {
                    var wikiUrl = config.coord === '(0,E)' 
                        ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95'
                        : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
                    var hint = createEmptyHint({
                        className: 'empty-state-hint',
                        text: '拖入' + config.name + '图片',
                        buttons: [
                            { text: '🔗 Wiki查询', url: wikiUrl },
                            { text: '🔗 编队查询', url: 'https://game.granbluefantasy.jp/#party/index/0/npc/0' }
                        ]
                    });
                    charHeader.appendChild(hint);
                }
            } else {
                // [修复] 关键点：如果有图片，强制显示图片！
                if(img) img.style.display = '';
                charHeader.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== 通用函数：更新技能源空状态（全局作用域）==========
        window.updateSkillSourceEmptyState = function(skillCoord) {
            var skillSourceCell = findSkillSourceCell(skillCoord);
            if (!skillSourceCell) return;
            
            var isEmpty = !hasValidImages(skillSourceCell, '.skill-box img');
            var existingHint = skillSourceCell.querySelector('.empty-state-hint');
            
            if (isEmpty) {
                skillSourceCell.classList.add('has-empty-state');
                if(!existingHint) {
                    var hint = createEmptyHint({
                        className: 'empty-state-hint',
                        text: '拖入技能图片<br>(最多10个)',
                        buttons: []
                    });
                    skillSourceCell.appendChild(hint);
                }
            } else {
                skillSourceCell.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== 辅助函数：通过坐标更新角色空状态 ==========
        window.updateCharEmptyStateByCoord = function(coordText) {
            var config = characterConfigs.find(function(c) {
                return c.coord === coordText;
            });
            if (config) {
                var charHeader = Array.from(document.querySelectorAll('.character-header')).find(function(th) {
                    var coord = th.querySelector('.coord-header');
                    return coord && coord.textContent.includes(coordText);
                });
                if (charHeader) {
                    window.updateCharEmptyState(charHeader, config);
                }
            }
        };
        
        // ========== 通用函数：更新召唤石空状态（全局作用域）==========
        window.updateSummonEmptyState = function(summonCoord, maxCount, showButton) {
            var summonCell = findSkillSourceCell(summonCoord);
            if (!summonCell) return;
            
            var isEmpty = !hasValidImages(summonCell, '.skill-box img');
            var existingHint = summonCell.querySelector('.empty-state-hint, .summon-empty-state-hint');
            
            if (isEmpty) {
                summonCell.classList.add('has-empty-state');
                if(!existingHint) {
                    var buttons = showButton ? [
                        { text: '🔗 Wiki查询', url: 'https://gbf.huijiwiki.com/wiki/SSR%E5%8F%AC%E5%94%A4%E7%9F%B3' },
                        { text: '🔗 编队查询', url: 'https://game.granbluefantasy.jp/#party/index/0/npc/0' }
                    ] : [];
                    
                    var hint = createEmptyHint({
                        className: 'summon-empty-state-hint',
                        text: '拖入召唤石图片<br>(最多' + maxCount + '个)',
                        textClass: 'summon-empty-text',
                        buttonsClass: 'summon-empty-buttons summon-empty-buttons-vertical',
                        buttons: buttons
                    });
                    summonCell.appendChild(hint);
                }
            } else {
                summonCell.classList.remove('has-empty-state');
                if (existingHint) {
                    existingHint.remove();
                }
            }
        };
        
        // ========== 通用函数：更新角色头像空状态（全局作用域）==========
        window.updateCharacterEmptyState = function(characterCoord) {
            var characterHeader = findCharacterHeader(characterCoord);
            if (!characterHeader) return;
            
            var characterImg = characterHeader.querySelector('img');
            var isEmpty = !isValidImage(characterImg);
            var existingHint = characterHeader.querySelector('.empty-state-hint');
            
            if (isEmpty && !existingHint) {
                var isMainChar = (characterCoord === 'E');
                var wikiUrl = isMainChar ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95' : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
                var wikiText = isMainChar ? '🔗 Wiki查询职业' : '🔗 Wiki查询';
                var emptyText = isMainChar ? '拖入职业图片' : '拖入角色图片';
                
                var hint = createEmptyHint({
                    className: 'empty-state-hint',
                    text: emptyText,
                    buttons: [
                        { text: wikiText, url: wikiUrl },
                        { text: '🔗 编队查询', url: 'https://game.granbluefantasy.jp/#party/index/0/npc/0' }
                    ]
                });
                characterHeader.appendChild(hint);
                characterHeader.classList.add('has-empty-state');
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                characterHeader.classList.remove('has-empty-state');
            }
        };
        
        // ========== 通用函数：更新BOSS栏空状态（全局作用域）==========
        window.updateBossEmptyState = function() {
            var topRows = document.querySelectorAll('.top-row');
            if (!topRows[0]) return;
            
            var bossTh = topRows[0].querySelector('th');
            if (!bossTh) return;
            
            var bossImg = bossTh.querySelector('img');
            var isEmpty = !isValidImage(bossImg);
            var existingHint = bossTh.querySelector('.boss-empty-state-hint');
            
            if (isEmpty && !existingHint) {
                var hint = createEmptyHint({
                    className: 'boss-empty-state-hint',
                    text: '拖入BOSS图片',
                    textClass: 'boss-empty-text',
                    buttonsClass: 'boss-empty-buttons',
                    buttons: [{ text: '🔗 Wiki查询BOSS', url: 'https://gbf.huijiwiki.com/wiki/BOSS%E5%88%97%E8%A1%A8' }]
                });
                var wikiBtn = hint.querySelector('.wiki-btn-small');
                if (wikiBtn) wikiBtn.className = 'wiki-btn';
                bossTh.appendChild(hint);
                if (bossImg) bossImg.style.display = 'none';
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                if (bossImg) bossImg.style.display = '';
            }
        };
        
        // ========== 通用函数：更新备注单元格空状态（已禁用）==========
        window.updateNoteEmptyState = function(noteCell) {
            // 功能已禁用 - 不再显示"点击编辑"提示
        };
        
        // ========== 初始化所有备注单元格的空状态（已禁用）==========
        window.initNoteEmptyStates = function() {
            // 功能已禁用
        };
        
        // ========== 通用的不可删除文字设置函数 ==========
        function setupUndeletableText(textSpan, defaultName) {
            if (!textSpan) return;
            
            if (textSpan.textContent.trim() === '') {
                textSpan.textContent = defaultName;
            }
            
            // 使用 onblur 替代 addEventListener 防止重复绑定
            textSpan.onblur = function() {
                var text = this.textContent.trim();
                if (text === '') {
                    this.textContent = defaultName;
                    saveToStorage();
                }
            };
            
            textSpan.oninput = function() {
                var text = this.textContent.trim();
                var self = this;
                if (text === '') {
                    setTimeout(function() {
                        if (self.textContent.trim() === '') {
                            self.textContent = defaultName;
                            saveToStorage();
                        }
                    }, 5000);
                }
            };
        }
        
        // 暴露给全局使用
        window.setupUndeletableText = setupUndeletableText;
        
        // ========== [重构] 初始化动态元素函数 ==========
        // 此函数包含原 window.onload 中的大部分逻辑，可在页面加载和切换模板时重复调用
        function initDynamicElements() {
            // 0. 为所有单元格添加 data-col 属性（用于智能高亮系统）
            initColumnDataAttributes();
            
            // 1. 为所有符合条件的单元格添加按钮（包括D列）
            document.querySelectorAll('tbody td').forEach(function(cell){
                addCellButtons(cell);
            });
            
            // 2. 为所有 I 列 (6人) 或 M 列 (9人) 添加行控面板 (合并/拆分)
            document.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                // [修改] 增加对 M 列的判断
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });
            
            // 3. 调整召唤石删除按钮位置
            setTimeout(function() { adjustAllSummonDeleteButtons(); }, 100);
            
            // 4. 角色头像双击编辑
            document.querySelectorAll('.character-header').forEach(function(th){
                th.style.cursor = 'pointer';
                // 移除旧的监听器，使用 ondblclick 替代 addEventListener 防止重复绑定
                th.ondblclick = function(e){
                    if(e.target.closest('.t-text')) return;
                    e.stopPropagation();
                    showQuickAddCharacter(this);
                };
            });
            
            // 5. 初始化不可删除的文字
            // 5.1 0A-0D 表头
            var headerConfigs = [
                { coord: '(0,A)', name: '阶段/HP' },
                { coord: '(0,B)', name: '触发/回合' },
                { coord: '(0,C)', name: '备注' },
                { coord: '(0,D)', name: '召唤石' }
            ];
            
            headerConfigs.forEach(function(config) {
                var headerTh = Array.from(document.querySelectorAll('thead th')).find(function(th) {
                    var coordEl = th.querySelector('.coord-header');
                    return coordEl && coordEl.textContent.includes(config.coord);
                });
                if (headerTh) {
                    var textSpan = headerTh.querySelector('.t-text');
                    if(textSpan && window.setupUndeletableText) window.setupUndeletableText(textSpan, config.name);
                }
            });
            
            // 5.2 阶段名和T
            document.querySelectorAll('.t-text.phase-name').forEach(function(textSpan) {
                if(window.setupUndeletableText) window.setupUndeletableText(textSpan, '阶段状态');
            });
            document.querySelectorAll('.b-cell-content .t-text').forEach(function(textSpan) {
                if(window.setupUndeletableText) window.setupUndeletableText(textSpan, 'T');
            });
            
            // 6. 为角色栏初始化：删除按钮、空状态、拖拽
            characterConfigs.forEach(function(config) {
                var charHeader = Array.from(document.querySelectorAll('.character-header')).find(function(th) {
                    var coord = th.querySelector('.coord-header');
                    return coord && coord.textContent.includes(config.coord);
                });
                
                if (!charHeader) return;
                
                // 6.1 添加删除按钮
                if (!charHeader.querySelector('.delete-char-btn')) {
                    var deleteBtn = document.createElement('button');
                    deleteBtn.className = 'mini-fab delete delete-char-btn';
                    deleteBtn.innerHTML = '−';
                    deleteBtn.title = '清空' + config.name + '、技能源及文字';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (!confirm('确定要重置' + config.name + '的所有内容吗？')) return;
                        
                        var img = charHeader.querySelector('img');
                        if (img) img.src = EMPTY_IMAGE_SRC;
                        
                        var nameSpan = charHeader.querySelector('.char-name');
                        if (nameSpan) nameSpan.textContent = config.name;
                        
                        var skillSourceRow = document.querySelector('.skill-source-row');
                        if (skillSourceRow) {
                            var skillCells = skillSourceRow.querySelectorAll('td');
                            skillCells.forEach(function(cell) {
                                var coordEl = cell.querySelector('.coord');
                                if (coordEl) {
                                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                    if (match && match[2] === config.skillCoord) {
                                        cell.querySelectorAll('.skill-box').forEach(function(b) { b.remove(); });
                                    }
                                }
                            });
                        }
                        
                        saveToStorage();
                        window.updateCharEmptyState(charHeader, config);
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    };
                    charHeader.appendChild(deleteBtn);
                }
                
                // 6.2 确保角色名存在
                var charNameSpan = charHeader.querySelector('.char-name');
                if (!charNameSpan) {
                    charNameSpan = document.createElement('span');
                    charNameSpan.className = 'header-text t-text char-name';
                    charNameSpan.setAttribute('contenteditable', 'true');
                    charNameSpan.setAttribute('onblur', 'saveToStorage()');
                    charNameSpan.textContent = config.name;
                    var editBtn = charHeader.querySelector('.mini-fab.edit, .btn-edit-glass');
                    if (editBtn) {
                        charHeader.insertBefore(charNameSpan, editBtn);
                    } else {
                        charHeader.appendChild(charNameSpan);
                    }
                }
                
                if (charNameSpan.textContent.trim() === '') {
                    charNameSpan.textContent = config.name;
                }
                
                // 6.3 绑定外部拖拽 (使用 on* 属性防止重复绑定)
                charHeader.classList.add('drag-drop-zone');
                charHeader.ondragover = function(e) { e.preventDefault(); this.classList.add('drag-over'); };
                charHeader.ondragleave = function(e) { this.classList.remove('drag-over'); };
                charHeader.ondrop = function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('不支持本地文件，请使用在线图片URL');
                        return;
                    }
                    if (url) {
                        var img = this.querySelector('img');
                        if (img) {
                            img.src = url;
                        } else {
                            img = document.createElement('img');
                            img.src = url;
                            var br = this.querySelector('br');
                            if (br) this.insertBefore(img, br.nextSibling);
                            else this.appendChild(img);
                        }
                        saveToStorage();
                        window.updateCharEmptyState(charHeader, config);
                    }
                };
                
                // 6.4 初始化空状态
                window.updateCharEmptyState(charHeader, config);
                window.updateSkillSourceEmptyState(config.skillCoord);
            });
            
            // 7. 技能源格子的拖拽
            characterConfigs.forEach(function(config) {
                var skillSourceCell = null;
                var skillSourceRow = document.querySelector('.skill-source-row');
                if (skillSourceRow) {
                    var skillCells = skillSourceRow.querySelectorAll('td');
                    skillCells.forEach(function(cell) {
                        var coordEl = cell.querySelector('.coord');
                        if (coordEl) {
                            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                            if (match && match[2] === config.skillCoord) {
                                skillSourceCell = cell;
                            }
                        }
                    });
                }
                
                if (!skillSourceCell) return;
                
                skillSourceCell.classList.add('drag-drop-zone');
                skillSourceCell.ondragover = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (isExternal) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    }
                };
                skillSourceCell.ondragleave = function(e) { this.classList.remove('drag-over'); };
                skillSourceCell.ondrop = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (!isExternal) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('drag-over');
                    
                    var currentCount = this.querySelectorAll('.skill-box').length;
                    if (currentCount >= 10) {
                        alert('技能已达上限（10个），请先删除部分技能');
                        return;
                    }
                    
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('不支持本地文件，请使用在线图片URL');
                        return;
                    }
                    
                    if (url) {
                        var box = createSkillBox(url, {
                            className: 'skill-box skill-source',
                            size: 40,
                            editable: true,
                            deletable: true,
                            sourceType: 'skill',
                            dragImageSize: 20
                        });
                        this.appendChild(box);
                        saveToStorage();
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    }
                };
            });
            
            // 8. 召唤石配置初始化
            summonConfigs.forEach(function(config) {
                var summonCell = null;
                var skillSourceRow = document.querySelector('.skill-source-row');
                if (skillSourceRow) {
                    var cells = skillSourceRow.querySelectorAll('td');
                    cells.forEach(function(cell) {
                        var coordEl = cell.querySelector('.coord');
                        if (coordEl) {
                            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                            if (match && match[2] === config.coord) {
                                summonCell = cell;
                            }
                        }
                    });
                }
                
                if (!summonCell) return;
                
                // 8.1 添加删除按钮
                if (!summonCell.querySelector('.delete-char-btn')) {
                    var db = document.createElement('button');
                    db.className = 'mini-fab delete delete-char-btn';
                    db.innerHTML = '−';
                    db.title = '清空' + config.name;
                    db.style.left = '2px';
                    db.style.top = '2px';
                    db.onclick = function(e) {
                        e.stopPropagation();
                        if (confirm('确定要清空' + config.name + '吗？')) {
                            summonCell.querySelectorAll('.skill-box').forEach(function(b) { b.remove(); });
                            saveToStorage();
                            window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                        }
                    };
                    summonCell.appendChild(db);
                    summonCell.classList.add('has-fab');
                }
                
                // 8.2 外部拖拽功能
                summonCell.classList.add('drag-drop-zone');
                summonCell.ondragover = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (isExternal) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    }
                };
                summonCell.ondragleave = function(e) { this.classList.remove('drag-over'); };
                summonCell.ondrop = function(e) {
                    var types = e.dataTransfer.types;
                    var isExternal = types.includes('Files') || types.includes('text/html');
                    if (!isExternal) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('drag-over');
                    
                    var currentCount = this.querySelectorAll('.skill-box').length;
                    if (currentCount >= config.maxCount) {
                        alert('召唤石已达上限（' + config.maxCount + '个），请先删除部分召唤石');
                        return;
                    }
                    
                    var url = '';
                    if (e.dataTransfer.getData('text/html')) {
                        var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                        if (match) url = match[1];
                    }
                    if (!url && e.dataTransfer.getData('text/plain')) {
                        var text = e.dataTransfer.getData('text/plain').trim();
                        if (text.match(/^https?:\/\//i)) url = text;
                    }
                    if (!url && e.dataTransfer.files.length > 0) {
                        alert('不支持本地文件，请使用在线图片URL');
                        return;
                    }
                    
                    if (url) {
                        var box = createSkillBox(url, {
                            className: 'skill-box summon-box skill-source',
                            isSummon: true,
                            editable: true,
                            deletable: true,
                            sourceType: 'summon',
                            dragImageSize: 20
                        });
                        var addBtn = this.querySelector('.mini-fab.add');
                        if (addBtn) this.insertBefore(box, addBtn);
                        else this.appendChild(box);
                        saveToStorage();
                        window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                    }
                };
                
                // 8.3 初始化空状态
                window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
            });
            
            // 9. 召唤石双击快速添加
            // [修复] 只为主表头的召唤石格绑定双击事件，换人行由 initSwapRowElements 处理
            document.querySelectorAll('.skill-source-row:not(.swap-source-row) td').forEach(function(cell){
                var coordEl = cell.querySelector('.coord');
                if(coordEl){
                    var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if(match){
                        var col = match[2];
                        if(col === 'A-B' || col === 'C'){
                            cell.style.cursor = 'pointer';
                            cell.ondblclick = function(e){
                                if(e.target.tagName === 'IMG') return;
                                e.stopPropagation();
                                showQuickAddSummon(this);
                            };
                        }
                    }
                }
            });
            
            // 10. BOSS栏初始化
            if(window.updateBossEmptyState) window.updateBossEmptyState();
            
            // 10.5 备注单元格空状态初始化
            if(window.initNoteEmptyStates) window.initNoteEmptyStates();
            
            // 11. BOSS栏拖拽
            var topRows = document.querySelectorAll('.top-row');
            if(topRows[0]){
                var bossTh = topRows[0].querySelector('th');
                if(bossTh){
                    bossTh.classList.add('drag-drop-zone');
                    bossTh.ondragover = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (isExternal) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        }
                    };
                    bossTh.ondragleave = function(e) { this.classList.remove('drag-over'); };
                    bossTh.ondrop = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (!isExternal) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');
                        
                        var url = '';
                        if (e.dataTransfer.getData('text/html')) {
                            var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                            if (match) url = match[1];
                        }
                        if (!url && e.dataTransfer.getData('text/plain')) {
                            var text = e.dataTransfer.getData('text/plain').trim();
                            if (text.match(/^https?:\/\//i)) url = text;
                        }
                        if (!url && e.dataTransfer.files.length > 0) {
                            alert('不支持本地文件，请使用在线图片URL');
                            return;
                        }
                        
                        if (url) {
                            var bossImg = this.querySelector('img');
                            if(bossImg) bossImg.src = url;
                            saveToStorage();
                            if(window.updateBossEmptyState) window.updateBossEmptyState();
                        }
                    };
                }
            }
            
            // 12. 状态图标行拖拽
            if(topRows[1]){
                var statusTh = topRows[1].querySelector('th');
                if(statusTh){
                    statusTh.classList.add('drag-drop-zone');
                    statusTh.ondragover = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (isExternal) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        }
                    };
                    statusTh.ondragleave = function(e) { this.classList.remove('drag-over'); };
                    statusTh.ondrop = function(e) {
                        var types = e.dataTransfer.types;
                        var isExternal = types.includes('Files') || types.includes('text/html');
                        if (!isExternal) return;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');
                        
                        var url = '';
                        if (e.dataTransfer.getData('text/html')) {
                            var match = e.dataTransfer.getData('text/html').match(/<img[^>]+src="([^">]+)"/);
                            if (match) url = match[1];
                        }
                        if (!url && e.dataTransfer.getData('text/plain')) {
                            var text = e.dataTransfer.getData('text/plain').trim();
                            if (text.match(/^https?:\/\//i)) url = text;
                        }
                        if (!url && e.dataTransfer.files.length > 0) {
                            alert('不支持本地文件，请使用在线图片URL');
                            return;
                        }
                        
                        if (url) {
                            var box = createSkillBox(url, {
                                className: 'skill-box skill-source',
                                size: 33,
                                editable: true,
                                deletable: true,
                                sourceType: 'status',
                                dragImageSize: 16
                            });
                            var editBtn = this.querySelector('.mini-fab.edit, .btn-edit-glass');
                            if(editBtn) this.insertBefore(box, editBtn);
                            else this.appendChild(box);
                            saveToStorage();
                        }
                    };
                }
            }
            
            // 13. 绑定基本拖拽
            document.querySelectorAll('.skill-source').forEach(function(el){
                bindDragEvents(el, 20);
            });
            // [修复] 排除换人行的格子，避免与 initSwapRowElements 的事件监听器冲突导致双重图标
            document.querySelectorAll('tbody td').forEach(function(cell){
                // 跳过换人行的格子（swap-header-row 和 swap-source-row）
                var parentRow = cell.closest('tr');
                if(parentRow && (parentRow.classList.contains('swap-header-row') || parentRow.classList.contains('swap-source-row'))) {
                    return; // 这些格子由 initSwapRowElements 专门处理
                }
                bindCellEvents(cell);
            });
            
            // 14. 图片双击编辑
            document.querySelectorAll('.skill-source-row img, .top-row img').forEach(function(img){
                img.style.cursor = 'pointer';
                img.ondblclick = function(e){
                    e.stopPropagation();
                    editImageUrl(this);
                };
            });
            
            // 15. 为源技能/召唤石/状态图标添加删除按钮
            initSourceDeleteButtons();
        }
        
        // [新增] 集中管理工具栏按钮状态
        function updateSwapButtonState() {
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            
            // 1. 控制"增加换人行"按钮显隐
            var swapBtn = document.getElementById('btnAddSwapRow');
            if (swapBtn) {
                swapBtn.style.display = is9Man ? 'inline-flex' : 'none';
            }
            
            // 2. 动态更新"重置"按钮的提示
            var resetBtn = document.getElementById('btnReset');
            if (resetBtn) {
                if (is9Man) {
                    resetBtn.setAttribute('data-tooltip', '⚠️ 重置为【9人模式】默认状态');
                } else {
                    resetBtn.setAttribute('data-tooltip', '⚠️ 重置为【6人模式】默认状态');
                }
            }
        }
        
        window.onload=function(){
            loadDefaultFontSize();
            loadIconScale();
            applyDefaultFontSize();
            loadCoordsState();
            
            // 初始化创作者系统
            initAuthorSystem();
            
            // 加载数据
            loadFromStorage();
            
            // 初始化所有动态元素（关键！）
            initDynamicElements();
            
            // [修改] 使用统一函数检查按钮状态
            updateSwapButtonState();
            
            // 监听窗口调整
            window.addEventListener('resize', function() {
                setTimeout(adjustAllSummonDeleteButtons, 100);
            });
            
            // 恢复数据后重新应用字体大小
            applyDefaultFontSize();
        };
        
        function bindCellEvents(cell){
            // 1. 拖拽进入：添加高亮样式
            cell.addEventListener('dragenter', function(e){
                e.preventDefault();
                if(draggedElement || e.dataTransfer.types.length > 0) {
                    this.classList.add('drag-feedback');
                }
            });
            
            // 2. 拖拽悬停：保持允许放置状态
            cell.addEventListener('dragover',function(e){
                e.preventDefault();
                e.dataTransfer.dropEffect='copy';
                if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)){
                    this.classList.add('drag-feedback');
                }
            });
            
            // 3. 拖拽离开：移除高亮样式
            cell.addEventListener('dragleave', function(e){
                if (e.target === this) {
                    this.classList.remove('drag-feedback');
                }
            });
            
            // 4. 放置：移除高亮并处理逻辑
            cell.addEventListener('drop',function(e){
                e.preventDefault();
                this.classList.remove('drag-feedback');
                if(draggedElement){
                    var targetBox=e.target.closest('.skill-box');
                    var clone=draggedElement.cloneNode(true);
                    clone.classList.remove('skill-source');
                    clone.classList.add('has-fab');
                    bindDragEvents(clone, 20);
                    clone.addEventListener('contextmenu',function(ev){ev.preventDefault();this.remove();saveToStorage();});
                    // 添加删除按钮
                    var delBtn = document.createElement('button');
                    delBtn.className = 'mini-fab delete';
                    delBtn.innerHTML = '×';
                    delBtn.title = '删除';
                    delBtn.onclick = function(ev){
                        ev.stopPropagation();
                        clone.remove();
                        saveToStorage();
                    };
                    clone.appendChild(delBtn);
                    
                    // 如果是召唤石，调整删除按钮位置
                    if (clone.classList.contains('summon-box')) {
                        adjustSummonDeleteButton(clone);
                        applyIconScalingToElement(clone);
                    } else {
                        applyIconScalingToElement(clone);
                    }
                    if(targetBox&&!targetBox.classList.contains('skill-source')){
                        targetBox.before(clone);
                    }else{
                        this.appendChild(clone);
                    }
                    if(!draggedElement.classList.contains('skill-source')){var sourceCell=draggedElement.closest('td')||draggedElement.closest('th');if(sourceCell===this){draggedElement.remove();}}
                    saveToStorage();
                }
            });
            
            cell.addEventListener('dblclick',function(e){
                // 双击添加文字功能已由按钮替代
            });
            
            // 为符合条件的单元格添加按钮（函数内部会判断列号）
            addCellButtons(cell);
        }
        
        document.addEventListener('contextmenu',function(e){
            // 原有的技能/文字右键逻辑
            var box=e.target.closest('.skill-box');
            if(box&&!box.classList.contains('skill-source')){e.preventDefault();box.remove();saveToStorage();return;}
            var text=e.target.closest('.user-text');
            if(text){showContextMenu(e,text,'user-text');return;}
            var ttext=e.target.closest('.t-text');
            if(ttext){showContextMenu(e,ttext,'t-text');return;}
        });
        
        function getCellCoord(cell){
            var coord=cell.querySelector('.coord');
            if(coord){
                // 支持 (2,B) 和 (2-6,A) 两种格式
                var match=coord.textContent.match(/\((\d+)(?:-\d+)?,([A-Z\-]+)\)/);
                if(match)return{row:parseInt(match[1]),col:match[2]};
            }
            return null;
        }
        function findCellByCoord(row,col){
            var cells=document.querySelectorAll('tbody td');
            for(var i=0;i<cells.length;i++){
                var c=getCellCoord(cells[i]);
                if(c&&c.col===col){
                    // A列是rowspan单元格，检查row是否在范围内
                    if(col==='A'){
                        var rowspan=parseInt(cells[i].getAttribute('rowspan'))||1;
                        if(row>=c.row&&row<c.row+rowspan)return cells[i];
                    }else if(c.row===row){
                        return cells[i];
                    }
                }
            }
            return null;
        }
        
        // 获取单元格的行索引(基于DOM位置)
        function getCellRowIndex(cell){
            var row=cell.closest('tr');
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            return rows.indexOf(row);
        }
        
        // 获取单元格的列标识(基于DOM位置)
        // [修改] 列映射扩充到 M 列，支持 9 人模式
        function getCellColId(cell){
            var row=cell.closest('tr');
            var cells=Array.from(row.querySelectorAll('td'));
            var cellIndex=cells.indexOf(cell);
            var hasRowspanCell=row.querySelector('td[rowspan]');
            // 列映射: 有rowspan的行从A开始，没有的从B开始（被rowspan覆盖）
            var cols=['A','B','C','D','E','F','G','H','I','J','K','L','M'];
            if(!hasRowspanCell){
                // 检查是否是被rowspan覆盖的行
                var rowIdx=getCellRowIndex(cell);
                var isInPhase=false;
                var tbody=document.querySelector('tbody');
                var rows=Array.from(tbody.querySelectorAll('tr'));
                for(var i=rowIdx;i>=0;i--){
                    var rs=rows[i].querySelector('td[rowspan]');
                    if(rs){
                        var rowspan=parseInt(rs.getAttribute('rowspan'))||1;
                        if(i+rowspan>rowIdx){isInPhase=true;break;}
                    }
                }
                if(isInPhase){cols=['B','C','D','E','F','G','H','I','J','K','L','M'];}
            }else{
                cols=['A','B','C','D','E','F','G','H','I','J','K','L','M'];
            }
            return cols[cellIndex]||'?';
        }
        
        // 重新计算所有坐标
        // [修改] 列数组扩充到 M 列，支持 6人/9人 模式自适应
        function recalculateAllCoords(){
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            var currentRow=1; // 从第1行开始(第0行是表头)
            var phaseStartRow=currentRow;
            
            rows.forEach(function(row,idx){
                // [修复] 跳过换人行，保留其特殊坐标格式 (SRC1,A-B) 等
                if(row.classList.contains('swap-header-row') || row.classList.contains('swap-source-row')) {
                    return;
                }
                
                var phaseCell=row.querySelector('td[rowspan]');
                if(phaseCell){
                    // 这是阶段起始行
                    phaseStartRow=currentRow+1; // 阶段数据行从下一行开始
                    var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
                    var endRow=currentRow+rowspan;
                    var coordSpan=phaseCell.querySelector('.coord');
                    if(coordSpan){
                        if(rowspan>1){
                            coordSpan.textContent='('+(currentRow+1)+'-'+endRow+',A)';
                        }else{
                            coordSpan.textContent='('+(currentRow+1)+',A)';
                        }
                    }
                }
                // 更新该行所有单元格的坐标
                var cells=Array.from(row.querySelectorAll('td'));
                var colOffset=phaseCell?0:0;
                // [修改] 扩充列数组到 M，JS 会根据 cellIdx 自动取值
                var cols=phaseCell?['A','B','C','D','E','F','G','H','I','J','K','L','M']:['B','C','D','E','F','G','H','I','J','K','L','M'];
                
                cells.forEach(function(cell,cellIdx){
                    if(cell===phaseCell)return; // 跳过阶段单元格
                    var coordSpan=cell.querySelector('.coord');
                    if(coordSpan){
                        var colId=cols[phaseCell?cellIdx:cellIdx];
                        if(colId){
                            coordSpan.textContent='('+(currentRow+1)+','+colId+')';
                        }
                    }
                });
                currentRow++;
            });
        }
        
        function collectData(){
            recalculateAllCoords(); // 先确保坐标是最新的
            // [修复] 增加 mode 字段，保存当前是 6人 还是 9人 模式
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            var data={version:3,mode: is9Man ? 9 : 6,savedAt:new Date().toISOString(),skills:[],texts:[],phases:[],tTexts:[],rows:[],headerImages:[]};
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            
            // 保存行结构
            rows.forEach(function(row,rowIdx){
                // [修复] 跳过换人行，它们由 collectSwapSections 专门处理
                if(row.classList.contains('swap-header-row') || row.classList.contains('swap-source-row')) {
                    return;
                }
                var phaseCell=row.querySelector('td[rowspan]');
                var rowData={index:rowIdx,hasPhase:!!phaseCell};
                if(phaseCell){
                    rowData.rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
                    var phaseName=phaseCell.querySelector('.phase-name');
                    if(phaseName)rowData.phaseName=phaseName.textContent;
                    rowData.phaseClass=row.className||'';
                }
                data.rows.push(rowData);
            });
            
            // 保存技能和文字(使用实际坐标)
            document.querySelectorAll('tbody td').forEach(function(cell){
                // [修复] 跳过换人行的格子，它们由 collectSwapSections 专门处理
                var parentRow = cell.closest('tr');
                if(parentRow && (parentRow.classList.contains('swap-header-row') || parentRow.classList.contains('swap-source-row'))) {
                    return;
                }
                var coord=getCellCoord(cell);if(!coord)return;
                cell.querySelectorAll('.skill-box:not(.skill-source)').forEach(function(box){
                    var img=box.querySelector('img');
                    // 只保存有效的图片（有 src 且不为空，且不是占位符图片）
                    if(img && img.src && img.src.trim() && img.src !== EMPTY_IMAGE_SRC){
                        data.skills.push({row:coord.row,col:coord.col,imgSrc:img.src});
                    }
                });
                cell.querySelectorAll('.user-text').forEach(function(txt){
                    // 只保存非空文字
                    if(txt.textContent && txt.textContent.trim()){
                        data.texts.push({row:coord.row,col:coord.col,text:txt.textContent,color:txt.style.color||"",bold:txt.style.fontWeight==="bold",fontSize:txt.style.fontSize||""});
                    }
                });
            });
            
            // 保存阶段信息 - 改进版：保存每个阶段的详细行信息
            var phaseDetails = [];
            document.querySelectorAll('td[rowspan]').forEach(function(cell, phaseIndex){
                var rs=parseInt(cell.getAttribute('rowspan'));
                var phaseName=cell.querySelector('.phase-name');
                var phaseRow = cell.closest('tr');
                var tbody = document.querySelector('tbody');
                var allRows = Array.from(tbody.querySelectorAll('tr'));
                var phaseRowIndex = allRows.indexOf(phaseRow);
                
                // 收集这个阶段内所有行的信息
                var phaseRowsInfo = [];
                for(var i = 0; i < rs; i++){
                    var currentRow = allRows[phaseRowIndex + i];
                    if(currentRow){
                        var rowCoord = null;
                        var bCell = currentRow.querySelector('td:not([rowspan])');
                        if(bCell){
                            var coordEl = bCell.querySelector('.coord');
                            if(coordEl){
                                var match = coordEl.textContent.match(/\((\d+),B\)/);
                                if(match) rowCoord = parseInt(match[1]);
                            }
                        }
                        
                        var rowText = '';
                        var tTextEl = bCell ? bCell.querySelector('.t-text') : null;
                        if(tTextEl) rowText = tTextEl.textContent;
                        
                        phaseRowsInfo.push({
                            index: i,
                            coord: rowCoord,
                            text: rowText,
                            exists: true
                        });
                    }
                }
                
                phaseDetails.push({
                    name: phaseName ? phaseName.textContent : '',
                    rowspan: rs,
                    rows: phaseRowsInfo,
                    className: phaseRow.className || ''
                });
            });
            data.phases = phaseDetails;
            
            // 保存T数文字(使用实际坐标)，包括表头
            document.querySelectorAll('.t-text').forEach(function(el){
                var cell=el.closest('td')||el.closest('th');
                if(!cell)return;
                var coord=null;
                var coordEl=cell.querySelector('.coord')||cell.querySelector('.coord-header');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+)(?:-\d+)?,([A-Z\-]+)\)/);
                    if(match)coord={row:parseInt(match[1]),col:match[2]};
                }
                if(coord){
                    data.tTexts.push({
                        row:coord.row,
                        col:coord.col,
                        text:el.textContent,
                        fontSize:el.style.fontSize||"",
                        color:el.style.color||"",
                        customSize:el.hasAttribute('data-custom-size'),
                        customColor:el.hasAttribute('data-custom-color'),
                        isHeader:!!el.closest('th')
                    });
                }
            });
            
            // 保存表头图片URL（角色头像、技能源、BOSS图、状态图标）
            // [修复] 限制选择器只获取 thead 中的角色头像，避免获取到换人行的 td 导致 closest('th') 报错
            document.querySelectorAll('thead .character-header img').forEach(function(img){
                var th=img.closest('th');
                if(!th) return; // 双重保险
                var coordEl=th.querySelector('.coord-header');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                    if(match){
                        // 只保存有效图片，过滤掉空的base64图片
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                            data.headerImages.push({
                                type:'character',
                                row:parseInt(match[1]),
                                col:match[2],
                                src:img.src
                            });
                        }
                    }
                }
            });
            
            // [优化] 只收集主表头的技能源，换人行的技能源在 swapSections 中单独处理
            document.querySelectorAll('thead .skill-source-row img').forEach(function(img){
                var cell=img.closest('td');
                var coordEl=cell.querySelector('.coord');
                if(coordEl){
                    var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                    if(match){
                        var skillBox=img.closest('.skill-box');
                        var index=Array.from(cell.querySelectorAll('.skill-box img')).indexOf(img);
                        // 只保存有效图片，过滤掉空的base64图片
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                            data.headerImages.push({
                                type:'skill-source',
                                row:parseInt(match[1]),
                                col:match[2],
                                index:index,
                                src:img.src
                            });
                        }
                    }
                }
            });
            
            // 保存BOSS图和状态图标
            var topRows = document.querySelectorAll('.top-row');
            topRows.forEach(function(row, rowIndex){
                if(rowIndex === 0){
                    // BOSS图行 - 只有一张图片
                    var bossImg = row.querySelector('th > img');
                    if(bossImg && bossImg.src && bossImg.src !== EMPTY_IMAGE_SRC && bossImg.src.trim() !== ''){
                        data.headerImages.push({
                            type: 'boss-image',
                            src: bossImg.src
                        });
                    }
                } else if(rowIndex === 1){
                    // 状态图标行 - 多个 skill-box
                    row.querySelectorAll('.skill-box img').forEach(function(img, imgIndex){
                        if(img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== ''){
                            data.headerImages.push({
                                type: 'status-icon',
                                index: imgIndex,
                                src: img.src
                            });
                        }
                    });
                }
            });
            
            // [新增] 保存换人行数据 (含位置信息)
            data.swapSections = [];
            var swapHeaderRows = document.querySelectorAll('.swap-header-row');
            var allTbodyRows = Array.from(document.querySelector('tbody').querySelectorAll('tr'));
            
            swapHeaderRows.forEach(function(headerRow, swapIndex) {
                var swapId = headerRow.getAttribute('data-swap-id') || ('swap-' + swapIndex);
                var sourceRow = document.querySelector('.swap-source-row[data-swap-id="' + swapId + '"]');
                
                // [新增] 计算换人行在表格中的位置（排除其他换人行后的索引）
                var rowIndexInTable = 0;
                for(var i = 0; i < allTbodyRows.length; i++) {
                    var row = allTbodyRows[i];
                    if(row === headerRow) break;
                    // 只计算非换人行
                    if(!row.classList.contains('swap-header-row') && !row.classList.contains('swap-source-row')) {
                        rowIndexInTable++;
                    }
                }
                
                var swapData = {
                    id: swapId,
                    index: swapIndex,
                    characters: [],
                    skills: [],
                    // [新增] 位置信息：换人行前面有多少个普通数据行
                    positionIndex: rowIndexInTable
                };
                
                // 保存角色头像和名称
                headerRow.querySelectorAll('.swap-char-cell').forEach(function(cell, cellIndex) {
                    var coordEl = cell.querySelector('.coord-header');
                    var img = cell.querySelector('img');
                    var nameEl = cell.querySelector('.char-name');
                    var coord = '';
                    if(coordEl) {
                        var match = coordEl.textContent.match(/\((SW\d+),([A-Z])\)/);
                        if(match) coord = match[2];
                    }
                    
                    var charData = {
                        col: coord,
                        index: cellIndex,
                        name: nameEl ? nameEl.textContent : '',
                        src: ''
                    };
                    
                    if(img && img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                        charData.src = img.src;
                    }
                    
                    swapData.characters.push(charData);
                });
                
                // 保存技能源图片
                if(sourceRow) {
                    sourceRow.querySelectorAll('.source-cell').forEach(function(cell, cellIndex) {
                        var coordEl = cell.querySelector('.coord');
                        var coord = '';
                        if(coordEl) {
                            var match = coordEl.textContent.match(/\((SRC\d+),([A-Z\-]+)\)/);
                            if(match) coord = match[2];
                        }
                        
                        // [修复] 跳过 D 列，因为 FC 图标是固定的，不需要保存
                        if(coord === 'D') return;
                        
                        cell.querySelectorAll('.skill-box img').forEach(function(img, imgIndex) {
                            if(img && img.src && img.src !== EMPTY_IMAGE_SRC && img.src.trim() !== '') {
                                swapData.skills.push({
                                    col: coord,
                                    cellIndex: cellIndex,
                                    imgIndex: imgIndex,
                                    src: img.src
                                });
                            }
                        });
                    });
                }
                
                data.swapSections.push(swapData);
            });
            
            // [新增] 保存创作者信息
            var finalHistory = [...AuthorSystem.history];
            var currentAuthor = AuthorSystem.currentAuthor;
            // 如果当前作者不是访客，且不在历史记录的最后一位，则加入
            if (currentAuthor !== '访客' && currentAuthor !== 'Guest' && finalHistory[finalHistory.length - 1] !== currentAuthor) {
                finalHistory.push(currentAuthor);
            }
            data.metadata = {
                authors: finalHistory,
                lastEditor: currentAuthor
            };
            
            return data;
        }
        
        function restoreData(data){
            // 先恢复行结构 - 改进版：根据详细的行信息恢复
            if(data.phases && data.phases.length > 0){
                var existingPhaseCells = document.querySelectorAll('td[rowspan]');
                var existingCount = existingPhaseCells.length;
                var targetCount = data.phases.length;
                
                // 如果需要更多阶段，先创建新阶段
                if(targetCount > existingCount){
                    for(var i = 0; i < targetCount - existingCount; i++){
                        // 临时创建新阶段（不保存）- 在最后一个阶段后面插入
                        var tbody = document.querySelector('tbody');
                        var lastPhaseCell = tbody.querySelector('tr:last-child td[rowspan]') || tbody.querySelector('td[rowspan]:last-of-type');
                        var phaseRow = document.createElement('tr');
                        phaseRow.className = 'phase-100-80';
                        // [修复] 使用 getDataCellsHtml 动态生成列，支持 9 人模式
                        var extraCells = getDataCellsHtml(0);
                        phaseRow.innerHTML = '<td rowspan="1"><span class="coord">(0,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">阶段状态</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td><td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;
                        tbody.appendChild(phaseRow);
                        phaseRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
                        // 绑定不可删除逻辑
                        var phaseName = phaseRow.querySelector('.t-text.phase-name');
                        if(phaseName && window.setupUndeletableText) window.setupUndeletableText(phaseName, '阶段状态');
                        var bText = phaseRow.querySelector('.b-cell-content .t-text');
                        if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
                    }
                }
                // 如果需要更少阶段，删除多余阶段
                else if(targetCount < existingCount){
                    var phaseCells = document.querySelectorAll('td[rowspan]');
                    for(var i = existingCount - 1; i >= targetCount; i--){
                        var phaseCell = phaseCells[i];
                        if(phaseCell){
                            var phaseRow = phaseCell.closest('tr');
                            var rowspan = parseInt(phaseCell.getAttribute('rowspan')) || 1;
                            var tbody = document.querySelector('tbody');
                            var rows = Array.from(tbody.querySelectorAll('tr'));
                            var phaseIndex = rows.indexOf(phaseRow);
                            // 删除该阶段的所有行
                            for(var j = rowspan - 1; j >= 0; j--){
                                var rowToDelete = rows[phaseIndex + j];
                                if(rowToDelete && !rowToDelete.classList.contains('add-phase-row')){
                                    rowToDelete.remove();
                                }
                            }
                        }
                    }
                }
                
                // 重新获取阶段单元格
                var cells = document.querySelectorAll('td[rowspan]');
                
                data.phases.forEach(function(phaseData, phaseIndex){
                    if(cells[phaseIndex]){
                        var currentRs = parseInt(cells[phaseIndex].getAttribute('rowspan')) || 1;
                        var targetRs = phaseData.rowspan;
                        
                        // 如果需要更多行，添加行
                        if(targetRs > currentRs){
                            var diff = targetRs - currentRs;
                            for(var i = 0; i < diff; i++){
                                var btn = cells[phaseIndex].querySelector('.phase-btn');
                                if(btn) addRowToPhaseNoSave(btn);
                            }
                        }
                        // 如果需要更少行，删除行
                        else if(targetRs < currentRs){
                            var phaseRow = cells[phaseIndex].closest('tr');
                            var tbody = document.querySelector('tbody');
                            var allRows = Array.from(tbody.querySelectorAll('tr'));
                            var phaseRowIndex = allRows.indexOf(phaseRow);
                            
                            // 从后往前删除多余的行
                            var diff = currentRs - targetRs;
                            for(var i = 0; i < diff; i++){
                                var rowToDelete = allRows[phaseRowIndex + currentRs - 1 - i];
                                if(rowToDelete && !rowToDelete.querySelector('td[rowspan]')){
                                    rowToDelete.remove();
                                }
                            }
                            
                            // 更新rowspan
                            cells[phaseIndex].setAttribute('rowspan', targetRs);
                        }
                        
                        // 恢复阶段名称
                        var phaseName = cells[phaseIndex].querySelector('.phase-name');
                        if(phaseName && phaseData.name){
                            phaseName.textContent = phaseData.name;
                        }
                    }
                });
            }
            
            // 重新计算坐标
            recalculateAllCoords();
            
            // 清空已放置的技能和文字
            clearAllSilent();
            
            // 恢复T数文字
            if(data.tTexts){
                data.tTexts.forEach(function(t){
                    var cell=null;
                    if(t.isHeader||t.row===0){
                        // 表头行
                        var ths=document.querySelectorAll('thead th');
                        ths.forEach(function(th){
                            var coordEl=th.querySelector('.coord-header');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                if(match&&parseInt(match[1])===t.row&&match[2]===t.col){
                                    cell=th;
                                }
                            }
                        });
                    }else{
                        cell=findCellByCoord(t.row,t.col);
                    }
                    if(cell){
                        var tText=cell.querySelector('.t-text');
                        if(tText){
                            tText.textContent=t.text;
                            if(t.fontSize){tText.style.fontSize=t.fontSize;}
                            if(t.color){tText.style.color=t.color;}
                            if(t.customSize){tText.setAttribute('data-custom-size','true');}
                            if(t.customColor){tText.setAttribute('data-custom-color','true');}
                        }
                    }
                });
            }
            
            // 恢复技能
            if(data.skills){
                data.skills.forEach(function(s){
                    // 只恢复有效的技能（有 imgSrc 且不为空，且不是占位符图片）
                    if(!s.imgSrc || !s.imgSrc.trim() || s.imgSrc === EMPTY_IMAGE_SRC) return;
                    
                    var cell=findCellByCoord(s.row,s.col);
                    if(cell){
                        var box=document.createElement('span');
                        box.className='skill-box has-fab';
                        box.innerHTML='<img src="'+s.imgSrc+'" style="width:40px;height:40px;">';
                        bindDragEvents(box, 20);
                        box.addEventListener('contextmenu',function(e){e.preventDefault();this.remove();saveToStorage();});
                        // 添加删除按钮
                        var delBtn = document.createElement('button');
                        delBtn.className = 'mini-fab delete';
                        delBtn.innerHTML = '×';
                        delBtn.title = '删除';
                        delBtn.onclick = function(ev){
                            ev.stopPropagation();
                            box.remove();
                            saveToStorage();
                        };
                        box.appendChild(delBtn);
                        
                        // 如果是召唤石，调整删除按钮位置
                        if (s.imgSrc && (s.imgSrc.includes('/summon/') || box.classList.contains('summon-box'))) {
                            box.classList.add('summon-box');
                            adjustSummonDeleteButton(box);
                        }
                        
                        cell.appendChild(box);
                    }
                });
            }
            
            // 恢复用户文字
            if(data.texts){
                data.texts.forEach(function(t){
                    // 只恢复非空文字
                    if(!t.text || !t.text.trim()) return;
                    
                    var cell=findCellByCoord(t.row,t.col);
                    if(cell){
                        // 创建wrapper包裹用户文字和删除按钮
                        var wrapper=document.createElement('span');
                        wrapper.className='user-text-wrapper';
                        
                        var span=document.createElement('span');
                        span.className='user-text';
                        span.textContent=t.text;
                        span.setAttribute('contenteditable','true');
                        if(t.color){span.style.color=t.color;}
                        if(t.bold){span.style.fontWeight='bold';}
                        if(t.fontSize){span.style.fontSize=t.fontSize;}
                        
                        // 恢复优先级属性（用于保持样式）
                        if(t.color){
                            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
                            var p1Color=isDark?'#ff6b6b':'#c62828';
                            var p2Color=isDark?'#ff8a80':'#c62828';
                            if(t.color===p1Color||t.color==='#c62828'||t.color==='rgb(198, 40, 40)'||t.color==='rgb(255, 107, 107)'){
                                span.setAttribute('data-priority','1');
                            }else if(t.color===p2Color||t.color==='#ff8a80'||t.color==='rgb(255, 138, 128)'){
                                span.setAttribute('data-priority','2');
                            }else if(t.bold){
                                span.setAttribute('data-priority','3');
                            }else{
                                span.setAttribute('data-priority','4');
                            }
                        }
                        
                        // 添加删除按钮
                        var delBtn=document.createElement('button');
                        delBtn.className='mini-fab delete';
                        delBtn.innerHTML='×';
                        delBtn.title='删除';
                        delBtn.onclick=function(ev){
                            ev.stopPropagation();
                            wrapper.remove();
                            saveToStorage();
                        };
                        
                        wrapper.appendChild(span);
                        wrapper.appendChild(delBtn);
                        
                        // 添加事件监听
                        span.addEventListener('blur',function(){
                            if(!this.textContent.trim()){
                                wrapper.remove();
                            }
                            saveToStorage();
                        });
                        
                        span.addEventListener('paste',function(e){
                            e.preventDefault();
                            var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                            document.execCommand('insertText',false,text.substring(0,50));
                        });
                        
                        span.addEventListener('keydown',function(e){
                            if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                                e.preventDefault();
                            }
                            if(e.key==='Enter'){
                                e.preventDefault();
                                this.blur();
                            }
                        });
                        
                        span.addEventListener('input',function(){
                            var priority=this.getAttribute('data-priority');
                            var currentColor=this.style.color;
                            var currentWeight=this.style.fontWeight;
                            var currentSize=this.style.fontSize;
                            setTimeout(function(){
                                if(span.style.color!==currentColor)span.style.color=currentColor;
                                if(span.style.fontWeight!==currentWeight)span.style.fontWeight=currentWeight;
                                if(span.style.fontSize!==currentSize)span.style.fontSize=currentSize;
                            },0);
                        });
                        
                        cell.appendChild(wrapper);
                    }
                });
            }
            
            // 恢复表头图片URL
            if(data.headerImages){
                // 用于收集状态图标数据
                var statusIconsToRestore = [];
                
                // 先删除所有源技能区域的 skill-box（清除HTML模板中的默认元素）
                // [修复] 只清除主表头的 skill-source-row，不清除换人行的 swap-source-row
                document.querySelectorAll('.skill-source-row:not(.swap-source-row) td').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    var editBtn = cell.querySelector('.mini-fab.edit, .btn-edit-glass');
                    // 删除所有 skill-box
                    cell.querySelectorAll('.skill-box').forEach(function(box){
                        box.remove();
                    });
                });
                
                // 角色头像只设置 src 为占位符（因为头像元素需要保留）
                document.querySelectorAll('.character-header img').forEach(function(img){
                    img.src = EMPTY_IMAGE_SRC;
                });
                
                // 然后恢复保存的图片（自动过滤占位符）
                data.headerImages.forEach(function(img){
                    // 跳过占位符图片
                    if(!img.src || img.src === EMPTY_IMAGE_SRC || img.src.trim() === '') {
                        return;
                    }
                    
                    if(img.type==='character'){
                        // 恢复角色头像
                        var ths=document.querySelectorAll('.character-header');
                        ths.forEach(function(th){
                            var coordEl=th.querySelector('.coord-header');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z])\)/);
                                if(match&&parseInt(match[1])===img.row&&match[2]===img.col){
                                    var imgEl=th.querySelector('img');
                                    if(imgEl) {
                                        imgEl.src=img.src;
                                        // [修复] 恢复数据时，确保图片可见
                                        imgEl.style.display = '';
                                    }
                                }
                            }
                        });
                    }else if(img.type==='skill-source'){
                        // 恢复技能源图片 - 创建新的 skill-box 元素
                        // [修复] 只恢复主表头的技能源，不恢复换人行的
                        var cells=document.querySelectorAll('.skill-source-row:not(.swap-source-row) td');
                        cells.forEach(function(cell){
                            var coordEl=cell.querySelector('.coord');
                            if(coordEl){
                                var match=coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
                                if(match&&parseInt(match[1])===img.row&&match[2]===img.col){
                                    // 创建新的 skill-box 元素
                                    var isSummon = (img.col === 'A-B' || img.col === 'C');
                                    var sourceType = isSummon ? 'summon' : 'skill';
                                    var box = createSkillBox(img.src, {
                                        className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                                        size: 40,
                                        editable: true,
                                        deletable: true,
                                        sourceType: sourceType,
                                        isSummon: isSummon,
                                        dragImageSize: 20
                                    });
                                    cell.appendChild(box);
                                }
                            }
                        });
                    }else if(img.type==='top-row'){
                        // 兼容旧数据格式 - 恢复BOSS图和状态图标
                        var topRows=document.querySelectorAll('.top-row');
                        if(topRows[img.rowIndex]){
                            var imgs=topRows[img.rowIndex].querySelectorAll('img');
                            if(imgs[img.imgIndex])imgs[img.imgIndex].src=img.src;
                        }
                    }else if(img.type==='boss-image'){
                        // 新格式 - 恢复BOSS图
                        var topRows=document.querySelectorAll('.top-row');
                        if(topRows[0]){
                            var bossImg=topRows[0].querySelector('th > img');
                            if(bossImg)bossImg.src=img.src;
                        }
                    }else if(img.type==='status-icon'){
                        // 新格式 - 恢复状态图标（先收集，后面统一处理）
                        statusIconsToRestore.push(img);
                    }
                });
                
                // 检查是否有 BOSS 图数据，如果没有则清空
                var hasBossData = data.headerImages.some(function(img){
                    return img.type === 'boss-image' || (img.type === 'top-row' && img.rowIndex === 0);
                });
                if(!hasBossData){
                    var topRows = document.querySelectorAll('.top-row');
                    if(topRows[0]){
                        var bossImg = topRows[0].querySelector('th > img');
                        if(bossImg) bossImg.src = EMPTY_IMAGE_SRC;
                    }
                }
                
                // 恢复状态图标 - 先删除现有的，再创建新的
                if(statusIconsToRestore && statusIconsToRestore.length > 0){
                    var topRows = document.querySelectorAll('.top-row');
                    if(topRows[1]){
                        var statusTh = topRows[1].querySelector('th');
                        var editBtn = statusTh.querySelector('.mini-fab.edit, .btn-edit-glass');
                        // 删除所有现有的 skill-box
                        statusTh.querySelectorAll('.skill-box').forEach(function(box){
                            box.remove();
                        });
                        // 按 index 排序后创建新的 skill-box
                        statusIconsToRestore.sort(function(a, b){ return a.index - b.index; });
                        statusIconsToRestore.forEach(function(iconData){
                            var box = createSkillBox(iconData.src, {
                                className: 'skill-box skill-source',
                                size: 33,
                                editable: false,
                                deletable: true,
                                sourceType: 'status',
                                dragImageSize: 16
                            });
                            // 插入到编辑按钮之前
                            if(editBtn){
                                statusTh.insertBefore(box, editBtn);
                            } else {
                                statusTh.appendChild(box);
                            }
                        });
                    }
                } else {
                    // 如果没有状态图标数据，清空现有的（用户已清空）
                    var hasStatusData = data.headerImages.some(function(img){
                        return img.type === 'status-icon' || (img.type === 'top-row' && img.rowIndex === 1);
                    });
                    if(!hasStatusData){
                        var topRows = document.querySelectorAll('.top-row');
                        if(topRows[1]){
                            var statusTh = topRows[1].querySelector('th');
                            statusTh.querySelectorAll('.skill-box').forEach(function(box){
                                box.remove();
                            });
                        }
                    }
                }
                
                // 更新所有源技能区域和角色头像的空状态显示
                // [修改] 扩展到 M 列，支持 9 人模式
                var characterConfigs = [
                    { coord: '(0,E)', name: '主角', skillCoord: 'E' },
                    { coord: '(0,F)', name: '2号位', skillCoord: 'F' },
                    { coord: '(0,G)', name: '3号位', skillCoord: 'G' },
                    { coord: '(0,H)', name: '4号位', skillCoord: 'H' },
                    { coord: '(0,I)', name: '后排1', skillCoord: 'I' },
                    { coord: '(0,J)', name: '后排2', skillCoord: 'J' },
                    { coord: '(0,K)', name: '后排3', skillCoord: 'K' },
                    { coord: '(0,L)', name: '后排4', skillCoord: 'L' },
                    { coord: '(0,M)', name: '后排5', skillCoord: 'M' }
                ];
                var summonConfigs = [
                    { coord: 'A-B', fullCoord: '(1,A-B)', name: '主召唤石', maxCount: 6, showButton: true },
                    { coord: 'C', fullCoord: '(1,C)', name: '副召唤石', maxCount: 3, showButton: false }
                ];
                
                characterConfigs.forEach(function(config) {
                    if(window.updateSkillSourceEmptyState) {
                        window.updateSkillSourceEmptyState(config.skillCoord);
                    }
                    if(window.updateCharacterEmptyState) {
                        window.updateCharacterEmptyState(config.coord.match(/\(0,([A-Z])\)/)[1]);
                    }
                });
                
                summonConfigs.forEach(function(config) {
                    if(window.updateSummonEmptyState) {
                        window.updateSummonEmptyState(config.coord, config.maxCount, config.showButton);
                    }
                });
                
                // 更新BOSS栏空状态
                if(window.updateBossEmptyState) {
                    window.updateBossEmptyState();
                }
            }
            
            // [新增] 恢复换人行数据 (修复位置问题)
            if(data.swapSections && data.swapSections.length > 0) {
                // 先删除现有的换人行
                document.querySelectorAll('.swap-header-row').forEach(function(row) { row.remove(); });
                document.querySelectorAll('.swap-source-row').forEach(function(row) { row.remove(); });
                
                // 按 positionIndex 排序，确保按正确顺序插入
                var sortedSwapSections = data.swapSections.slice().sort(function(a, b) {
                    return (a.positionIndex || 0) - (b.positionIndex || 0);
                });
                
                // 重建换人行
                sortedSwapSections.forEach(function(swapData, swapIndex) {
                    // 更新全局计数器
                    swapRowCounter = Math.max(swapRowCounter, swapIndex + 1);
                    
                    // 调用 insertSwapRow 创建结构，但不保存
                    var tbody = document.querySelector('tbody');
                    var is9ManMode = document.querySelector('thead .back-row-2') !== null;
                    var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
                    
                    var swapId = swapData.id || ('swap-restore-' + swapIndex);
                    var swapNum = swapIndex + 1;
                    
                    // [修复] 恢复时同样合并 A+B 列
                    var labelColsHtml = '<td colspan="2" class="swap-label-cell" style="vertical-align:middle; text-align:center;">' +
                        '<div style="font-weight:bold; color:var(--text-secondary); font-size:12px;">🔄 换人</div>' +
                        '<button class="swap-delete-btn" onclick="removeSwapSection(this)" title="删除此换人区块">×</button>' +
                        '</td>' +
                        '<td class="swap-label-cell"></td>' +
                        '<td class="swap-label-cell"></td>';
                    
                    // 构建角色头像栏
                    var cols = ['E','F','G','H','I','J'];
                    var defaultNames = ['主角','2号位','3号位','4号位','后排1','后排2'];
                    if(is9ManMode) {
                        cols.push('K','L','M');
                        defaultNames.push('后排3','后排4','后排5');
                    }
                    
                    var charColsHtml = '';
                    cols.forEach(function(col, idx) {
                        var backClass = '';
                        if(idx >= 4 && idx <= 5) backClass = ' back-row';
                        if(idx >= 6) backClass = ' back-row-2';
                        
                        // 从保存的数据中获取角色信息
                        var charData = swapData.characters && swapData.characters[idx];
                        var charName = charData && charData.name ? charData.name : defaultNames[idx];
                        var charSrc = charData && charData.src ? charData.src : EMPTY_IMAGE_SRC;
                        var imgStyle = charSrc === EMPTY_IMAGE_SRC ? 'display:none' : '';
                        
                        // [修复] 添加 position:relative 确保编辑按钮定位正确
                        charColsHtml += '<td class="swap-char-cell character-header has-fab' + backClass + '" style="position:relative;">' +
                            '<span class="coord-header">(SW' + swapNum + ',' + col + ')</span><br>' +
                            '<img src="' + charSrc + '" style="' + imgStyle + '">' +
                            '<span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">' + charName + '</span>' +
                            '<div class="btn-edit-glass" onclick="showQuickAddCharacterForSwap(this.closest(\'.swap-char-cell\'))">' + editIcon + '</div>' +
                            '</td>';
                    });
                    
                    var trHeader = document.createElement('tr');
                    trHeader.className = 'swap-header-row';
                    trHeader.setAttribute('data-swap-id', swapId);
                    trHeader.innerHTML = labelColsHtml + charColsHtml;
                    
                    // 构建技能源栏
                    var sourceColsHtml = '';
                    cols.forEach(function(col, idx) {
                        var backClass = '';
                        if(idx >= 4 && idx <= 5) backClass = ' back-row';
                        if(idx >= 6) backClass = ' back-row-2';
                        sourceColsHtml += '<td class="source-cell' + backClass + '"><span class="coord">(SRC' + swapNum + ',' + col + ')</span></td>';
                    });
                    
                    var trSource = document.createElement('tr');
                    trSource.className = 'skill-source-row swap-source-row';
                    trSource.setAttribute('data-swap-id', swapId);
                    // [修复] A-B、C 列移除编辑按钮，统一使用悬停删除
                    trSource.innerHTML = 
                        '<td colspan="2" class="source-cell" style="vertical-align:middle;position:relative;">' +
                            '<span class="coord">(SRC' + swapNum + ',A-B)</span>' +
                        '</td>' +
                        '<td class="source-cell" style="vertical-align:middle;position:relative;">' +
                            '<span class="coord">(SRC' + swapNum + ',C)</span>' +
                        '</td>' +
                        '<td class="source-cell">' +
                            '<span class="coord">(SRC' + swapNum + ',D)</span>' +
                            '<span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span>' +
                        '</td>' +
                        sourceColsHtml;
                    
                    // [修复] 根据 positionIndex 找到正确的插入位置
                    var insertAfterRow = null;
                    if(typeof swapData.positionIndex === 'number' && swapData.positionIndex > 0) {
                        // 获取当前所有非换人行
                        var normalRows = Array.from(tbody.querySelectorAll('tr')).filter(function(row) {
                            return !row.classList.contains('swap-header-row') && !row.classList.contains('swap-source-row');
                        });
                        // positionIndex 表示换人行前面有多少个普通行，所以插入点是第 positionIndex-1 行之后
                        if(swapData.positionIndex <= normalRows.length) {
                            insertAfterRow = normalRows[swapData.positionIndex - 1];
                        }
                    }
                    
                    // 插入到正确位置或追加到末尾
                    if(insertAfterRow && insertAfterRow.nextSibling) {
                        tbody.insertBefore(trHeader, insertAfterRow.nextSibling);
                        tbody.insertBefore(trSource, trHeader.nextSibling);
                    } else if(insertAfterRow) {
                        // insertAfterRow 是最后一行
                        tbody.appendChild(trHeader);
                        tbody.appendChild(trSource);
                    } else {
                        // 没有位置信息或位置无效，追加到末尾
                        tbody.appendChild(trHeader);
                        tbody.appendChild(trSource);
                    }
                    
                    // 恢复技能源图片
                    if(swapData.skills && swapData.skills.length > 0) {
                        swapData.skills.forEach(function(skillData) {
                            var cells = trSource.querySelectorAll('.source-cell');
                            cells.forEach(function(cell) {
                                var coordEl = cell.querySelector('.coord');
                                if(coordEl) {
                                    var match = coordEl.textContent.match(/\(SRC\d+,([A-Z\-]+)\)/);
                                    if(match && match[1] === skillData.col) {
                                        var isSummon = (skillData.col === 'A-B' || skillData.col === 'C');
                                        // [修复] 所有列统一使用悬停删除按钮
                                        var box = createSkillBox(skillData.src, {
                                            className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                                            size: 40,
                                            editable: true,
                                            deletable: true, // 所有列都有删除按钮
                                            dragImageSize: 20
                                        });
                                        cell.appendChild(box);
                                    }
                                }
                            });
                        });
                    }
                    
                    // 初始化事件绑定
                    if(typeof initSwapRowElements === 'function') {
                        initSwapRowElements(trHeader, trSource);
                    }
                });
            }
            
            // [新增] 强制刷新阶段颜色，解决导入/刷新后颜色不对的问题
            if(typeof refreshPhaseColors === 'function') {
                refreshPhaseColors();
            }
            
            // [新增] 恢复创作者信息
            if(data.metadata && data.metadata.authors) {
                AuthorSystem.history = data.metadata.authors;
                // 加载别人的存档时，保持当前用户不变（或为访客）
                // 历史记录会在打开弹窗时显示
            }
            
            // [新增] 恢复数据后，强制检查换人行按钮状态
            updateSwapButtonState();
        }
        
        // 添加行但不保存(用于恢复数据时) (已更新：包含右侧+号)
        // [修改] 使用 getDataCellsHtml 动态生成列
        function addRowToPhaseNoSave(btn){
            var phaseCell=btn.closest('td');
            var phaseRow=phaseCell.closest('tr');
            var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            var phaseIndex=rows.indexOf(phaseRow);
            var lastRowIndex=phaseIndex+rowspan-1;
            var newRow=document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // 坐标稍后会重算
            newRow.innerHTML='<td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;
            if(lastRowIndex<rows.length-1){rows[lastRowIndex].after(newRow);}else{tbody.appendChild(newRow);}
            phaseCell.setAttribute('rowspan',rowspan+1);
            newRow.querySelectorAll('td').forEach(function(cell){bindCellEvents(cell);});
            // 为新添加的B列文字绑定不可删除逻辑
            var bText = newRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
        }
        
        function saveToStorage(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(collectData()));}catch(e){}}
        function loadFromStorage(){
            try{
                var saved=localStorage.getItem(STORAGE_KEY);
                if(saved){
                    var data = JSON.parse(saved);
                    // [关键修复] 先检查存档里的模式
                    // 如果存档是9人模式，但当前页面是6人骨架（默认），则先切换骨架
                    var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                    var savedMode = data.mode || 6; // 旧存档默认为 6
                    if (savedMode === 9 && !currentIs9Man) {
                        // 强制切换到 9人骨架，传入 true 表示是恢复模式（不保存、不弹窗）
                        loadTemplate(9, true);
                    } else if (savedMode === 6 && currentIs9Man) {
                        // 如果存的是6人但当前是9人，切回6人
                        loadTemplate(6, true);
                    }
                    // 骨架正确后，再填充数据
                    restoreData(data);
                }else{
                    // 没有保存的数据，尝试加载用户默认配置
                    var defaultData=localStorage.getItem(STORAGE_KEY+'_default');
                    if(defaultData){
                        var data = JSON.parse(defaultData);
                        // 同样的逻辑应用于默认配置
                        var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                        var savedMode = data.mode || 6;
                        if (savedMode !== (currentIs9Man ? 9 : 6)) {
                            loadTemplate(savedMode, true);
                        }
                        restoreData(data);
                    }
                }
            }catch(e){
                console.error('加载存档失败:', e);
            }
        }
        function exportJSON(){var data=collectData();var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var link=document.createElement('a');link.download='gbf_guide_'+new Date().toISOString().slice(0,10)+'.json';link.href=URL.createObjectURL(blob);link.click();}
        function importJSON(e){
            var file=e.target.files[0];
            if(!file)return;
            var reader=new FileReader();
            reader.onload=function(ev){
                try{
                    var data=JSON.parse(ev.target.result);
                    // [新增] 导入前先切换骨架
                    var currentIs9Man = document.querySelector('thead .back-row-2') !== null;
                    var savedMode = data.mode || 6;
                    if (savedMode !== (currentIs9Man ? 9 : 6)) {
                        loadTemplate(savedMode, true);
                    }
                    restoreData(data);
                    saveToStorage();
                    alert('导入成功!');
                }catch(err){
                    alert('导入失败');
                }
            };
            reader.readAsText(file);
            e.target.value='';
        }
        
        // ========== 6人/9人 模板切换功能 ==========
        
        // ========== BOSS选择弹窗控制 ==========
        function showBossSelectModal() {
            document.getElementById('bossSelectModal').classList.add('active');
        }
        
        function closeBossSelectModal() {
            document.getElementById('bossSelectModal').classList.remove('active');
        }
        
        function confirmSwitchMode(mode) {
            var modeName = (mode === 9) ? '极妈模板' : '极法模板';
            var msg = '【重要提醒】\n\n' +
                      '即将切换到 ' + modeName + '\n\n' +
                      '⚠️ 此操作将清空当前表格的所有内容！\n\n' +
                      '如果您有重要数据，请先点击「取消」\n' +
                      '然后使用工具栏的「导出」按钮保存配置。\n\n' +
                      '确定要继续吗？';
            
            if (confirm(msg)) {
                closeBossSelectModal();
                loadTemplate(mode);
            }
        }
        
        // 点击弹窗背景关闭
        document.addEventListener('click', function(e) {
            var modal = document.getElementById('bossSelectModal');
            if (e.target === modal) {
                closeBossSelectModal();
            }
        });

        // ========== 默认模板 JSON 配置 ==========
        // 【说明】将你的默认 JSON 粘贴到下面对应的位置
        // 切换模式时会自动加载这些配置（如果有的话）
        
        // 九人模式默认配置 - 将完整 JSON 字符串粘贴到这里（用单引号包裹）
        var DEFAULT_9MAN_JSON = '{"version":3,"mode":9,"savedAt":"2026-01-12T16:18:47.690Z","skills":[{"row":5,"col":"C","imgSrc":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"},{"row":11,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":12,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":13,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":14,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":15,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":16,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"row":17,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":18,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":19,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":20,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":21,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":22,"col":"C","imgSrc":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"row":24,"col":"D","imgSrc":"https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png"},{"row":24,"col":"E","imgSrc":"https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png"},{"row":24,"col":"F","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png"},{"row":24,"col":"G","imgSrc":"https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png"},{"row":24,"col":"H","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"row":25,"col":"C","imgSrc":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"row":27,"col":"C","imgSrc":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png"}],"texts":[{"row":5,"col":"C","text":"所有人出玉后A","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":6,"col":"C","text":"偷T尽快A2","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":7,"col":"C","text":"等90%","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"C","text":"再生之神意","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":"未满足条件时，BOSS获取获取他化自在（强化满豆·70%特动难度）","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":" -50hit或6回奥义","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":11,"col":"E","text":"-对boss造成一定伤害","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":12,"col":"C","text":"满豆","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":13,"col":"C","text":"满豆","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":14,"col":"C","text":"70% 1/3","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":15,"col":"C","text":"70%2/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":16,"col":"C","text":"70%3/3","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":17,"col":"C","text":"破坏之神意","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":"未满足条件时，BOSS获取获取他化自在（强化满豆·70%特动难度）","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":" -6回行动或5回技能","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":17,"col":"E","text":"-对boss造成一定伤害","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":18,"col":"C","text":"满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":19,"col":"C","text":"满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":20,"col":"C","text":"70%1/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":21,"col":"C","text":"70%2/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":22,"col":"C","text":"70%3/3","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"12回技能","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"3000w技伤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":23,"col":"C","text":"3000w奥义","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"未达成解除难度提升","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"满豆难度提升","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"C","text":"BUFF效果提升","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"D","text":"40HIT/+20HIT","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"D","text":"BOSS获得BUFF追伤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"技伤3000w/+500w","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"BOSS平A带DB","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"E","text":"2级以上穿盾","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"行动5回/+1回","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"BOSS获得斩杀","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"F","text":"初始20% 最大60%","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"奥义6回/+1回","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"随机角色技能CD+2","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"G","text":"初始1人 提升+1","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"TA3回/+1回","color":"rgb(255, 107, 107)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"依等级获得","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"二动","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"破坏追伤","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":24,"col":"H","text":"三动","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":25,"col":"C","text":"解不掉会早一回合满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":27,"col":"C","text":"解满豆出玉","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":28,"col":"C","text":"特动随机","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":29,"col":"C","text":"满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":30,"col":"C","text":"满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":31,"col":"C","text":"满豆","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":32,"col":"C","text":"特动随机","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":38,"col":"C","text":"特动随机","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"},{"row":38,"col":"C","text":"数值强化","color":"rgb(198, 40, 40)","bold":true,"fontSize":"11px"}],"phases":[{"name":"100%-80%","rowspan":9,"rows":[{"index":0,"coord":2,"text":"1T","exists":true},{"index":1,"coord":3,"text":"2T","exists":true},{"index":2,"coord":4,"text":"3T","exists":true},{"index":3,"coord":5,"text":"4T","exists":true},{"index":4,"coord":6,"text":"5T","exists":true},{"index":5,"coord":7,"text":"6T","exists":true},{"index":6,"coord":8,"text":"1e伤害","exists":true},{"index":7,"coord":9,"text":"6奥义","exists":true},{"index":8,"coord":10,"text":"80HIT+FC","exists":true}],"className":"phase-100-80"},{"name":"70-G50","rowspan":12,"rows":[{"index":0,"coord":11,"text":"再生之神意","exists":true},{"index":1,"coord":12,"text":"15弱体+4TA","exists":true},{"index":2,"coord":13,"text":"5驱散/7回200w","exists":true},{"index":3,"coord":14,"text":"6回技能","exists":true},{"index":4,"coord":15,"text":"5回驱散+5回行动","exists":true},{"index":5,"coord":16,"text":"50HIT+5回300w","exists":true},{"index":6,"coord":17,"text":"破坏之神意","exists":true},{"index":7,"coord":18,"text":"12回弱体+50HIT","exists":true},{"index":8,"coord":19,"text":"5回奥义+3回红技","exists":true},{"index":9,"coord":20,"text":"5回奥义","exists":true},{"index":10,"coord":21,"text":"4TA+3驱散","exists":true},{"index":11,"coord":22,"text":"3回800w+FC","exists":true}],"className":"phase-80-60"},{"name":"G50","rowspan":1,"rows":[{"index":0,"coord":23,"text":"G50特动","exists":true}],"className":"phase-60-20"},{"name":"G50-G100","rowspan":8,"rows":[{"index":0,"coord":24,"text":"四王天类BUFF","exists":true},{"index":1,"coord":25,"text":"1T","exists":true},{"index":2,"coord":26,"text":"2T","exists":true},{"index":3,"coord":27,"text":"满豆","exists":true},{"index":4,"coord":28,"text":"满豆","exists":true},{"index":5,"coord":29,"text":"3回800w+2回蓝技","exists":true},{"index":6,"coord":30,"text":"15回DB+8回300w伤害","exists":true},{"index":7,"coord":31,"text":"5回驱散+FC","exists":true}],"className":"phase-20-0"},{"name":"G100-0%","rowspan":7,"rows":[{"index":0,"coord":32,"text":"一轮试炼","exists":true},{"index":1,"coord":33,"text":"15回DB","exists":true},{"index":2,"coord":34,"text":"150HIT","exists":true},{"index":3,"coord":35,"text":"6回驱散","exists":true},{"index":4,"coord":36,"text":"1e伤害","exists":true},{"index":5,"coord":37,"text":"5回600w","exists":true},{"index":6,"coord":38,"text":"二轮试炼","exists":true}],"className":"phase-100-80"}],"tTexts":[{"row":0,"col":"A","text":"阶段","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"B","text":"回合/特动","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"C","text":"备注","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"D","text":"召唤石","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"E","text":"主角","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"F","text":"2号位","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"G","text":"3号位","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"H","text":"4号位","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"I","text":"后排1","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"J","text":"后排2","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"K","text":"后排3","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"L","text":"后排4","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":0,"col":"M","text":"后排5","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":true},{"row":2,"col":"A","text":"100%-80%","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":2,"col":"B","text":"1T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":3,"col":"B","text":"2T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":4,"col":"B","text":"3T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":5,"col":"B","text":"4T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":6,"col":"B","text":"5T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":7,"col":"B","text":"6T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":8,"col":"B","text":"1e伤害","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":9,"col":"B","text":"6奥义","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":10,"col":"B","text":"80HIT+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":11,"col":"A","text":"70-G50","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":11,"col":"B","text":"再生之神意","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":12,"col":"B","text":"15弱体+4TA","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":13,"col":"B","text":"5驱散/7回200w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":14,"col":"B","text":"6回技能","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":15,"col":"B","text":"5回驱散+5回行动","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":16,"col":"B","text":"50HIT+5回300w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":17,"col":"B","text":"破坏之神意","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":18,"col":"B","text":"12回弱体+50HIT","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":19,"col":"B","text":"5回奥义+3回红技","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":20,"col":"B","text":"5回奥义","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":21,"col":"B","text":"4TA+3驱散","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":22,"col":"B","text":"3回800w+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":23,"col":"A","text":"G50","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":23,"col":"B","text":"G50特动","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":24,"col":"A","text":"G50-G100","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":24,"col":"B","text":"四王天类BUFF","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":25,"col":"B","text":"1T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":26,"col":"B","text":"2T","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":27,"col":"B","text":"满豆","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":28,"col":"B","text":"满豆","fontSize":"11px","color":"rgb(255, 0, 0)","customSize":false,"customColor":true,"isHeader":false},{"row":29,"col":"B","text":"3回800w+2回蓝技","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":30,"col":"B","text":"15回DB+8回300w伤害","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":31,"col":"B","text":"5回驱散+FC","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":32,"col":"A","text":"G100-0%","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":32,"col":"B","text":"一轮试炼","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":33,"col":"B","text":"15回DB","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":34,"col":"B","text":"150HIT","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":35,"col":"B","text":"6回驱散","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":36,"col":"B","text":"1e伤害","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":37,"col":"B","text":"5回600w","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false},{"row":38,"col":"B","text":"二轮试炼","fontSize":"11px","color":"","customSize":false,"customColor":false,"isHeader":false}],"rows":[{"index":0,"hasPhase":true,"rowspan":9,"phaseName":"100%-80%","phaseClass":"phase-100-80"},{"index":1,"hasPhase":false},{"index":2,"hasPhase":false},{"index":3,"hasPhase":false},{"index":4,"hasPhase":false},{"index":5,"hasPhase":false},{"index":6,"hasPhase":false},{"index":7,"hasPhase":false},{"index":8,"hasPhase":false},{"index":9,"hasPhase":true,"rowspan":12,"phaseName":"70-G50","phaseClass":"phase-80-60"},{"index":10,"hasPhase":false},{"index":11,"hasPhase":false},{"index":12,"hasPhase":false},{"index":13,"hasPhase":false},{"index":14,"hasPhase":false},{"index":15,"hasPhase":false},{"index":16,"hasPhase":false},{"index":17,"hasPhase":false},{"index":18,"hasPhase":false},{"index":19,"hasPhase":false},{"index":20,"hasPhase":false},{"index":21,"hasPhase":true,"rowspan":1,"phaseName":"G50","phaseClass":"phase-60-20"},{"index":24,"hasPhase":true,"rowspan":8,"phaseName":"G50-G100","phaseClass":"phase-20-0"},{"index":25,"hasPhase":false},{"index":26,"hasPhase":false},{"index":27,"hasPhase":false},{"index":28,"hasPhase":false},{"index":29,"hasPhase":false},{"index":30,"hasPhase":false},{"index":31,"hasPhase":false},{"index":32,"hasPhase":true,"rowspan":7,"phaseName":"G100-0%","phaseClass":"phase-100-80"},{"index":33,"hasPhase":false},{"index":34,"hasPhase":false},{"index":35,"hasPhase":false},{"index":36,"hasPhase":false},{"index":37,"hasPhase":false},{"index":38,"hasPhase":false}],"headerImages":[{"type":"skill-source","row":1,"col":"D","index":0,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png"},{"type":"boss-image","src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/lobby/room_index/thumb/unlimited_versusia.png"},{"type":"status-icon","index":0,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"},{"type":"status-icon","index":1,"src":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png"},{"type":"status-icon","index":2,"src":"https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png"},{"type":"status-icon","index":3,"src":"https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png"},{"type":"status-icon","index":4,"src":"https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png"},{"type":"status-icon","index":5,"src":"https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png"},{"type":"status-icon","index":6,"src":"https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png"},{"type":"status-icon","index":7,"src":"https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png"},{"type":"status-icon","index":8,"src":"https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png"},{"type":"status-icon","index":9,"src":"https://gbf.wiki/images/thumb/2/2f/Btn_singularity_chain_1_0.png/180px-Btn_singularity_chain_1_0.png"},{"type":"status-icon","index":10,"src":"https://gbf.wiki/images/thumb/7/76/Btn_singularity_chain_1_1.png/180px-Btn_singularity_chain_1_1.png"}],"swapSections":[{"id":"swap-1-1768228496333","index":0,"characters":[{"col":"E","index":0,"name":"主角","src":""},{"col":"F","index":1,"name":"2号位","src":""},{"col":"G","index":2,"name":"3号位","src":""},{"col":"H","index":3,"name":"4号位","src":""},{"col":"I","index":4,"name":"后排1","src":""},{"col":"J","index":5,"name":"后排2","src":""},{"col":"K","index":6,"name":"后排3","src":""},{"col":"L","index":7,"name":"后排4","src":""},{"col":"M","index":8,"name":"后排5","src":""}],"skills":[],"positionIndex":22}],"metadata":{"authors":["真實lowb"],"lastEditor":"真實lowb"},"mergedCells":[{"row":11,"col":"E","colspan":4},{"row":17,"col":"E","colspan":4}]}'
      
      // 六人模式默认配置 - 将完整 JSON 字符串粘贴到这里（用单引号包裹）
        var DEFAULT_6MAN_JSON = '{ "version": 3, "mode": 6, "savedAt": "2026-01-12T16:18:10.568Z", "skills": [ { "row": 16, "col": "C", "imgSrc": "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png" }, { "row": 17, "col": "C", "imgSrc": "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png" } ], "texts": [ { "row": 10, "col": "C", "text": "弱体7回", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 11, "col": "C", "text": "驱散2回", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 27, "col": "C", "text": "弱体7回", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 28, "col": "C", "text": "驱散2回", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 30, "col": "C", "text": "随机试炼1/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 31, "col": "C", "text": "随机试炼2/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" }, { "row": 32, "col": "C", "text": "随机试炼3/3", "color": "rgb(198, 40, 40)", "bold": true, "fontSize": "11px" } ], "phases": [ { "name": "100%-80%", "rowspan": 10, "rows": [ { "index": 0, "coord": 2, "text": "1T", "exists": true }, { "index": 1, "coord": 3, "text": "2T", "exists": true }, { "index": 2, "coord": 4, "text": "3T", "exists": true }, { "index": 3, "coord": 5, "text": "4T", "exists": true }, { "index": 4, "coord": 6, "text": "5T", "exists": true }, { "index": 5, "coord": 7, "text": "TA4回", "exists": true }, { "index": 6, "coord": 8, "text": "2000w奥义", "exists": true }, { "index": 7, "coord": 9, "text": "1500技伤", "exists": true }, { "index": 8, "coord": 10, "text": "满豆1", "exists": true }, { "index": 9, "coord": 11, "text": "满豆2", "exists": true } ], "className": "phase-100-80" }, { "name": "80%-60%", "rowspan": 6, "rows": [ { "index": 0, "coord": 12, "text": "80%", "exists": true }, { "index": 1, "coord": 13, "text": "40HIT", "exists": true }, { "index": 2, "coord": 14, "text": "1500w技伤", "exists": true }, { "index": 3, "coord": 15, "text": "TA4回", "exists": true }, { "index": 4, "coord": 16, "text": "TA3回", "exists": true }, { "index": 5, "coord": 17, "text": "奥义4回", "exists": true } ], "className": "phase-80-60" }, { "name": "60%-20%", "rowspan": 11, "rows": [ { "index": 0, "coord": 18, "text": "60%", "exists": true }, { "index": 1, "coord": 19, "text": "苹果", "exists": true }, { "index": 2, "coord": 20, "text": "无特动", "exists": true }, { "index": 3, "coord": 21, "text": "奥义5回", "exists": true }, { "index": 4, "coord": 22, "text": "攻击6回", "exists": true }, { "index": 5, "coord": 23, "text": "3500w伤害", "exists": true }, { "index": 6, "coord": 24, "text": "弱体10回", "exists": true }, { "index": 7, "coord": 25, "text": "FC", "exists": true }, { "index": 8, "coord": 26, "text": "60HIT", "exists": true }, { "index": 9, "coord": 27, "text": "满豆1", "exists": true }, { "index": 10, "coord": 28, "text": "满豆2", "exists": true } ], "className": "phase-60-20" }, { "name": "20%-0%", "rowspan": 7, "rows": [ { "index": 0, "coord": 29, "text": "20%", "exists": true }, { "index": 1, "coord": 30, "text": "6回奥义", "exists": true }, { "index": 2, "coord": 31, "text": "12回技能", "exists": true }, { "index": 3, "coord": 32, "text": "66次伤害", "exists": true }, { "index": 4, "coord": 33, "text": "FC", "exists": true }, { "index": 5, "coord": 34, "text": "99e", "exists": true }, { "index": 6, "coord": 35, "text": "99HIT", "exists": true } ], "className": "phase-20-0" } ], "tTexts": [ { "row": 0, "col": "A", "text": "阶段", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "B", "text": "回合/特动", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "C", "text": "备注", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "D", "text": "召唤石", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "E", "text": "主角", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "F", "text": "2号位", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "G", "text": "3号位", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "H", "text": "4号位", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "I", "text": "后排1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 0, "col": "J", "text": "后排2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": true }, { "row": 2, "col": "A", "text": "100%-80%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 2, "col": "B", "text": "1T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 3, "col": "B", "text": "2T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 4, "col": "B", "text": "3T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 5, "col": "B", "text": "4T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 6, "col": "B", "text": "5T", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 7, "col": "B", "text": "TA4回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 8, "col": "B", "text": "2000w奥义", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 9, "col": "B", "text": "1500技伤", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 10, "col": "B", "text": "满豆1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 11, "col": "B", "text": "满豆2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 12, "col": "A", "text": "80%-60%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 12, "col": "B", "text": "80%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 13, "col": "B", "text": "40HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 14, "col": "B", "text": "1500w技伤", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 15, "col": "B", "text": "TA4回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 16, "col": "B", "text": "TA3回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 17, "col": "B", "text": "奥义4回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 18, "col": "A", "text": "60%-20%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 18, "col": "B", "text": "60%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 19, "col": "B", "text": "苹果", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 20, "col": "B", "text": "无特动", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 21, "col": "B", "text": "奥义5回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 22, "col": "B", "text": "攻击6回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 23, "col": "B", "text": "3500w伤害", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 24, "col": "B", "text": "弱体10回", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 25, "col": "B", "text": "FC", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 26, "col": "B", "text": "60HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 27, "col": "B", "text": "满豆1", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 28, "col": "B", "text": "满豆2", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 29, "col": "A", "text": "20%-0%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 29, "col": "B", "text": "20%", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 30, "col": "B", "text": "6回奥义", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 31, "col": "B", "text": "12回技能", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 32, "col": "B", "text": "66次伤害", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 33, "col": "B", "text": "FC", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 34, "col": "B", "text": "99e", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false }, { "row": 35, "col": "B", "text": "99HIT", "fontSize": "11px", "color": "", "customSize": false, "customColor": false, "isHeader": false } ], "rows": [ { "index": 0, "hasPhase": true, "rowspan": 10, "phaseName": "100%-80%", "phaseClass": "phase-100-80" }, { "index": 1, "hasPhase": false }, { "index": 2, "hasPhase": false }, { "index": 3, "hasPhase": false }, { "index": 4, "hasPhase": false }, { "index": 5, "hasPhase": false }, { "index": 6, "hasPhase": false }, { "index": 7, "hasPhase": false }, { "index": 8, "hasPhase": false }, { "index": 9, "hasPhase": false }, { "index": 10, "hasPhase": true, "rowspan": 6, "phaseName": "80%-60%", "phaseClass": "phase-80-60" }, { "index": 11, "hasPhase": false }, { "index": 12, "hasPhase": false }, { "index": 13, "hasPhase": false }, { "index": 14, "hasPhase": false }, { "index": 15, "hasPhase": false }, { "index": 16, "hasPhase": true, "rowspan": 11, "phaseName": "60%-20%", "phaseClass": "phase-60-20" }, { "index": 17, "hasPhase": false }, { "index": 18, "hasPhase": false }, { "index": 19, "hasPhase": false }, { "index": 20, "hasPhase": false }, { "index": 21, "hasPhase": false }, { "index": 22, "hasPhase": false }, { "index": 23, "hasPhase": false }, { "index": 24, "hasPhase": false }, { "index": 25, "hasPhase": false }, { "index": 26, "hasPhase": false }, { "index": 27, "hasPhase": true, "rowspan": 7, "phaseName": "20%-0%", "phaseClass": "phase-20-0" }, { "index": 28, "hasPhase": false }, { "index": 29, "hasPhase": false }, { "index": 30, "hasPhase": false }, { "index": 31, "hasPhase": false }, { "index": 32, "hasPhase": false }, { "index": 33, "hasPhase": false } ], "headerImages": [ { "type": "skill-source", "row": 1, "col": "D", "index": 0, "src": "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" }, { "type": "boss-image", "src": "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" }, { "type": "status-icon", "index": 0, "src": "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png" }, { "type": "status-icon", "index": 1, "src": "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png" } ], "swapSections": [], "metadata": { "authors": [ "真實lowb" ], "lastEditor": "真實lowb" }, "mergedCells": []}'


        // ========== 默认模板 JSON 配置结束 ==========

        // 9人高难模板 (保留兼容性)
        function bossTemplate() {
            showBossSelectModal();
        }
        
        // 6人普通模板 (保留兼容性)
        function normalTemplate() {
            showBossSelectModal();
        }
        
        // [修复] 增加 isRestoring 参数，用于在加载存档时静默切换骨架
        function loadTemplate(mode, isRestoring) {
            var is9Man = (mode === 9);
            var thead = document.querySelector('thead');
            var tbody = document.querySelector('tbody');
            
            // 定义 SVG 编辑图标，方便复用
            var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            
            // 准备默认状态栏图标
            var statusHtml = '';
            if (is9Man) {
                // 9人模式：加载指定的8张图片
                var icons9 = [
                    "https://gbf.wiki/images/thumb/4/41/Status_3353_1.png/25px-Status_3353_1.png",
                    "https://gbf.wiki/images/thumb/5/50/Status_3354_1.png/25px-Status_3354_1.png",
                    "https://gbf.wiki/images/thumb/2/23/Status_3355_1.png/25px-Status_3355_1.png",
                    "https://gbf.wiki/images/thumb/a/ad/Status_3357_1.png/25px-Status_3357_1.png",
                    "https://gbf.wiki/images/thumb/4/41/Status_3356_1.png/25px-Status_3356_1.png",
                    "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4054.png",
                    "https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_1.png",
                    "https://prd-game-a-granbluefantasy.akamaized.net/assets/img/sp/raid/assets/ui_exception/group_gauge/singularity_chain/icon_0.png",
                    "https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/status/x64/status_4051.png"
                ];
                icons9.forEach(function(url){
                    statusHtml += '<span class="skill-box skill-source"><img src="' + url + '" style="width:33px;height:33px;"></span>';
                });
            } else {
                // 6人模式：保留几个默认的
                var icons6 = [
                    "https://gbf.wiki/images/thumb/c/c6/Status_3245.png/25px-Status_3245.png",
                    "https://gbf.wiki/images/thumb/e/e4/Status_3246.png/25px-Status_3246.png"
                ];
                icons6.forEach(function(url){
                    statusHtml += '<span class="skill-box skill-source"><img src="' + url + '" style="width:33px;height:33px;"></span>';
                });
            }
            
            // 1. 生成表头 HTML
            var extraHeader = '';
            var extraSource = '';
            
            // 定义后排配置
            var backs = [
                {c:'I', n:'后排1', cls:'back-row'},
                {c:'J', n:'后排2', cls:'back-row'}
            ];
            if(is9Man) {
                backs.push(
                    {c:'K', n:'后排3', cls:'back-row-2'},
                    {c:'L', n:'后排4', cls:'back-row-2'},
                    {c:'M', n:'后排5', cls:'back-row-2'}
                );
            }
            
            // 循环生成表头格 (注意：src 已改为 EMPTY_IMAGE_SRC)
            backs.forEach(function(b){
                extraHeader += '<th class="character-header ' + b.cls + ' has-fab"><span class="coord-header">(0,' + b.c + ')</span><br><img src="' + EMPTY_IMAGE_SRC + '" style="display:none"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">' + b.n + '</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="编辑角色">' + editIcon + '</div></th>';
                extraSource += '<td class="source-cell"><span class="coord">(1,' + b.c + ')</span></td>';
            });
            
            var colSpan = is9Man ? 13 : 10;
            
            // 根据模式选择默认BOSS图片
            // 9人模式(极妈) 用 2900032000_unlimited.png，6人模式(极法) 用 305581.png
            var bossImgUrl = is9Man 
                ? 'https://huiji-public.huijistatic.com/gbf/uploads/4/4f/2900032000_unlimited.png'
                : 'https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png';
            
            // 重写 thead
            thead.innerHTML = '<tr class="top-row has-fab"><th colspan="' + colSpan + '" style="padding:10px;position:relative;"><img src="' + bossImgUrl + '" style="max-width:100%;height:auto;"><button class="mini-fab edit" onclick="showQuickAddBoss(this)">' + editIcon + '</button></th></tr>' +
                '<tr class="top-row has-fab"><th colspan="' + colSpan + '" style="padding:8px;position:relative;min-height:50px;">' + statusHtml + '<button class="mini-fab edit" onclick="showQuickAddStatus(this)">' + editIcon + '</button></th></tr>' +
                '<tr>' +
                    '<th><span class="coord-header">(0,A)</span><br><span class="header-text t-text">阶段</span></th>' +
                    '<th><span class="coord-header">(0,B)</span><br><span class="header-text t-text">回合/特动</span></th>' +
                    '<th><span class="coord-header">(0,C)</span><br><span class="header-text t-text">备注</span></th>' +
                    '<th><span class="coord-header">(0,D)</span><br><span class="header-text t-text">召唤石</span></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,E)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">主角</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="编辑角色">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,F)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">2号位</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="编辑角色">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,G)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">3号位</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="编辑角色">' + editIcon + '</div></th>' +
                    '<th class="character-header has-fab"><span class="coord-header">(0,H)</span><br><img src="' + EMPTY_IMAGE_SRC + '"><span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">4号位</span><div class="btn-edit-glass" onclick="showQuickAddCharacter(this.closest(\'.character-header\'))" title="编辑角色">' + editIcon + '</div></th>' +
                    extraHeader +
                '</tr>' +
                '<tr class="skill-source-row">' +
                    '<td colspan="2" class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,A-B)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest(\'.source-cell\'))">' + editIcon + '</button></td>' +
                    '<td class="source-cell has-fab" style="vertical-align:middle;position:relative;"><span class="coord">(1,C)</span><button class="mini-fab edit" onclick="showQuickAddSummon(this.closest(\'.source-cell\'))">' + editIcon + '</button></td>' +
                    '<td class="source-cell"><span class="coord">(1,D)</span><span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span></td>' +
                    '<td class="source-cell"><span class="coord">(1,E)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,F)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,G)</span></td>' +
                    '<td class="source-cell"><span class="coord">(1,H)</span></td>' +
                    extraSource +
                '</tr>';
            
            // 2. 重写 tbody (生成默认的一个阶段)
            tbody.innerHTML = '';
            
            // 直接根据 is9Man 生成数据格，不依赖 DOM 检测
            var dataCellsHtml = '';
            var cols = is9Man ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            cols.forEach(function(col, i) {
                var cls = (i >= 4) ? 'note-cell' : 'data-cell';
                dataCellsHtml += '<td class="' + cls + '"><span class="coord">(2,' + col + ')</span></td>';
            });
            
            var rowHTML = '<tr class="phase-100-80">' +
                '<td rowspan="1"><span class="coord">(2,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">100%-?</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)">+</button></div></td>' +
                '<td><span class="coord">(2,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">1T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td>' +
                '<td class="data-cell"><span class="coord">(2,C)</span></td>' +
                '<td><span class="coord">(2,D)</span></td>' +
                dataCellsHtml +
                '</tr>';
            tbody.innerHTML = rowHTML;
            
            // 3. 重新绑定事件和初始化
            // 调用统一初始化函数（关键！）
            initDynamicElements();
            
            // 刷新坐标和保存
            recalculateAllCoords();
            
            // [新增] 强制应用一次默认字号设置，解决文字和按钮大小不对的问题
            applyDefaultFontSize();
            
            // [新增] 强制应用图标缩放设置，确保新生成的按钮应用当前的缩放设置
            applyIconScaling();
            
            // [修改] 使用统一函数控制换人行按钮的显示
            updateSwapButtonState();
            
            // [修复] 如果是恢复数据模式，不要触发保存，不要弹窗提醒
            if (!isRestoring) {
                // [新增] 检查是否有默认 JSON 配置，如果有则自动加载
                var defaultJson = is9Man ? DEFAULT_9MAN_JSON : DEFAULT_6MAN_JSON;
                if (defaultJson) {
                    try {
                        var data = JSON.parse(defaultJson);
                        restoreData(data);
                        saveToStorage();
                        alert(is9Man ? '已切换至【9人模式】并加载默认配置' : '已切换至【6人模式】并加载默认配置');
                    } catch(e) {
                        console.error('默认JSON解析失败:', e);
                        saveToStorage();
                        alert(is9Man ? '已切换至【极妈模板】' : '已切换至【极法模板】');
                    }
                } else {
                    saveToStorage();
                    alert(is9Man ? '已切换至【极妈模板】' : '已切换至【极法模板】');
                }
            }
        }
        
        // ========== [新增] 换人行功能 ==========
        // 全局计数器，用于生成唯一的换人行ID
        var swapRowCounter = 0;
        
        // [重构] 插入换人/转阶段功能 - 修复 M 格误触和 B 列显示问题
        function insertSwapRow() {
            var tbody = document.querySelector('tbody');
            var is9ManMode = document.querySelector('thead .back-row-2') !== null;
            var editIcon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            
            // 生成唯一ID
            swapRowCounter++;
            var swapId = 'swap-' + swapRowCounter + '-' + Date.now();
            
            // --- 1. 构建第一行：角色头像栏 (swap-header-row) ---
            // [修复] A+B 列合并，确保不再出现独立的 "B" 格子
            var labelColsHtml = '<td colspan="2" class="swap-label-cell" style="vertical-align:middle; text-align:center; position:relative;">' +
                '<div style="font-weight:bold; color:var(--text-secondary); font-size:12px;">🔄 换人</div>' +
                '<button class="swap-delete-btn" onclick="removeSwapSection(this)" title="删除此换人区块">×</button>' +
                '</td>' +
                '<td class="swap-label-cell"></td>' +
                '<td class="swap-label-cell"></td>';
            
            // 生成角色列 E-M
            var cols = is9ManMode ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            var names = ['主角','2号位','3号位','4号位','后排1','后排2','后排3','后排4','后排5'];
            
            var charColsHtml = '';
            cols.forEach(function(col, idx) {
                var backClass = '';
                if(idx >= 4 && idx <= 5) backClass = ' back-row';
                if(idx >= 6) backClass = ' back-row-2';
                
                // [修复] 添加 position:relative 确保编辑按钮定位正确
                charColsHtml += '<td class="swap-char-cell character-header has-fab has-empty-state' + backClass + '" style="position:relative;">' +
                    '<span class="coord-header">(SW' + swapRowCounter + ',' + col + ')</span><br>' +
                    '<img src="' + EMPTY_IMAGE_SRC + '" style="display:none">' +
                    '<span class="header-text t-text char-name" contenteditable="true" onblur="saveToStorage()">' + names[idx] + '</span>' +
                    '<div class="btn-edit-glass" onclick="showQuickAddCharacterForSwap(this.closest(\'.swap-char-cell\'))">' + editIcon + '</div>' +
                    '</td>';
            });
            
            var trHeader = document.createElement('tr');
            trHeader.className = 'swap-header-row';
            trHeader.setAttribute('data-swap-id', swapId);
            trHeader.innerHTML = labelColsHtml + charColsHtml;
            
            // --- 2. 构建第二行：源技能栏 (swap-source-row) ---
            // [修复] E-M 列不添加任何 onclick 或编辑按钮，只能通过拖拽添加，悬停显示删除按钮
            var sourceColsHtml = '';
            cols.forEach(function(col, idx) {
                var backClass = '';
                if(idx >= 4 && idx <= 5) backClass = ' back-row';
                if(idx >= 6) backClass = ' back-row-2';
                // 纯净的格子，只有坐标，无按钮
                sourceColsHtml += '<td class="source-cell' + backClass + '">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',' + col + ')</span>' +
                    '</td>';
            });
            
            var trSource = document.createElement('tr');
            trSource.className = 'skill-source-row swap-source-row';
            trSource.setAttribute('data-swap-id', swapId);
            // [修复] A-B、C 列移除编辑按钮，统一使用悬停删除
            trSource.innerHTML = 
                '<td colspan="2" class="source-cell" style="vertical-align:middle;position:relative;">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',A-B)</span>' +
                '</td>' +
                '<td class="source-cell" style="vertical-align:middle;position:relative;">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',C)</span>' +
                '</td>' +
                '<td class="source-cell">' +
                    '<span class="coord">(SRC' + swapRowCounter + ',D)</span>' +
                    '<span class="skill-box skill-source"><img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/ui/icon/ability/m/fatal_chain_3.png" style="width:40px;height:40px;"></span>' +
                '</td>' +
                sourceColsHtml;
            
            // 插入到表格底部
            tbody.appendChild(trHeader);
            tbody.appendChild(trSource);
            
            // 初始化功能 (拖拽、缩放等)
            initSwapRowElements(trHeader, trSource);
            
            if(typeof applyIconScaling === 'function') applyIconScaling();
            saveToStorage();
            
            // 滚动到新区域
            trHeader.scrollIntoView({behavior: "smooth"});
        }
        
        // 删除换人区块 (同时删除头像行和技能行)
        function removeSwapSection(btn) {
            if(confirm('确定要删除这个换人区块吗？(将删除头像行和对应的技能行)')) {
                var trHeader = btn.closest('tr');
                var swapId = trHeader.getAttribute('data-swap-id');
                
                // 通过 data-swap-id 找到对应的技能行
                var trSource = document.querySelector('tr.swap-source-row[data-swap-id="' + swapId + '"]');
                
                if(trSource) {
                    trSource.remove();
                }
                trHeader.remove();
                saveToStorage();
            }
        }
        
        // 为换人行的角色格显示快速添加弹窗
        function showQuickAddCharacterForSwap(cell) {
            // 复用现有的角色添加逻辑，但针对换人行的单元格
            if(typeof showQuickAddCharacter === 'function') {
                // 临时给 cell 添加 character-header 类以复用逻辑
                var originalClass = cell.className;
                cell.classList.add('character-header');
                showQuickAddCharacter(cell);
                // 恢复原始类名（在弹窗关闭后会自动处理）
            }
        }
        
        // 初始化换人行元素的事件绑定
        function initSwapRowElements(headerRow, sourceRow) {
            // 为换人行的角色格绑定拖放事件
            headerRow.querySelectorAll('.swap-char-cell').forEach(function(cell, idx) {
                // 1. 拖拽进入：添加高亮样式
                cell.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    // 检查内部拖拽(draggedElement)或外部拖拽(dataTransfer)
                    if(draggedElement || e.dataTransfer.types.length > 0) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 2. 拖拽悬停：保持允许放置状态
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 3. 拖拽离开：移除高亮样式
                cell.addEventListener('dragleave', function(e) {
                    if(e.target === this) {
                        this.classList.remove('drag-feedback');
                    }
                });
                
                // 4. 放置：处理内部拖拽和外部拖拽
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // [修复] 阻止事件冒泡，防止其他监听器重复处理
                    this.classList.remove('drag-feedback');
                    
                    var imgSrc = '';
                    
                    // 优先处理内部拖拽 (draggedElement)
                    if(draggedElement) {
                        var dragImg = draggedElement.querySelector('img');
                        if(dragImg) {
                            imgSrc = dragImg.src;
                        }
                    }
                    
                    // 其次处理外部拖拽
                    if(!imgSrc) {
                        // 方式1: text/html
                        var htmlData = e.dataTransfer.getData('text/html');
                        if(htmlData) {
                            var match = htmlData.match(/<img[^>]+src=["']([^"']+)["']/i);
                            if(match && match[1]) imgSrc = match[1];
                        }
                        // 方式2: text/plain
                        if(!imgSrc) {
                            var plainText = e.dataTransfer.getData('text/plain');
                            if(plainText && plainText.match(/^https?:\/\//i)) imgSrc = plainText;
                        }
                    }
                    
                    if(imgSrc) {
                        var img = this.querySelector('img');
                        if(img) {
                            img.src = imgSrc;
                            img.style.display = '';
                        }
                        // 更新空状态
                        updateSwapCharEmptyState(this);
                        saveToStorage();
                    }
                });
                
                // 初始触发空状态检测
                updateSwapCharEmptyState(cell);
            });
            
            // 为换人行的技能格绑定拖放事件
            sourceRow.querySelectorAll('.source-cell').forEach(function(cell) {
                var coordEl = cell.querySelector('.coord');
                var coordText = coordEl ? coordEl.textContent : '';
                var isSummonCell = coordText.indexOf('A-B') > -1 || coordText.indexOf(',C)') > -1;
                var isSkillCell = !isSummonCell && coordText.indexOf(',D)') === -1; // 排除D列(FC格)
                
                // 1. 拖拽进入：添加高亮样式
                cell.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    // 检查内部拖拽(draggedElement)或外部拖拽(dataTransfer)
                    if(draggedElement || e.dataTransfer.types.length > 0) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 2. 拖拽悬停：保持允许放置状态
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    if(!this.classList.contains('drag-feedback') && (draggedElement || e.dataTransfer.types.length > 0)) {
                        this.classList.add('drag-feedback');
                    }
                });
                
                // 3. 拖拽离开：移除高亮样式
                cell.addEventListener('dragleave', function(e) {
                    if(e.target === this) {
                        this.classList.remove('drag-feedback');
                    }
                });
                
                // 4. 放置：处理内部拖拽和外部拖拽
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // [修复] 阻止事件冒泡，防止其他监听器重复处理
                    this.classList.remove('drag-feedback');
                    
                    var imgSrc = '';
                    var cellRef = this;
                    var coordEl = cellRef.querySelector('.coord');
                    var isSummon = coordEl && 
                        (coordEl.textContent.indexOf('A-B') > -1 || 
                         coordEl.textContent.indexOf(',C)') > -1);
                    
                    // 优先处理内部拖拽 (draggedElement)
                    if(draggedElement) {
                        var dragImg = draggedElement.querySelector('img');
                        if(dragImg) {
                            imgSrc = dragImg.src;
                        }
                    }
                    
                    // 其次处理外部拖拽
                    if(!imgSrc) {
                        // 方式1: text/html
                        var htmlData = e.dataTransfer.getData('text/html');
                        if(htmlData) {
                            var match = htmlData.match(/<img[^>]+src=["']([^"']+)["']/i);
                            if(match && match[1]) imgSrc = match[1];
                        }
                        // 方式2: text/plain
                        if(!imgSrc) {
                            var plainText = e.dataTransfer.getData('text/plain');
                            if(plainText && plainText.match(/^https?:\/\//i)) imgSrc = plainText;
                        }
                    }
                    
                    if(imgSrc) {
                        // 创建新的 skill-box
                        // [修复] 所有列统一使用悬停删除按钮
                        var box = createSkillBox(imgSrc, {
                            className: isSummon ? 'skill-box summon-box skill-source' : 'skill-box skill-source',
                            size: 40,
                            editable: true,
                            deletable: true, // 所有列都有删除按钮
                            dragImageSize: 20
                        });
                        cellRef.appendChild(box);
                        
                        // 更新空状态
                        if(isSummon) {
                            updateSwapSummonEmptyState(cellRef);
                        } else {
                            updateSwapSourceEmptyState(cellRef);
                        }
                        saveToStorage();
                    }
                });
                
                // 移除双击添加召唤石功能（统一使用拖拽）
                
                // 初始触发空状态检测
                if(isSummonCell) {
                    updateSwapSummonEmptyState(cell);
                } else if(isSkillCell) {
                    updateSwapSourceEmptyState(cell);
                }
            });
        }
        
        // [新增] 换人行角色格空状态检测
        function updateSwapCharEmptyState(cell) {
            if (!cell) return;
            
            var img = cell.querySelector('img');
            var isEmpty = !img || !img.src || img.src === EMPTY_IMAGE_SRC || img.src.trim() === '' || img.style.display === 'none';
            var existingHint = cell.querySelector('.empty-state-hint');
            
            if (isEmpty && !existingHint) {
                // 判断是否为主角位置
                var coordEl = cell.querySelector('.coord-header');
                var isMainChar = coordEl && coordEl.textContent.indexOf(',E)') > -1;
                var wikiUrl = isMainChar ? 'https://gbf.huijiwiki.com/wiki/%E8%81%8C%E4%B8%9A%E7%9B%AE%E5%BD%95' : 'https://gbf.huijiwiki.com/wiki/SSR%E4%BA%BA%E7%89%A9';
                var wikiText = isMainChar ? '🔗 Wiki职业' : '🔗 Wiki查询';
                var emptyText = isMainChar ? '拖入职业图片' : '拖入角色图片';
                
                var hint = document.createElement('div');
                hint.className = 'empty-state-hint';
                hint.innerHTML = '<span class="empty-text">' + emptyText + '</span>' +
                    '<div class="empty-buttons">' +
                    '<a href="' + wikiUrl + '" target="_blank" class="wiki-btn-small wiki-warning">' + wikiText + '</a>' +
                    '<a href="https://game.granbluefantasy.jp/#party/index/0/npc/0" target="_blank" class="wiki-btn-small">🔗 编队</a>' +
                    '</div>';
                cell.appendChild(hint);
                cell.classList.add('has-empty-state');
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }
        
        // [新增] 换人行技能源格空状态检测
        function updateSwapSourceEmptyState(cell) {
            if (!cell) return;
            
            var skillBoxes = cell.querySelectorAll('.skill-box');
            var isEmpty = skillBoxes.length === 0;
            var existingHint = cell.querySelector('.swap-source-empty-hint');
            
            // 跳过 D 列（FC格）和 A-B/C 列（召唤石格，已有编辑按钮）
            var coordEl = cell.querySelector('.coord');
            if (coordEl) {
                var coordText = coordEl.textContent;
                if (coordText.indexOf(',D)') > -1 || coordText.indexOf('A-B') > -1 || coordText.indexOf(',C)') > -1) {
                    return;
                }
            }
            
            if (isEmpty && !existingHint) {
                var hint = document.createElement('div');
                hint.className = 'swap-source-empty-hint';
                hint.style.cssText = 'font-size:10px;color:#999;text-align:center;padding:5px;';
                hint.textContent = '拖入技能';
                cell.appendChild(hint);
                cell.classList.add('has-empty-state');
            } else if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }
        
        // [新增] 换人行召唤石格空状态检测
        // [修改] 移除换人行B列的空召唤提示，只保留移除逻辑
        function updateSwapSummonEmptyState(cell) {
            if (!cell) return;
            
            // 只处理移除已有提示的逻辑，不再添加新提示
            var existingHint = cell.querySelector('.swap-summon-empty-hint');
            var skillBoxes = cell.querySelectorAll('.skill-box');
            var isEmpty = skillBoxes.length === 0;
            
            if (!isEmpty && existingHint) {
                existingHint.remove();
                cell.classList.remove('has-empty-state');
            }
        }

        // 加载配置功能
        function loadConfig(){
            var defaultData = localStorage.getItem(STORAGE_KEY + '_default');
            if(defaultData){
                if(confirm('确定加载保存的配置？当前内容将被覆盖。')){
                    restoreData(JSON.parse(defaultData));
                    saveToStorage();
                    alert('配置已加载');
                }
            } else {
                alert('没有找到保存的配置');
            }
        }
        
        // 恢复功能 - 重置为初始状态
        function resetData(){
            if (!confirm('⚠️ 警告：恢复初始状态将清空所有当前编辑的内容。\n\n确定要继续吗？')) {
                return;
            }
            // 1. 清空本地存储
            localStorage.removeItem(STORAGE_KEY);
            // 2. 重置换人行计数器
            swapRowCounter = 0;
            // 3. 检测当前是 6人 还是 9人 模式
            var is9Man = document.querySelector('thead .back-row-2') !== null;
            // 4. 重新加载对应模板
            loadTemplate(is9Man ? 9 : 6);
        }
        
        function saveAsDefault(){if(confirm('确认保存当前配置？')){localStorage.setItem(STORAGE_KEY+'_default',JSON.stringify(collectData()));alert('已保存为默认');}}
        
        function showTextInput(cell){
            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
            var p1Color=isDark?'#ff6b6b':'#c62828';
            var p2Color=isDark?'#ff8a80':'#c62828';
            var p3Color=isDark?'#e0e0e0':'#333';
            var p4Color=isDark?'#bdbdbd':'#333';
            var defaultSize=getDefaultFontSize();
            var overlay=document.createElement('div');overlay.className='modal-overlay';
            var modal=document.createElement('div');modal.className='text-input-modal';
            modal.innerHTML='<div style="margin-bottom:12px;font-size:14px;font-weight:500;">添加备注文字</div><input type="text" placeholder="输入备注内容" maxlength="50" style="width:100%;margin-bottom:14px;"><div style="margin-bottom:14px;display:flex;flex-wrap:wrap;gap:4px;"><label class="material-radio"><input type="radio" name="style" value="1" checked><span style="color:'+p1Color+';font-weight:bold;">优先级1</span></label><label class="material-radio"><input type="radio" name="style" value="2"><span style="color:'+p2Color+';">优先级2</span></label><label class="material-radio"><input type="radio" name="style" value="3"><span style="color:'+p3Color+';font-weight:bold;">优先级3</span></label><label class="material-radio"><input type="radio" name="style" value="4"><span style="color:'+p4Color+';">优先级4</span></label></div><div style="display:flex;gap:10px;justify-content:flex-end;"><button class="btn-cancel" style="background:#616161;">取消</button><button class="btn-confirm">确定</button></div>';
            document.body.appendChild(overlay);document.body.appendChild(modal);
            var input=modal.querySelector('input[type="text"]');input.focus();
            function close(){overlay.remove();modal.remove();}
            function submit(){
                var txt=input.value.trim();if(!txt){close();return;}
                var style=modal.querySelector('input[name="style"]:checked').value;
                
                // 创建wrapper包裹用户文字和删除按钮
                var wrapper=document.createElement('span');
                wrapper.className='user-text-wrapper';
                
                var span=document.createElement('span');
                span.className='user-text';
                span.textContent=txt;
                span.setAttribute('contenteditable','true');
                span.setAttribute('data-priority',style);
                span.style.fontSize=defaultSize+'px';
                if(style==='1'){span.style.color=p1Color;span.style.fontWeight='bold';}
                else if(style==='2'){span.style.color=p2Color;}
                else if(style==='3'){span.style.color=p3Color;span.style.fontWeight='bold';}
                else{span.style.color=p4Color;}
                
                // 标记为可以被默认字号影响（不设置data-custom-size）
                
                // 添加删除按钮
                var delBtn=document.createElement('button');
                delBtn.className='mini-fab delete';
                delBtn.innerHTML='×';
                delBtn.title='删除';
                delBtn.onclick=function(ev){
                    ev.stopPropagation();
                    var parentCell = wrapper.closest('td');
                    wrapper.remove();
                    saveToStorage();
                    // 更新备注单元格空状态
                    if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                };
                
                wrapper.appendChild(span);
                wrapper.appendChild(delBtn);
                
                // 添加事件监听
                span.addEventListener('blur',function(){
                    // 清理空文本
                    if(!this.textContent.trim()){
                        var parentCell = wrapper.closest('td');
                        wrapper.remove();
                        // 更新备注单元格空状态
                        if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                    }
                    saveToStorage();
                });
                
                span.addEventListener('paste',function(e){
                    // 只允许粘贴纯文本，防止格式污染
                    e.preventDefault();
                    var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                    document.execCommand('insertText',false,text.substring(0,50));
                });
                
                span.addEventListener('keydown',function(e){
                    // 限制长度
                    if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                        e.preventDefault();
                    }
                    // 防止换行
                    if(e.key==='Enter'){
                        e.preventDefault();
                        this.blur();
                    }
                });
                
                span.addEventListener('input',function(){
                    // 保持样式不变，移除任何内联格式
                    var priority=this.getAttribute('data-priority');
                    var currentColor=this.style.color;
                    var currentWeight=this.style.fontWeight;
                    var currentSize=this.style.fontSize;
                    
                    // 如果检测到样式被改变，恢复它
                    setTimeout(function(){
                        if(span.style.color!==currentColor)span.style.color=currentColor;
                        if(span.style.fontWeight!==currentWeight)span.style.fontWeight=currentWeight;
                        if(span.style.fontSize!==currentSize)span.style.fontSize=currentSize;
                    },0);
                });
                
                cell.appendChild(wrapper);
                saveToStorage();
                // 更新备注单元格空状态
                if(window.updateNoteEmptyState) window.updateNoteEmptyState(cell);
                close();
            }
            overlay.onclick=close;
            modal.querySelector('.btn-confirm').onclick=submit;
            modal.querySelector('.btn-cancel').onclick=close;
            input.onkeydown=function(e){if(e.key==='Enter')submit();if(e.key==='Escape')close();};
        }
        
        function addRow(){var tbody=document.querySelector('tbody'),rowCount=tbody.querySelectorAll('tr').length+2,tr=document.createElement('tr');tr.innerHTML='<td><span class="coord">('+rowCount+',B)</span></td><td class="data-cell"><span class="coord">('+rowCount+',C)</span></td><td><span class="coord">('+rowCount+',D)</span></td><td class="data-cell"><span class="coord">('+rowCount+',E)</span></td><td class="data-cell"><span class="coord">('+rowCount+',F)</span></td><td class="data-cell"><span class="coord">('+rowCount+',G)</span></td><td class="data-cell"><span class="coord">('+rowCount+',H)</span></td><td class="note-cell"><span class="coord">('+rowCount+',I)</span></td><td class="note-cell"><span class="coord">('+rowCount+',J)</span></td>';tbody.appendChild(tr);tr.querySelectorAll('td').forEach(function(cell){bindCellEvents(cell);});}
        // [修复] 导出图片功能 - 使用 fetch + blob 方式处理跨域图片
        function exportAsImage(){
            var tableWrapper = document.querySelector('.table-wrapper');
            var table = document.getElementById('guideTable');
            if (!tableWrapper || !table) return;
            
            // 隐藏状态栏
            if(typeof statusBar !== 'undefined') statusBar.style.display = 'none';
            
            // 给用户反馈
            var btn = document.querySelector('button[onclick="exportAsImage()"]');
            var originalText = btn ? btn.innerHTML : '';
            if(btn) {
                btn.innerHTML = '⏳ 正在处理图片...';
                btn.disabled = true;
            }
            
            // 导出前隐藏所有Mini FAB按钮
            table.classList.add('exporting');
            
            // 检测当前主题
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var bgColor = isDark ? '#1e1e1e' : '#ffffff';
            var textColor = isDark ? '#e0e0e0' : '#333333';
            var borderColor = isDark ? '#444' : '#ddd';
            
            // 🌟 创建高级感水印 (High-End Watermark) - 顶部版本
            var watermark = document.createElement('div');
            watermark.id = 'exportWatermark';
            
            // 作者信息（左侧，大字）
            var authorName = AuthorSystem.currentAuthor;
            var authorHtml = (authorName === '访客' || authorName === 'Guest') ? 
                '<span style="font-size: 28px; font-weight: 900; letter-spacing: 1px;">GBF 一图流攻略</span>' : 
                '<span style="opacity: 0.6; font-size: 14px; margin-right: 8px;">一图流制作 by</span>' +
                '<span style="font-size: 28px; font-weight: 900; letter-spacing: 1px;">' + authorName + '</span>';
            
            // 历史贡献者（左侧下方）
            var historyNames = AuthorSystem.history.filter(function(n) { return n !== authorName && n !== '访客' && n !== 'Guest'; });
            var contributorsHtml = '';
            if (historyNames.length > 0) {
                contributorsHtml = '<div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">贡献者: ' + historyNames.join(', ') + '</div>';
            }
            
            // 水印 HTML 内容（左侧作者，右侧网址）
            watermark.innerHTML = 
                '<div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; line-height: 1.2;">' +
                    '<div style="display: flex; flex-direction: column;">' +
                        '<div style="display: flex; align-items: baseline;">' + authorHtml + '</div>' +
                        contributorsHtml +
                    '</div>' +
                    '<div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">' +
                        '<span style="font-size: 18px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 2px;">gbfop.com</span>' +
                        '<span style="font-size: 12px; opacity: 0.6; font-weight: 500; letter-spacing: 1px;">GranBlueFantasy One Picture</span>' +
                    '</div>' +
                '</div>';
            
            // 水印容器样式（顶部版本）
            watermark.style.cssText = 
                'margin-bottom: 20px;' +
                'padding: 20px 30px;' +
                'border-bottom: 3px solid ' + borderColor + ';' +
                'background: ' + bgColor + ';' +
                'color: ' + textColor + ';' +
                'font-family: "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;' +
                'box-sizing: border-box;' +
                'border-radius: 12px 12px 0 0;';
            
            // 插入水印到表格容器顶部
            tableWrapper.insertBefore(watermark, tableWrapper.firstChild);
            
            // 收集所有需要处理的图片
            var images = Array.from(table.querySelectorAll('img'));
            var originalSrcs = new Map();
            var processed = 0;
            var total = images.length;
            
            if (total === 0) {
                doCapture();
                return;
            }
            
            // 逐个处理图片
            images.forEach(function(img) {
                var src = img.src;
                
                // 跳过已经是 base64 或空的
                if (!src || src.startsWith('data:') || src.startsWith('blob:')) {
                    processed++;
                    checkComplete();
                    return;
                }
                
                // 保存原始 src
                originalSrcs.set(img, src);
                
                // 使用 fetch 通过代理获取图片
                fetchImageAsBase64(src)
                    .then(function(base64) {
                        if (base64) {
                            img.src = base64;
                        }
                    })
                    .catch(function() {
                        // 失败时保持原样
                    })
                    .finally(function() {
                        processed++;
                        if(btn) btn.innerHTML = '⏳ 处理中 ' + processed + '/' + total;
                        checkComplete();
                    });
            });
            
            function checkComplete() {
                if (processed >= total) {
                    if(btn) btn.innerHTML = '⏳ 生成截图...';
                    setTimeout(doCapture, 300);
                }
            }
            
            function doCapture() {
                // 临时处理 sticky 定位
                var stickyElements = document.querySelectorAll('.guide-table thead, .toolbar');
                var originalStyles = [];
                stickyElements.forEach(function(el) {
                    originalStyles.push({
                        position: el.style.position,
                        top: el.style.top
                    });
                    el.style.position = 'static';
                    el.style.top = 'auto';
                });
                
                setTimeout(function() {
                    // 截图目标改为 tableWrapper（包含水印）
                    html2canvas(tableWrapper, {
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: bgColor,
                        scale: 2,
                        scrollX: 0,
                        scrollY: -window.scrollY,
                        logging: false
                    }).then(function(canvas){
                        restoreAll();
                        downloadCanvas(canvas);
                    }).catch(function(error){
                        restoreAll();
                        console.error('截图失败:', error);
                        alert('导出失败，建议使用浏览器截图功能（如 Windows 的 Win+Shift+S）');
                    });
                }, 200);
                
                function restoreAll() {
                    stickyElements.forEach(function(el, i) {
                        el.style.position = originalStyles[i].position || '';
                        el.style.top = originalStyles[i].top || '';
                    });
                    originalSrcs.forEach(function(src, img) {
                        img.src = src;
                    });
                    table.classList.remove('exporting');
                    // 🌟 移除水印
                    if (watermark && watermark.parentNode) {
                        watermark.parentNode.removeChild(watermark);
                    }
                    if(btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            }
            
            function downloadCanvas(canvas) {
                var link = document.createElement('a');
                var date = new Date();
                var dateStr = date.getFullYear() + '-' + 
                              String(date.getMonth()+1).padStart(2,'0') + '-' + 
                              String(date.getDate()).padStart(2,'0');
                link.download = 'gbfop_Guide_' + dateStr + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }
        
        // 通过多个代理尝试获取图片的 Base64
        function fetchImageAsBase64(url) {
            // 代理列表（按可靠性排序）
            var proxies = [
                function(u) { return 'https://corsproxy.io/?' + encodeURIComponent(u); },
                function(u) { return 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u); },
                function(u) { return 'https://proxy.cors.sh/' + u; }
            ];
            
            // 先尝试直接获取
            return tryFetch(url)
                .catch(function() {
                    // 依次尝试代理
                    return proxies.reduce(function(promise, proxyFn) {
                        return promise.catch(function() {
                            return tryFetch(proxyFn(url));
                        });
                    }, Promise.reject());
                });
        }
        
        function tryFetch(url) {
            return new Promise(function(resolve, reject) {
                var timeout = setTimeout(function() { reject('timeout'); }, 8000);
                
                fetch(url, { mode: 'cors' })
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP error');
                        return response.blob();
                    })
                    .then(function(blob) {
                        clearTimeout(timeout);
                        var reader = new FileReader();
                        reader.onloadend = function() {
                            resolve(reader.result);
                        };
                        reader.onerror = function() { reject('read error'); };
                        reader.readAsDataURL(blob);
                    })
                    .catch(function(err) {
                        clearTimeout(timeout);
                        reject(err);
                    });
            });
        }
        function clearAllSilent(){document.querySelectorAll('tbody td').forEach(function(cell){cell.querySelectorAll('.skill-box:not(.skill-source)').forEach(function(box){box.remove();});cell.querySelectorAll('.user-text-wrapper').forEach(function(wrapper){wrapper.remove();});cell.querySelectorAll('.user-text').forEach(function(txt){txt.remove();});});}
        function clearAll(){if(confirm('清空所有?')){clearAllSilent();saveToStorage();}}
        // 阶段内添加行 (已更新：包含右侧+号)
        function addRowToPhase(btn){
            var phaseCell=btn.closest('td');
            var phaseRow=phaseCell.closest('tr');
            var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            var phaseIndex=rows.indexOf(phaseRow);
            var lastRowIndex=phaseIndex+rowspan-1;
            var newRow=document.createElement('tr');
            newRow.innerHTML='<td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td><td class="data-cell"><span class="coord">(0,E)</span></td><td class="data-cell"><span class="coord">(0,F)</span></td><td class="data-cell"><span class="coord">(0,G)</span></td><td class="data-cell"><span class="coord">(0,H)</span></td><td class="note-cell"><span class="coord">(0,I)</span></td><td class="note-cell"><span class="coord">(0,J)</span></td>';
            if(lastRowIndex<rows.length-1){rows[lastRowIndex].after(newRow);}else{tbody.appendChild(newRow);}
            phaseCell.setAttribute('rowspan',rowspan+1);
            newRow.querySelectorAll('td').forEach(function(cell){bindCellEvents(cell);});
            // 为新添加的B列文字绑定不可删除逻辑
            var bText = newRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
            recalculateAllCoords();
            applyDefaultFontSize(); // 应用默认字号到新添加的行
            saveToStorage();
        }
        function deleteRow(btn){
            var row=btn.closest('tr');
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr:not(.add-phase-row)'));
            var rowIndex=rows.indexOf(row);
            var phaseCell=null;
            var phaseCellRow=null;
            for(var i=rowIndex;i>=0;i--){var cell=rows[i].querySelector('td[rowspan]');if(cell){phaseCell=cell;phaseCellRow=rows[i];break;}}
            if(!phaseCell)return;
            var rowspan=parseInt(phaseCell.getAttribute('rowspan'))||1;
            if(rowspan<=1){alert('至少保留1行');return;}
            
            // 检查是否删除的是阶段第一行（包含rowspan单元格的行）
            var isFirstRowOfPhase = (row === phaseCellRow);
            
            if(isFirstRowOfPhase && rowspan > 1){
                // 删除阶段第一行：需要将阶段单元格移动到下一行
                var nextRow = rows[rowIndex + 1];
                if(nextRow){
                    // 保存阶段行的class（如phase-80-60）
                    var phaseClass = row.className;
                    
                    // 更新rowspan
                    phaseCell.setAttribute('rowspan', rowspan - 1);
                    
                    // 将阶段单元格插入到下一行的开头
                    nextRow.insertBefore(phaseCell, nextRow.firstChild);
                    
                    // 将阶段class转移到新的第一行
                    if(phaseClass){
                        nextRow.className = phaseClass;
                    }
                    
                    // 删除原来的第一行
                    row.remove();
                }
            } else {
                // 删除非第一行：原有逻辑
                phaseCell.setAttribute('rowspan', rowspan - 1);
                row.remove();
            }
            
            recalculateAllCoords();
            saveToStorage();
        }
        
        // [改进] 辅助函数：根据模式生成对应的数据格
        // 不再依赖 .character-header 数量，避免换人行干扰
        function getDataCellsHtml(rowIndex, is9Man) {
            // 如果没有传入 is9Man，则通过 thead 检测（兼容旧调用）
            if (typeof is9Man === 'undefined') {
                is9Man = document.querySelector('thead .back-row-2') !== null;
            }
            var cols = is9Man ? ['E','F','G','H','I','J','K','L','M'] : ['E','F','G','H','I','J'];
            var html = '';
            // 使用 cols.length 循环，永远不会越界
            for(var i = 0; i < cols.length; i++) {
                var col = cols[i];
                // I列及之后通常作为 note-cell (备注格)
                var cls = (i >= 4) ? 'note-cell' : 'data-cell';
                html += '<td class="' + cls + '"><span class="coord">(' + rowIndex + ',' + col + ')</span></td>';
            }
            return html;
        }
        
        // [新增] 在当前行下方插入新行
        // [修改] 使用 getDataCellsHtml 动态生成列
        function insertRowBelow(btn) {
            var currentRow = btn.closest('tr');
            var tbody = document.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr:not(.add-phase-row)'));
            var currentRowIndex = rows.indexOf(currentRow);

            // 1. 找到该行所属的阶段 (Phase)
            var phaseCell = null;
            // 向前查找带有 rowspan 的行
            for (var i = currentRowIndex; i >= 0; i--) {
                var cell = rows[i].querySelector('td[rowspan]');
                if (cell) {
                    var rs = parseInt(cell.getAttribute('rowspan')) || 1;
                    // 检查 rowspan 是否覆盖了 currentRow
                    if (currentRowIndex <= i + rs - 1) {
                        phaseCell = cell;
                    }
                    break;
                }
            }

            // 2. 创建新行 - [修改] 动态生成后半部分
            var newRow = document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // 坐标稍后会重算
            newRow.innerHTML = '<td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;

            // 3. 插入新行
            currentRow.after(newRow);

            // 4. 更新阶段的 rowspan
            if (phaseCell) {
                var currentRs = parseInt(phaseCell.getAttribute('rowspan')) || 1;
                phaseCell.setAttribute('rowspan', currentRs + 1);
            }

            // 5. 绑定事件
            newRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
            // 绑定不可删除逻辑
            var bText = newRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
            
            // [新增] 为新行的 I/M 列添加合并控制按钮
            newRow.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });

            // 6. 刷新
            recalculateAllCoords();
            applyDefaultFontSize();
            saveToStorage();
        }
        
        // 删除整个阶段
        function deletePhase(btn){
            var phaseCell = btn.closest('td');
            var phaseRow = phaseCell.closest('tr');
            var tbody = document.querySelector('tbody');
            var allPhaseCells = document.querySelectorAll('td[rowspan]');
            
            // 检查是否至少保留1个阶段
            if(allPhaseCells.length <= 1){
                alert('至少保留1个阶段');
                return;
            }
            
            // 确认对话框
            if(!confirm('确定删除此阶段？该阶段的所有行都会被删除。')){
                return;
            }
            
            var rowspan = parseInt(phaseCell.getAttribute('rowspan')) || 1;
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var phaseIndex = rows.indexOf(phaseRow);
            
            // 删除该阶段的所有行（从后往前删除）
            for(var i = rowspan - 1; i >= 0; i--){
                var rowToDelete = rows[phaseIndex + i];
                if(rowToDelete && !rowToDelete.classList.contains('add-phase-row')){
                    rowToDelete.remove();
                }
            }
            
            recalculateAllCoords();
            refreshPhaseColors();
            saveToStorage();
        }
        
        // [新增] 刷新所有阶段的颜色 (红->橙->黄->绿 循环)
        function refreshPhaseColors() {
            var phaseCells = document.querySelectorAll('tbody tr > td[rowspan]');
            var classes = ['phase-100-80', 'phase-80-60', 'phase-60-20', 'phase-20-0'];
            phaseCells.forEach(function(cell, index) {
                var row = cell.parentElement;
                // 移除旧颜色类
                classes.forEach(function(c) { row.classList.remove(c); });
                // 添加新颜色类 (取模循环)
                row.classList.add(classes[index % classes.length]);
            });
        }
        
        // [新增] 在当前阶段下方插入新阶段
        // [修改] 使用 getDataCellsHtml 动态生成列
        function insertPhaseBelow(btn) {
            var currentPhaseCell = btn.closest('td');
            var currentPhaseRow = currentPhaseCell.closest('tr');
            var rowspan = parseInt(currentPhaseCell.getAttribute('rowspan')) || 1;

            // 1. 计算插入位置 (当前阶段的最后一行之后)
            var tbody = document.querySelector('tbody');
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var currentIndex = rows.indexOf(currentPhaseRow);
            var insertIndex = currentIndex + rowspan;
            var referenceRow = rows[insertIndex];
            
            // [新增] 如果下面紧跟的是换人行，则跳过换人行（包括 header 和 source）
            while (referenceRow && (referenceRow.classList.contains('swap-header-row') || referenceRow.classList.contains('swap-source-row'))) {
                referenceRow = referenceRow.nextElementSibling;
            }

            // 2. 创建新阶段行 (默认1行高度) - [修改] 动态生成后半部分
            var newPhaseRow = document.createElement('tr');
            var extraCells = getDataCellsHtml(0); // 坐标稍后会重算
            newPhaseRow.innerHTML = '<td rowspan="1"><span class="coord">(0,A)</span><span class="t-text phase-name" contenteditable="true" onblur="saveToStorage()">新阶段</span><br><div class="a-cell-buttons"><button class="phase-del-btn" onclick="deletePhase(this)" title="删除此阶段">−</button><button class="phase-btn" onclick="insertPhaseBelow(this)" title="在下方插入新阶段">+</button></div></td><td><span class="coord">(0,B)</span><div class="b-cell-content"><button class="del-btn" onclick="deleteRow(this)">−</button><span class="t-text" contenteditable="true" onblur="saveToStorage()">T</span><button class="add-row-btn" onclick="insertRowBelow(this)">+</button></div></td><td class="data-cell"><span class="coord">(0,C)</span></td><td><span class="coord">(0,D)</span></td>' + extraCells;

            // 3. 插入 DOM
            if (referenceRow) {
                referenceRow.before(newPhaseRow);
            } else {
                tbody.appendChild(newPhaseRow);
            }

            // 4. 绑定通用事件
            newPhaseRow.querySelectorAll('td').forEach(function(cell){ bindCellEvents(cell); });
            // 绑定不可删除逻辑
            var phaseName = newPhaseRow.querySelector('.t-text.phase-name');
            if(phaseName && window.setupUndeletableText) window.setupUndeletableText(phaseName, '新阶段');
            var bText = newPhaseRow.querySelector('.b-cell-content .t-text');
            if(bText && window.setupUndeletableText) window.setupUndeletableText(bText, 'T');
            
            // [新增] 为新阶段行的 I/M 列添加合并控制按钮
            newPhaseRow.querySelectorAll('.note-cell').forEach(function(cell){
                var coord = cell.querySelector('.coord');
                if(coord && (coord.textContent.includes(',I)') || coord.textContent.includes(',M)'))) {
                    updateRowControls(cell);
                }
            });

            // 5. 刷新一切
            refreshPhaseColors();
            recalculateAllCoords();
            applyDefaultFontSize();
            saveToStorage();
        }
        
        // ========== 格子合并功能（新版） ==========
        
        // 直接添加优先级1文字（不弹窗）
        function addPriorityText(cell){
            var isDark=document.documentElement.getAttribute('data-theme')==='dark';
            var p1Color=isDark?'#ff6b6b':'#c62828';
            var defaultSize=getDefaultFontSize();
            
            // 创建wrapper包裹用户文字和删除按钮
            var wrapper=document.createElement('span');
            wrapper.className='user-text-wrapper';
            
            var span=document.createElement('span');
            span.className='user-text';
            span.textContent='文字';
            span.setAttribute('contenteditable','true');
            span.setAttribute('data-priority','1');
            span.style.fontSize=defaultSize+'px';
            span.style.color=p1Color;
            span.style.fontWeight='bold';
            
            // 标记为可以被默认字号影响（不设置data-custom-size）
            
            // 添加删除按钮
            var delBtn=document.createElement('button');
            delBtn.className='mini-fab delete';
            delBtn.innerHTML='×';
            delBtn.title='删除';
            delBtn.onclick=function(ev){
                ev.stopPropagation();
                var parentCell = wrapper.closest('td');
                wrapper.remove();
                saveToStorage();
                // 更新备注单元格空状态
                if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
            };
            
            wrapper.appendChild(span);
            wrapper.appendChild(delBtn);
            
            // 添加事件监听
            span.addEventListener('blur',function(){
                // 清理空文本
                if(!this.textContent.trim()){
                    var parentCell = wrapper.closest('td');
                    wrapper.remove();
                    // 更新备注单元格空状态
                    if(parentCell && window.updateNoteEmptyState) window.updateNoteEmptyState(parentCell);
                }
                saveToStorage();
            });
            
            span.addEventListener('paste',function(e){
                // 只允许粘贴纯文本，防止格式污染
                e.preventDefault();
                var text=(e.clipboardData||window.clipboardData).getData('text/plain');
                document.execCommand('insertText',false,text.substring(0,50));
            });
            
            span.addEventListener('keydown',function(e){
                // 限制长度
                if(this.textContent.length>=50&&e.key!=='Backspace'&&e.key!=='Delete'&&!e.ctrlKey&&!e.metaKey){
                    e.preventDefault();
                }
                // 防止换行
                if(e.key==='Enter'){
                    e.preventDefault();
                    this.blur();
                }
            });
            
            // 添加到单元格
            cell.appendChild(wrapper);
            
            // 更新备注单元格空状态
            if(window.updateNoteEmptyState) window.updateNoteEmptyState(cell);
            
            // 自动选中文字进行编辑
            span.focus();
            span.select();
            
            saveToStorage();
        }
        
        // 向右合并单元格
        function mergeRight(cell){
            var row = cell.closest('tr');
            var cells = Array.from(row.querySelectorAll('td'));
            var currentIndex = cells.indexOf(cell);
            var currentColspan = parseInt(cell.getAttribute('colspan') || 1);
            
            // 找到下一个可见的单元格进行合并
            var nextVisibleCell = null;
            var nextVisibleIndex = -1;
            
            // 从当前单元格后面开始查找下一个可见单元格
            for(var i = currentIndex + 1; i < cells.length; i++){
                var testCell = cells[i];
                if(testCell.style.display !== 'none' && testCell.offsetParent !== null){
                    nextVisibleCell = testCell;
                    nextVisibleIndex = i;
                    break;
                }
            }
            
            if(!nextVisibleCell) return; // 没有找到可合并的单元格
            
            // 检查是否超出H列范围（不能合并到I或J列）
            var coord = getCellCoord(nextVisibleCell);
            if(coord && (coord.col === 'I' || coord.col === 'J')) return; // 不能合并到I或J列
            
            // 保存被合并单元格的信息（用于拆分时恢复）
            if(!cell.mergedCells) {
                cell.mergedCells = [];
            }
            
            // 保存单元格信息
            var cellInfo = {
                coord: coord,
                innerHTML: nextVisibleCell.innerHTML,
                className: nextVisibleCell.className,
                index: nextVisibleIndex
            };
            cell.mergedCells.push(cellInfo);
            
            // 完全移除被合并的单元格
            nextVisibleCell.remove();
            
            // 增加当前单元格的colspan
            cell.setAttribute('colspan', currentColspan + 1);
            
            // 更新按钮状态
            updateCellButtons(cell);
            
            saveToStorage();
        }
        
        // 完全拆分单元格
        function splitCell(cell){
            var currentColspan = parseInt(cell.getAttribute('colspan') || 1);
            
            if(currentColspan <= 1) return; // 没有合并，无需拆分
            if(!cell.mergedCells || cell.mergedCells.length === 0) return; // 没有保存的合并信息
            
            var row = cell.closest('tr');
            
            // 按照保存的顺序恢复所有被合并的单元格
            var insertAfter = cell;
            
            cell.mergedCells.forEach(function(cellInfo){
                // 创建新的单元格
                var newCell = document.createElement('td');
                newCell.innerHTML = '<span class="coord">(' + cellInfo.coord.row + ',' + cellInfo.coord.col + ')</span>';
                newCell.className = 'data-cell';
                
                // 插入到当前位置之后
                insertAfter.after(newCell);
                insertAfter = newCell; // 更新插入位置
                
                // 绑定事件
                bindCellEvents(newCell);
                
                // 使用setTimeout确保DOM更新完成后再添加按钮
                (function(targetCell){
                    setTimeout(function(){
                        addCellButtons(targetCell);
                    }, 0);
                })(newCell);
            });
            
            // 重置当前单元格的colspan
            cell.removeAttribute('colspan');
            
            // 清除保存的合并信息
            delete cell.mergedCells;
            
            // 更新按钮状态
            updateCellButtons(cell);
            
            saveToStorage();
        }
        
        // 更新单元格按钮状态
        function updateCellButtons(cell){
            // 移除现有按钮
            var existingButtons = cell.querySelectorAll('.micro-fab');
            existingButtons.forEach(function(btn){ btn.remove(); });
            
            // 添加新按钮
            addCellButtons(cell);
            
            // 重新应用默认字号到新创建的按钮
            var size = getDefaultFontSize() + 'px';
            cell.querySelectorAll('.micro-fab').forEach(function(btn){
                btn.style.fontSize = size;
            });
        }
        
        // 调整召唤石删除按钮位置的函数
        function adjustSummonDeleteButton(summonBox) {
            var img = summonBox.querySelector('img');
            var deleteBtn = summonBox.querySelector('.mini-fab.delete');
            
            if (!img || !deleteBtn) return;
            
            // 等待图片加载完成后调整位置
            function adjustPosition() {
                // 获取当前的图标缩放比例
                var iconScale = getIconScale() / 100;
                iconScale = Math.max(0.5, Math.min(2.0, iconScale));
                
                // 由于图片现在是绝对定位且居中，我们需要计算其实际显示尺寸
                var naturalWidth = img.naturalWidth;
                var naturalHeight = img.naturalHeight;
                
                if (naturalWidth === 0 || naturalHeight === 0) return;
                
                // 计算图片的实际显示尺寸（考虑缩放和max-width、max-height约束）
                var maxWidth = 40 * iconScale;
                var maxHeight = 48 * iconScale;
                var containerSize = 40 * iconScale;
                
                var scaleX = maxWidth / naturalWidth;
                var scaleY = maxHeight / naturalHeight;
                var scale = Math.min(scaleX, scaleY, 1); // 不放大，只缩小
                
                var displayWidth = naturalWidth * scale;
                var displayHeight = naturalHeight * scale;
                
                // 计算删除按钮位置（相对于图片右上角）
                var btnTop = (containerSize - displayHeight) / 2 - 6; // 容器中心 - 图片高度的一半 - 按钮偏移
                var btnRight = (containerSize - displayWidth) / 2 - 6; // 容器中心 - 图片宽度的一半 - 按钮偏移
                
                // 设置删除按钮位置
                deleteBtn.style.top = btnTop + 'px';
                deleteBtn.style.right = btnRight + 'px';
            }
            
            // 如果图片已经加载，直接调整
            if (img.complete && img.naturalHeight !== 0) {
                adjustPosition();
            } else {
                // 否则等待图片加载
                img.addEventListener('load', adjustPosition);
            }
        }
        
        // 为所有现有的召唤石调整删除按钮位置
        function adjustAllSummonDeleteButtons() {
            document.querySelectorAll('.skill-box.summon-box:not(.skill-source)').forEach(function(summonBox) {
                adjustSummonDeleteButton(summonBox);
            });
        }
        
        // 为单元格添加按钮 (优化版：净化E-H列，操作移至I列)
        function addCellButtons(cell){
            if(!cell) return;
            
            // 获取坐标信息
            var coordEl = cell.querySelector('.coord');
            if(!coordEl) return;
            var match = coordEl.textContent.match(/\((\d+),([A-Z\-]+)\)/);
            if(!match) return;
            var col = match[2];
            
            // ------------------------------------------------
            // 1. 数据列 (E-H): 只保留"添加文字"，移除所有合并按钮
            // ------------------------------------------------
            if(['E', 'F', 'G', 'H'].includes(col)) {
                // 清理旧按钮
                cell.querySelectorAll('.micro-fab').forEach(function(btn){ btn.remove(); });
                
                // 只添加左上角的文字编辑按钮
                var textBtn = document.createElement('button');
                textBtn.className = 'micro-fab text top-left';
                textBtn.innerHTML = '✎';
                textBtn.title = '添加文字';
                textBtn.onclick = function(e){ e.stopPropagation(); addPriorityText(cell); };
                cell.appendChild(textBtn);
                
                // 应用字号
                var size = getDefaultFontSize() + 'px';
                textBtn.style.fontSize = size;
            }
            
            // C列和D列也保留添加文字按钮
            if(col === 'C' || col === 'D') {
                cell.querySelectorAll('.micro-fab').forEach(function(btn){ btn.remove(); });
                var textBtn = document.createElement('button');
                textBtn.className = 'micro-fab text top-left';
                textBtn.innerHTML = '✎';
                textBtn.title = '添加文字';
                textBtn.onclick = function(e){ e.stopPropagation(); addPriorityText(cell); };
                cell.appendChild(textBtn);
                var size = getDefaultFontSize() + 'px';
                textBtn.style.fontSize = size;
            }
            
            // ------------------------------------------------
            // 2. 备注列 (I): 添加"整行合并/拆分"控制面板
            // ------------------------------------------------
            if(col === 'I') {
                updateRowControls(cell);
            }
        }
        
        // 定义 SVG 图标常量 (Material Design 风格)
        var ICON_MERGE = '<svg viewBox="0 0 24 24"><path d="M20 9h-7.5l2.5-2.5-1.4-1.4L9 9.7l4.6 4.6 1.4-1.4L12.5 10.5H20v-1.5zm-16 6h7.5l-2.5 2.5 1.4 1.4L15 14.3l-4.6-4.6-1.4 1.4L11.5 13.5H4v1.5z"/></svg>'; // 收缩箭头
        var ICON_SPLIT = '<svg viewBox="0 0 24 24"><path d="M15 15h7.5l-2.5 2.5 1.4 1.4 4.6-4.6-4.6-4.6-1.4 1.4 2.5 2.5H15v-1.5zM9 9H1.5l2.5-2.5L2.6 5.1-2 9.7l4.6 4.6 1.4-1.4L1.5 10.5H9v-1.5z"/></svg>'; // 扩散箭头
        
        // 更新I列的行控面板
        function updateRowControls(noteCell) {
            // 1. 清理旧面板，防止重复堆叠
            var oldPanel = noteCell.querySelector('.note-cell-controls');
            if(oldPanel) oldPanel.remove();
            
            // 验证这是 I 列
            var noteCellCoord = noteCell.querySelector('.coord');
            if(!noteCellCoord || !noteCellCoord.textContent.match(/,I\)$/)) return;
            
            var row = noteCell.parentElement;
            if(!row) return;
            
            // 2. 重新从 DOM 获取该行的所有单元格（确保是最新状态）
            var cells = Array.from(row.querySelectorAll('td'));
            
            // 3. 统计 E-H 列的数量来判断是否合并
            var dataColCount = 0;
            for(var i = 0; i < cells.length; i++) {
                var coordEl = cells[i].querySelector('.coord');
                if(coordEl) {
                    var text = coordEl.textContent;
                    if(text.match(/,[EFGH]\)$/)) {
                        dataColCount++;
                    }
                }
            }
            
            // 如果有4个数据列(E,F,G,H)，说明是拆分状态；如果只有1个(E)，说明是合并状态
            var isFullyMerged = (dataColCount === 1);
            var isFullySplit = (dataColCount === 4);
            
            // 如果既不是合并也不是拆分（异常状态），不显示按钮
            if(!isFullyMerged && !isFullySplit) return;
            
            // 4. 创建面板
            var panel = document.createElement('div');
            panel.className = 'note-cell-controls';
            
            // 5. 根据状态互斥显示按钮
            if (isFullyMerged) {
                // 状态：已合并 -> 显示【拆分】按钮
                var splitBtn = document.createElement('button');
                splitBtn.className = 'row-action-btn split';
                splitBtn.innerHTML = ICON_SPLIT;
                splitBtn.title = '拆分单元格';
                splitBtn.onclick = function(e) { e.stopPropagation(); splitRowAll(row); };
                panel.appendChild(splitBtn);
            } else {
                // 状态：未合并 -> 显示【合并】按钮
                var mergeBtn = document.createElement('button');
                mergeBtn.className = 'row-action-btn merge';
                mergeBtn.innerHTML = ICON_MERGE;
                mergeBtn.title = '合并整行技能';
                mergeBtn.onclick = function(e) { e.stopPropagation(); mergeRowAll(row); };
                panel.appendChild(mergeBtn);
            }
            
            noteCell.appendChild(panel);
        }
        
        // 整行合并逻辑
        function mergeRowAll(row) {
            var allCells = Array.from(row.querySelectorAll('td'));
            var targetCells = [];
            var targetCols = ['E', 'F', 'G', 'H'];
            
            // 收集当前存在的E-H列单元格
            allCells.forEach(function(cell){
                var coord = getCellCoord(cell);
                if(coord && targetCols.includes(coord.col)) {
                    targetCells.push(cell);
                }
            });
            
            if(targetCells.length <= 1) return; // 只有一个格子，无需合并
            
            var firstCell = targetCells[0]; 
            
            // 搬运内容并删除后续格子
            for(var i = 1; i < targetCells.length; i++) {
                var cell = targetCells[i];
                var skills = cell.querySelectorAll('.skill-box:not(.skill-source)');
                skills.forEach(function(s){ firstCell.appendChild(s); });
                var texts = cell.querySelectorAll('.user-text-wrapper');
                texts.forEach(function(t){ firstCell.appendChild(t); });
                cell.remove();
            }
            
            // 设置跨度
            firstCell.setAttribute('colspan', 4);
            
            // 更新UI：E列只留铅笔
            addCellButtons(firstCell); 
            
            // 查找 I 列并刷新控制面板（使用精确匹配）
            var iCell = null;
            for(var j = 0; j < allCells.length; j++) {
                var coord = allCells[j].querySelector('.coord');
                if(coord && coord.textContent.match(/,I\)$/)) {
                    iCell = allCells[j];
                    break;
                }
            }
            if(iCell) updateRowControls(iCell);
            
            saveToStorage();
        }
        
        // 整行拆分逻辑
        function splitRowAll(row) {
            var allCells = Array.from(row.querySelectorAll('td'));
            var eCell = allCells.find(function(c) {
                var coord = c.querySelector('.coord');
                return coord && coord.textContent.includes(',E)');
            });
            
            if(!eCell) return;
            
            // 检查当前是否已经是拆分状态（防止重复拆分）
            var currentColspan = parseInt(eCell.getAttribute('colspan') || 1);
            if(currentColspan <= 1) {
                // 已经是拆分状态，只需要刷新按钮
                var existingICells = Array.from(row.querySelectorAll('td'));
                for(var k = 0; k < existingICells.length; k++) {
                    var coordEl = existingICells[k].querySelector('.coord');
                    if(coordEl && coordEl.textContent.match(/,I\)$/)) {
                        updateRowControls(existingICells[k]);
                        break;
                    }
                }
                return;
            }
            
            // 恢复为1列
            eCell.setAttribute('colspan', 1);
            // 同时移除 colspan 属性（某些浏览器可能需要）
            if(currentColspan <= 1) {
                eCell.removeAttribute('colspan');
            }
            
            // 获取行号
            var coordObj = getCellCoord(eCell);
            var rowNum = coordObj.row;
            
            // 插入 F, G, H
            var newCols = ['F', 'G', 'H'];
            var insertRef = eCell;
            
            for(var i=0; i < 3; i++) {
                var colChar = newCols[i];
                var newCell = document.createElement('td');
                newCell.className = 'data-cell';
                newCell.innerHTML = '<span class="coord">(' + rowNum + ',' + colChar + ')</span>';
                insertRef.after(newCell);
                insertRef = newCell;
                bindCellEvents(newCell);
            }
            
            // 更新UI
            addCellButtons(eCell); // 恢复E列的铅笔
            
            // 使用 setTimeout 确保 DOM 完全更新后再刷新控制面板
            setTimeout(function() {
                var freshCells = Array.from(row.querySelectorAll('td'));
                var iCell = null;
                for(var j = 0; j < freshCells.length; j++) {
                    var coordEl = freshCells[j].querySelector('.coord');
                    if(coordEl && coordEl.textContent.match(/,I\)$/)) {
                        iCell = freshCells[j];
                        break;
                    }
                }
                if(iCell) updateRowControls(iCell);
            }, 0);
            
            saveToStorage();
        }
        
        // 修改collectData以保存合并信息
        var originalCollectData=collectData;
        collectData=function(){
            var data=originalCollectData();
            data.mergedCells=[];
            
            // 收集合并信息
            var tbody=document.querySelector('tbody');
            var rows=Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(function(row){
                var cells=Array.from(row.querySelectorAll('td'));
                cells.forEach(function(cell){
                    var colspan=parseInt(cell.getAttribute('colspan'))||1;
                    if(colspan>1){
                        var coord=getCellCoord(cell);
                        if(coord&&coord.row>=3){
                            // 只保存数据行的合并信息，排除I和J列
                            if(coord.col!=='I'&&coord.col!=='J'&&coord.col!=='H'){
                                data.mergedCells.push({
                                    row:coord.row,
                                    col:coord.col,
                                    colspan:colspan
                                });
                            }
                        }
                    }
                });
            });
            
            return data;
        };
        
        // 修改restoreData以恢复合并信息
        var originalRestoreData=restoreData;
        restoreData=function(data){
            // 先恢复基础数据
            originalRestoreData(data);
            
            // 然后恢复合并信息
            if(data.mergedCells&&data.mergedCells.length>0){
                data.mergedCells.forEach(function(merge){
                    var cell=findCellByCoord(merge.row,merge.col);
                    if(cell){
                        var row=cell.closest('tr');
                        var allCells=Array.from(row.querySelectorAll('td'));
                        var cellIndex=allCells.indexOf(cell);
                        var currentColspan=parseInt(cell.getAttribute('colspan'))||1;
                        var targetColspan=merge.colspan;
                        
                        // 执行合并操作
                        for(var i=currentColspan;i<targetColspan;i++){
                            var nextCell=allCells[cellIndex+1];
                            if(nextCell){
                                // 保存下一个单元格的内容（包括wrapper）
                                var skills=nextCell.querySelectorAll('.skill-box:not(.skill-source)');
                                var wrappers=nextCell.querySelectorAll('.user-text-wrapper');
                                var texts=nextCell.querySelectorAll('.user-text:not(.user-text-wrapper .user-text)');
                                skills.forEach(function(skill){cell.appendChild(skill);});
                                wrappers.forEach(function(wrapper){cell.appendChild(wrapper);});
                                texts.forEach(function(text){cell.appendChild(text);});
                                
                                // 删除下一个单元格
                                nextCell.remove();
                                
                                // 增加colspan
                                cell.setAttribute('colspan',i+1);
                                
                                // 更新allCells数组
                                allCells=Array.from(row.querySelectorAll('td'));
                            }
                        }
                        
                        // 更新按钮状态（显示拆分按钮而不是合并按钮）
                        updateCellButtons(cell);
                    }
                });
                
                recalculateAllCoords();
                
                // [新增] 恢复数据后，刷新所有I列的控制按钮状态
                document.querySelectorAll('.note-cell').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    if(coord && coord.textContent.includes(',I)')) {
                        updateRowControls(cell);
                    }
                });
                
                // 合并完成后立即应用图标缩放（修复合并后图标大小重置的问题）
                applyIconScaling();
            } else {
                // 没有合并单元格时也要应用图标缩放
                applyIconScaling();
                
                // [新增] 即使没有合并单元格，也刷新I列控制面板
                document.querySelectorAll('.note-cell').forEach(function(cell){
                    var coord = cell.querySelector('.coord');
                    if(coord && coord.textContent.includes(',I)')) {
                        updateRowControls(cell);
                    }
                });
            }
        };
    </script>

    <!-- BOSS选择弹窗 -->
    <div id="bossSelectModal" class="boss-select-modal">
        <div class="boss-select-content">
            <div class="boss-select-title">选择副本模式</div>
            <div class="boss-select-hint">⚠️ 切换模式将重置表格，请先导出保存当前配置</div>
            <div class="boss-select-grid">
                <div class="boss-option option-9man" onclick="confirmSwitchMode(9)">
                    <div class="boss-img-wrapper">
                        <img src="https://huiji-public.huijistatic.com/gbf/uploads/4/4f/2900032000_unlimited.png" alt="9人模式">
                    </div>
                    <div class="boss-option-label">极妈模板</div>
                </div>
                <div class="boss-option option-6man" onclick="confirmSwitchMode(6)">
                    <div class="boss-img-wrapper">
                        <img src="https://prd-game-a1-granbluefantasy.akamaized.net/assets/img/sp/quest/assets/lobby/305581.png" alt="6人模式">
                    </div>
                    <div class="boss-option-label">极法模板</div>
                </div>
            </div>
            <button class="boss-select-cancel" onclick="closeBossSelectModal()">取消</button>
        </div>
    </div>
</body>
</html>